<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Swoop Spotter</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  // Configure Tailwind to use class-based dark mode with our custom class
  tailwind.config = {
    darkMode: ['class', '.dark-mode']
  }
</script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  /* ===== Light Mode (Default) ===== */
  :root {
    --bg-primary: #f2eceb;
    --bg-secondary: #e8e2e1;
    --bg-tertiary: #dcd6d5;
    --text-primary: #422d1e;
    --text-secondary: #5a4a3a;
    --border-color: #d4cac7;
    --shadow: rgba(66, 45, 30, 0.12);
    --shadow-heavy: rgba(66, 45, 30, 0.22);
    --map-bg: #e8e2e1;
  }
  
  /* ===== Dark Mode ===== */
  body.dark-mode {
    --bg-primary: #1a1410;
    --bg-secondary: #2a1f18;
    --bg-tertiary: #3a2d22;
    --text-primary: #f2eceb;
    --text-secondary: #d4cac7;
    --border-color: #4a3d32;
    --shadow: rgba(0, 0, 0, 0.3);
    --shadow-heavy: rgba(0, 0, 0, 0.5);
    --map-bg: #181818;
  }
  
  body { 
    background: var(--bg-primary); 
    color: var(--text-primary);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  
  #map { 
    height: 56vh; 
    width: 100%; 
    border-radius: 0.5rem; 
    position: relative;
    z-index: 1;
    background: var(--map-bg);
  }
  
  .fab { 
    position:absolute; 
    bottom:1rem; 
    right:1rem; 
    z-index:1400; 
    width:56px; 
    height:56px; 
    border-radius:9999px; 
    display:grid; 
    place-items:center; 
    box-shadow:0 8px 24px var(--shadow-heavy); 
    cursor:pointer; 
  }
  
  .tag-input { 
    min-height:2.6rem; 
    display:flex; 
    align-items:center; 
    gap:6px; 
    flex-wrap:wrap; 
    padding:6px; 
    border:1px solid var(--border-color); 
    border-radius:8px; 
    background: var(--bg-primary); 
    cursor:text; 
  }
  
  .tag { 
    background: var(--bg-secondary); 
    color: var(--text-primary); 
    padding:6px 8px; 
    border-radius:999px; 
    display:inline-flex; 
    align-items:center; 
    gap:6px; 
    font-size:13px; 
  }
  
  .tag .x { cursor:pointer; font-weight:700; }
  
  .tag-list { 
    position:absolute; 
    left:0; 
    right:0; 
    top:100%; 
    margin-top:6px; 
    background: var(--bg-primary); 
    border:1px solid var(--border-color); 
    border-radius:8px; 
    box-shadow:0 10px 30px var(--shadow); 
    max-height:220px; 
    overflow:auto; 
    z-index:10050; 
    display:none; 
  }
  
  .tag-list > div { padding:8px 10px; cursor:pointer; }
  .tag-list > div:hover { background: var(--bg-secondary); }
  
  .modal-overlay { 
    z-index:99999 !important; 
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  /* Ensure modals don't exceed viewport and content scrolls within */
  .modal-overlay > div,
  #profileModal > div:first-child,
  #authModal > div:first-child,
  #safetyTipsModal > div:first-child,
  #testingModal > div:first-child,
  #statsModal > div:first-child {
    max-height: 90vh !important;
    display: flex;
    flex-direction: column;
  }
  
  /* Make modal content areas scrollable while keeping headers/buttons visible */
  #profileModal .p-6:not(:first-child),
  #authModal form,
  #safetyTipsModal .overflow-y-auto,
  #testingModal .space-y-4,
  #statsModal .p-6 {
    overflow-y: auto !important;
    flex: 1 1 auto;
  }
  
  .tag-box { 
    min-height: 2.6rem; 
    display: flex; 
    align-items: center; 
    gap: 6px; 
    flex-wrap: wrap; 
    padding: 6px; 
    border: 1px solid var(--border-color); 
    border-radius: 8px; 
    background: var(--bg-primary); 
    cursor: text;
    margin-bottom: 1rem;
  }
  
  .input-field {
    width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 8px 12px;
    margin-bottom: 1rem;
    background: var(--bg-primary);
    color: var(--text-primary);
  }
  
  #alertBox { 
    position: fixed; 
    top:50%; 
    left:50%; 
    transform:translate(-50%,-50%); 
    z-index: 998; 
    background:#fff7ed; 
    color: #422d1e; 
    border:2px solid #f59e0b; 
    border-radius:0.5rem; 
    padding:0.75rem 1rem; 
    max-width:92%; 
    width:460px; 
    box-shadow: 0 10px 30px var(--shadow-heavy); 
    opacity:0; 
    pointer-events:none; 
    transition:all .26s ease; 
    display:none; 
  }
  
  /* Minimized alert state - small icon in top right corner of map (below header) */
  #alertBox.minimized {
    top: 80px !important;
    bottom: auto !important;
    right: 20px !important;
    left: auto !important;
    transform: none !important;
    width: 60px !important;
    height: 60px !important;
    max-width: none !important;
    padding: 0 !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    opacity: 1 !important;
    pointer-events: auto !important;
    cursor: pointer !important;
    background: #f59e0b !important;
    border: none !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    z-index: 10 !important;
  }
  
  @keyframes pulse-alert {
    0%, 100% { 
      background: #f59e0b;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }
    50% { 
      background: #fbbf24;
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.8);
    }
  }
  
  /* Hide alert content when minimized */
  #alertBox.minimized > * {
    display: none !important;
  }
  
  /* Show only the icon when minimized */
  #alertBox.minimized::before {
    content: '';
    display: block !important;
    width: 32px;
    height: 32px;
    background-image: url('Assets/Icons/alert.svg');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    filter: brightness(0) invert(1);
  }
  
  /* ===== Dark Mode Utility Classes ===== */
  .bg-primary { background-color: var(--bg-primary) !important; }
  .bg-secondary { background-color: var(--bg-secondary) !important; }
  .bg-tertiary { background-color: var(--bg-tertiary) !important; }
  .text-primary { color: var(--text-primary) !important; }
  .text-secondary { color: var(--text-secondary) !important; }
  .border-themed { border-color: var(--border-color) !important; }
  
  .btn-primary {
    background-color: var(--text-primary) !important;
    color: var(--bg-primary) !important;
    transition: opacity 0.2s ease;
  }
  .btn-primary:hover { opacity: 0.9; }
  
  .btn-secondary {
    background-color: var(--bg-secondary) !important;
    color: var(--text-primary) !important;
    border: 1px solid var(--border-color);
    transition: background-color 0.2s ease;
  }
  .btn-secondary:hover { background-color: var(--bg-tertiary) !important; }
  
  .btn-success {
    background-color: #047857 !important;
    color: white !important;
    transition: opacity 0.2s ease;
  }
  .btn-success:hover { opacity: 0.9; }
  
  .btn-danger {
    background-color: #DC2626 !important;
    color: white !important;
    transition: opacity 0.2s ease;
  }
  .btn-danger:hover { opacity: 0.9; }
  
  .card-primary {
    background-color: var(--bg-primary) !important;
    border: 2px solid var(--border-color);
  }
  
  .card-secondary {
    background-color: var(--bg-secondary) !important;
  }
  
  .error-box {
    background-color: #FEE2E2;
    color: #991B1B;
  }
  
  /* Enable Location Button - display as flex when visible */
  #enableLocationBtn:not(.hidden) {
    display: flex !important;
  }
  
  body.dark-mode .error-box {
    background-color: #7F1D1D;
    color: #FECACA;
  }
  
  .success-box {
    background-color: #DCFCE7;
    color: #14532D;
    border-left: 3px solid #059669;
  }
  
  body.dark-mode .success-box {
    background-color: #14532D;
    color: #DCFCE7;
    border-left: 3px solid #10B981;
  }
  
  /* ===== Override inline styles with dark mode ===== */
  body.dark-mode [style*="background-color: #f2eceb"],
  body.dark-mode [style*="background-color:#f2eceb"] {
    background-color: var(--bg-primary) !important;
  }
  
  body.dark-mode [style*="background-color: #e8e2e1"],
  body.dark-mode [style*="background-color:#e8e2e1"] {
    background-color: var(--bg-secondary) !important;
  }
  
  body.dark-mode [style*="background-color: #dcd6d5"],
  body.dark-mode [style*="background-color:#dcd6d5"] {
    background-color: var(--bg-tertiary) !important;
  }
  
  body.dark-mode [style*="background-color: #fff"],
  body.dark-mode [style*="background-color:#fff"],
  body.dark-mode [style*="background-color: white"],
  body.dark-mode [style*="background-color:white"] {
    background-color: var(--bg-tertiary) !important;
  }
  
  body.dark-mode [style*="color: #422d1e"],
  body.dark-mode [style*="color:#422d1e"] {
    color: var(--text-primary) !important;
  }
  
  body.dark-mode [style*="border: 2px solid #d4cac7"],
  body.dark-mode [style*="border:2px solid #d4cac7"],
  body.dark-mode [style*="border: 1px solid #d4cac7"],
  body.dark-mode [style*="border:1px solid #d4cac7"] {
    border-color: var(--border-color) !important;
  }
  
  /* Override white input fields */
  body.dark-mode input[style*="background-color"],
  body.dark-mode select[style*="background-color"],
  body.dark-mode textarea[style*="background-color"] {
    background-color: var(--bg-secondary) !important;
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
  }
  
  /* Override all text colors in dark mode */
  body.dark-mode h1, 
  body.dark-mode h2, 
  body.dark-mode h3, 
  body.dark-mode h4, 
  body.dark-mode h5, 
  body.dark-mode h6,
  body.dark-mode p,
  body.dark-mode label,
  body.dark-mode span,
  body.dark-mode div {
    color: var(--text-primary);
  }
  
  /* Tab headers in modals - ensure they're readable */
  body.dark-mode button[style*="color: #422d1e"],
  body.dark-mode .safety-tips-tab-btn,
  body.dark-mode [class*="tab-btn"] {
    color: var(--text-primary) !important;
  }
  
  /* Profile modal tab headers - override inline styles */
  body.dark-mode #profileStatsTab,
  body.dark-mode #profileEditTab {
    color: var(--text-primary) !important;
  }
  
  /* Active tab state - dark background with light text for contrast */
  body.dark-mode #profileStatsTab.active,
  body.dark-mode #profileEditTab.active,
  body.dark-mode .safety-tips-tab-btn[style*="opacity: 1"] {
    background-color: var(--text-primary) !important;
    color: var(--bg-primary) !important;
    border-color: var(--text-primary) !important;
  }
  
  /* Auth modal tab headers - beige text for better contrast */
  body.dark-mode #signInTab,
  body.dark-mode #signUpTab {
    color: var(--text-primary) !important;
  }
  
  /* Auth modal active tab - beige border */
  body.dark-mode #signInTab.active,
  body.dark-mode #signUpTab.active {
    border-bottom-color: var(--text-primary) !important;
  }
  
  /* Auth modal submit buttons - beige background with dark brown text */
  body.dark-mode #signInForm button[type="submit"],
  body.dark-mode #signUpForm button[type="submit"] {
    background-color: var(--text-primary) !important;
    color: #422d1e !important;
  }
  
  /* Swoop spot modal buttons - beige background with dark brown text */
  body.dark-mode .add-report-btn,
  body.dark-mode #addReportBtn,
  body.dark-mode .add-report-exit-btn,
  body.dark-mode #closeSafetyTipsBottom,
  body.dark-mode #useGPSBtnModal,
  body.dark-mode #testVibrateBtnModal,
  body.dark-mode #closeTestingModalBottom,
  body.dark-mode button[style*="background-color: #422d1e"] {
    background-color: var(--text-primary) !important;
    color: #422d1e !important;
  }
  
  /* Show More buttons - beige background with dark brown text */
  body.dark-mode #showMoreBtn,
  body.dark-mode .show-more-btn,
  body.dark-mode button.show-more-btn.text-white,
  body.dark-mode button.text-xs.text-white.show-more-btn {
    background-color: var(--text-primary) !important;
    color: #422d1e !important;
  }
  
  /* Exit modal "Yes, I saw the bird" button */
  body.dark-mode .calm-feedback-btn[data-action="yes"] {
    background-color: var(--text-primary) !important;
    color: #422d1e !important;
  }
  
  /* Safety Tips sources - lighter blue text for better contrast */
  body.dark-mode p[style*="color: #0C4A6E"] {
    color: #60A5FA !important; /* blue-400 - much lighter blue */
  }
  
  /* Safety Tips buttons - darker green in dark mode */
  body.dark-mode .safety-tips-btn,
  body.dark-mode button.safety-tips-btn,
  body.dark-mode button.safety-tips-btn.bg-green-600,
  body.dark-mode button.text-xs.bg-green-600.safety-tips-btn,
  body.dark-mode button.safety-tips-btn.text-xs.bg-green-600.hover\:bg-green-700 {
    background-color: #047857 !important; /* green-700 - darker than default green-600 */
    border-color: #047857 !important;
  }
  
  body.dark-mode .safety-tips-btn:hover,
  body.dark-mode button.safety-tips-btn.bg-green-600:hover {
    background-color: #065f46 !important; /* green-800 - even darker on hover */
    border-color: #065f46 !important;
  }
  
  /* Override Tailwind bg-green-600 for safety tips buttons specifically */
  body.dark-mode button.safety-tips-btn.bg-green-600.text-white,
  body.dark-mode .safety-tips-btn.bg-green-600 {
    background-color: #047857 !important;
  }
  
  /* Override Tailwind hover:bg-green-700 */
  body.dark-mode button.safety-tips-btn.hover\:bg-green-700:hover {
    background-color: #065f46 !important;
  }
  
  /* Override Tailwind text-white for show-more buttons - use attribute selector for inline styles */
  body.dark-mode button.show-more-btn.text-white,
  body.dark-mode button#showMoreBtn.text-white,
  body.dark-mode button.show-more-btn[style*="background-color: #422d1e"],
  body.dark-mode button#showMoreBtn[style*="background-color: #422d1e"] {
    color: #422d1e !important;
  }
  
  /* Override inline style bg for safety tips buttons */
  body.dark-mode button.safety-tips-btn[class*="bg-green"] {
    background-color: #047857 !important;
  }
  
  body.dark-mode button.safety-tips-btn[class*="bg-green"]:hover {
    background-color: #065f46 !important;
  }
  
  /* Leaflet map zoom controls - dark background with light symbols */
  body.dark-mode .leaflet-control-zoom a {
    background-color: var(--bg-secondary) !important;
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
  }
  
  body.dark-mode .leaflet-control-zoom a:hover {
    background-color: var(--bg-tertiary) !important;
  }
  
  /* Menu text - ensure dropdown menu items are readable */
  body.dark-mode #userMenuDropdown button {
    color: var(--text-primary) !important;
  }
  
  /* Keep specific color classes that should remain */
  body.dark-mode .text-red-500,
  body.dark-mode .text-red-600,
  body.dark-mode .text-red-700 {
    color: #EF4444 !important;
  }
  
  body.dark-mode .text-green-500,
  body.dark-mode .text-green-600,
  body.dark-mode .text-green-700 {
    color: #10B981 !important;
  }
  
  body.dark-mode .text-blue-500,
  body.dark-mode .text-blue-600,
  body.dark-mode .text-blue-700 {
    color: #3B82F6 !important;
  }
  
  body.dark-mode .text-orange-500,
  body.dark-mode .text-orange-600,
  body.dark-mode .text-orange-700 {
    color: #F97316 !important;
  }
  
  body.dark-mode .text-gray-500,
  body.dark-mode .text-gray-600,
  body.dark-mode .text-gray-700 {
    color: var(--text-secondary) !important;
  }
  
  /* Alert colors - use darker versions for better contrast */
  body.dark-mode .risk-danger,
  body.dark-mode [class*="text-red"] {
    color: #DC2626 !important; /* Darker red */
  }
  
  body.dark-mode .risk-caution,
  body.dark-mode [class*="text-orange"],
  body.dark-mode [class*="text-yellow"] {
    color: #D97706 !important; /* Darker orange */
  }
  
  body.dark-mode .risk-low,
  body.dark-mode .risk-calm {
    color: #059669 !important; /* Darker green */
  }
  
  /* Nearby alerts and map alerts - use darker colors */
  body.dark-mode .border-red-400 {
    border-color: #DC2626 !important;
  }
  
  body.dark-mode .bg-red-50,
  body.dark-mode div.bg-red-50 {
    background-color: #7F1D1D !important; /* Dark red background */
  }
  
  body.dark-mode [class*="bg-red-50"] {
    background-color: #7F1D1D !important;
  }
  
  body.dark-mode .text-red-700,
  body.dark-mode div.text-red-700 {
    color: #FCA5A5 !important; /* Light red for readability */
  }
  
  body.dark-mode .border-yellow-400 {
    border-color: #D97706 !important;
  }
  
  body.dark-mode .bg-yellow-50,
  body.dark-mode div.bg-yellow-50 {
    background-color: #78350F !important; /* Dark orange/yellow background */
  }
  
  body.dark-mode [class*="bg-yellow-50"] {
    background-color: #78350F !important;
  }
  
  body.dark-mode .text-yellow-700,
  body.dark-mode div.text-yellow-700 {
    color: #FCD34D !important; /* Light yellow for readability */
  }
  
  body.dark-mode .border-green-400 {
    border-color: #059669 !important;
  }
  
  body.dark-mode .bg-green-50,
  body.dark-mode div.bg-green-50 {
    background-color: #14532D !important; /* Dark green background */
  }
  
  body.dark-mode [class*="bg-green-50"] {
    background-color: #14532D !important;
  }
  
  body.dark-mode .text-green-700,
  body.dark-mode div.text-green-700 {
    color: #6EE7B7 !important; /* Light green for readability */
  }
  
  body.dark-mode .border-blue-400 {
    border-color: #2563eb !important;
  }
  
  body.dark-mode .bg-blue-50,
  body.dark-mode div.bg-blue-50 {
    background-color: #1E3A8A !important; /* Dark blue background */
  }
  
  body.dark-mode [class*="bg-blue-50"] {
    background-color: #1E3A8A !important;
  }
  
  body.dark-mode .text-blue-700 {
    color: #93C5FD !important; /* Light blue for readability */
  }
  
  body.dark-mode .text-gray-600,
  body.dark-mode .text-gray-500 {
    color: var(--text-secondary) !important;
  }
  
  /* Ensure bold text in alerts is also light colored */
  body.dark-mode .bg-red-50 b,
  body.dark-mode .bg-yellow-50 b,
  body.dark-mode .bg-green-50 b,
  body.dark-mode .bg-blue-50 b {
    color: var(--text-primary) !important;
  }
  
  /* Reports Feed - different color classes */
  body.dark-mode .border-red-500 {
    border-color: #DC2626 !important;
  }
  
  body.dark-mode .text-red-600 {
    color: #FCA5A5 !important;
  }
  
  body.dark-mode .border-yellow-500 {
    border-color: #D97706 !important;
  }
  
  body.dark-mode .text-yellow-600 {
    color: #FCD34D !important;
  }
  
  body.dark-mode .border-green-500 {
    border-color: #059669 !important;
  }
  
  body.dark-mode .text-green-600 {
    color: #6EE7B7 !important;
  }
  
  /* Override bg-white in reports */
  body.dark-mode .bg-white,
  body.dark-mode div.bg-white {
    background-color: var(--bg-secondary) !important;
  }
  
  /* Risk Level Banner - bg-*-100 backgrounds */
  body.dark-mode .bg-red-100 {
    background-color: #7F1D1D !important; /* Dark red background */
  }
  
  body.dark-mode .bg-yellow-100 {
    background-color: #78350F !important; /* Dark orange/yellow background */
  }
  
  body.dark-mode .bg-green-100 {
    background-color: #14532D !important; /* Dark green background */
  }
  
  body.dark-mode .bg-blue-100 {
    background-color: #1E3A8A !important; /* Dark blue background */
  }
  
  /* Alert Box (map alerts) - override light backgrounds */
  body.dark-mode #alertBox.risk-danger {
    background: #7F1D1D !important;
    border-color: #DC2626 !important;
  }
  
  body.dark-mode #alertBox.risk-caution {
    background: #78350F !important;
    border-color: #D97706 !important;
  }
  
  body.dark-mode #alertBox.risk-low {
    background: #14532D !important;
    border-color: #059669 !important;
  }
  
  body.dark-mode #alertBox.risk-calm {
    background: #1E3A8A !important;
    border-color: #2563eb !important;
  }
  
  /* Dark mode minimized alert - red color */
  body.dark-mode #alertBox.minimized {
    background: #DC2626 !important;
  }
  
  @keyframes pulse-alert-dark {
    0%, 100% { 
      background: #DC2626;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
    }
    50% { 
      background: #EF4444;
      box-shadow: 0 6px 20px rgba(220, 38, 38, 0.8);
    }
  }
  
  body.dark-mode #alertBox.minimized {
    animation: pulse-alert-dark 2s ease-in-out infinite !important;
  }
  
  /* Ensure text in alertBox is light colored */
  body.dark-mode #alertBox,
  body.dark-mode #alertBox * {
    color: var(--text-primary) !important;
  }
  
  /* Keep white text on colored buttons */
  body.dark-mode button[style*="background-color: #422d1e"] {
    color: var(--bg-primary) !important;
  }
  
  body.dark-mode button[style*="background-color: #10B981"],
  body.dark-mode button[style*="background-color: #DC2626"] {
    color: white !important;
  }
  
  /* ===== Dark Mode - Navigation Bar ===== */
  body.dark-mode .desktop-nav {
    background-color: var(--bg-secondary) !important;
    border-bottom: 1px solid var(--border-color);
  }
  
  body.dark-mode .desktop-nav-item {
    color: var(--text-primary) !important;
  }
  
  body.dark-mode .desktop-nav-item:hover {
    background-color: var(--bg-tertiary) !important;
  }
  
  body.dark-mode .desktop-nav-item.active {
    background-color: var(--text-primary) !important;
    color: #422d1e !important;
  }
  
  body.dark-mode .desktop-nav-item.active * {
    color: #422d1e !important;
  }
  
  body.dark-mode .desktop-nav-item.active img {
    filter: brightness(0) saturate(100%) invert(8%) sepia(18%) saturate(1753%) hue-rotate(347deg) brightness(93%) contrast(92%);
  }
  
  /* Make non-active desktop nav icons beige in dark mode */
  body.dark-mode .desktop-nav-item:not(.active) img {
    filter: brightness(0) saturate(100%) invert(93%) sepia(8%) saturate(502%) hue-rotate(330deg) brightness(102%) contrast(93%);
  }
  
  /* ===== Dark Mode - Logo Color ===== */
  body.dark-mode .cls-1 {
    fill: var(--text-primary) !important;
  }
  
  /* For SVG loaded via img tag, use filter instead */
  body.dark-mode img[src*="Logo-Horizontal.svg"] {
    filter: brightness(0) saturate(100%) invert(93%) sepia(8%) saturate(502%) hue-rotate(330deg) brightness(102%) contrast(93%);
  }
  
  /* ===== Dark Mode - Mobile Navigation ===== */
  body.dark-mode .mobile-nav {
    background-color: var(--bg-secondary) !important;
    border-top-color: var(--border-color) !important;
  }
  
  body.dark-mode .mobile-nav-item {
    color: var(--text-primary) !important;
  }
  
  body.dark-mode .mobile-nav-item.active {
    opacity: 1;
  }
  
  /* Make active mobile nav icons beige in dark mode */
  body.dark-mode .mobile-nav-item.active img {
    filter: brightness(0) saturate(100%) invert(92%) sepia(8%) saturate(378%) hue-rotate(338deg) brightness(96%) contrast(92%);
  }
  
  /* Make non-active mobile nav icons beige in dark mode */
  body.dark-mode .mobile-nav-item:not(.active) img {
    filter: brightness(0) saturate(100%) invert(93%) sepia(8%) saturate(502%) hue-rotate(330deg) brightness(102%) contrast(93%);
  }
  
  #alertBox.show { display:block; opacity:1; pointer-events:auto; }
  
  /* Risk level colors for alert box */
  #alertBox.risk-danger { background: #fee2e2; border-color: #ef4444; }
  #alertBox.risk-caution { background: #fff7ed; border-color: #f59e0b; }
  #alertBox.risk-low { background: #dcfce7; border-color: #22c55e; }
  #alertBox.risk-calm { background: #dbeafe; border-color: #3b82f6; }
  .required::after { content: ' *'; color: #ef4444; font-weight:700; margin-left:6px; }
  /* report feed coloring */
  .report-low { border-left: 4px solid #10B981; }
  .report-caution { border-left: 4px solid #F59E0B; }
  .report-danger { border-left: 4px solid #EF4444; }
  @media (max-width:480px){ #alertBox{ width:94%; padding:.6rem; } }

  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .tab-btn {
    transition: all 0.2s;
    position: relative;
  }
  .tab-btn:not(.active) {
    color: var(--color-dark);
    opacity: 0.6;
    border-bottom-color: transparent;
  }
  .tab-btn.active {
    color: var(--color-dark);
    opacity: 1;
    border-bottom-color: var(--color-dark);
  }
  .tab-btn:hover:not(.active) {
    opacity: 0.8;
    border-bottom-color: #d4cac7;
  }
  .latest-report {
    background-color: var(--color-light);
    border-radius: 0.5rem;
    padding: 1rem;
  }
  
  /* Mobile modal scrolling improvements */
  body.modal-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
  }
  
  /* Ensure modal content is scrollable on mobile and not hidden behind mobile nav */
  @media (max-width: 768px) {
    /* Standard modal overlays (spotModal, detailsModal) */
    .modal-overlay {
      align-items: flex-start !important;
      padding-top: 1rem;
      padding-bottom: calc(80px + env(safe-area-inset-bottom) + 1rem) !important;
    }
    
    /* Ensure modal inner content has proper spacing and max height */
    .modal-overlay > div {
      max-height: calc(100vh - 2rem - 80px - env(safe-area-inset-bottom)) !important;
      overflow-y: auto !important;
    }
    
    /* Profile Modal & Auth Modal */
    #profileModal,
    #authModal {
      align-items: flex-start !important;
      padding-top: 2rem !important;
      padding-bottom: calc(80px + env(safe-area-inset-bottom) + 1rem) !important;
    }
    
    #profileModal > div,
    #authModal > div {
      max-height: calc(100vh - 4rem - 80px - env(safe-area-inset-bottom)) !important;
      overflow-y: auto !important;
    }
    
    /* Safety Tips Modal & Testing Modal */
    #safetyTipsModal,
    #testingModal {
      padding-bottom: calc(80px + env(safe-area-inset-bottom) + 1rem) !important;
    }
    
    #safetyTipsModal > div,
    #testingModal > div {
      max-height: calc(100vh - 2rem - 80px - env(safe-area-inset-bottom)) !important;
      overflow-y: auto !important;
    }
    
    /* Stats Modal */
    .stats-modal {
      padding-bottom: calc(80px + env(safe-area-inset-bottom) + 1rem) !important;
    }
    
    .stats-modal > div {
      max-height: calc(100vh - 2rem - 80px - env(safe-area-inset-bottom)) !important;
    }
  }

  /* Mobile Navigation Bar */
  .mobile-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: #f2eceb;
    border-top: 2px solid #d4cac7;
    z-index: 1000;
    display: none;
    padding: 8px 0 max(8px, env(safe-area-inset-bottom));
    box-shadow: 0 -2px 10px rgba(66, 45, 30, 0.1);
  }

  .mobile-nav-items {
    display: flex;
    justify-content: space-around;
    align-items: center;
    max-width: 500px;
    margin: 0 auto;
  }

  .mobile-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 4px 12px;
    background: none;
    border: none;
    cursor: pointer;
    color: #422d1e;
    opacity: 0.6;
    transition: opacity 0.2s;
    text-decoration: none;
    font-size: 11px;
    font-weight: 500;
  }

  .mobile-nav-item.active {
    opacity: 1;
  }

  .mobile-nav-item:active {
    opacity: 0.4;
  }

  .mobile-nav-item img {
    width: 24px;
    height: 24px;
  }

  /* Show mobile nav on small screens */
  @media (max-width: 768px) {
    .mobile-nav {
      display: block;
    }

    main {
      padding-bottom: calc(80px + env(safe-area-inset-bottom)) !important;
    }
  }

  /* Stats Modal for Mobile */
  .stats-modal {
    display: none;
    position: fixed;
    inset: 0;
    background-color: rgba(66, 45, 30, 0.5);
    z-index: 60;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .stats-modal.active {
    display: flex;
  }
  
  body.dark-mode .stats-modal {
    background-color: rgba(0, 0, 0, 0.5);
  }
  
  /* Desktop/Web Top Navigation */
  .desktop-nav {
    display: none;
    background-color: #f2eceb;
    border-bottom: 2px solid #d4cac7;
    box-shadow: 0 2px 10px rgba(66, 45, 30, 0.1);
  }

  .desktop-nav-items {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .desktop-nav-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: none;
    border: none;
    cursor: pointer;
    color: #422d1e;
    opacity: 0.6;
    transition: all 0.2s;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    border-bottom: 3px solid transparent;
  }

  .desktop-nav-item.active {
    opacity: 1;
    border-bottom-color: #422d1e;
  }

  .desktop-nav-item:hover {
    opacity: 1;
    background-color: #e8e2e1;
  }

  .desktop-nav-item img {
    width: 20px;
    height: 20px;
  }

  /* Show desktop nav on larger screens, hide mobile nav */
  @media (min-width: 769px) {
    .desktop-nav {
      display: block;
    }
  }
  
  
  /* Safari-specific form element fixes */
  select, input, textarea {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }
  
  /* Consistent form field styling across all browsers */
  #birdSpecies {
    background-color: white;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 36px !important;
  }
  
  /* Bird Add Button Styling */
  .bird-add-btn {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 8px 24px rgba(0,0,0,0.18);
    overflow: hidden;
    background: transparent;
  }
  .bird-add-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 12px 32px rgba(0,0,0,0.24);
  }
  .bird-add-btn:active {
    transform: scale(0.98);
  }
  .bird-add-btn img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .bird-add-btn .plus-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 32px;
    font-weight: 300;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    pointer-events: none;
    z-index: 2;
  }
  
  /* Location tracking button animation */
  #trackLocationBtn {
    transition: background-color 0.3s ease, transform 0.1s ease;
  }
  #trackLocationBtn:active {
    transform: scale(0.95);
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
</style>

<!-- Dark Mode Button Overrides - Must be after Tailwind to ensure highest priority -->
<style>
  /* Force override Tailwind's text-white class for show-more buttons in dark mode */
  body.dark-mode .show-more-btn.text-white,
  body.dark-mode #showMoreBtn.text-white {
    color: #422d1e !important;
  }
  
  /* Force override Tailwind's bg-green-600 class for safety-tips buttons in dark mode */
  body.dark-mode .safety-tips-btn.bg-green-600,
  body.dark-mode button.safety-tips-btn.bg-green-600,
  body.dark-mode .safety-tips-btn.text-xs.bg-green-600,
  body.dark-mode button.text-xs.bg-green-600.safety-tips-btn,
  body.dark-mode .safety-tips-btn.text-xs.bg-green-600.hover\:bg-green-700 {
    background-color: #047857 !important;
  }
  
  /* Override hover state for safety-tips buttons */
  body.dark-mode .safety-tips-btn.bg-green-600:hover,
  body.dark-mode button.safety-tips-btn.bg-green-600:hover,
  body.dark-mode .safety-tips-btn.hover\:bg-green-700:hover,
  body.dark-mode button.safety-tips-btn.hover\:bg-green-700:hover,
  body.dark-mode .safety-tips-btn.text-xs.bg-green-600.hover\:bg-green-700:hover {
    background-color: #065f46 !important;
  }
</style>

</head>
<body class="min-h-screen">

<header class="shadow sticky top-0 z-50 bg-primary">
  <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex-1"></div>
    <img src="Assets/Logo/Logo-Horizontal.svg" alt="Swoop Spotter Logo" class="h-8" />
    <div class="flex-1 flex justify-end items-center gap-1 relative">
      <!-- Hamburger Menu Button -->
      <button id="hamburgerMenuButton" class="p-2 rounded transition-colors text-primary hover:bg-secondary" title="Menu">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
      
      <!-- Hamburger Menu Dropdown -->
      <div id="hamburgerMenuDropdown" class="hidden absolute right-0 top-full mt-2 rounded-lg shadow-xl p-2 z-50 card-primary" style="min-width: 220px;">
        <!-- User Info (shown when signed in) -->
        <div id="hamburgerUserInfo" class="hidden flex items-center gap-3 mb-2 pb-2 px-2 border-themed" style="border-bottom-width: 1px;">
          <img id="hamburgerUserAvatar" src="Assets/Users Icons/user_1.svg" alt="Avatar" class="w-10 h-10 rounded-full">
          <div class="flex-1 min-w-0">
            <div id="hamburgerUserName" class="font-medium text-primary truncate">User Name</div>
            <div id="hamburgerUserEmail" class="text-xs text-secondary truncate">user@email.com</div>
          </div>
        </div>
        
        <!-- Menu Items -->
        <button id="menuHome" class="w-full text-left px-3 py-2 rounded mb-1 text-primary hover:bg-secondary flex items-center gap-2">
          <img src="Assets/Menu Icons/Light Mode/menu-home.svg" alt="" width="16" height="16" class="menu-icon-light">
          <img src="Assets/Menu Icons/Dark Mode/menu-home-dark.svg" alt="" width="16" height="16" class="menu-icon-dark hidden">
          Home
        </button>
        
        <button id="menuContributions" class="hidden w-full text-left px-3 py-2 rounded mb-1 text-primary hover:bg-secondary flex items-center gap-2">
          <img src="Assets/Menu Icons/Light Mode/menu-contributions.svg" alt="" width="16" height="16" class="menu-icon-light">
          <img src="Assets/Menu Icons/Dark Mode/menu-contributions-dark.svg" alt="" width="16" height="16" class="menu-icon-dark hidden">
          Contributions
        </button>
        
        <button id="menuEditProfile" class="hidden w-full text-left px-3 py-2 rounded mb-1 text-primary hover:bg-secondary flex items-center gap-2">
          <img src="Assets/Menu Icons/Light Mode/menu-profile.svg" alt="" width="16" height="16" class="menu-icon-light">
          <img src="Assets/Menu Icons/Dark Mode/menu-profile-dark.svg" alt="" width="16" height="16" class="menu-icon-dark hidden">
          Edit Profile
        </button>
        
        <button id="menuStats" class="hidden w-full text-left px-3 py-2 rounded mb-1 text-primary hover:bg-secondary flex items-center gap-2">
          <img src="Assets/Menu Icons/Light Mode/menu-stats.svg" alt="" width="16" height="16" class="menu-icon-light">
          <img src="Assets/Menu Icons/Dark Mode/menu-stats-dark.svg" alt="" width="16" height="16" class="menu-icon-dark hidden">
          Stats
        </button>
        
        <button id="menuTips" class="w-full text-left px-3 py-2 rounded mb-1 text-primary hover:bg-secondary flex items-center gap-2">
          <img src="Assets/Menu Icons/Light Mode/menu-tips.svg" alt="" width="16" height="16" class="menu-icon-light">
          <img src="Assets/Menu Icons/Dark Mode/menu-tips-dark.svg" alt="" width="16" height="16" class="menu-icon-dark hidden">
          Safety Tips
        </button>
        
        <button id="menuTesting" class="w-full text-left px-3 py-2 rounded mb-1 text-primary hover:bg-secondary flex items-center gap-2">
          <img src="Assets/Menu Icons/Light Mode/menu-testing.svg" alt="" width="16" height="16" class="menu-icon-light">
          <img src="Assets/Menu Icons/Light Mode/menu-testing.svg" alt="" width="16" height="16" class="menu-icon-dark hidden" style="filter: brightness(0) saturate(100%) invert(92%) sepia(8%) saturate(378%) hue-rotate(338deg) brightness(96%) contrast(92%);">
          Testing
        </button>
        
        <!-- Manual Sync Button -->
        <button id="menuSync" class="hidden w-full text-left px-3 py-2 rounded mb-1 text-primary hover:bg-secondary flex items-center gap-2">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
          <span id="menuSyncText">Sync Now</span>
          <span id="menuSyncBadge" class="hidden ml-auto bg-orange-500 text-white text-xs px-2 py-0.5 rounded-full"></span>
        </button>
        
        <!-- Clear Sync Queue Button -->
        <button id="menuClearSync" class="hidden w-full text-left px-3 py-2 rounded mb-1 text-primary hover:bg-secondary flex items-center gap-2">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
          <span>Clear Unsynced</span>
        </button>
        
        <!-- Dark Mode Toggle -->
        <button id="menuDarkMode" class="w-full text-left px-3 py-2 rounded mb-1 text-primary hover:bg-secondary flex items-center gap-2">
          <svg class="moon-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          <svg class="sun-icon hidden" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
          <span class="dark-mode-text">Dark Mode</span>
        </button>
        
        <!-- Divider (only shown when signed in) -->
        <div id="menuDivider" class="hidden border-themed my-1" style="border-bottom-width: 1px;"></div>
        
        <button id="menuSignIn" class="w-full text-left px-3 py-2 rounded text-primary hover:bg-secondary flex items-center gap-2">
          <img src="Assets/Menu Icons/Light Mode/menu-logout.svg" alt="" width="16" height="16" class="menu-icon-light">
          <img src="Assets/Menu Icons/Dark Mode/menu-logout-dark.svg" alt="" width="16" height="16" class="menu-icon-dark hidden">
          Sign In
        </button>
        
        <button id="menuSignOut" class="hidden w-full text-left px-3 py-2 rounded text-primary hover:bg-secondary flex items-center gap-2">
          <img src="Assets/Menu Icons/Light Mode/menu-logout.svg" alt="" width="16" height="16" class="menu-icon-light">
          <img src="Assets/Menu Icons/Dark Mode/menu-logout-dark.svg" alt="" width="16" height="16" class="menu-icon-dark hidden">
          Sign Out
        </button>
      </div>
    </div>
  </div>
</header>

<!-- Desktop/Web Top Navigation -->
<nav class="desktop-nav" id="desktopNav">
  <div class="desktop-nav-items">
    <button class="desktop-nav-item active" id="desktopNavHome" data-view="home">
      <img src="Assets/Menu Icons/Light Mode/menu-home.svg" alt="Home">
      <span>Home</span>
    </button>
    <button class="desktop-nav-item" id="desktopNavProfile" data-view="profile">
      <img src="Assets/Menu Icons/Light Mode/menu-profile.svg" alt="Profile">
      <span>Profile</span>
    </button>
    <button class="desktop-nav-item" id="desktopNavTips" data-view="tips">
      <img src="Assets/Menu Icons/Light Mode/menu-tips.svg" alt="Safety Tips">
      <span>Safety Tips</span>
    </button>
    <button class="desktop-nav-item" id="desktopNavStats" data-view="stats">
      <img src="Assets/Menu Icons/Light Mode/menu-stats.svg" alt="Stats">
      <span>Stats</span>
    </button>
    <button class="desktop-nav-item" id="desktopNavTesting" data-view="testing">
      <img src="Assets/Menu Icons/Light Mode/menu-testing.svg" alt="Testing" width="20" height="20">
      <span>Testing</span>
    </button>
    <button class="desktop-nav-item" id="desktopNavLogout" data-view="logout">
      <img src="Assets/Menu Icons/Light Mode/menu-logout.svg" alt="Sign Out">
      <span>Sign Out</span>
    </button>
  </div>
</nav>

<main class="max-w-4xl mx-auto px-4 pb-12 pt-4">
  <div id="map" class="shadow rounded relative">
    <button id="openAddBtn" class="fab bird-add-btn" title="Add Swoop Spot">
      <img src="Assets/Icons/bird_background.svg" alt="">
      <span class="plus-icon">+</span>
    </button>
    
    <!-- Enable Location Button (shows when location not enabled) -->
    <button id="enableLocationBtn" class="hidden" style="position: absolute; bottom: 10px; left: 10px; z-index: 1000; background-color: #422d1e; color: white; padding: 8px 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 14px; font-weight: 500; align-items: center; gap: 8px; border: none; cursor: pointer;" onmouseover="this.style.backgroundColor='#5a3d2a'" onmouseout="this.style.backgroundColor='#422d1e'">
      Enable Location
    </button>
  </div>

  <!-- Add Swoop Spot button below map -->
  <div class="mt-4 flex justify-center gap-2 flex-wrap">
    <button id="addSpotBelowMap" class="px-6 py-2 rounded text-white font-medium btn-primary">
      + Add Swoop Spot
    </button>
    <button id="safetyTipsBtn" class="px-6 py-2 rounded text-white font-medium flex items-center gap-2 btn-success">
      <img src="Assets/Icons/tips.svg" alt="Tips" style="width: 20px; height: 20px; filter: brightness(0) invert(1);">
      Safety Tips
    </button>
  </div>

  <div class="mt-4">
    <section class="p-3 rounded shadow bg-primary">
      <h2 class="font-semibold mb-2 text-primary">Nearby Alerts</h2>
      <div id="alertsList" class="space-y-2 max-h-56 overflow-auto"></div>
    </section>
  </div>
</main>

<!-- centered alert -->
<div id="alertBox" role="status" aria-live="polite"></div>

<!-- Sync Indicator -->
<div id="syncIndicator" class="hidden"></div>

<!-- Add / New Spot Modal -->
<div id="spotModal" class="hidden fixed inset-0 modal-overlay flex items-start justify-center bg-black/40 pt-4 pb-4 px-4">
  <div class="rounded-lg shadow-lg w-full max-w-2xl my-auto max-h-[95vh] overflow-y-auto" style="background-color: #f2eceb;">
    <div class="p-6">
      <!-- Header -->
      <div class="flex justify-between items-center mb-4">
        <div>
          <h2 class="text-xl font-bold" style="color: #422d1e;">Add Swoop Spot</h2>
          <p class="text-sm mt-1" style="color: #422d1e; opacity: 0.7;">Click the map to select location, or enter an address below</p>
        </div>
        <button id="closeSpotModal" class="text-2xl" style="color: #422d1e; opacity: 0.6;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">&times;</button>
      </div>

    <form id="spotForm" class="space-y-4">
      <!-- Spot Details Section -->
      <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
        <h3 class="font-medium mb-3" style="color: #422d1e;">Spot Details</h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Bird species <span class="text-red-500">*</span></label>
            <select id="birdSpecies" class="w-full rounded-lg p-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #f2eceb; color: #422d1e;">
              <option>Magpie</option>
              <option>Magpie-Lark (Peewee)</option>
              <option>Masked Lapwing (plover)</option>
              <option>Butcherbird</option>
              <option>Crow</option>
              <option>Noisy Miner</option>
              <option>Noisy Friarbird</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Location Section -->
      <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
        <h3 class="font-medium mb-3" style="color: #422d1e;">Location</h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Address (optional)</label>
            <div class="flex gap-2">
              <div class="relative flex-1">
                <input id="addressField" placeholder="Enter an address" class="w-full rounded-lg p-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #f2eceb; color: #422d1e;" />
                <div id="addressField_suggestions"></div>
              </div>
              <button type="button" id="geoBtn" class="px-3 py-2 rounded text-sm whitespace-nowrap" style="border: 1px solid #d4cac7; background-color: #f2eceb; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='#f2eceb'">Find Me</button>
            </div>
            <div id="addressInfo" class="text-xs mt-1" style="color: #422d1e; opacity: 0.7;"></div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Coordinates</label>
            <input id="coordsField" class="w-full rounded-lg p-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #e8e2e1; color: #422d1e;" readonly placeholder="Click map or find address"/>
          </div>
        </div>
      </div>

      <!-- Initial Report Section -->
      <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
        <h3 class="font-medium mb-3" style="color: #422d1e;">Initial Report</h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Bird behaviour <span class="text-red-500">*</span></label>
            <div class="relative">
              <div id="rbirdBox" class="tag-input" tabindex="0"></div>
              <div id="rbirdList" class="tag-list"></div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Human behaviour <span class="text-red-500">*</span></label>
            <div class="relative">
              <div id="rhumanBox" class="tag-input" tabindex="0"></div>
              <div id="rhumanList" class="tag-list"></div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Precautions taken <span class="text-red-500">*</span></label>
            <div class="relative">
              <div id="rprecBox" class="tag-input" tabindex="0"></div>
              <div id="rprecList" class="tag-list"></div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Alert level (auto-set from bird behaviour)</label>
            <input type="text" id="ralertLevel" class="w-full rounded-lg p-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #e8e2e1; color: #422d1e;" readonly>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Extra info (optional)</label>
            <textarea id="reextra" class="w-full rounded-lg p-2 h-20" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #f2eceb; color: #422d1e;" placeholder="Any additional notes..."></textarea>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-2 pt-2">
        <button type="button" id="spotCancel" class="px-4 py-2 rounded" style="border: 1px solid #d4cac7; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='transparent'">Cancel</button>
        <button type="submit" id="spotSave" class="px-4 py-2 text-white rounded" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Create Swoop Spot</button>
      </div>
    </form>
    </div>
  </div>
</div>

<!-- Spot Details / Report Feed Modal -->
<div id="detailsModal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center bg-black/40 p-4">
  <div class="rounded-lg shadow-lg w-full max-w-2xl my-auto max-h-[85vh] flex flex-col" style="background-color: #f2eceb;">
    <div class="p-5 flex-shrink-0">
      <div class="flex justify-between items-start">
        <div>
          <h3 id="detailsTitle" class="text-lg font-semibold" style="color: #422d1e;">Spot details</h3>
          <p id="detailsSubtitle" class="text-xs" style="color: #422d1e; opacity: 0.7;">Feed of reports. Add a new report to append to this spot.</p>
        </div>
        <div>
          <button id="closeDetails" style="color: #422d1e; opacity: 0.7;">âœ–</button>
        </div>
      </div>
    </div>

    <div class="flex-1 overflow-y-auto px-5">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Left: spot summary & reports -->
        <div>
          <div id="spotHeader" class="p-3 rounded mb-3" style="border: 1px solid #d4cac7;">
            <!-- populated dynamically -->
          </div>

          <div class="overflow-auto max-h-96 space-y-2" id="reportsFeed">
            <!-- report items -->
          </div>
        </div>

        <!-- Right: add new report form -->
        <div class="p-3 rounded" style="background-color: #e8e2e1;">
          <h4 class="font-semibold mb-2" style="color: #422d1e;">Add a report</h4>
          <form id="reportForm" class="space-y-3 text-sm">
            <div>
              <label class="required" style="color: #422d1e;">Bird behaviour</label>
              <div class="relative">
                <div id="rbirdBox2" class="tag-input" tabindex="0"></div>
                <div id="rbirdList2" class="tag-list"></div>
              </div>
            </div>

            <div>
              <label class="required" style="color: #422d1e;">Human behaviour</label>
              <div class="relative">
                <div id="rhumanBox2" class="tag-input" tabindex="0"></div>
                <div id="rhumanList2" class="tag-list"></div>
              </div>
            </div>

            <div>
              <label class="required" style="color: #422d1e;">Precautions</label>
              <div class="relative">
                <div id="rprecBox2" class="tag-input" tabindex="0"></div>
                <div id="rprecList2" class="tag-list"></div>
              </div>
            </div>

            <div>
              <label class="required">Alert level (derived)</label>
              <select id="repAlertLevel" class="w-full border p-2 rounded">
                <option>Low risk</option>
                <option>Take caution</option>
                <option>Danger - Avoid</option>
              </select>
            </div>

            <div>
              <label>Extra notes</label>
              <textarea id="repExtra" class="w-full border p-2 rounded"></textarea>
            </div>

            <div class="flex justify-end gap-2">
              <button type="button" id="reportCancel" class="px-3 py-2 border rounded">Cancel</button>
              <button type="submit" id="reportSave" class="px-4 py-2 bg-yellow-500 text-white rounded">Add report</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirm discard modal -->
<div id="confirmModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4">
  <div class="rounded-lg shadow-lg p-4 max-w-sm w-full my-auto" style="background-color: #f2eceb;">
    <div class="text-sm mb-3">
      <div class="font-semibold" style="color: #422d1e;">Discard changes?</div>
      <div class="text-xs" style="color: #422d1e; opacity: 0.7;">You have unsaved changes. Are you sure you want to close without saving?</div>
    </div>
    <div class="flex justify-end gap-2">
      <button id="keepEditing" class="px-3 py-1 rounded" style="border: 1px solid #d4cac7; color: #422d1e;">Keep editing</button>
      <button id="discardChanges" class="px-3 py-1 bg-red-600 text-white rounded">Discard</button>
    </div>
  </div>
</div>

<!-- Success modal -->
<div id="successModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4 overflow-y-auto">
  <div class="rounded-lg shadow-lg p-6 max-w-md w-full my-auto" style="background-color: #f2eceb;">
    <div class="text-center">
      <div class="mb-4">
        <img id="successUserIcon" src="" alt="User status" class="w-32 h-32 mx-auto" />
      </div>
      <h3 class="text-xl font-bold mb-2" style="color: #422d1e;">Swoop Spot Created!</h3>
      <p id="successMessage" class="mb-4" style="color: #422d1e;">
        <!-- Message will be dynamically set -->
      </p>
      <p id="goodEggMessage" class="text-lg font-medium text-green-600 mb-4">You're a good egg!</p>
      <button id="closeSuccessModal" class="px-6 py-2 text-white rounded-lg" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
        Got it!
      </button>
    </div>
  </div>
</div>

<!-- Exit Prompt Modal -->
<div id="exitPromptModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4 overflow-y-auto">
  <div class="rounded-lg shadow-lg p-6 max-w-lg w-full my-auto max-h-[90vh] flex flex-col" style="background-color: #f2eceb;">
    <div class="mb-4">
      <h3 class="text-xl font-bold mb-2" style="color: #422d1e;">Did you spot any birds?</h3>
      <p class="text-sm" style="color: #422d1e; opacity: 0.7;">You passed through the following swoop zones. Please update each one:</p>
    </div>
    
    <div id="exitPromptList" class="flex-1 overflow-y-auto space-y-3 mb-4">
      <!-- Spots will be dynamically added here -->
    </div>
    
    <div class="flex justify-end gap-2 pt-3" style="border-top: 1px solid #d4cac7;">
      <button id="closeExitPrompt" class="px-4 py-2 rounded" style="border: 1px solid #d4cac7; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='transparent'">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Test Date Modal -->
<div id="testDateModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4">
  <div class="rounded-lg shadow-lg w-full max-w-md mx-auto" style="background-color: #f2eceb;">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold" style="color: #422d1e;">Test Date Simulation</h3>
        <button id="closeTestDate" class="text-2xl" style="color: #422d1e; opacity: 0.7;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
      </div>
      
      <div class="mb-4">
        <p class="text-sm mb-4" style="color: #422d1e; opacity: 0.8;">
          Set a test date to see how the app behaves at different times of year. This is useful for testing pre-season warnings and seasonal features.
        </p>
        
        <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Select Test Date:</label>
        <input type="date" id="testDateInput" class="w-full rounded-lg p-2 mb-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #fff; color: #422d1e;">
        
        <div class="text-xs mb-4" style="color: #422d1e; opacity: 0.6;">
          <strong>Tips:</strong>
          <ul class="list-disc pl-5 mt-1">
            <li>Set to July to see pre-season warnings (30 days before August nesting season)</li>
            <li>Set to December to see spots marked as "Calm" (after nesting season)</li>
            <li>Set to September to see active swooping season alerts</li>
          </ul>
        </div>
      </div>
      
      <div class="flex gap-2">
        <button id="applyTestDate" class="flex-1 px-4 py-2 text-white rounded font-medium" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
          Apply Test Date
        </button>
        <button id="resetTestDate" class="flex-1 px-4 py-2 rounded font-medium" style="background-color: #d4cac7; color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
          Reset to Today
        </button>
      </div>
      
      <div id="currentTestDate" class="mt-4 text-sm text-center" style="color: #422d1e;">
        <!-- Will show current test date or "Using real date" -->
      </div>
    </div>
  </div>
</div>
<!-- Auth Modal -->
<div id="authModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="z-index: 9999;">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" style="background-color: #f2eceb; border: 2px solid #d4cac7;">
    <div class="flex items-center justify-between p-6 border-b" style="border-color: #d4cac7;">
      <h2 class="text-2xl font-bold" style="color: #422d1e;">Welcome to Swoop Spotter</h2>
      <button id="closeAuthModal" class="text-gray-500 hover:text-gray-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <!-- Tabs -->
    <div class="flex border-b" style="border-color: #d4cac7;">
      <button id="signInTab" class="flex-1 py-3 px-4 text-center font-medium active" style="border-bottom: 2px solid #422d1e; color: #422d1e;">
        Sign In
      </button>
      <button id="signUpTab" class="flex-1 py-3 px-4 text-center font-medium" style="color: #422d1e; opacity: 0.6;">
        Sign Up
      </button>
    </div>
    
    <!-- Sign In Form -->
    <form id="signInForm" class="p-6">
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Email</label>
        <input type="email" id="signInEmail" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color: #d4cac7; background-color: white;">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Password</label>
        <input type="password" id="signInPassword" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color: #d4cac7; background-color: white;">
      </div>
      <div id="signInError" class="hidden mb-4 p-3 rounded" style="background-color: #FEE2E2; color: #991B1B;"></div>
      <button type="submit" class="w-full text-white py-2 px-4 rounded-lg font-medium" style="background-color: #422d1e;">
        Sign In
      </button>
    </form>
    
    <!-- Sign Up Form -->
    <form id="signUpForm" class="hidden p-6">
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Display Name</label>
        <input type="text" id="signUpName" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color: #d4cac7; background-color: white;">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Email</label>
        <input type="email" id="signUpEmail" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color: #d4cac7; background-color: white;">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Password</label>
        <input type="password" id="signUpPassword" required minlength="6" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color: #d4cac7; background-color: white;">
      </div>
      <div id="signUpError" class="hidden mb-4 p-3 rounded" style="background-color: #FEE2E2; color: #991B1B;"></div>
      <button type="submit" class="w-full text-white py-2 px-4 rounded-lg font-medium" style="background-color: #422d1e;">
        Sign Up
      </button>
    </form>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto" style="z-index: 9999;">
  <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full my-auto" style="background-color: #f2eceb; border: 2px solid #d4cac7;">
    <div class="flex items-center justify-between p-6 border-b" style="border-color: #d4cac7; background-color: #f2eceb;">
      <h2 class="text-2xl font-bold" style="color: #422d1e;">My Profile</h2>
      <button id="closeProfileModal" class="text-gray-500 hover:text-gray-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <!-- Profile Header -->
    <div class="p-6 border-b" style="border-color: #d4cac7;">
      <div class="flex items-center gap-4">
        <img id="profileAvatar" src="Assets/Users Icons/user_1.svg" alt="Avatar" class="w-20 h-20 rounded-full">
        <div>
          <h3 id="profileDisplayName" class="text-xl font-bold" style="color: #422d1e;"></h3>
          <p id="profileEmail" class="text-sm" style="color: #422d1e; opacity: 0.7;"></p>
          <p id="profileJoined" class="text-xs mt-1" style="color: #422d1e; opacity: 0.6;"></p>
        </div>
      </div>
    </div>
    
    <!-- New User Welcome Message -->
    <div id="newUserWelcome" class="hidden p-4 mx-6 mt-6 rounded" style="background-color: #DCFCE7; border-left: 3px solid #059669;">
      <p class="text-sm font-medium" style="color: #14532D;">
        ðŸŽ‰ Welcome to SwoopSpotter! Complete your profile below to personalize your experience.
      </p>
    </div>
    
    <!-- Tabs -->
    <div class="flex border-b" style="border-color: #d4cac7;">
      <button id="profileStatsTab" class="flex-1 py-3 px-4 text-center font-medium active" style="border-bottom: 2px solid #422d1e; color: #422d1e; opacity: 1;">
        Contributions
      </button>
      <button id="profileEditTab" class="flex-1 py-3 px-4 text-center font-medium" style="color: #422d1e; opacity: 0.6; border-color: transparent;">
        Edit Profile
      </button>
    </div>
    
    <!-- Stats Content -->
    <div id="profileStatsContent" class="p-6">
      <h3 class="text-lg font-bold mb-4" style="color: #422d1e;">Your Contributions</h3>
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="text-center p-4 rounded" style="background-color: white; border: 2px solid #d4cac7;">
          <div class="text-3xl font-bold" style="color: #422d1e;" id="profileStatSpotsCreated">0</div>
          <div class="text-sm" style="color: #422d1e; opacity: 0.7;">Spots Created</div>
        </div>
        <div class="text-center p-4 rounded" style="background-color: white; border: 2px solid #d4cac7;">
          <div class="text-3xl font-bold" style="color: #422d1e;" id="profileStatReportsCreated">0</div>
          <div class="text-sm" style="color: #422d1e; opacity: 0.7;">Reports Added</div>
        </div>
        <div class="text-center p-4 rounded" style="background-color: white; border: 2px solid #d4cac7;">
          <div class="text-3xl font-bold" style="color: #422d1e;" id="profileStatSafePassages">0</div>
          <div class="text-sm" style="color: #422d1e; opacity: 0.7;">Safe Passages</div>
        </div>
      </div>
      
      <h3 class="text-lg font-bold mb-4" style="color: #422d1e;">Recent Activity</h3>
      <div id="profileRecentActivity" class="space-y-2">
        <span style="color: #422d1e; opacity: 0.6;" class="text-sm">Loading...</span>
      </div>
    </div>
    
    <!-- Edit Profile Content -->
    <div id="profileEditContent" class="hidden p-6">
      <form id="profileEditForm">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Display Name</label>
          <input type="text" id="editDisplayName" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color: #d4cac7; background-color: white;">
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Avatar</label>
          <input type="hidden" id="selectedAvatar" value="user_1.svg">
          <!-- Horizontal scrollable avatar picker -->
          <div class="flex gap-2 overflow-x-auto pb-2" style="-webkit-overflow-scrolling: touch;">
            <button type="button" class="avatar-btn flex-shrink-0 p-2 rounded-lg border-2 hover:bg-gray-100 transition-all" data-avatar="user_1.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_1.svg" alt="Avatar 1" class="w-12 h-12">
            </button>
            <button type="button" class="avatar-btn flex-shrink-0 p-2 rounded-lg border-2 hover:bg-gray-100 transition-all" data-avatar="user_2.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_2.svg" alt="Avatar 2" class="w-12 h-12">
            </button>
            <button type="button" class="avatar-btn flex-shrink-0 p-2 rounded-lg border-2 hover:bg-gray-100 transition-all" data-avatar="user_3.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_3.svg" alt="Avatar 3" class="w-12 h-12">
            </button>
            <button type="button" class="avatar-btn flex-shrink-0 p-2 rounded-lg border-2 hover:bg-gray-100 transition-all" data-avatar="user_4.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_4.svg" alt="Avatar 4" class="w-12 h-12">
            </button>
            <button type="button" class="avatar-btn flex-shrink-0 p-2 rounded-lg border-2 hover:bg-gray-100 transition-all" data-avatar="user_5.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_5.svg" alt="Avatar 5" class="w-12 h-12">
            </button>
            <button type="button" class="avatar-btn flex-shrink-0 p-2 rounded-lg border-2 hover:bg-gray-100 transition-all" data-avatar="user_6.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_6.svg" alt="Avatar 6" class="w-12 h-12">
            </button>
            <button type="button" class="avatar-btn flex-shrink-0 p-2 rounded-lg border-2 hover:bg-gray-100 transition-all" data-avatar="user_7.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_7.svg" alt="Avatar 7" class="w-12 h-12">
            </button>
            <button type="button" class="avatar-btn flex-shrink-0 p-2 rounded-lg border-2 hover:bg-gray-100 transition-all" data-avatar="user_8.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_8.svg" alt="Avatar 8" class="w-12 h-12">
            </button>
            <button type="button" class="avatar-btn flex-shrink-0 p-2 rounded-lg border-2 hover:bg-gray-100 transition-all" data-avatar="user_9.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_9.svg" alt="Avatar 9" class="w-12 h-12">
            </button>
            <button type="button" class="avatar-btn flex-shrink-0 p-2 rounded-lg border-2 hover:bg-gray-100 transition-all" data-avatar="user_10.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_10.svg" alt="Avatar 10" class="w-12 h-12">
            </button>
          </div>
        </div>
        
        <div id="profileEditError" class="hidden mb-4 p-3 rounded" style="background-color: #FEE2E2; color: #991B1B;"></div>
        <div id="profileEditSuccess" class="hidden mb-4 p-3 rounded" style="background-color: #DCFCE7; color: #14532D;"></div>
        
        <div class="flex gap-3">
          <button type="submit" class="flex-1 text-white py-2 px-4 rounded-lg font-medium" style="background-color: #422d1e;">
            Save Changes
          </button>
          <button type="button" id="cancelEditProfile" class="flex-1 py-2 px-4 rounded-lg font-medium" style="background-color: white; border: 2px solid #d4cac7; color: #422d1e;">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Safety Tips Modal -->
<div id="safetyTipsModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4">
  <div class="rounded-lg shadow-lg w-full max-w-2xl mx-auto my-auto flex flex-col" style="background-color: #f2eceb; max-height: 90vh;">
    <!-- Fixed Header -->
    <div class="p-6 pb-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold" style="color: #422d1e;">Bird Safety & Prevention</h3>
        <button id="closeSafetyTips" class="text-2xl" style="color: #422d1e; opacity: 0.7;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
      </div>
      
      <!-- Tabs -->
      <div style="border-bottom: 1px solid #d4cac7;" class="mb-4">
        <nav class="flex -mb-px" role="tablist">
          <button data-tab="safety" role="tab" class="safety-tips-tab-btn active mr-4 py-2 px-1 border-b-2 font-medium" style="border-color: #422d1e; color: #422d1e;">
            Safety Tips
          </button>
          <button data-tab="preventative" role="tab" class="safety-tips-tab-btn mr-4 py-2 px-1 border-b-2 border-transparent" style="color: #422d1e; opacity: 0.6;" onmouseover="this.style.opacity='0.8'" onmouseout="this.classList.contains('active') || (this.style.opacity='0.6')">
            Preventative Tips
          </button>
          <button data-tab="sources" role="tab" class="safety-tips-tab-btn py-2 px-1 border-b-2 border-transparent" style="color: #422d1e; opacity: 0.6;" onmouseover="this.style.opacity='0.8'" onmouseout="this.classList.contains('active') || (this.style.opacity='0.6')">
            Sources
          </button>
        </nav>
      </div>
      
      <!-- Species selector -->
      <div id="speciesSelectorContainer">
        <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Select bird species for specific tips:</label>
        <select id="tipsSpeciesSelect" class="w-full rounded-lg p-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #fff; color: #422d1e;">
          <option value="general">General Tips (All Birds)</option>
          <option value="Magpie">Magpie</option>
          <option value="Magpie-Lark (Peewee)">Magpie-Lark (Peewee)</option>
          <option value="Masked Lapwing">Masked Lapwing (Plover)</option>
          <option value="Butcherbird">Butcherbird</option>
          <option value="Crow">Crow</option>
          <option value="Noisy Miner">Noisy Miner</option>
          <option value="Noisy Friarbird">Noisy Friarbird</option>
        </select>
      </div>
    </div>
    
    <!-- Scrollable Content Area -->
    <div class="flex-1 overflow-y-auto px-6" style="min-height: 0;">
      <!-- Tab Content -->
      <div class="pb-4">
        <!-- Safety Tips Tab -->
        <div id="safetyTab" class="safety-tips-tab-content active" role="tabpanel">
          <div id="tipsContent" class="space-y-4" style="color: #422d1e;">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
        
        <!-- Preventative Tips Tab -->
        <div id="preventativeTab" class="safety-tips-tab-content hidden" role="tabpanel">
          <div id="preventativeTipsContent" class="space-y-4" style="color: #422d1e;">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
        
        <!-- Sources Tab -->
        <div id="sourcesTab" class="safety-tips-tab-content hidden" role="tabpanel">
          <div id="sourcesContent" class="space-y-4" style="color: #422d1e;">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
    
    <!-- Fixed Footer -->
    <div class="p-6 pt-4 text-center" style="border-top: 1px solid #d4cac7;">
      <button id="closeSafetyTipsBottom" class="px-6 py-2 text-white rounded font-medium" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Testing Modal -->
<div id="testingModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4 overflow-y-auto">
  <div class="rounded-lg shadow-lg w-full max-w-2xl mx-auto my-auto" style="background-color: #f2eceb;">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold" style="color: #422d1e;">Testing & Debug Tools</h3>
        <button id="closeTestingModal" class="text-2xl" style="color: #422d1e; opacity: 0.7;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
      </div>
      
      <!-- Find Me / GPS -->
      <div class="mb-6 p-4 rounded" style="background-color: white; border: 2px solid #d4cac7;">
        <h4 class="font-semibold mb-3" style="color: #422d1e;">GPS Location</h4>
        <button id="useGPSBtnModal" class="w-full px-4 py-2 rounded text-white font-medium" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
          Find Me (GPS)
        </button>
      </div>
      
      <!-- Test Vibration -->
      <div class="mb-6 p-4 rounded" style="background-color: white; border: 2px solid #d4cac7;">
        <h4 class="font-semibold mb-3" style="color: #422d1e;">Vibration Test</h4>
        <p class="text-sm mb-3" style="color: #422d1e; opacity: 0.7;">Test device vibration (mobile only)</p>
        <button id="testVibrateBtnModal" class="w-full px-4 py-2 rounded text-white font-medium" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
          Test Vibration
        </button>
      </div>
      
      <!-- Test Date -->
      <div class="mb-6 p-4 rounded" style="background-color: white; border: 2px solid #d4cac7;">
        <h4 class="font-semibold mb-3" style="color: #422d1e;">Date Testing</h4>
        <p class="text-sm mb-3" style="color: #422d1e; opacity: 0.7;">Test with a specific date to check seasonal behaviors</p>
        <div id="currentTestDateModal" class="mb-3 text-sm" style="color: #422d1e;">Using real date (today)</div>
        <div class="grid gap-2">
          <input type="date" id="testDateInputModal" class="w-full px-3 py-2 border rounded" style="border-color: #d4cac7; background-color: #f2eceb;">
          <div class="flex gap-2">
            <button id="applyTestDateModal" class="flex-1 px-4 py-2 rounded text-white font-medium" style="background-color: #10B981;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
              Apply Test Date
            </button>
            <button id="resetTestDateModal" class="flex-1 px-4 py-2 rounded border font-medium" style="border-color: #d4cac7; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='transparent'">
              Reset to Today
            </button>
          </div>
        </div>
      </div>
      
      <!-- Walk Simulator -->
      <div class="mb-6 p-4 rounded" style="background-color: white; border: 2px solid #d4cac7;">
        <h4 class="font-semibold mb-3" style="color: #422d1e;">Walk Simulator</h4>
        <p class="text-sm mb-3" style="color: #422d1e; opacity: 0.7;">Simulate a straight-line walk between two addresses</p>
        <div class="grid gap-2">
          <input id="simStartModal" placeholder="Start walk: Address" class="p-2 rounded w-full" style="border: 1px solid #d4cac7; background-color: #f2eceb;"/>
          <input id="simEndModal" placeholder="End walk: Address" class="p-2 rounded w-full" style="border: 1px solid #d4cac7; background-color: #f2eceb;"/>
          <div class="flex gap-2">
            <button id="playSimModal" class="flex-1 px-4 py-2 rounded text-white font-medium" style="background-color: #10B981;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
              Play
            </button>
            <button id="stopSimModal" class="flex-1 px-4 py-2 rounded text-white font-medium" style="background-color: #DC2626;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
              Stop
            </button>
          </div>
        </div>
      </div>
      
      <!-- Close button -->
      <div class="text-center">
        <button id="closeTestingModalBottom" class="px-6 py-2 text-white rounded font-medium" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ----------------------------
// Global Test Date Manager (MUST be before any code that uses getCurrentDate)
// ----------------------------
window.testDateManager = {
  _testDate: null,
  setTestDate(date) {
    this._testDate = date;
  },
  getTestDate() {
    return this._testDate;
  },
  getCurrentDate() {
    return this._testDate ? new Date(this._testDate) : new Date();
  }
};

// Global getCurrentDate function for convenience
window.getCurrentDate = function() {
  return window.testDateManager.getCurrentDate();
};

// Main app IIFE
(() => {
  // ----------------------------
  // Supabase Configuration
  // ----------------------------
  const SUPABASE_URL = 'https://ghoipwkezxiyjkgikfyw.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdob2lwd2tlenhpeWprZ2lrZnl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDcyNzQsImV4cCI6MjA3NjEyMzI3NH0.T-Sxyq4hv1U1DI5NHD6k30bHWjO0i5BTMeaUAuFRifg';
  
  // Initialize Supabase client
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  // ----------------------------
  // Authentication State
  // ----------------------------
  let currentUser = null;
  let userProfile = null;
  
  // Sync state
  let isSyncing = false;
  let syncEnabled = true; // Can be toggled for offline mode
  
  // ----------------------------
  // Local convenience wrapper for test date
  // ----------------------------
  // Use the global testDateManager (initialized before IIFE)
  function getCurrentDate() {
    return window.getCurrentDate();
  }
  
  // ----------------------------
  // Setup map + icons + DOM refs
  // ----------------------------
  // Initialize map with a slight delay to ensure DOM is ready
  // Start with a default view (will be updated once we get user location)
  const map = L.map('map', {
    minZoom: 3,
    maxZoom: 18,
    zoomControl: true,
    trackResize: true // Ensure map handles resize events properly
  }).setView([-27.4698, 153.0251], 18);
  
  console.log('ðŸ—ºï¸ Map initialized:', !!map);
  
  // Define light and dark tile layers
  const lightTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 20
  });
  
  const darkTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 20
  });
  
  // Add the appropriate tile layer based on current theme
  const savedTheme = localStorage.getItem('theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const isDarkMode = savedTheme === 'dark' || (!savedTheme && prefersDark);
  
  console.log('ðŸŽ¨ Initial theme:', isDarkMode ? 'dark' : 'light');
  
  if (isDarkMode) {
    darkTileLayer.addTo(map);
  } else {
    lightTileLayer.addTo(map);
  }
  
  // Function to switch map tiles (will be called by dark mode toggle)
  window.switchMapTiles = function(isDark) {
    console.log('ðŸ—ºï¸ Switching map tiles to:', isDark ? 'dark' : 'light');
    
    try {
      if (isDark) {
        // Check if light layer exists before removing
        if (map.hasLayer(lightTileLayer)) {
          map.removeLayer(lightTileLayer);
        }
        // Only add dark layer if not already added
        if (!map.hasLayer(darkTileLayer)) {
          darkTileLayer.addTo(map);
        }
      } else {
        // Check if dark layer exists before removing
        if (map.hasLayer(darkTileLayer)) {
          map.removeLayer(darkTileLayer);
        }
        // Only add light layer if not already added
        if (!map.hasLayer(lightTileLayer)) {
          lightTileLayer.addTo(map);
        }
      }
      
      console.log('âœ… Map tiles switched successfully');
      
      // Force map to refresh/redraw (helps prevent rendering issues)
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
      
    } catch (error) {
      console.error('âŒ Error switching map tiles:', error);
      // Fallback: ensure at least one tile layer is active
      if (!map.hasLayer(lightTileLayer) && !map.hasLayer(darkTileLayer)) {
        console.log('âš ï¸ No tile layer active, adding default light layer');
        lightTileLayer.addTo(map);
      }
    }
  };
  
  // ----------------------------
  // Location Tracking (Continuous)
  // ----------------------------
  function startLocationTracking() {
    if (!navigator.geolocation) {
      toast('Geolocation is not supported by your browser');
      return;
    }

    if (isTracking) {
      // Already tracking, stop it
      stopLocationTracking();
      return;
    }

    console.log('ðŸŽ¯ Starting continuous location tracking...');
    console.log(`ðŸ“¡ Location mode: ${useHighAccuracy ? 'GPS (high accuracy)' : 'Network (Wi-Fi/cell towers)'}`);

    // Use watchPosition for continuous tracking
    locationWatchId = navigator.geolocation.watchPosition(
      // Success callback
      (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const accuracy = position.coords.accuracy; // Accuracy in meters
        
        console.log(`ðŸ“ Location update: ${lat}, ${lng} (accuracy: ${Math.round(accuracy)}m)`);
        console.log(`ðŸ“¡ Source: ${useHighAccuracy ? 'GPS' : 'Network (Wi-Fi/cell)'}`);
        
        // Reset error counter on success
        consecutiveErrors = 0;
        
        // Update user location on map and check for alerts
        checkLocation(lat, lng);
        
        // Center map on user only on first successful track
        if (!isTracking) {
          map.setView([lat, lng], Math.max(map.getZoom(), 18));
          isTracking = true;
          
          // Hide the enable location button since tracking is active
          const enableLocationBtn = document.getElementById('enableLocationBtn');
          if (enableLocationBtn) {
            console.log('ðŸ”˜ Hiding Enable Location button - tracking is active');
            enableLocationBtn.classList.add('hidden');
          }
          
          // Show success message with location method
          const method = useHighAccuracy ? 'GPS' : 'network location';
          const accuracyQuality = accuracy < 50 ? 'excellent' : accuracy < 100 ? 'good' : 'approximate';
          toast(`Location tracking active (${method} - ${accuracyQuality} accuracy)`, 2000);
          console.log(`âœ… Location tracking active via ${method}`);
        }
      },
      // Error callback
      (err) => {
        console.error('âŒ Location tracking error:', err);
        console.log('ðŸ“Š Error details:', {
          code: err.code,
          message: err.message,
          consecutiveErrors: consecutiveErrors + 1,
          currentMode: useHighAccuracy ? 'GPS' : 'Network'
        });
        
        consecutiveErrors++;
        
        let errorMsg = '';
        let shouldFallback = false;
        
        switch(err.code) {
          case err.PERMISSION_DENIED:
            errorMsg = 'Location permission denied. Please enable location access in your device settings.';
            // Stop tracking and show enable button
            stopLocationTracking();
            const enableLocationBtn = document.getElementById('enableLocationBtn');
            if (enableLocationBtn) {
              console.log('ðŸ”˜ Showing Enable Location button - permission denied');
              enableLocationBtn.classList.remove('hidden');
            }
            break;
            
          case err.POSITION_UNAVAILABLE:
            errorMsg = 'Location unavailable.';
            // Try fallback to network-based location after 2 consecutive errors
            shouldFallback = useHighAccuracy && consecutiveErrors >= 2;
            if (shouldFallback) {
              console.log('âš ï¸ GPS unavailable, switching to network-based location...');
              errorMsg = 'GPS signal weak - switching to network location...';
            } else if (!useHighAccuracy) {
              errorMsg = 'Location services unavailable. Check device settings.';
            } else {
              console.log('âš ï¸ GPS unavailable, will keep trying... (attempt ' + consecutiveErrors + ')');
              errorMsg = 'Searching for GPS signal...';
            }
            break;
            
          case err.TIMEOUT:
            errorMsg = 'Location request timed out.';
            // Try fallback to network-based location after 3 consecutive timeouts
            shouldFallback = useHighAccuracy && consecutiveErrors >= 3;
            if (shouldFallback) {
              console.log('â±ï¸ GPS timeout repeatedly - switching to network-based location...');
              errorMsg = 'GPS taking too long - switching to network location...';
            } else {
              console.log('â±ï¸ Location timeout, will keep trying... (attempt ' + consecutiveErrors + ')');
              errorMsg = 'Still searching for location...';
            }
            break;
            
          default:
            errorMsg = err.message || 'Unknown location error';
        }
        
        // Show error message (don't spam if already tracking)
        if (!isTracking || consecutiveErrors === 1) {
          toast(errorMsg, 3000);
        }
        
        // Implement fallback: restart tracking with network-based location
        if (shouldFallback) {
          console.log('ðŸ”„ Restarting tracking with network-based location...');
          stopLocationTracking();
          useHighAccuracy = false; // Switch to network mode
          consecutiveErrors = 0; // Reset counter
          setTimeout(() => {
            startLocationTracking(); // Restart with network mode
          }, 1000);
        }
      },
      // Options - GPS or Network based on useHighAccuracy flag
      {
        enableHighAccuracy: useHighAccuracy,  // true = GPS, false = Network (Wi-Fi/cell)
        timeout: useHighAccuracy ? 20000 : 10000,  // GPS gets more time (20s), network is faster (10s)
        maximumAge: useHighAccuracy ? 5000 : 30000  // GPS needs fresh data (5s), network can be older (30s)
      }
    );
  }

  function stopLocationTracking() {
    if (locationWatchId !== null) {
      navigator.geolocation.clearWatch(locationWatchId);
      locationWatchId = null;
    }
    
    isTracking = false;
    consecutiveErrors = 0; // Reset error counter
    useHighAccuracy = true; // Reset to GPS for next time
    console.log('ðŸ›‘ Location tracking stopped');
  }
  
  // Enable Location Button functionality
  const enableLocationBtn = document.getElementById('enableLocationBtn');
  
  function requestUserLocation() {
    if (!navigator.geolocation) {
      toast('Geolocation is not supported by your browser');
      return;
    }
    
    console.log('ðŸŒ Requesting user location...');
    
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        console.log(`âœ… User location found: ${lat}, ${lng}`);
        
        // Center map on user's location
        map.setView([lat, lng], 18);
        
        // Add user marker
        checkLocation(lat, lng);
        
        // Hide the enable location button
        if (enableLocationBtn) {
          console.log('ðŸ”˜ Hiding Enable Location button - location found');
          enableLocationBtn.classList.add('hidden');
        }
        
        toast('Location found! Tracking your position...', 2000);
        
        // Start continuous location tracking
        console.log('ðŸŽ¯ Starting continuous location tracking...');
        startLocationTracking();
      },
      (error) => {
        console.warn('âš ï¸ Location access denied or unavailable:', error);
        console.log('Error details:', {
          code: error.code,
          message: error.message,
          PERMISSION_DENIED: error.PERMISSION_DENIED,
          POSITION_UNAVAILABLE: error.POSITION_UNAVAILABLE,
          TIMEOUT: error.TIMEOUT
        });
        
        // Show friendly message based on error
        let message = '';
        switch(error.code) {
          case error.PERMISSION_DENIED:
            message = 'Location access denied. Click "Enable Location" button on the map to try again.';
            // Show the enable location button
            if (enableLocationBtn) {
              console.log('ðŸ”˜ Showing Enable Location button - permission denied');
              enableLocationBtn.classList.remove('hidden');
            }
            break;
          case error.POSITION_UNAVAILABLE:
            // Position unavailable means GPS/network can't determine location
            // This is NOT a permission issue - device just can't get a fix
            console.log('âš ï¸ POSITION_UNAVAILABLE - GPS/network signal unavailable');
            
            message = 'Location signal unavailable. Trying network positioning...';
            // Try again with lower accuracy as fallback
            console.log('ðŸ”„ Retrying with enableHighAccuracy: false (network-based)...');
            setTimeout(() => {
              navigator.geolocation.getCurrentPosition(
                (position) => {
                  const lat = position.coords.latitude;
                  const lng = position.coords.longitude;
                  console.log(`âœ… Location found (low accuracy): ${lat}, ${lng}`);
                  map.setView([lat, lng], 18);
                  checkLocation(lat, lng);
                  if (enableLocationBtn) {
                    enableLocationBtn.classList.add('hidden');
                  }
                  toast('Location found! Tracking your position...', 2000);
                  startLocationTracking();
                },
                (retryError) => {
                  console.error('âŒ Network positioning also failed:', retryError);
                  
                  // Detect device type for helpful message
                  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                  const isAndroid = /Android/.test(navigator.userAgent);
                  const isMobile = isIOS || isAndroid;
                  
                  let helpMessage = 'Cannot determine location. ';
                  if (isIOS) {
                    helpMessage += 'Check: Settings â†’ Privacy & Security â†’ Location Services â†’ Safari â†’ While Using';
                  } else if (isAndroid) {
                    helpMessage += 'Check: Settings â†’ Location â†’ turn on location';
                  } else {
                    helpMessage += 'Try: 1) Move near a window, 2) Enable Wi-Fi, 3) Reload page';
                  }
                  helpMessage += '. You can still browse the map manually.';
                  
                  toast(helpMessage, 8000);
                  
                  // Show enable button for retry
                  if (enableLocationBtn) {
                    enableLocationBtn.classList.remove('hidden');
                  }
                },
                { enableHighAccuracy: false, timeout: 15000, maximumAge: 300000 }
              );
            }, 1000);
            break;
          case error.TIMEOUT:
            message = 'Location request timed out. Retrying...';
            // Auto-retry on timeout
            setTimeout(() => {
              console.log('ðŸ”„ Retrying location request after timeout...');
              requestUserLocation();
            }, 2000);
            break;
          default:
            message = 'Could not get your location. Showing default area.';
        }
        
        toast(message, 4000);
        // Map will stay at default Brisbane location set above
      },
      {
        enableHighAccuracy: true,
        timeout: 15000, // Increased from 10s to 15s
        maximumAge: 60000 // Accept cached location up to 1 minute old
      }
    );
  }
  
  // Attach click handler to enable location button
  if (enableLocationBtn) {
    enableLocationBtn.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent map click event from firing
      console.log('ðŸ”˜ Enable Location button clicked');
      requestUserLocation();
    });
  }
  
  // Automatically try to get user's location on page load
  if (navigator.geolocation) {
    // Wait for map to be fully initialized before requesting location
    setTimeout(() => {
      console.log('ðŸ—ºï¸ Map ready, requesting location...');
      requestUserLocation();
    }, 500);
  } else {
    console.warn('âš ï¸ Geolocation not supported by browser');
    toast('Location services not available. Showing default area.', 3000);
  }

  function birdSVG(col){
    let iconName;
    switch(col) {
      case '#10B981': iconName = 'swoop_low.svg'; break;
      case '#F59E0B': iconName = 'swoop_caution.svg'; break;
      case '#EF4444': iconName = 'swoop_danger.svg'; break;
      case '#3b82f6': iconName = 'calm.svg'; break; // Blue for calm
      default: iconName = 'swoop_calm.svg';
    }
    return `<img src="Assets/Icons/${iconName}" width="36" height="36" alt="Bird icon">`;
  }
  function getBirdIcon(level, isPreseason = false){
    console.log(`ðŸŽ¨ getBirdIcon called: level=${level}, isPreseason=${isPreseason}`);
    
    // If isPreseason flag is set, always use blue (calm) color for preventative messaging
    if (isPreseason) {
      console.log('  â†’ Returning blue (calm) icon due to isPreseason flag');
      return L.divIcon({ className:'bird-marker', html: birdSVG('#3b82f6'), iconSize:[36,36], iconAnchor:[18,18] });
    }
    
    let col = '#10B981'; // low risk (green)
    if(level === 'Take caution') col = '#F59E0B'; // caution (amber)
    if(level === 'Danger - Avoid') col = '#EF4444'; // danger (red)
    if(level === 'Calm - All clear') col = '#3b82f6'; // calm (blue)
    
    console.log(`  â†’ Returning ${col} icon for risk level: ${level}`);
    return L.divIcon({ className:'bird-marker', html: birdSVG(col), iconSize:[36,36], iconAnchor:[18,18] });
  }
  function getBirdIconSVG(level){
    let iconName;
    if(level === 'Danger - Avoid') iconName = 'swoop_danger.svg';
    else if(level === 'Take caution') iconName = 'swoop_caution.svg';
    else if(level === 'Calm - All clear') iconName = 'calm.svg';
    else iconName = 'swoop_low.svg';
    return `<img src="Assets/Icons/${iconName}" width="48" height="48" alt="Bird icon" class="rounded-lg">`;
  }
  
  // Function to get user icon based on their profile avatar
  function getUserIcon() {
    // Get avatar filename from profile (e.g., "user_3.svg")
    const avatarFilename = userProfile?.avatar_url || 'user.svg';
    // Construct full path based on whether it's a user avatar or default icon
    const avatarPath = avatarFilename.startsWith('user_') 
      ? `Assets/Users Icons/${avatarFilename}` 
      : `Assets/Icons/${avatarFilename}`;
    
    console.log('ðŸŽ­ getUserIcon called:', { 
      hasUserProfile: !!userProfile, 
      avatarFilename, 
      avatarPath,
      currentUser: !!currentUser 
    });
    
    return L.divIcon({ 
      className:'', // Empty className to avoid default Leaflet divIcon styles
      html: `<img src="${avatarPath}" width="36" height="36" alt="User icon">`, 
      iconSize:[36,36], 
      iconAnchor:[18,18] 
    });
  }

  // DOM refs
  const openAddBtn = document.getElementById('openAddBtn');
  const spotModal = document.getElementById('spotModal');
  const closeSpotModal = document.getElementById('closeSpotModal');
  const spotForm = document.getElementById('spotForm');
  const birdSpecies = document.getElementById('birdSpecies');
  const addressField = document.getElementById('addressField');
  const addressInfo = document.getElementById('addressInfo');
  const coordsField = document.getElementById('coordsField');
  const rbirdBox = document.getElementById('rbirdBox');
  const rbirdList = document.getElementById('rbirdList');
  const rhumanBox = document.getElementById('rhumanBox');
  const rhumanList = document.getElementById('rhumanList');
  const rprecBox = document.getElementById('rprecBox');
  const rprecList = document.getElementById('rprecList');
  const ralertLevel = document.getElementById('ralertLevel');
  const reextra = document.getElementById('reextra');
  const spotCancel = document.getElementById('spotCancel');
  const geoBtn = document.getElementById('geoBtn');

  const detailsModal = document.getElementById('detailsModal');
  const closeDetails = document.getElementById('closeDetails');
  const detailsTitle = document.getElementById('detailsTitle');
  const reportsFeed = document.getElementById('reportsFeed');
  const spotHeader = document.getElementById('spotHeader');
  const reportForm = document.getElementById('reportForm');
  const rbirdBox2 = document.getElementById('rbirdBox2');
  const rbirdList2 = document.getElementById('rbirdList2');
  const rhumanBox2 = document.getElementById('rhumanBox2');
  const rhumanList2 = document.getElementById('rhumanList2');
  const rprecBox2 = document.getElementById('rprecBox2');
  const rprecList2 = document.getElementById('rprecList2');
  const repAlertLevel = document.getElementById('repAlertLevel');
  const repExtra = document.getElementById('repExtra');
  const reportCancel = document.getElementById('reportCancel');

  const alertsList = document.getElementById('alertsList');
  const alertBox = document.getElementById('alertBox');

  const confirmModal = document.getElementById('confirmModal');
  const keepEditing = document.getElementById('keepEditing');
  const discardChanges = document.getElementById('discardChanges');

  const successModal = document.getElementById('successModal');
  const closeSuccessModal = document.getElementById('closeSuccessModal');
  const successUserIcon = document.getElementById('successUserIcon');
  const successMessage = document.getElementById('successMessage');
  const goodEggMessage = document.getElementById('goodEggMessage');

  const exitPromptModal = document.getElementById('exitPromptModal');
  const exitPromptList = document.getElementById('exitPromptList');
  const closeExitPrompt = document.getElementById('closeExitPrompt');

  // Test Date refs
  const testDateBtn = document.getElementById('testDateBtn');
  const testDateModal = document.getElementById('testDateModal');
  const closeTestDate = document.getElementById('closeTestDate');
  const testDateInput = document.getElementById('testDateInput');
  const applyTestDate = document.getElementById('applyTestDate');
  const resetTestDate = document.getElementById('resetTestDate');
  const currentTestDate = document.getElementById('currentTestDate');

  // Safety Tips refs
  const safetyTipsModal = document.getElementById('safetyTipsModal');
  const closeSafetyTips = document.getElementById('closeSafetyTips');
  const safetyTipsBtn = document.getElementById('safetyTipsBtn');
  const tipsSpeciesSelect = document.getElementById('tipsSpeciesSelect');
  const tipsContent = document.getElementById('tipsContent');

  // Auth UI refs
  const authModal = document.getElementById('authModal');
  const closeAuthModal = document.getElementById('closeAuthModal');
  const signInTab = document.getElementById('signInTab');
  const signUpTab = document.getElementById('signUpTab');
  const signInForm = document.getElementById('signInForm');
  const signUpForm = document.getElementById('signUpForm');
  const signInEmail = document.getElementById('signInEmail');
  const signInPassword = document.getElementById('signInPassword');
  const signInError = document.getElementById('signInError');
  const signUpName = document.getElementById('signUpName');
  const signUpEmail = document.getElementById('signUpEmail');
  const signUpPassword = document.getElementById('signUpPassword');
  const signUpError = document.getElementById('signUpError');
  const signInButton = document.getElementById('signInButton');
  const userButton = document.getElementById('userButton');
  const userButtonName = document.getElementById('userButtonName');
  const userMenuDropdown = document.getElementById('userMenuDropdown');
  const userMenuName = document.getElementById('userMenuName');
  const userMenuEmail = document.getElementById('userMenuEmail');
  const userMenuStats = document.getElementById('userMenuStats');
  const userMenuProfile = document.getElementById('userMenuProfile');
  const userMenuSignOut = document.getElementById('userMenuSignOut');
  
  // Profile Modal Elements
  const profileModal = document.getElementById('profileModal');
  const closeProfileModal = document.getElementById('closeProfileModal');
  const profileStatsTab = document.getElementById('profileStatsTab');
  const profileEditTab = document.getElementById('profileEditTab');
  const profileStatsContent = document.getElementById('profileStatsContent');
  const profileEditContent = document.getElementById('profileEditContent');
  const profileEditForm = document.getElementById('profileEditForm');
  const editDisplayName = document.getElementById('editDisplayName');
  const selectedAvatar = document.getElementById('selectedAvatar');
  const profileEditError = document.getElementById('profileEditError');
  const profileEditSuccess = document.getElementById('profileEditSuccess');
  const cancelEditProfile = document.getElementById('cancelEditProfile');
  
  // Debug: Check if elements exist
  console.log('Profile modal elements:', {
    profileModal: !!profileModal,
    closeProfileModal: !!closeProfileModal,
    profileStatsTab: !!profileStatsTab,
    userMenuStats: !!userMenuStats,
    userMenuProfile: !!userMenuProfile
  });

  // NOTE: trackLocationBtn removed from UI - tracking functionality commented out
  // const trackLocationBtn = document.getElementById('trackLocationBtn');
  // const trackBtnText = document.getElementById('trackBtnText');
  const useGPSBtn = document.getElementById('useGPSBtn');

  // Walk simulator elements are now in Testing Modal - see lines ~5700+ for handlers

  // constants + data arrays
  const STORAGE_KEY = 'swoop_reports_v1';
  const SYNC_QUEUE_KEY = 'swoop_sync_queue_v1';
  const BIRD_BEHAVIOURS = ["noisy","swoop","close swoop","made contact + uninjured","made contact + injured"];
  const HUMAN_BEHAVIOURS = ["walking","running","cycling","riding e-scooter","alone","with others","with pram","with children","in group","other"];
  const PRECAUTIONS = ["Hat","Sunglasses","Umbrella","Helmet","Helmet with Cable Ties","Made Eye Contact","None"];

  // Swooping season data (month ranges: 1 = January, 12 = December)
  const SWOOPING_SEASONS = {
    "Magpie": { start: 8, end: 11 },  // August to November
    "Magpie-Lark (Peewee)": { start: 8, end: 11 },  // August to November
    "Masked Lapwing": { start: 6, end: 12 },  // June to December (longer season)
    "Butcherbird": { start: 8, end: 11 },  // August to November
    "Crow": { start: 8, end: 10 },  // August to October
    "Noisy Miner": { start: 7, end: 11 },  // July to November
    "Noisy Friarbird": { start: 9, end: 12 }  // September to December
  };

  // Days to wait after last report before auto-calming
  const AUTO_CALM_DAYS = 10;
  
  // Days before season start to show pre-season warning with preventative tips (30 days = 1 month)
  const PRESEASON_WARNING_DAYS = 30;
  
  // Preventative tips for building rapport with birds (shown for pre-season warnings)
  // All tips sourced from documented organizations - see SAFETY_TIPS_SOURCES.md
  const PREVENTATIVE_TIPS = {
    general: [
      "Walk the same routes regularly so birds become familiar with you",
      "Plant native trees and shrubs to provide nesting habitat",
      "Provide fresh water sources year-round",
      "Keep pets supervised or indoors during nesting seasons",
      "Avoid disturbing nests or approaching nesting birds",
      "Learn to recognize bird alarm calls and give space when heard"
    ],
    Magpie: [
      "Feed magpies outside nesting season to build positive associations",
      "Magpies remember individual human faces for years",
      "Walk past regularly before nesting season - familiarity reduces aggression",
      "Avoid feeding during breeding season (August-November)",
      "Only ~10% of male magpies swoop - consistent presence helps birds recognize you",
      "Give respectful distance to known nesting trees year-round"
    ],
    "Magpie-Lark (Peewee)": [
      "Provide water sources - magpie-larks love bathing",
      "Plant native shrubs that attract insects",
      "Avoid loud noises or sudden movements near their territory",
      "Become a familiar presence before breeding season begins"
    ],
    "Masked Lapwing": [
      "Keep lawns slightly longer to protect ground nests",
      "Mark known nesting areas to avoid accidental disturbance",
      "Keep dogs leashed in areas where plovers nest",
      "Learn their distinctive alarm calls and respect warning signals",
      "Plovers protect ground nests - wide berth year-round builds trust"
    ],
    Butcherbird: [
      "Respect their territory - butcherbirds are highly territorial",
      "Provide high perches and hunting opportunities",
      "Maintain respectful distance from known nesting areas",
      "Consistent non-threatening presence reduces defensive behavior"
    ],
    Crow: [
      "Crows have exceptional memory and recognize individual humans",
      "Never threaten or harm crows - they remember and communicate threats",
      "Consistent friendly behavior builds long-term recognition",
      "Crows teach offspring about threats - positive associations last generations"
    ],
    "Noisy Miner": [
      "Plant native flowering plants that attract insects and nectar",
      "Miners are highly communal - respect the entire colony's space",
      "Provide water sources year-round",
      "Consistent presence during non-breeding times reduces aggression"
    ],
    "Noisy Friarbird": [
      "Plant native flowering trees - friarbirds feed on nectar",
      "Provide water sources for drinking and bathing",
      "Maintain respectful distance from flowering trees during breeding",
      "Friarbirds are less aggressive than other species - calm presence helps"
    ]
  };

  // Safety tips data
  const SAFETY_TIPS = {
    general: {
      title: "General Bird Swooping Safety",
      description: "These tips apply to most swooping birds during nesting season (typically August to November in Australia).",
      tips: [
        "Avoid the area if possible during nesting season",
        "Travel in groups - birds usually target individuals",
        "Wear a broad-brimmed hat or helmet",
        "Carry an open umbrella above your head",
        "Wear sunglasses or safety glasses to protect your eyes",
        "Don't run - move calmly and quickly through the area",
        "Face the bird and maintain eye contact while moving away",
        "Dismount from bikes and scooters and walk through swooping zones",
        "Attach cable ties or pipe cleaners to your helmet to deter birds",
        "Take an alternate route if available",
        "Don't attempt to harm or provoke the bird - they're protecting their nest",
        "Report aggressive birds to local authorities"
      ]
    },
    Magpie: {
      title: "Australian Magpie Safety Tips",
      description: "Magpies are highly territorial during breeding season and account for most swooping incidents. They have excellent memory and may target specific individuals.",
      tips: [
        "Magpies remember faces - if swooped, avoid that area for several weeks",
        "Walk, don't run - running triggers their chase instinct",
        "Wear a broad-brimmed hat and sunglasses",
        "Attach cable ties or zip ties to your helmet (very effective for magpies)",
        "Draw eyes on the back of your hat or helmet",
        "Dismount your bike and walk it through the area",
        "Travel in groups - magpies rarely swoop groups",
        "Make eye contact and face the bird as you move away",
        "Don't wave your arms or swing objects - this may provoke more attacks",
        "Feed magpies in your yard outside nesting season to build positive associations",
        "Most magpies only swoop for 4-6 weeks during nesting",
        "Only 10% of male magpies actually swoop humans"
      ]
    },
    "Magpie-Lark (Peewee)": {
      title: "Magpie-Lark (Peewee) Safety Tips",
      description: "Magpie-larks are smaller but can be very aggressive defenders of their territory. Despite the name, they're not related to magpies.",
      tips: [
        "Wear a hat or helmet for head protection",
        "These birds are persistent but less dangerous than magpies",
        "Move quickly but calmly through the area",
        "Don't stop or linger near their nesting tree",
        "They typically swoop within 50 meters of their nest",
        "Face the bird and maintain eye contact",
        "Carry an umbrella or stick held above your head",
        "They're very protective but rarely make contact",
        "Nesting season is shorter than magpies (usually 3-4 weeks of swooping)"
      ]
    },
    "Masked Lapwing": {
      title: "Masked Lapwing (Plover) Safety Tips",
      description: "Plovers nest on the ground and are extremely protective of their eggs and chicks. They have distinctive yellow facial wattles and wing spurs.",
      tips: [
        "Watch for their distinctive alarm call - a loud, urgent cry",
        "Look for ground nests (small depressions) and give them wide berth",
        "Don't approach chicks - parents will attack",
        "Keep dogs on leash in areas where plovers nest",
        "They rarely make contact but will divebomb repeatedly",
        "Walk around known nesting areas - plovers defend a small territory",
        "The swooping usually lasts 4-6 weeks while chicks are vulnerable",
        "Once chicks can fly, parents become less aggressive",
        "Respect temporary fencing around plover nests in parks"
      ]
    },
    Butcherbird: {
      title: "Butcherbird Safety Tips",
      description: "Butcherbirds are highly territorial and can be aggressive defenders. They're less common swoopers but very persistent when protecting nests.",
      tips: [
        "Avoid the area if possible during nesting season",
        "Wear a broad-brimmed hat or helmet",
        "Travel in groups - butcherbirds usually target individuals",
        "Don't run - move calmly and quickly through the area",
        "Face the bird and maintain eye contact while moving away",
        "Carry an umbrella above your head",
        "Butcherbirds are powerful flyers - give wide berth to nesting trees",
        "They typically defend a larger territory than magpies",
        "Don't attempt to harm or provoke the bird"
      ]
    },
    Crow: {
      title: "Crow Safety Tips",
      description: "Crows have exceptional memory and can recognize individual humans. They're less likely to swoop than other species but can be very persistent.",
      tips: [
        "Crows remember faces for years - avoid provoking them",
        "Never harm or threaten crows - they communicate threats to other crows",
        "Wear a hat or helmet for head protection",
        "Move calmly through the area",
        "Face the bird and maintain eye contact",
        "Crows typically swoop from behind - stay alert",
        "Travel in groups when possible",
        "Take an alternate route during nesting season",
        "Respect their territory and they'll usually leave you alone"
      ]
    },
    "Noisy Miner": {
      title: "Noisy Miner Safety Tips",
      description: "Noisy miners are highly communal and aggressive defenders of their colony territory. Multiple birds may swoop together.",
      tips: [
        "Avoid the area if possible - entire colony may defend territory",
        "Wear a broad-brimmed hat or helmet",
        "Move quickly but calmly through the area",
        "Don't run - this may trigger multiple birds to chase",
        "Face the birds and maintain eye contact",
        "Travel in groups when possible",
        "Miners are less likely to make contact than magpies",
        "Take an alternate route during nesting season",
        "Don't attempt to harm or provoke the birds"
      ]
    },
    "Noisy Friarbird": {
      title: "Noisy Friarbird Safety Tips",
      description: "Friarbirds are less aggressive than other species but can be territorial around flowering trees during breeding season.",
      tips: [
        "Wear a hat or helmet for head protection",
        "Move calmly through the area",
        "Don't linger near flowering trees during nesting season",
        "Face the bird and maintain eye contact",
        "Friarbirds rarely make contact - they're mostly bluffing",
        "Travel in groups when possible",
        "Take an alternate route if available",
        "They're less persistent than magpies or plovers",
        "Respect their territory and move through quickly"
      ]
    }
  };

  // state
  let spots = []; // spot objects with reports array
  let tempMarker = null;
  let selectedLocation = null; // {lat,lng}
  let initialFormState = null; // for dirty checks
  let selectedRBird = [], selectedRHuman = [], selectedRPrec = [];
  let selectedReportBird = [], selectedReportHuman = [], selectedReportPrec = [];
  let activeDetailsSpotId = null;
  let userMarker = null;
  let simTimer = null, simPath = [], simIndex = 0;
  
  // Location tracking state
  let locationWatchId = null;
  let isTracking = false;
  let useHighAccuracy = true; // Start with GPS, fall back to network if needed
  let consecutiveErrors = 0; // Track consecutive errors to trigger fallback
  
  // Sync queue state
  let syncQueue = []; // Array of {spotId, action: 'create'|'update', timestamp, retryCount}
  let syncInProgress = false;
  let syncRetryTimer = null;

  // cute names - expanded dataset with 50+ creative generic bird names
  const cuteNames = [
    "Fluffy Breeze", "Peckle Pops", "Feather Fiasco", "Wingy Woo", "Sir Chirpsalot",
    "Cloud Nibbler", "Little Zoomer", "Chirpadoodle", "Pip Squeak", "Muffin Flap",
    "Captain Beaky", "Swoopy McSwoopface", "Tweety Tornado", "Baron Von Birb",
    "Princess Plume", "Sky Rascal", "Beaky Blinder", "Lord Featherbottom",
    "Waddle Wellington", "Squawk Box", "Professor Peck", "Ruffles McGee",
    "Wing Commander", "Count Flappula", "Duchess Downy", "Sir Flapsalot",
    "Mister Whistle", "Lady Wingnut", "Captain Caw", "Feathers O'Malley",
    "Birdy Sanders", "Nest Potato", "Flap Jackson", "Beaker Bonanza",
    "Sergeant Swoop", "Admiral Airborne", "Doctor Doodle", "Judge Jitters",
    "Mayor Feathers", "Sheriff Screech", "Detective Talon", "Colonel Crest",
    "General Wings", "Lieutenant Chirp", "Commander Cluck", "Private Peck",
    "Zippy Zephyr", "Gusty Gale", "Breezy Buddy", "Windy Wanderer",
    "Talon Trouble", "Skyward Sam", "Aerial Ace", "Hover Helper",
    "Perch Patrol", "Branch Boss", "Treetop Terror", "Canopy Captain",
    "Swoosh Sultan", "Draft Dodger", "Glide Guide", "Soar Supreme"
  ];
  function randName(){ return cuteNames[Math.floor(Math.random()*cuteNames.length)]; }
  
  // Get a unique name within 5km radius
  function getUniqueName(lat, lng) {
    // Get all spot names within 5km
    const usedNames = spots
      .filter(s => metersBetween(lat, lng, s.lat, s.lng) <= 5000)
      .map(s => s.name);
    
    // Get available names (not used within 5km)
    const availableNames = cuteNames.filter(name => !usedNames.includes(name));
    
    // If all names are used within 5km, just use any random name
    if (availableNames.length === 0) {
      return randName();
    }
    
    // Return a random name from available names
    return availableNames[Math.floor(Math.random() * availableNames.length)];
  }
  
  function uid(){ return 's_' + Math.random().toString(36).slice(2,9); }

  // Format timestamp to show relative time
  function formatTimeAgo(timestamp) {
    const now = getCurrentDate().getTime();
    const then = new Date(timestamp).getTime();
    const diff = now - then;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (days > 0) {
      return `${days} day${days > 1 ? 's' : ''} ago`;
    }
    
    if (hours > 0) {
      const remainingMinutes = minutes % 60;
      if (remainingMinutes > 0) {
        return `${hours} hour${hours > 1 ? 's' : ''} ${remainingMinutes} minute${remainingMinutes > 1 ? 's' : ''} ago`;
      }
      return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    }
    
    return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
  }

  // Debounce helper
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // Get radius based on risk level
  function getRadiusByRisk(risk) {
    return risk === 'Danger - Avoid' ? 100 : 
           risk === 'Take caution' ? 80 : 50;
  }

  function metersBetween(aLat,aLng,bLat,bLng){
    const R=6371e3, toRad=v=>v*Math.PI/180;
    const Ï†1=toRad(aLat), Ï†2=toRad(bLat), Î”Ï†=toRad(bLat-aLat), Î”Î»=toRad(bLng-aLng);
    const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
  
  // Toast notification function with stacking support
  function toast(msg, t=1600){ 
    // Create or get toast container
    let container = document.getElementById('toast-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toast-container';
      container.style.cssText = 'position: fixed; top: 6rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; max-width: 320px;';
      document.body.appendChild(container);
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.style.cssText = 'background-color: #422d1e; color: white; padding: 0.75rem; border-radius: 0.375rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out;';
    toast.textContent = String(msg);
    
    // Add slide-in animation
    const style = document.createElement('style');
    if (!document.getElementById('toast-animation-style')) {
      style.id = 'toast-animation-style';
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    }
    
    container.appendChild(toast);
    
    // Remove toast after duration
    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease-in';
      setTimeout(() => {
        toast.remove();
        // Remove container if empty
        if (container.children.length === 0) {
          container.remove();
        }
      }, 300);
    }, t);
  }
  
  function escapeHtml(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // ----------------------------
  // Authentication Functions
  // ----------------------------
  
  // Check auth state on load
  async function initAuth() {
    console.log('ðŸ” Initializing authentication...');
    
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      console.log('âœ… User session found:', session.user.email);
      await handleAuthStateChange(session.user);
      
      // Load and process sync queue now that user is authenticated
      loadSyncQueue();
      updateSyncIndicator();
      
      // Process any pending syncs after a short delay
      if (syncQueue.length > 0) {
        console.log(`ðŸ”„ User authenticated, will process ${syncQueue.length} pending syncs`);
        setTimeout(() => processSyncQueue(), 2000);
      }
    } else {
      console.log('âš ï¸ No user session found');
      // No session - update UI to show logged out state
      updateAuthUI();
      
      // Still load sync queue for display (but won't process until sign in)
      loadSyncQueue();
      updateSyncIndicator();
    }
    
    // Listen for auth changes
    supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('ðŸ” Auth state changed:', event);
      if (event === 'SIGNED_IN' && session) {
        await handleAuthStateChange(session.user);
      } else if (event === 'SIGNED_OUT') {
        handleSignOut();
      }
    });
  }
  
  // Load user profile from database
  async function loadUserProfile() {
    if (!currentUser) return null;
    
    const { data: profile, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', currentUser.id)
      .single();
    
    if (profile) {
      userProfile = profile;
      console.log('âœ… Profile loaded:', profile);
      
      // Update user marker icon immediately if it exists
      if (userMarker) {
        console.log('ðŸŽ­ Updating user marker icon after profile load');
        userMarker.setIcon(getUserIcon());
      }
    } else {
      console.log('No profile found, user metadata:', currentUser.user_metadata);
      // Profile might not exist yet, use metadata as fallback
      userProfile = {
        display_name: currentUser.user_metadata?.display_name || currentUser.email.split('@')[0],
        email: currentUser.email
      };
    }
    
    return userProfile;
  }
  
  // Handle user sign in
  async function handleAuthStateChange(user) {
    currentUser = user;
    
    // Fetch user profile
    await loadUserProfile();
    
    // Update UI
    updateAuthUI();
    
    // Reload spots with user context (silently since we show welcome message)
    await loadAllFromSupabase(true);
    
    // Subscribe to real-time updates now that user is authenticated
    subscribeToRealtimeUpdates();
    
    // Sync queue is now loaded in initAuth() before this function
    // Just update the indicator in case it changed
    updateSyncIndicator();
    
    // Process any pending syncs (queue was already loaded in initAuth)
    if (syncQueue.length > 0) {
      console.log(`ðŸ”„ Processing ${syncQueue.length} pending syncs after sign in`);
      setTimeout(() => processSyncQueue(), 2000);
    }
    
    // Check if this is a new user signup
    const isNewUser = sessionStorage.getItem('newUserSignup') === 'true';
    
    if (isNewUser) {
      // Clear the flag
      sessionStorage.removeItem('newUserSignup');
      
      // Open profile modal on edit tab for new users
      setTimeout(() => {
        openProfileModal('edit', true);
      }, 500);
    } else {
      toast(`Welcome back, ${userProfile?.display_name || user.email.split('@')[0]}!`, 2000);
    }
  }
  
  // Update UI based on auth state
  function updateAuthUI() {
    const hamburgerUserInfo = document.getElementById('hamburgerUserInfo');
    const hamburgerUserName = document.getElementById('hamburgerUserName');
    const hamburgerUserEmail = document.getElementById('hamburgerUserEmail');
    const hamburgerUserAvatar = document.getElementById('hamburgerUserAvatar');
    const menuContributions = document.getElementById('menuContributions');
    const menuEditProfile = document.getElementById('menuEditProfile');
    const menuStats = document.getElementById('menuStats');
    const menuSignIn = document.getElementById('menuSignIn');
    const menuSignOut = document.getElementById('menuSignOut');
    const menuDivider = document.getElementById('menuDivider');
    
    // Desktop nav sign out/sign in button
    const desktopNavLogout = document.getElementById('desktopNavLogout');
    const desktopNavLogoutSpan = desktopNavLogout?.querySelector('span');
    
    // Mobile nav sign out/sign in button
    const mobileNavLogout = document.getElementById('navLogout');
    const mobileNavLogoutSpan = mobileNavLogout?.querySelector('span');
    
    if (currentUser) {
      // Get display name from profile or user metadata or email
      const displayName = userProfile?.display_name || 
                         currentUser.user_metadata?.display_name || 
                         currentUser.email.split('@')[0];
      
      // Show user info in hamburger menu
      if (hamburgerUserInfo) hamburgerUserInfo.classList.remove('hidden');
      if (hamburgerUserName) hamburgerUserName.textContent = displayName;
      if (hamburgerUserEmail) hamburgerUserEmail.textContent = currentUser.email;
      
      // Update hamburger menu avatar
      const avatarUrl = userProfile?.avatar_url || 'user_1.svg';
      if (hamburgerUserAvatar) {
        hamburgerUserAvatar.src = `Assets/Users Icons/${avatarUrl}`;
      }
      
      // Show signed-in menu items
      if (menuContributions) menuContributions.classList.remove('hidden');
      if (menuEditProfile) menuEditProfile.classList.remove('hidden');
      if (menuStats) menuStats.classList.remove('hidden');
      if (menuSignOut) menuSignOut.classList.remove('hidden');
      if (menuDivider) menuDivider.classList.remove('hidden');
      
      // Hide sign in button
      if (menuSignIn) menuSignIn.classList.add('hidden');
      
      // Update desktop nav button to show "Sign Out"
      if (desktopNavLogoutSpan) desktopNavLogoutSpan.textContent = 'Sign Out';
      
      // Update mobile nav button to show "Sign Out"
      if (mobileNavLogoutSpan) mobileNavLogoutSpan.textContent = 'Sign Out';
      
      console.log('UI updated with display name:', displayName);
    } else {
      // Hide user info in hamburger menu
      if (hamburgerUserInfo) hamburgerUserInfo.classList.add('hidden');
      
      // Hide signed-in menu items
      if (menuContributions) menuContributions.classList.add('hidden');
      if (menuEditProfile) menuEditProfile.classList.add('hidden');
      if (menuStats) menuStats.classList.add('hidden');
      if (menuSignOut) menuSignOut.classList.add('hidden');
      if (menuDivider) menuDivider.classList.add('hidden');
      
      // Show sign in button
      if (menuSignIn) menuSignIn.classList.remove('hidden');
      
      // Update desktop nav button to show "Sign In"
      if (desktopNavLogoutSpan) desktopNavLogoutSpan.textContent = 'Sign In';
      
      // Update mobile nav button to show "Sign In"
      if (mobileNavLogoutSpan) mobileNavLogoutSpan.textContent = 'Sign In';
    }
  }
  
  // Handle sign out
  function handleSignOut() {
    currentUser = null;
    userProfile = null;
    
    // Clean up real-time subscriptions
    if (spotsChannel) {
      console.log('ðŸ§¹ Removing spots channel on sign out');
      supabase.removeChannel(spotsChannel);
      spotsChannel = null;
    }
    if (reportsChannel) {
      console.log('ðŸ§¹ Removing reports channel on sign out');
      supabase.removeChannel(reportsChannel);
      reportsChannel = null;
    }
    
    updateAuthUI();
    toast('Signed out successfully', 2000);
  }
  
  // Sign in with email/password
  async function signIn(email, password) {
    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
      });
      
      if (error) throw error;
      
      if (authModal) authModal.classList.add('hidden');
      if (signInError) signInError.classList.add('hidden');
      if (signInForm) signInForm.reset();
      
      return { success: true };
    } catch (error) {
      console.error('Sign in error:', error);
      if (signInError) {
        signInError.textContent = error.message;
        signInError.classList.remove('hidden');
      } else {
        toast('Sign in error: ' + error.message, 3000);
      }
      return { success: false, error };
    }
  }
  
  // Sign up with email/password
  async function signUp(name, email, password) {
    try {
      const { data, error } = await supabase.auth.signUp({
        email: email,
        password: password,
        options: {
          data: {
            display_name: name
          }
        }
      });
      
      if (error) throw error;
      
      // If user was created, ensure profile has correct display name
      if (data.user) {
        // Wait a bit for trigger to fire, then check/update profile
        setTimeout(async () => {
          try {
            const { data: existingProfile } = await supabase
              .from('profiles')
              .select('*')
              .eq('id', data.user.id)
              .single();
            
            if (existingProfile && !existingProfile.display_name) {
              // Update profile with correct display name
              await supabase
                .from('profiles')
                .update({ display_name: name })
                .eq('id', data.user.id);
              console.log('Profile display name updated to:', name);
            } else if (!existingProfile) {
              // Create profile manually if trigger didn't work
              await supabase
                .from('profiles')
                .insert({
                  id: data.user.id,
                  email: email,
                  display_name: name
                });
              console.log('Profile created manually with display name:', name);
            }
          } catch (profileError) {
            console.warn('Profile update/create failed:', profileError);
          }
        }, 1000);
      }
      
      if (authModal) authModal.classList.add('hidden');
      if (signUpError) signUpError.classList.add('hidden');
      if (signUpForm) signUpForm.reset();
      
      // Check if email confirmation is required
      if (data.user && !data.session) {
        toast('Account created! Please check your email to verify.', 4000);
      } else {
        // Mark this as a new signup to trigger profile setup flow
        sessionStorage.setItem('newUserSignup', 'true');
        toast('Welcome! Let\'s set up your profile.', 3000);
      }
      
      return { success: true };
    } catch (error) {
      console.error('Sign up error:', error);
      if (signUpError) {
        signUpError.textContent = error.message;
        signUpError.classList.remove('hidden');
      } else {
        toast('Sign up error: ' + error.message, 3000);
      }
      return { success: false, error };
    }
  }
  
  // Sign out
  async function signOutUser() {
    try {
      const { error } = await supabase.auth.signOut();
      if (error) throw error;
    } catch (error) {
      console.error('Sign out error:', error);
      toast('Error signing out', 2000);
    }
  }

  // ----------------------------
  // Profile Modal Functions
  // ----------------------------
  
  async function openProfileModal(defaultTab = 'stats', isNewUser = false) {
    console.log('openProfileModal called', { currentUser, userProfile, defaultTab, isNewUser });
    
    if (!currentUser) {
      toast('Please sign in first', 2000);
      return;
    }
    
    // Load fresh profile data
    await loadUserProfile();
    
    // Populate profile header
    document.getElementById('profileDisplayName').textContent = userProfile?.display_name || currentUser.email.split('@')[0];
    document.getElementById('profileEmail').textContent = currentUser.email;
    
    // Set avatar image
    const avatarUrl = userProfile?.avatar_url || 'user_1.svg';
    document.getElementById('profileAvatar').src = `Assets/Users Icons/${avatarUrl}`;
    
    // Format join date
    const joinDate = new Date(currentUser.created_at);
    document.getElementById('profileJoined').textContent = `Member since: ${joinDate.toLocaleDateString()}`;
    
    // Update stats
    console.log('ðŸ“Š Setting stats from userProfile:', {
      spots: userProfile?.total_spots_created,
      reports: userProfile?.total_reports_created,
      safePassages: userProfile?.total_safe_passages
    });
    document.getElementById('profileStatSpotsCreated').textContent = userProfile?.total_spots_created || 0;
    document.getElementById('profileStatReportsCreated').textContent = userProfile?.total_reports_created || 0;
    document.getElementById('profileStatSafePassages').textContent = userProfile?.total_safe_passages || 0;
    
    // Load recent activity
    await loadRecentActivity();
    
    // Populate edit form
    editDisplayName.value = userProfile?.display_name || currentUser.email.split('@')[0];
    selectedAvatar.value = userProfile?.avatar_url || 'user_1.svg';
    
    // Update avatar picker selection
    document.querySelectorAll('.avatar-btn').forEach(btn => {
      if (btn.dataset.avatar === selectedAvatar.value) {
        btn.style.borderColor = '#422d1e';
        btn.style.backgroundColor = '#e8e2e1';
      } else {
        btn.style.borderColor = 'transparent';
        btn.style.backgroundColor = '';
      }
    });
    
    // Show/hide new user welcome message
    const newUserWelcome = document.getElementById('newUserWelcome');
    if (newUserWelcome) {
      if (isNewUser) {
        newUserWelcome.classList.remove('hidden');
      } else {
        newUserWelcome.classList.add('hidden');
      }
    }
    
    // Show modal on specified tab
    if (defaultTab === 'edit') {
      profileEditTab.click();
    } else {
      profileStatsTab.click();
    }
    profileModal.classList.remove('hidden');
  }
  
  
  function closeProfileModalFn() {
    profileModal.classList.add('hidden');
    profileEditError.classList.add('hidden');
    profileEditSuccess.classList.add('hidden');
    document.body.classList.remove('modal-open');
    
    // Reset to home view when closing modal
    scrollToHome();
  }
  
  // Helper function to close all modals
  function closeAllModals() {
    // Close all possible modals
    const modals = [
      'profileModal',
      'statsModal', 
      'safetyTipsModal',
      'testingModal',
      'authModal',
      'spotModal',
      'detailsModal',
      'successModal'
    ];
    
    modals.forEach(modalId => {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('hidden');
      }
    });
    
    document.body.classList.remove('modal-open');
  }
  
  // Helper function to scroll to home and reset view
  function scrollToHome() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Reset mobile nav to home
    const navHome = document.getElementById('navHome');
    if (navHome) {
      document.querySelectorAll('.mobile-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      navHome.classList.add('active');
    }
    
    // Reset desktop nav to home
    const desktopNavHome = document.getElementById('desktopNavHome');
    if (desktopNavHome) {
      const desktopNavItems = [
        'desktopNavHome',
        'desktopNavProfile', 
        'desktopNavTips',
        'desktopNavStats',
        'desktopNavTesting',
        'desktopNavLogout'
      ];
      
      desktopNavItems.forEach(itemId => {
        const item = document.getElementById(itemId);
        if (item) {
          item.classList.remove('active');
          item.style.backgroundColor = '';
          item.style.color = '';
        }
      });
      
      desktopNavHome.classList.add('active');
    }
  }
  
  async function loadRecentActivity() {
    const activityContainer = document.getElementById('profileRecentActivity');
    activityContainer.innerHTML = '<span style="color: #422d1e; opacity: 0.6;" class="text-sm">Loading...</span>';
    
    try {
      const { data: recentSpots, error: spotsError } = await supabase
        .from('spots')
        .select('id, name, species, created_at')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false })
        .limit(3);
      
      if (spotsError) throw spotsError;
      
      if (!recentSpots || recentSpots.length === 0) {
        activityContainer.innerHTML = '<span style="color: #422d1e; opacity: 0.6;" class="text-sm">No recent activity</span>';
        return;
      }
      
      activityContainer.innerHTML = '';
      recentSpots.forEach(spot => {
        const activityEl = document.createElement('div');
        activityEl.className = 'flex items-start gap-2 text-sm';
        activityEl.style.cssText = 'color: #422d1e;';
        
        const date = new Date(spot.created_at);
        const timeAgo = getTimeAgo(date);
        
        activityEl.innerHTML = `
          <div class="flex-1">
            <span class="font-medium">${spot.name}</span>
            <span style="opacity: 0.7;"> - ${spot.species}</span>
            <br>
            <span style="opacity: 0.6;" class="text-xs">${timeAgo}</span>
          </div>
        `;
        activityContainer.appendChild(activityEl);
      });
    } catch (error) {
      console.error('Error loading recent activity:', error);
      activityContainer.innerHTML = '<span style="color: #422d1e; opacity: 0.6;" class="text-sm">Error loading activity</span>';
    }
  }
  
  function getTimeAgo(date) {
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
    return date.toLocaleDateString();
  }
  
  async function updateUserProfile(e) {
    e.preventDefault();
    
    profileEditError.classList.add('hidden');
    profileEditSuccess.classList.add('hidden');
    
    const newDisplayName = editDisplayName.value.trim();
    const newAvatar = selectedAvatar.value;
    
    if (!newDisplayName) {
      profileEditError.textContent = 'Display name is required';
      profileEditError.classList.remove('hidden');
      return;
    }
    
    try {
      console.log('Updating profile:', { newDisplayName, newAvatar, userId: currentUser.id });
      
      const { data, error } = await supabase
        .from('profiles')
        .update({
          display_name: newDisplayName,
          avatar_url: newAvatar
        })
        .eq('id', currentUser.id)
        .select();
      
      if (error) {
        console.error('Supabase error:', error);
        throw error;
      }
      
      console.log('Profile updated successfully:', data);
      
      userProfile = {
        ...userProfile,
        display_name: newDisplayName,
        avatar_url: newAvatar
      };
      
      updateAuthUI();
      
      // Update user marker icon on map
      if (userMarker) {
        try {
          userMarker.setIcon(getUserIcon());
        } catch(e) {
          console.error('Error updating user marker icon:', e);
        }
      }
      
      profileEditSuccess.textContent = 'Profile updated successfully!';
      profileEditSuccess.classList.remove('hidden');
      
      setTimeout(() => {
        profileStatsTab.click();
        document.getElementById('profileDisplayName').textContent = newDisplayName;
        document.getElementById('profileAvatar').src = `Assets/Users Icons/${newAvatar}`;
      }, 1000);
      
    } catch (error) {
      console.error('Error updating profile:', error);
      profileEditError.textContent = `Error: ${error.message || 'Please try again.'}`;
      profileEditError.classList.remove('hidden');
    }
  }
  
  // Increment user's safe passage count
  async function incrementUserSafePassages() {
    if (!currentUser) return;
    
    try {
      console.log('ðŸ“Š Incrementing safe passages for user:', currentUser.id);
      
      // Increment the safe passage counter in the database
      const { data, error } = await supabase.rpc('increment_safe_passages', {
        user_id: currentUser.id
      });
      
      if (error) {
        console.error('âŒ Database error:', error);
        throw error;
      }
      
      console.log('âœ… Database increment successful');
      
      // Reload profile from database to get the updated count
      await loadUserProfile();
      
      console.log('âœ… Profile reloaded, total_safe_passages:', userProfile?.total_safe_passages);
      
      // Update the displayed stat if profile modal is open
      const statElement = document.getElementById('profileStatSafePassages');
      if (statElement && userProfile) {
        statElement.textContent = userProfile.total_safe_passages || 0;
        console.log('âœ… Updated UI element to:', userProfile.total_safe_passages || 0);
      }
      
      console.log('âœ… Safe passage count incremented to:', userProfile?.total_safe_passages);
    } catch (error) {
      console.error('âŒ Error incrementing safe passages:', error);
      console.error('âŒ Error details:', {
        message: error.message,
        hint: error.hint,
        details: error.details
      });
      
      // Show user-friendly error
      toast('Could not update safe passage count. Please check database setup.', 3000);
    }
  }
  
  // Increment user's spots created count
  async function incrementUserSpotsCreated() {
    if (!currentUser) return;
    
    try {
      // Increment the spots counter in the database
      const { error } = await supabase.rpc('increment_spots_created', {
        user_id: currentUser.id
      });
      
      if (error) throw error;
      
      // Reload profile from database to get the updated count
      await loadUserProfile();
      
      // Update the displayed stat if profile modal is open
      const statElement = document.getElementById('profileStatSpotsCreated');
      if (statElement && userProfile) {
        statElement.textContent = userProfile.total_spots_created || 0;
      }
      
      console.log('âœ… Spots created count incremented to:', userProfile?.total_spots_created);
    } catch (error) {
      console.error('âŒ Error incrementing spots created:', error);
      // Don't show error to user, just log it
    }
  }
  
  // Increment user's reports created count
  async function incrementUserReportsCreated() {
    if (!currentUser) return;
    
    try {
      // Increment the reports counter in the database
      const { error } = await supabase.rpc('increment_reports_created', {
        user_id: currentUser.id
      });
      
      if (error) throw error;
      
      // Reload profile from database to get the updated count
      await loadUserProfile();
      
      // Update the displayed stat if profile modal is open
      const statElement = document.getElementById('profileStatReportsCreated');
      if (statElement && userProfile) {
        statElement.textContent = userProfile.total_reports_created || 0;
      }
      
      console.log('âœ… Reports created count incremented to:', userProfile?.total_reports_created);
    } catch (error) {
      console.error('âŒ Error incrementing reports created:', error);
      // Don't show error to user, just log it
    }
  }

  // ----------------------------
  // Persistence (Supabase + localStorage fallback)
  // ----------------------------
  
  // ----------------------------
  // Sync Queue Management
  // ----------------------------
  
  // Load sync queue from localStorage
  function loadSyncQueue() {
    try {
      const queueData = localStorage.getItem(SYNC_QUEUE_KEY);
      syncQueue = queueData ? JSON.parse(queueData) : [];
      console.log(`ðŸ“‹ Loaded ${syncQueue.length} items from sync queue`);
      return syncQueue;
    } catch (e) {
      console.warn('âš ï¸ Error loading sync queue:', e);
      syncQueue = [];
      return [];
    }
  }
  
  // Save sync queue to localStorage
  function saveSyncQueue() {
    try {
      localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(syncQueue));
      console.log(`ðŸ’¾ Saved ${syncQueue.length} items to sync queue`);
    } catch (e) {
      console.warn('âš ï¸ Error saving sync queue:', e);
    }
  }
  
  // Add spot to sync queue
  function addToSyncQueue(spotId, action = 'create') {
    console.log(`âž• Adding to sync queue: ${spotId} (${action})`);
    
    // Check if already in queue
    const existingIndex = syncQueue.findIndex(item => item.spotId === spotId);
    
    if (existingIndex >= 0) {
      // Update existing queue item
      syncQueue[existingIndex].action = action;
      syncQueue[existingIndex].timestamp = Date.now();
      syncQueue[existingIndex].retryCount = (syncQueue[existingIndex].retryCount || 0);
      console.log(`ðŸ”„ Updated existing queue item for ${spotId}`);
    } else {
      // Add new queue item with user tracking
      syncQueue.push({
        spotId: spotId,
        action: action,
        timestamp: Date.now(),
        retryCount: 0,
        user_id: currentUser?.id, // Track ownership
        created_by_name: userProfile?.display_name || currentUser?.email?.split('@')[0] || 'Unknown'
      });
      console.log(`âœ… Added new queue item for ${spotId}`);
    }
    
    saveSyncQueue();
    updateSyncIndicator();
  }
  
  // Remove spot from sync queue
  function removeFromSyncQueue(spotId) {
    const initialLength = syncQueue.length;
    syncQueue = syncQueue.filter(item => item.spotId !== spotId);
    
    if (syncQueue.length < initialLength) {
      console.log(`âœ… Removed ${spotId} from sync queue`);
      saveSyncQueue();
      updateSyncIndicator();
    }
  }
  
  // Clear entire sync queue (useful for clearing old pre-fix spots)
  function clearSyncQueue() {
    console.log('ðŸ—‘ï¸ Clearing sync queue...');
    const clearedCount = syncQueue.length;
    
    if (clearedCount === 0) {
      toast('Sync queue is already empty', 2000);
      return;
    }
    
    // Clear the queue
    syncQueue = [];
    saveSyncQueue();
    updateSyncIndicator();
    
    console.log(`âœ… Cleared ${clearedCount} items from sync queue`);
    toast(`Cleared ${clearedCount} unsynced spot${clearedCount > 1 ? 's' : ''}`, 2000);
  }
  
  // Update sync indicator UI
  function updateSyncIndicator() {
    const indicator = document.getElementById('syncIndicator');
    const menuSync = document.getElementById('menuSync');
    const menuSyncBadge = document.getElementById('menuSyncBadge');
    const menuClearSync = document.getElementById('menuClearSync');
    
    if (syncQueue.length > 0) {
      // Update floating indicator
      if (indicator) {
        indicator.textContent = `${syncQueue.length} unsynced`;
        indicator.classList.remove('hidden');
        indicator.style.cssText = 'position: fixed; top: 140px; right: 20px; background: #F59E0B; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; z-index: 998; box-shadow: 0 2px 6px rgba(0,0,0,0.2);';
      }
      
      // Show sync button in menu (only if user is signed in)
      if (currentUser && menuSync) {
        menuSync.classList.remove('hidden');
      }
      
      // Show clear sync button in menu
      if (currentUser && menuClearSync) {
        menuClearSync.classList.remove('hidden');
      }
      
      // Update menu badge
      if (menuSyncBadge) {
        menuSyncBadge.textContent = syncQueue.length;
        menuSyncBadge.classList.remove('hidden');
      }
    } else {
      // Hide indicator
      if (indicator) {
        indicator.classList.add('hidden');
      }
      
      // Hide sync button and badge
      if (menuSync) {
        menuSync.classList.add('hidden');
      }
      if (menuSyncBadge) {
        menuSyncBadge.classList.add('hidden');
      }
      
      // Hide clear sync button
      if (menuClearSync) {
        menuClearSync.classList.add('hidden');
      }
    }
  }
  
  // Process sync queue - retry all failed syncs
  async function processSyncQueue() {
    if (syncInProgress || syncQueue.length === 0 || !syncEnabled || !currentUser) {
      console.log('âš ï¸ Cannot process sync queue:', {
        syncInProgress,
        queueLength: syncQueue.length,
        syncEnabled,
        hasUser: !!currentUser
      });
      return;
    }
    
    console.log(`ðŸ”„ Processing sync queue: ${syncQueue.length} items`);
    console.log('ðŸ“Š Sync queue state:', {
      total: syncQueue.length,
      pending: syncQueue.filter(i => (i.retryCount || 0) < 5).length,
      failed: syncQueue.filter(i => (i.retryCount || 0) >= 5).length,
      currentUserId: currentUser?.id
    });
    
    syncInProgress = true;
    
    // Create a copy to iterate over (in case queue changes during processing)
    const itemsToSync = [...syncQueue];
    
    for (const item of itemsToSync) {
      // Validate ownership (skip if created by different user)
      // Backward compatible: if user_id is missing, assume it belongs to current user
      if (item.user_id && item.user_id !== currentUser?.id) {
        console.log(`âš ï¸ Skipping sync - spot ${item.spotId} created by different user (${item.created_by_name || 'unknown'})`);
        removeFromSyncQueue(item.spotId);
        continue;
      }
      
      // Find the spot in our local spots array
      const spot = spots.find(s => s.id === item.spotId);
      
      if (!spot) {
        console.log(`âš ï¸ Spot ${item.spotId} not found locally, removing from queue`);
        removeFromSyncQueue(item.spotId);
        continue;
      }
      
      console.log(`ðŸ”„ Attempting to sync: ${spot.name} (retry ${item.retryCount || 0})`);
      
      try {
        // Attempt to save to Supabase
        await saveSpotToSupabaseInternal(spot);
        
        // Success - remove from queue
        console.log(`âœ… Successfully synced: ${spot.name}`);
        removeFromSyncQueue(item.spotId);
        toast(`Synced: ${spot.name}`, 1600);
        
      } catch (error) {
        console.error(`âŒ Failed to sync ${spot.name}:`, error);
        
        // Increment retry count
        const queueItem = syncQueue.find(qi => qi.spotId === item.spotId);
        if (queueItem) {
          queueItem.retryCount = (queueItem.retryCount || 0) + 1;
          queueItem.lastError = error.message;
          queueItem.lastAttempt = Date.now();
          saveSyncQueue();
          
          // If too many retries, notify user
          if (queueItem.retryCount >= 5) {
            console.warn(`âš ï¸ ${spot.name} failed ${queueItem.retryCount} times`);
            toast(`Sync issue: ${spot.name} - will keep trying`, 3000);
          }
        }
      }
      
      // Small delay between syncs to avoid overwhelming the server
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    syncInProgress = false;
    updateSyncIndicator();
    
    // Schedule next retry if there are still items in queue
    if (syncQueue.length > 0) {
      scheduleNextSync();
    }
  }
  
  // Schedule next sync retry (exponential backoff)
  function scheduleNextSync() {
    if (syncRetryTimer) {
      clearTimeout(syncRetryTimer);
    }
    
    // Get the max retry count to determine backoff
    const maxRetries = Math.max(...syncQueue.map(item => item.retryCount || 0), 0);
    
    // Exponential backoff: 30s, 1m, 2m, 5m, 10m
    const delays = [30000, 60000, 120000, 300000, 600000];
    const delay = delays[Math.min(maxRetries, delays.length - 1)];
    
    console.log(`â° Scheduling next sync in ${delay / 1000}s`);
    
    syncRetryTimer = setTimeout(() => {
      console.log('â° Retry timer triggered, processing sync queue...');
      processSyncQueue();
    }, delay);
  }
  
  // Internal save function (used by both direct save and sync queue)
  async function saveSpotToSupabaseInternal(spot) {
    if (!syncEnabled) {
      throw new Error('Sync is disabled');
    }
    
    if (!currentUser) {
      throw new Error('User not authenticated');
    }
    
    // Track that we're saving this spot to ignore its real-time update
    recentlySavedSpotIds.add(spot.id);
    
    // Clear it after a short delay (in case the real-time update is delayed)
    setTimeout(() => {
      recentlySavedSpotIds.delete(spot.id);
    }, 3000);
    
    // Prepare spot data (exclude UI elements)
    const spotData = {
      id: spot.id,
      name: spot.name,
      species: spot.species,
      lat: Number(spot.lat),
      lng: Number(spot.lng),
      risk: spot.risk,
      is_preseason: spot.isPreseason === true,
      safe_passage_count: spot.safePassageCount || 0,
      last_safe_passage: spot.lastSafePassage || null,
      user_id: currentUser.id,
      created_by_name: userProfile?.display_name || currentUser.email.split('@')[0]
    };
    
    console.log(`ðŸ’¾ Saving spot ${spot.name}: isPreseason=${spot.isPreseason}, DB is_preseason=${spotData.is_preseason}`);
    
    // Upsert spot (insert or update)
    const { data: spotResult, error: spotError } = await supabase
      .from('spots')
      .upsert(spotData)
      .select();
    
    if (spotError) throw spotError;
    
    // Save reports for this spot
    if (spot.reports && spot.reports.length > 0) {
      const reportsData = spot.reports.map(r => ({
        id: r.id,
        spot_id: spot.id,
        alert_level: r.alertLevel,
        bird_behaviour: r.birdBehaviour || [],
        human_behaviour: r.humanBehaviour || [],
        precautions: r.precautions || [],
        extra_details: r.extra || '',
        timestamp: r.timestamp,
        user_id: r.user_id || currentUser.id,
        created_by_name: r.created_by_name || (userProfile?.display_name || currentUser.email.split('@')[0])
      }));
      
      const { error: reportsError } = await supabase
        .from('reports')
        .upsert(reportsData);
      
      if (reportsError) throw reportsError;
    }
    
    console.log('âœ… Spot synced to Supabase:', spot.name);
  }
  
  // Save spot to Supabase
  async function saveSpotToSupabase(spot) {
    console.log('ðŸ’¾ saveSpotToSupabase called:', { 
      spotName: spot.name, 
      spotId: spot.id,
      syncEnabled, 
      currentUser: currentUser?.email || 'null',
      reportsCount: spot.reports?.length || 0
    });
    
    if (!syncEnabled) {
      console.log('âŒ Sync disabled - skipping save to Supabase');
      return;
    }
    
    // Don't sync if user is not authenticated
    if (!currentUser) {
      console.log('âš ï¸ User not authenticated, adding to sync queue for later');
      addToSyncQueue(spot.id, 'create');
      return;
    }
    
    try {
      isSyncing = true;
      console.log('ðŸ“¤ Attempting to save to Supabase...');
      
      // Try to save immediately
      await saveSpotToSupabaseInternal(spot);
      
      console.log('âœ… Successfully saved to Supabase');
      
      // Success - remove from queue if it was there
      removeFromSyncQueue(spot.id);
      
    } catch (error) {
      console.error('âŒ Error saving to Supabase:', error);
      console.error('âŒ Error details:', {
        message: error.message,
        code: error.code,
        details: error.details,
        hint: error.hint
      });
      
      // Add to sync queue for retry
      addToSyncQueue(spot.id, 'update');
      
      // Show user-friendly error
      toast('Saved locally - will sync when online', 2000);
      
      // Schedule retry
      scheduleNextSync();
      
    } finally {
      isSyncing = false;
    }
  }
  
  // Save all spots to localStorage (backup)
  function saveAll(){
    try {
      const serial = spots.map(s => {
        const { marker, circle, ...rest } = s;
        return rest;
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(serial));
    } catch(e){ console.warn(e); }
  }
  
  // Load all spots from Supabase
  async function loadAllFromSupabase(silent = false) {
    console.log('ðŸ”„ loadAllFromSupabase called, syncEnabled:', syncEnabled);
    
    if (!syncEnabled) {
      console.log('âš ï¸ Sync disabled, falling back to localStorage');
      loadAll(); // Fallback to localStorage
      return;
    }
    
    try {
      if (!silent) {
        toast('Loading spots from cloud...', 1000);
      }
      
      console.log('ðŸ“¡ Fetching spots from Supabase...');
      
      // Fetch all spots with their reports
      const { data: spotsData, error } = await supabase
        .from('spots')
        .select(`
          *,
          reports (*)
        `)
        .order('created_at', { ascending: false });
      
      console.log('ðŸ“Š Supabase response:', { spotsData, error });
      
      if (error) throw error;
      
      // Clear existing spots
      console.log('ðŸ—‘ï¸ Clearing existing spots:', spots.length);
      spots.forEach(s => {
        try {
          map.removeLayer(s.marker);
          map.removeLayer(s.circle);
        } catch(e) {}
      });
      spots = [];
      
      // Create spots from Supabase data
      if (spotsData && spotsData.length > 0) {
        console.log(`âœ… Creating ${spotsData.length} spots from Supabase data`);
        spotsData.forEach(spotData => {
          console.log('Creating spot:', spotData.name, 'DB is_preseason:', spotData.is_preseason);
          // Convert Supabase format to app format
          const spot = {
            id: spotData.id,
            name: spotData.name,
            species: spotData.species,
            lat: Number(spotData.lat),
            lng: Number(spotData.lng),
            // Pass isPreseason from database - explicitly convert to boolean
            // This ensures false/null from DB are treated as false (not recalculated)
            isPreseason: spotData.is_preseason === true ? true : false,
            address: spotData.address || '',
            createdAt: spotData.created_at,
            safePassageCount: spotData.safe_passage_count || 0,
            reports: (spotData.reports || []).map(r => ({
              id: r.id,
              alertLevel: r.alert_level,
              birdBehaviour: r.bird_behaviour || [],
              humanBehaviour: r.human_behaviour || [],
              precautions: r.precautions || [],
              extra: r.extra_details || '',
              timestamp: r.timestamp,
              user_id: r.user_id,
              created_by_name: r.created_by_name
            }))
          };
          
          createSpotFromData(spot, true);
        });
        
        console.log(`âœ… Successfully created ${spots.length} spots`);
        
        // Only show toast if not silent
        if (!silent) {
          toast(`Loaded ${spotsData.length} spots from cloud`, 2000);
        }
      } else if (!silent) {
        console.log('âš ï¸ No spots found in Supabase');
        toast('No spots found - add your first!', 2000);
      }
      
      // Save to localStorage as backup
      saveAll();
      
      // After loading from database, process sync queue to upload any pending items
      if (currentUser && syncQueue.length > 0) {
        console.log(`ðŸ”„ Processing ${syncQueue.length} queued items after database load`);
        setTimeout(() => processSyncQueue(), 2000); // Small delay to let UI settle
      }
      
    } catch (error) {
      console.error('âŒ Error loading from Supabase:', error);
      if (!silent) {
        toast('Loading from local storage...', 2000);
      }
      loadAll(); // Fallback to localStorage
    }
  }
  
  // Load from localStorage (fallback/offline)
  function loadAll(){
    console.log('ðŸ“‚ Loading spots from localStorage...');
    try {
      const raw = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      console.log(`ðŸ“‚ Found ${raw.length} spots in localStorage`);
      raw.forEach(r => createSpotFromData(r, true));
      console.log(`âœ… Successfully loaded ${spots.length} spots from localStorage`);
      
      // After loading from localStorage, check if we have a sync queue
      loadSyncQueue();
      if (currentUser && syncQueue.length > 0) {
        console.log(`ðŸ”„ Found ${syncQueue.length} items in sync queue`);
        updateSyncIndicator();
        setTimeout(() => processSyncQueue(), 3000);
      }
    } catch(e){ console.warn('âŒ localStorage load error:', e); }
  }
  
  // Subscribe to real-time updates
  let spotsChannel = null;
  let reportsChannel = null;
  
  function subscribeToRealtimeUpdates() {
    if (!syncEnabled) return;
    
    console.log('ðŸ”„ Setting up real-time subscriptions...');
    
    // Clean up existing subscriptions to prevent duplicates
    if (spotsChannel) {
      console.log('ðŸ§¹ Cleaning up existing spots channel');
      supabase.removeChannel(spotsChannel);
      spotsChannel = null;
    }
    if (reportsChannel) {
      console.log('ðŸ§¹ Cleaning up existing reports channel');
      supabase.removeChannel(reportsChannel);
      reportsChannel = null;
    }
    
    // Subscribe to spots table changes
    spotsChannel = supabase
      .channel('spots-changes')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'spots'
        },
        (payload) => {
          console.log('ðŸ”„ Spot changed:', payload);
          handleSpotRealTimeUpdate(payload);
        }
      )
      .subscribe();
    
    console.log('âœ… Subscribed to spots channel');
    
    // Subscribe to reports table changes
    reportsChannel = supabase
      .channel('reports-changes')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'reports'
        },
        (payload) => {
          console.log('ðŸ”„ Report changed:', payload);
          handleReportRealTimeUpdate(payload);
        }
      )
      .subscribe();
    
    console.log('âœ… Subscribed to reports channel');
  }
  
  // Handle real-time spot updates
  // Track recently saved spots to ignore their real-time updates
  let recentlySavedSpotIds = new Set();
  
  function handleSpotRealTimeUpdate(payload) {
    const { eventType, new: newSpot, old: oldSpot } = payload;
    
    console.log(`ðŸ”„ Real-time spot update: eventType=${eventType}, spot=${newSpot?.name}, id=${newSpot?.id}`);
    
    if (eventType === 'INSERT') {
      // New spot added by another user
      const existingSpot = spots.find(s => s.id === newSpot.id);
      if (!existingSpot) {
        toast(`New spot: ${newSpot.name}`, 2000);
        loadAllFromSupabase(true); // Reload silently
      }
    } else if (eventType === 'UPDATE') {
      // Check if this is our own update
      if (recentlySavedSpotIds.has(newSpot.id)) {
        console.log('ðŸ”• Ignoring real-time update for spot we just saved:', newSpot.id);
        recentlySavedSpotIds.delete(newSpot.id);
        return;
      }
      console.log(`ðŸ”„ Processing real-time UPDATE for spot ${newSpot.name} (not in recentlySavedSpotIds)`);
      // Spot updated by another user
      loadAllFromSupabase(true); // Reload silently
    } else if (eventType === 'DELETE') {
      // Spot deleted
      const spot = spots.find(s => s.id === oldSpot.id);
      if (spot) {
        try {
          map.removeLayer(spot.marker);
          map.removeLayer(spot.circle);
        } catch(e) {}
        spots = spots.filter(s => s.id !== oldSpot.id);
        renderAlerts();
        saveAll();
      }
    }
  }
  
  // Handle real-time report updates
  function handleReportRealTimeUpdate(payload) {
    // Don't reload when we just added a report ourselves
    // The real-time update would override our local state changes
    // Only reload if the report was added by another user
    const reportUserId = payload.new?.user_id;
    if (reportUserId === currentUser?.id) {
      console.log('ðŸ”• Ignoring real-time update for own report to prevent state override');
      return;
    }
    
    // When a report changes from another user, reload the affected spot
    console.log('ðŸ”„ Reloading spots due to real-time report update from another user');
    loadAllFromSupabase(true); // Reload silently
  }

  // ----------------------------
  // Robust Tag UI: idempotent, safe to re-run
  // Replaces previous setupTagUI implementation
  // ----------------------------
  function setupTagUI(box, list, options, selectedArray, onChange){
    // remove previously attached handlers stored on elements (if any)
    if (box._tagui_cleanup) {
      try { box._tagui_cleanup(); } catch(e){ /* ignore */ }
      delete box._tagui_cleanup;
    }
    if (list._tagui_cleanup) {
      try { list._tagui_cleanup(); } catch(e){ /* ignore */ }
      delete list._tagui_cleanup;
    }

    // render function (idempotent)
    function render(){
      box.innerHTML = '';
      selectedArray.forEach(p=>{
        const span = document.createElement('span');
        span.className='tag';
        span.innerHTML = `${escapeHtml(p)} <span class="x" data-val="${escapeHtml(p)}">&times;</span>`;
        box.appendChild(span);
      });
      if(selectedArray.length === 0){
        const ph = document.createElement('span');
        ph.className='text-xs text-gray-500';
        ph.textContent='Select...';
        box.appendChild(ph);
      }
      const caret = document.createElement('span');
      caret.innerHTML='&#9662;';
      caret.style.marginLeft='auto';
      caret.className='text-gray-400 text-sm';
      box.appendChild(caret);
    }

    // helper to populate list
    function populateList(){
      list.innerHTML = '';
      options.forEach(p => {
        const d = document.createElement('div');
        d.textContent = p;
        d.dataset.val = p;
        list.appendChild(d);
      });
    }

    // state for whether list is shown
    let listVisible = false;

    // click handler for box (toggle list)
    const onBoxClick = (e) => {
      e.stopPropagation();
      // toggle
      listVisible = !listVisible;
      if(listVisible){
        populateList();
        list.style.display = 'block';
      } else {
        list.style.display = 'none';
      }
    };

    // click handler for list items
    const onListClick = (e) => {
      const v = e.target && e.target.dataset && e.target.dataset.val;
      if(!v) return;
      if(!selectedArray.includes(v)) selectedArray.push(v);
      render();
      onChange && onChange();
      list.style.display = 'none';
      listVisible = false;
    };

    // click handler for removing a tag (delegated on the box)
    const onBoxRemoveClick = (e) => {
      const x = e.target.closest('.x');
      if(!x) return;
      const v = x.dataset.val;
      const idx = selectedArray.indexOf(v);
      if(idx>-1) selectedArray.splice(idx,1);
      render();
      onChange && onChange();
    };

    // global click to hide lists when clicking outside
    const onDocumentClick = (e) => {
      if(listVisible){
        list.style.display = 'none';
        listVisible = false;
      }
    };

    // attach listeners
    box.addEventListener('click', onBoxClick);
    list.addEventListener('click', onListClick);
    box.addEventListener('click', onBoxRemoveClick);
    document.addEventListener('click', onDocumentClick);

    // store cleanup function so subsequent initializations remove handlers
    box._tagui_cleanup = () => {
      try { box.removeEventListener('click', onBoxClick); } catch(e){}
      try { box.removeEventListener('click', onBoxRemoveClick); } catch(e){}
      try { document.removeEventListener('click', onDocumentClick); } catch(e){}
      try { list.removeEventListener('click', onListClick); } catch(e){}
      // hide list on cleanup
      try { list.style.display = 'none'; } catch(e){}
    };
    list._tagui_cleanup = box._tagui_cleanup;

    // initial render
    render();
  }

  // initializeAllTagUIs: central handler to reset & attach tag UIs cleanly
  function initializeAllTagUIs(){
    // hide any floating lists left open
    document.querySelectorAll('.tag-list').forEach(el => { el.style.display = 'none'; });

    // reset and attach create-spot modal tags
    selectedRBird = [];
    selectedRHuman = [];
    selectedRPrec = [];
    setupTagUI(rbirdBox, rbirdList, BIRD_BEHAVIOURS, selectedRBird, updateRAlertFromBirds);
    setupTagUI(rhumanBox, rhumanList, HUMAN_BEHAVIOURS, selectedRHuman, ()=>{});
    setupTagUI(rprecBox, rprecList, PRECAUTIONS, selectedRPrec, ()=>{});

    // reset and attach add-report modal tags
    selectedReportBird = [];
    selectedReportHuman = [];
    selectedReportPrec = [];
    setupTagUI(rbirdBox2, rbirdList2, BIRD_BEHAVIOURS, selectedReportBird, updateRepAlertFromBirds);
    setupTagUI(rhumanBox2, rhumanList2, HUMAN_BEHAVIOURS, selectedReportHuman, ()=>{});
    setupTagUI(rprecBox2, rprecList2, PRECAUTIONS, selectedReportPrec, ()=>{});
  }

  // ----------------------------
  // Alert level logic
  // ----------------------------
  function computeAlertFromBirds(birdTags){
    if(!Array.isArray(birdTags)) return 'Low risk';
    if(birdTags.includes('made contact + injured') || birdTags.includes('made contact + uninjured')) return 'Danger - Avoid';
    if(birdTags.includes('close swoop')) return 'Take caution';
    // if has swoop or noisy or none -> Low risk
    return 'Low risk';
  }
  function updateRAlertFromBirds(){ ralertLevel.value = computeAlertFromBirds(selectedRBird); }
  function updateRepAlertFromBirds(){ repAlertLevel.value = computeAlertFromBirds(selectedReportBird); }

  // ----------------------------
  // Geocoding (with CORS workaround)
  // ----------------------------
  async function geocodeAddress(q){
    // Use geocode.maps.co (free, CORS-friendly alternative to Nominatim)
    // This service uses OpenStreetMap data and allows browser requests
    const url = 'https://geocode.maps.co/search?q=' + encodeURIComponent(q);
    
    try {
      const res = await fetch(url);
      
      if (!res.ok) {
        throw new Error(`Geocoding failed: ${res.status} ${res.statusText}`);
      }
      
      const j = await res.json();
      if(!j || j.length===0) throw new Error('Address not found');
      return { 
        lat: parseFloat(j[0].lat), 
        lng: parseFloat(j[0].lon), 
        display: j[0].display_name 
      };
    } catch (error) {
      console.error('Geocoding error:', error);
      throw new Error('Unable to find address. Please try selecting from map instead.');
    }
  }

  // Address suggestions UI
  function createAddressList(input) {
    let listId = input.id + '_suggestions';
    let existingList = document.getElementById(listId);
    if (!existingList) {
      const list = document.createElement('div');
      list.id = listId;
      list.className = 'absolute left-0 right-0 rounded-lg shadow-lg mt-1 z-50 max-h-48 overflow-y-auto hidden';
      list.style.backgroundColor = '#f2eceb';
      list.style.border = '1px solid #d4cac7';
      input.parentElement.style.position = 'relative';
      input.parentElement.appendChild(list);
      return list;
    }
    return existingList;
  }

  // Address lookup and suggestion handler
  async function handleAddressLookup(input) {
    if (!input.value.trim()) {
      const list = document.getElementById(input.id + '_suggestions');
      if (list) list.classList.add('hidden');
      return;
    }

    try {
      // Use geocode.maps.co (free, CORS-friendly alternative)
      const url = 'https://geocode.maps.co/search?q=' + encodeURIComponent(input.value.trim());
      const res = await fetch(url);
      
      if (!res.ok) {
        console.warn('Address lookup failed:', res.status, res.statusText);
        return;
      }
      
      const results = await res.json();
      
      const list = createAddressList(input);
      list.innerHTML = '';
      
      if (results.length > 0) {
        results.slice(0, 5).forEach(r => {
          const div = document.createElement('div');
          div.className = 'p-2 cursor-pointer text-sm';
          div.style.color = '#422d1e';
          div.textContent = r.display_name;
          div.addEventListener('mouseover', () => div.style.backgroundColor = '#e8e2e1');
          div.addEventListener('mouseout', () => div.style.backgroundColor = 'transparent');
          div.addEventListener('click', () => {
            input.value = r.display_name;
            if (input.id === 'addressField') {
              selectedLocation = { lat: parseFloat(r.lat), lng: parseFloat(r.lon) };
              coordsField.value = `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
              addressInfo.textContent = `Selected: ${r.display_name}`;
              if (tempMarker) try { map.removeLayer(tempMarker); } catch(e){}
              tempMarker = L.marker([selectedLocation.lat, selectedLocation.lng]).addTo(map);
              map.setView([selectedLocation.lat, selectedLocation.lng], 16);
            }
            list.classList.add('hidden');
          });
          list.appendChild(div);
        });
        list.classList.remove('hidden');
      } else {
        list.classList.add('hidden');
      }
    } catch(err) {
      console.warn('Address lookup error:', err);
    }
  }

  // Setup debounced address lookup
  const debouncedAddressLookup = debounce(handleAddressLookup, 300);

  // ----------------------------
  // Map click behavior
  // ----------------------------
  map.on('click', (e) => {
    // if the spot modal is open, treat click as selected location
    if(!spotModal.classList.contains('hidden')){
      selectedLocation = { lat: e.latlng.lat, lng: e.latlng.lng };
      coordsField.value = `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
      addressInfo.textContent = `Selected from map: ${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
      if(tempMarker) try{ map.removeLayer(tempMarker); } catch(e){}
      tempMarker = L.marker(e.latlng).addTo(map);
      return;
    }
    // when details modal open, do nothing special
    if(!detailsModal.classList.contains('hidden')) return;
    // otherwise pan
    map.panTo(e.latlng);
  });

  // ----------------------------
  // Create spot & reports model
  // ----------------------------
  function createSpotFromData(data, skipSave=false){
    if(!data.id) data.id = uid();
    if(!Array.isArray(data.reports)) data.reports = [];
    if(!data.createdAt) data.createdAt = new Date().toISOString(); // Add creation date if missing
    
    console.log(`ðŸ”¨ Creating spot: ${data.name}, species: ${data.species || data.birdSpecies}, reports: ${data.reports?.length || 0}`);
    
    // compute risk if absent
    if(!data.risk) data.risk = computeSpotRiskFromReports(data.reports, data.species || data.birdSpecies);
    
    // Only calculate isPreseason if it's not explicitly set in the data
    // This respects manual clearing when reports are added
    // NOTE: We check for undefined only - false means it was explicitly cleared
    if (typeof data.isPreseason !== 'boolean') {
      const showPreseasonMsg = shouldShowPreseasonWarning(data.reports, data.species || data.birdSpecies, data.createdAt);
      data.isPreseason = showPreseasonMsg;
      console.log(`ðŸŽ¯ Spot ${data.name} risk: ${data.risk}, calculated isPreseason: ${data.isPreseason}`);
    } else {
      console.log(`ðŸŽ¯ Spot ${data.name} risk: ${data.risk}, using existing isPreseason: ${data.isPreseason}`);
    }
    
    // If showing pre-season warning, ensure risk is Calm
    if (data.isPreseason) {
      data.risk = 'Calm - All clear';
    }
    
    const lat = Number(data.lat), lng = Number(data.lng);
    const marker = L.marker([lat,lng], { icon: getBirdIcon(data.risk, data.isPreseason) }).addTo(map);
    const radius = getRadiusByRisk(data.risk);
    
    const circle = L.circle([lat,lng], { 
      radius: radius,
      color: data.risk === 'Danger - Avoid' ? '#EF4444' : data.risk === 'Take caution' ? '#F59E0B' : data.risk === 'Calm - All clear' ? '#3b82f6' : '#10B981',
      fillColor: data.risk === 'Danger - Avoid' ? '#FEE2E2' : data.risk === 'Take caution' ? '#FEF3C7' : data.risk === 'Calm - All clear' ? '#dbeafe' : '#DCFCE7',
      fillOpacity: 0.35 
    }).addTo(map);

    const spot = {
      id: data.id,
      name: data.name || 'Swoop Spot',
      species: data.species || data.birdSpecies || '',
      lat, lng,
      address: data.address || '',
      radius: getRadiusByRisk(data.risk),
      risk: data.risk,
      reports: data.reports.slice(),
      safePassageCount: data.safePassageCount || 0,
      createdAt: data.createdAt,
      isPreseason: data.isPreseason || false, // Use the value from data, not undefined showPreseasonMsg
      marker, circle
    };

    // marker click shows quick alert (custom yellow box)
    marker.on('click', ()=> showSpotQuickAlert(spot));

    spots.push(spot);
    if(!skipSave) {
      saveAll(); // Save to localStorage
      saveSpotToSupabase(spot); // Sync to Supabase
    }
    renderAlerts();
    return spot;
  }

  function buildSpotPopup(s){
    return `<div class="text-sm"><b>${escapeHtml(s.name)}</b><br/>Species: ${escapeHtml(s.species)}<br/>Risk: ${escapeHtml(s.risk)}<br/>Reports: ${s.reports.length}</div>`;
  }

  // ----------------------------
  // Add new spot (create from createSpotFromData)
  // ----------------------------
  function handleCreateSpotFromForm(e){
    e.preventDefault();
    // validations - removed spot name from required fields since it's auto-generated
    const missing = [];
    if(!birdSpecies.value.trim()) missing.push('Bird species');
    if(selectedRBird.length===0) missing.push('Bird behaviour (initial report)');
    if(selectedRHuman.length===0) missing.push('Human behaviour (initial report)');
    if(selectedRPrec.length===0) missing.push('Precautions');
    if(!selectedLocation && !addressField.value.trim()) missing.push('Location (click map or enter address)');
    if(missing.length>0){ toast('Please complete: ' + missing.join(', ')); return; }

    (async ()=>{
      let latlng = null;
      // prefer address if provided
      if(addressField.value.trim()){
        try {
          addressInfo.textContent = 'Finding address...';
          const g = await geocodeAddress(addressField.value.trim());
          latlng = { lat: g.lat, lng: g.lng, display: g.display };
          addressInfo.textContent = `Found: ${g.display}`;
        } catch(err){
          addressInfo.textContent = 'Address not found â€” use map click instead';
          if(selectedLocation) latlng = selectedLocation;
          else { toast('Address not found and no map selection'); return; }
        }
      } else if(selectedLocation){
        latlng = selectedLocation;
      } else {
        toast('Please select a location');
        return;
      }

      // create initial report
      const report = {
        id: uid(),
        timestamp: getCurrentDate().toISOString(),
        birdBehaviour: selectedRBird.slice(),
        humanBehaviour: selectedRHuman.slice(),
        precautions: selectedRPrec.slice(),
        extra: reextra.value.trim(),
        alertLevel: computeAlertFromBirds(selectedRBird),
        user_id: currentUser?.id || null,
        created_by_name: currentUser ? (userProfile?.display_name || currentUser.email.split('@')[0]) : 'Anonymous'
      };

      // determine spot risk based on initial report (same immediate raise)
      const spotRisk = computeSpotRiskFromReports([report], birdSpecies.value);

      // Generate unique random name within 5km radius
      const birdName = getUniqueName(latlng.lat, latlng.lng);
      
      const spotData = {
        id: uid(),
        name: birdName,
        species: birdSpecies.value,
        lat: latlng.lat,
        lng: latlng.lng,
        address: latlng.display || addressField.value.trim() || '',
        radius: spotRisk === 'Danger - Avoid' ? 100 : spotRisk === 'Take caution' ? 80 : 50,
        risk: spotRisk,
        reports: [report],
        createdAt: getCurrentDate().toISOString() // Track creation date for lifecycle management
      };

      createSpotFromData(spotData, false);
      saveAll();
      
      // Increment user's spots and reports counters
      incrementUserSpotsCreated(); // +1 spot
      incrementUserReportsCreated(); // +1 report (the initial report)
      
      // Show success modal BEFORE resetting the form (so selectedRBird is still populated)
      showSuccessModal(birdName, birdSpecies.value, selectedRBird);
      
      closeSpotModalImmediate();
    })();
  }

  // compute new overall spot risk from array of reports
  function computeSpotRiskFromReports(reportsArray, species = ''){
    // Check if the spot should be auto-calmed (season ended + 10 days since last report)
    // Spots stay calm even when new season starts - only new reports change the risk
    if (shouldAutoCalm(reportsArray, species)) {
      return 'Calm - All clear';
    }
    
    // Filter to only current season reports OR recent reports (within 30 days)
    const season = SWOOPING_SEASONS[species];
    const now = getCurrentDate();
    const currentYear = now.getFullYear();
    const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
    let relevantReports = reportsArray;
    
    if (season) {
      const currentSeasonStart = new Date(currentYear, season.start - 1, 1);
      
      console.log(`ðŸ” Risk calc debug:`, {
        now: now.toISOString(),
        currentYear,
        currentMonth: now.getMonth() + 1,
        seasonStart: season.start,
        currentSeasonStart: currentSeasonStart.toISOString(),
        thirtyDaysAgo: thirtyDaysAgo.toISOString(),
        totalReports: reportsArray.length
      });
      
      // Include reports from current season OR any recent reports (within 30 days)
      // This ensures reports added just before season starts are counted
      relevantReports = reportsArray.filter(r => {
        const reportDate = new Date(r.timestamp);
        const isCurrentSeason = reportDate >= currentSeasonStart;
        const isRecent = reportDate >= thirtyDaysAgo;
        console.log(`  ðŸ“ Report: ${reportDate.toISOString()}, current season: ${isCurrentSeason}, recent: ${isRecent}`);
        return isCurrentSeason || isRecent;
      });
      
      console.log(`ðŸ” Risk calculation: ${reportsArray.length} total reports, ${relevantReports.length} relevant (current season or recent)`);
    }
    
    // If no relevant reports, return calm
    if (relevantReports.length === 0) {
      return 'Calm - All clear';
    }
    
    // Calculate risk based on most severe behavior reported
    
    // Highest priority: any contact (injured/uninjured) => Danger
    for(const r of relevantReports){
      if(Array.isArray(r.birdBehaviour) && (r.birdBehaviour.includes('made contact + injured') || r.birdBehaviour.includes('made contact + uninjured'))) return 'Danger - Avoid';
    }
    // Next: any close swoop
    for(const r of relevantReports){ if(Array.isArray(r.birdBehaviour) && r.birdBehaviour.includes('close swoop')) return 'Take caution'; }
    // else Low
    return 'Low risk';
  }

  // Check if a spot should be automatically marked as calm
  // Returns true if:
  // 1. Season has ended + 10 days since last report, OR
  // 2. New season started but no new reports yet (stays calm until proven active)
  function shouldAutoCalm(reportsArray, species) {
    if (!species) {
      console.log('âŒ shouldAutoCalm: No species');
      return false;
    }
    
    // Get the swooping season for this species
    const season = SWOOPING_SEASONS[species];
    if (!season) {
      console.log('âŒ shouldAutoCalm: No season data for', species);
      return false;
    }
    
    // Must have at least one report (from previous season) to be marked calm
    if (!reportsArray || reportsArray.length === 0) {
      console.log('âŒ shouldAutoCalm: No reports, cannot be calm');
      return false;
    }
    
    // Get current date and most recent report date
    const now = getCurrentDate();
    const currentMonth = now.getMonth() + 1;
    const currentYear = now.getFullYear();
    
    // Find the most recent report
    const sortedReports = [...reportsArray].sort((a, b) => 
      new Date(b.timestamp) - new Date(a.timestamp)
    );
    const lastReport = sortedReports[0];
    const lastReportDate = new Date(lastReport.timestamp);
    const daysSinceLastReport = Math.floor((now - lastReportDate) / (1000 * 60 * 60 * 24));
    
    console.log(`ðŸ” shouldAutoCalm: ${species}, current: ${currentMonth}/${currentYear}, season: ${season.start}-${season.end}, last report: ${daysSinceLastReport} days ago`);
    
    // Check if we're currently in the swooping season
    const isInSeason = currentMonth >= season.start && currentMonth <= season.end;
    
    if (isInSeason) {
      // We're in the active season - check if there are any reports from THIS season
      const currentSeasonStart = new Date(currentYear, season.start - 1, 1);
      const hasCurrentSeasonReports = reportsArray.some(r => new Date(r.timestamp) >= currentSeasonStart);
      
      if (hasCurrentSeasonReports) {
        // There are reports from this season - calculate risk normally
        console.log(`âŒ shouldAutoCalm: In season with current reports - calculate risk normally`);
        return false;
      } else {
        // In season but no reports yet this year - stay calm
        console.log(`âœ… shouldAutoCalm: In season but no new reports - staying calm`);
        return true;
      }
    }
    
    // We're outside the season - check if enough time has passed since last report
    if (daysSinceLastReport >= AUTO_CALM_DAYS) {
      console.log(`âœ… shouldAutoCalm: Outside season + ${daysSinceLastReport} days since last report - marking calm`);
      return true;
    }
    
    console.log(`âŒ shouldAutoCalm: Outside season but only ${daysSinceLastReport} days since last report (need ${AUTO_CALM_DAYS})`);
    return false;
  }
  
  
  // Check if a spot should be reactivated with pre-season warning
  // This controls the ENTRY ALERT (blue preventative tips when entering the zone)
  // Note: This is different from the EXIT FEEDBACK prompt for calm spots during season
  function shouldShowPreseasonWarning(reportsArray, species, createdAt) {
    if (!species) return false;
    
    const season = SWOOPING_SEASONS[species];
    if (!season) return false;
    
    const now = getCurrentDate();
    const currentMonth = now.getMonth() + 1;
    const currentYear = now.getFullYear();
    
    // Check if currently outside nesting season
    const isOutsideSeason = currentMonth > season.end || currentMonth < season.start;
    if (!isOutsideSeason) return false; // Currently in season, no pre-season warning needed
    
    // Calculate days until next season starts
    let daysUntilSeason;
    
    if (currentMonth < season.start) {
      // Season starts later this year
      const seasonStartDate = new Date(currentYear, season.start - 1, 1);
      daysUntilSeason = Math.floor((seasonStartDate - now) / (1000 * 60 * 60 * 24));
    } else {
      // Season starts next year (we're past the end of this year's season)
      const nextSeasonStartDate = new Date(currentYear + 1, season.start - 1, 1);
      daysUntilSeason = Math.floor((nextSeasonStartDate - now) / (1000 * 60 * 60 * 24));
    }
    
    // Show pre-season warning ENTRY ALERT if we're within 30 days of next season
    // BUT we're NOT too close (not within 4 days) - those get the exit feedback instead
    const isInPreseasonWindow = daysUntilSeason >= 4 && daysUntilSeason <= PRESEASON_WARNING_DAYS;
    
    console.log(`ðŸ“… shouldShowPreseasonWarning: ${species}, days until season: ${daysUntilSeason}, showing entry alert: ${isInPreseasonWindow}`);
    
    return isInPreseasonWindow;
  }
  
  // Get the month name when nesting season begins
  function getSeasonStartMonth(species) {
    const season = SWOOPING_SEASONS[species];
    if (!season) return 'Unknown';
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                        'July', 'August', 'September', 'October', 'November', 'December'];
    return monthNames[season.start - 1];
  }

  // ----------------------------
  // Details modal (feed) + add report
  // ----------------------------
  function openDetailsModal(spotId) {
    const s = spots.find(x => x.id === spotId);
    if(!s) return;
    activeDetailsSpotId = spotId;

    // Initialize new arrays for tag UI
    selectedReportBird = [];
    selectedReportHuman = [];
    selectedReportPrec = [];

    detailsModal.innerHTML = `
      <div class="rounded-lg w-full max-w-2xl mx-auto my-auto max-h-[95vh] overflow-y-auto relative" style="background-color: #f2eceb;">
        <div class="p-6">
          <!-- Header -->
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold" style="color: #422d1e;">${escapeHtml(s.name)}</h2>
            <button id="closeDetails" style="color: #422d1e; opacity: 0.7;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
          </div>

          <!-- Risk Level Banner -->
          <div class="mb-4 py-2 px-3 rounded ${
            s.risk === 'Danger - Avoid' ? 'bg-red-100 text-red-700' :
            s.risk === 'Take caution' ? 'bg-yellow-100 text-yellow-700' :
            s.risk === 'Calm - All clear' ? 'bg-blue-100 text-blue-700' :
            'bg-green-100 text-green-700'
          }">
            <div class="font-medium">${escapeHtml(s.risk)}</div>
            <div class="text-sm">${escapeHtml(s.species)} â€¢ ${s.reports.length} report${s.reports.length === 1 ? '' : 's'} â€¢ ${s.safePassageCount || 0} safe passage${(s.safePassageCount || 0) === 1 ? '' : 's'}</div>
          </div>

          <!-- Tabs -->
          <div style="border-bottom: 1px solid #d4cac7;">
            <nav class="flex -mb-px" role="tablist">
              <button data-tab="main" role="tab" class="tab-btn active mr-4 py-2 px-1 border-b-2 font-medium" style="border-color: #422d1e; color: #422d1e;">
                Main Info
              </button>
              <button data-tab="feed" role="tab" class="tab-btn mr-4 py-2 px-1 border-b-2 border-transparent" style="color: #422d1e; opacity: 0.6;" onmouseover="this.style.opacity='0.8'" onmouseout="this.classList.contains('active') || (this.style.opacity='0.6')">
                Reports Feed
              </button>
              <button data-tab="add" role="tab" class="tab-btn py-2 px-1 border-b-2 border-transparent" style="color: #422d1e; opacity: 0.6;" onmouseover="this.style.opacity='0.8'" onmouseout="this.classList.contains('active') || (this.style.opacity='0.6')">
                Add Report
              </button>
            </nav>
          </div>

          <!-- Tab Content -->
          <div class="mt-4">
            <!-- Main Info Tab -->
            <div id="mainTab" class="tab-content active" role="tabpanel">
              <div class="space-y-4">
                <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
                  <div class="flex items-start gap-4 mb-3">
                    <div class="flex-shrink-0">
                      ${getBirdIconSVG(s.risk)}
                    </div>
                    <div class="flex-1">
                      <h3 class="font-medium mb-1" style="color: #422d1e;">Location Details</h3>
                      <div class="text-sm space-y-2" style="color: #422d1e;">
                        <div><span style="opacity: 0.7;">Address:</span> ${s.address ? escapeHtml(s.address) : `${s.lat.toFixed(6)}, ${s.lng.toFixed(6)}`}</div>
                        <div><span style="opacity: 0.7;">Bird Species:</span> ${escapeHtml(s.species)}</div>
                        <div><span style="opacity: 0.7;">Total Reports:</span> ${s.reports.length}</div>
                        ${s.created_by_name ? `<div><span style="opacity: 0.7;">Created by:</span> ${escapeHtml(s.created_by_name)}</div>` : ''}
                      </div>
                    </div>
                  </div>
                </div>

                <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
                  <h3 class="font-medium mb-3" style="color: #422d1e;">Latest Report</h3>
                  <div id="latestReport" class="rounded p-3" style="background-color: #f2eceb; border: 1px solid #d4cac7;">
                    ${s.reports.length > 0 ? renderLatestReport(s.reports[s.reports.length - 1]) : '<p style="color: #422d1e; opacity: 0.7;">No reports yet</p>'}
                  </div>
                </div>

                <div class="mt-4 text-center">
                  <button class="text-white px-4 py-2 rounded add-report-btn" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                    Add New Report
                  </button>
                </div>
              </div>
            </div>

            <!-- Reports Feed Tab -->
            <div id="feedTab" class="tab-content hidden" role="tabpanel">
              <div class="space-y-3 max-h-[calc(100vh-300px)] overflow-y-auto">
                ${renderReportsFeedContent(s)}
              </div>
            </div>

            <!-- Add Report Tab -->
            <div id="addTab" class="tab-content hidden" role="tabpanel">
              <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
                <div class="mb-4 flex gap-3">
                  <button type="button" id="noBirdBtn" class="flex-1 px-4 py-2 rounded" style="background-color: #e8e2e1; color: #422d1e; border: 1px solid #d4cac7;" onmouseover="this.style.backgroundColor='#dcd6d5'" onmouseout="this.style.backgroundColor='#e8e2e1'">
                    No Birds Spotted
                  </button>
                  <button type="button" id="addReportBtn" class="flex-1 px-4 py-2 text-white rounded" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                    Report Bird Activity
                  </button>
                </div>

                <form id="reportForm" class="hidden space-y-4">
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Bird Behaviour <span class="text-red-500">*</span></label>
                    <div class="relative">
                      <div id="rbirdBox2" class="tag-box"></div>
                      <div id="rbirdList2" class="tag-list"></div>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Human Behaviour <span class="text-red-500">*</span></label>
                    <div class="relative">
                      <div id="rhumanBox2" class="tag-box"></div>
                      <div id="rhumanList2" class="tag-list"></div>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Precautions <span class="text-red-500">*</span></label>
                    <div class="relative">
                      <div id="rprecBox2" class="tag-box"></div>
                      <div id="rprecList2" class="tag-list"></div>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Alert Level (auto-set)</label>
                    <input type="text" id="repAlertLevel" class="w-full rounded p-2" style="border: 1px solid #d4cac7; background-color: #e8e2e1; color: #422d1e;" readonly>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Extra Notes</label>
                    <textarea id="repExtra" class="w-full rounded p-2 h-20" style="border: 1px solid #d4cac7; background-color: #f2eceb; color: #422d1e;"></textarea>
                  </div>
                  <div class="flex justify-end gap-2">
                    <button type="button" id="reportCancel" class="px-4 py-2 rounded" style="border: 1px solid #d4cac7; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='transparent'">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-white rounded" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Submit Report</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    // Set up event handlers after the modal content is created
    detailsModal.querySelector('#closeDetails').addEventListener('click', () => {
      detailsModal.classList.add('hidden');
      activeDetailsSpotId = null;
    });

    // Tab switching
    detailsModal.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        switchTab(btn.dataset.tab);
      });
    });

    // Add report buttons
    detailsModal.querySelectorAll('.add-report-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        switchTab('add');
      });
    });

    // No bird button
    detailsModal.querySelector('#noBirdBtn').addEventListener('click', () => {
      // Check if user is signed in
      if (!currentUser) {
        toast('Please sign in to mark safe passages', 2000);
        authModal.classList.remove('hidden');
        document.body.classList.add('modal-open');
        detailsModal.classList.add('hidden');
        return;
      }
      
      // Just increment the safe passage counter
      if (!s.safePassageCount) s.safePassageCount = 0;
      s.safePassageCount++;
      s.lastSafePassage = getCurrentDate().toISOString();
      
      saveAll();
      
      // Save to Supabase if sync is enabled
      if (syncEnabled && currentUser) {
        console.log('ðŸ’¾ Syncing safe passage count to Supabase for spot:', s.name);
        saveSpotToSupabase(s);
      }
      
      // Increment user's safe passage count in profile
      incrementUserSafePassages();
      
      // Close the details modal
      detailsModal.classList.add('hidden');
      
      // Show success modal for safe passage
      showSafePassageModal(s.name, s.risk);
    });

    // Report form handling
    const addReportBtn = detailsModal.querySelector('#addReportBtn');
    const reportForm = detailsModal.querySelector('#reportForm');
    
    addReportBtn.addEventListener('click', () => {
      reportForm.classList.remove('hidden');
      addReportBtn.classList.add('hidden');
      detailsModal.querySelector('#noBirdBtn').classList.add('hidden');
      
      // Get the tag UI elements
      const rbirdBox2 = detailsModal.querySelector('#rbirdBox2');
      const rbirdList2 = detailsModal.querySelector('#rbirdList2');
      const rhumanBox2 = detailsModal.querySelector('#rhumanBox2');
      const rhumanList2 = detailsModal.querySelector('#rhumanList2');
      const rprecBox2 = detailsModal.querySelector('#rprecBox2');
      const rprecList2 = detailsModal.querySelector('#rprecList2');
      const repAlertLevel = detailsModal.querySelector('#repAlertLevel');
      
      // Reset and set up tag UIs
      selectedReportBird = [];
      selectedReportHuman = [];
      selectedReportPrec = [];
      
      setupTagUI(rbirdBox2, rbirdList2, BIRD_BEHAVIOURS, selectedReportBird, () => {
        repAlertLevel.value = computeAlertFromBirds(selectedReportBird);
      });
      setupTagUI(rhumanBox2, rhumanList2, HUMAN_BEHAVIOURS, selectedReportHuman, ()=>{});
      setupTagUI(rprecBox2, rprecList2, PRECAUTIONS, selectedReportPrec, ()=>{});
      
      repAlertLevel.value = 'Low risk';
    });

    const reportCancel = detailsModal.querySelector('#reportCancel');
    reportCancel.addEventListener('click', () => {
      reportForm.classList.add('hidden');
      addReportBtn.classList.remove('hidden');
      detailsModal.querySelector('#noBirdBtn').classList.remove('hidden');
      
      // Reset form and tag arrays
      selectedReportBird = [];
      selectedReportHuman = [];
      selectedReportPrec = [];
      
      const repExtra = detailsModal.querySelector('#repExtra');
      const repAlertLevel = detailsModal.querySelector('#repAlertLevel');
      
      if (repExtra) repExtra.value = '';
      if (repAlertLevel) repAlertLevel.value = 'Low risk';
    });

    // Set up tag UIs - Note: these are set up when the "Report Bird Activity" button is clicked
    // to ensure they use the correct DOM elements from the modal

    // Show modal
    detailsModal.classList.remove('hidden');
    document.body.classList.add('modal-open');

    // Set up form submission
    reportForm.addEventListener('submit', handleAddReport);
  }

  function renderLatestReport(report) {
    if (!report) return '<p class="text-gray-500">No reports yet</p>';
    
    const level = report.alertLevel || computeAlertFromBirds(report.birdBehaviour || []);
    const levelClass = level === 'Danger - Avoid' ? 'text-red-600' : 
                      level === 'Take caution' ? 'text-yellow-600' : 
                      'text-green-600';
    
    return `
      <div class="space-y-2">
        <div class="font-medium ${levelClass}">${escapeHtml(level)}</div>
        <div class="text-sm text-gray-600">
          ${new Date(report.timestamp).toLocaleString()}
          ${report.created_by_name ? ` â€¢ Reported by ${escapeHtml(report.created_by_name)}` : ''}
        </div>
        <div class="text-sm"><b>Bird behavior:</b> ${escapeHtml((report.birdBehaviour||[]).join(', '))}</div>
        <div class="text-sm"><b>Human activity:</b> ${escapeHtml((report.humanBehaviour||[]).join(', '))}</div>
        <div class="text-sm"><b>Precautions:</b> ${escapeHtml((report.precautions||[]).join(', '))}</div>
        ${report.extra ? `<div class="text-sm mt-1"><b>Notes:</b> ${escapeHtml(report.extra)}</div>` : ''}
      </div>
    `;
  }

  function renderReportsFeedContent(spot) {
    if (!spot.reports || spot.reports.length === 0) {
      return `
        <div class="text-center py-8 text-gray-500">
          No reports yet. Be the first to report bird activity at this location!
        </div>
        <div class="mt-4 text-center">
          <button class="text-white px-4 py-2 rounded add-report-btn" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
            Add Report
          </button>
        </div>
      `;
    }

    return `
      <div class="space-y-4">
        ${spot.reports.slice().reverse().map(report => {
          const level = report.alertLevel || computeAlertFromBirds(report.birdBehaviour || []);
          const cls = level === 'Danger - Avoid' ? 'border-red-500' : 
                     level === 'Take caution' ? 'border-yellow-500' : 
                     'border-green-500';
          const textColor = level === 'Danger - Avoid' ? 'text-red-600' : 
                           level === 'Take caution' ? 'text-yellow-600' : 
                           'text-green-600';

          return `
            <div class="p-3 rounded bg-white border-l-4 shadow-sm ${cls}">
              <div class="flex justify-between items-start mb-2">
                <div class="font-medium ${textColor}">${escapeHtml(level)}</div>
                <div class="text-xs text-gray-500">
                  ${new Date(report.timestamp).toLocaleString()}
                  ${report.created_by_name ? `<br>by ${escapeHtml(report.created_by_name)}` : ''}
                </div>
              </div>
              <div class="space-y-2">
                <div class="text-sm">
                  <span class="font-medium">Bird Activity:</span> 
                  ${escapeHtml((report.birdBehaviour||[]).join(', ')||'N/A')}
                </div>
                <div class="text-sm">
                  <span class="font-medium">Human Activity:</span> 
                  ${escapeHtml((report.humanBehaviour||[]).join(', ')||'N/A')}
                </div>
                <div class="text-sm">
                  <span class="font-medium">Precautions:</span> 
                  ${escapeHtml((report.precautions||[]).join(', ')||'None')}
                </div>
                ${report.extra ? `
                  <div class="text-sm pt-1 border-t">
                    <span class="font-medium">Notes:</span><br>
                    ${escapeHtml(report.extra)}
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }).join('')}
      </div>
      <div class="mt-4 text-center">
        <button class="text-white px-4 py-2 rounded add-report-btn" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
          Add New Report
        </button>
      </div>
    `;
  }

  function switchTab(tabId) {
    const tabButtons = detailsModal.querySelectorAll('.tab-btn');
    const tabContents = detailsModal.querySelectorAll('.tab-content');

    // Update all tab buttons with inline styles
    tabButtons.forEach(btn => {
      if (btn.dataset.tab === tabId) {
        btn.classList.add('active');
        btn.style.borderColor = '#422d1e';
        btn.style.color = '#422d1e';
        btn.style.opacity = '1';
      } else {
        btn.classList.remove('active');
        btn.style.borderColor = 'transparent';
        btn.style.color = '#422d1e';
        btn.style.opacity = '0.6';
      }
    });

    // Update all tab contents
    tabContents.forEach(content => {
      if (content.id === `${tabId}Tab`) {
        content.classList.add('active');
        content.classList.remove('hidden');
      } else {
        content.classList.remove('active');
        content.classList.add('hidden');
      }
    });
  }

  // ----------------------------
  // Create spot modal flow controls
  // ----------------------------
  openAddBtn.addEventListener('click', (e)=>{
    e.stopPropagation(); // Prevent click from propagating to map
    openCreateSpotModal();
  });

  // Add event listener for the button below the map
  const addSpotBelowMap = document.getElementById('addSpotBelowMap');
  addSpotBelowMap.addEventListener('click', ()=>{
    openCreateSpotModal();
  });

  function openCreateSpotModal(){
    // Check if user is logged in
    if (!currentUser) {
      toast('Please sign in to create spots', 2000);
      authModal.classList.remove('hidden');
      return;
    }
    
    // reset all form fields and state
    selectedLocation = null;
    if(tempMarker) try{ map.removeLayer(tempMarker); } catch(e){}
    tempMarker = null;
    
    // Show modal
    spotModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
    
    // Set default location to map center
    const center = map.getCenter();
    selectedLocation = { lat: center.lat, lng: center.lng };
    coordsField.value = `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
    addressInfo.textContent = 'Using map center. Click the map to change location or enter an address.';
    tempMarker = L.marker([selectedLocation.lat, selectedLocation.lng]).addTo(map);
    
    // Reset all form fields
    birdSpecies.value = 'Magpie';
    addressField.value = '';
    selectedRBird = []; 
    selectedRHuman = []; 
    selectedRPrec = [];
    reextra.value = '';
    ralertLevel.value = 'Low risk';
    
    // Clear any suggestion lists
    const addressSuggestions = document.getElementById('addressField_suggestions');
    if(addressSuggestions) addressSuggestions.innerHTML = '';
    
    // Reset tag UIs
    setupTagUI(rbirdBox, rbirdList, BIRD_BEHAVIOURS, selectedRBird, updateRAlertFromBirds);
    setupTagUI(rhumanBox, rhumanList, HUMAN_BEHAVIOURS, selectedRHuman, ()=>{});
    setupTagUI(rprecBox, rprecList, PRECAUTIONS, selectedRPrec, ()=>{});
    
    // Capture clean state for dirty checking
    initialFormState = captureSpotFormState();
  }

  // Close button in the modal header
  closeSpotModal.addEventListener('click', ()=> {
    spotModal.classList.add('hidden');
    closeSpotModalImmediate();
  });

  // Cancel button in the form
  spotCancel.addEventListener('click', ()=> {
    spotModal.classList.add('hidden');
    closeSpotModalImmediate();
  });

  function closeSpotModalImmediate(){
    // Hide the modal
    spotModal.classList.add('hidden');
    document.body.classList.remove('modal-open');
    
    // Clean up map
    if(tempMarker) {
      try { 
        map.removeLayer(tempMarker); 
      } catch(e){}
      tempMarker = null;
    }
    
    // Reset state
    selectedLocation = null;
    selectedRBird = [];
    selectedRHuman = [];
    selectedRPrec = [];
    
    // Clear any suggestion lists
    const addressSuggestions = document.getElementById('addressField_suggestions');
    if(addressSuggestions) addressSuggestions.innerHTML = '';
    
    // Reset form fields
    birdSpecies.value = 'Magpie';
    addressField.value = '';
    coordsField.value = '';
    addressInfo.textContent = '';
    reextra.value = '';
    ralertLevel.value = 'Low risk';
    
    // Reset tag UIs
    setupTagUI(rbirdBox, rbirdList, BIRD_BEHAVIOURS, selectedRBird, updateRAlertFromBirds);
    setupTagUI(rhumanBox, rhumanList, HUMAN_BEHAVIOURS, selectedRHuman, ()=>{});
    setupTagUI(rprecBox, rprecList, PRECAUTIONS, selectedRPrec, ()=>{});
  }

  function captureSpotFormState(){
    return {
      species: birdSpecies.value||'',
      addr: addressField.value||'',
      coords: coordsField.value||'',
      rbird: selectedRBird.slice(),
      rhuman: selectedRHuman.slice(),
      rprec: selectedRPrec.slice(),
      ralert: ralertLevel.value||'',
      extra: reextra.value||''
    };
  }
  function spotFormIsDirty(){ return JSON.stringify(captureSpotFormState()) !== JSON.stringify(initialFormState); }

  // Set up address auto-complete
  addressField.addEventListener('input', () => {
    debouncedAddressLookup(addressField);
  });

  // geo locate - Find Me button
  geoBtn.addEventListener('click', ()=>{
    if(!navigator.geolocation) {
      toast('Geolocation is not supported by your browser');
      addressInfo.textContent = 'Geolocation not supported';
      return;
    }
    
    // Show loading state
    addressInfo.textContent = 'Getting your location...';
    
    navigator.geolocation.getCurrentPosition(
      // Success callback
      p => {
        selectedLocation = { lat: p.coords.latitude, lng: p.coords.longitude };
        coordsField.value = `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
        addressInfo.textContent = 'Located device coordinates successfully';
        if(tempMarker) try{ map.removeLayer(tempMarker); } catch(e){}
        tempMarker = L.marker([selectedLocation.lat, selectedLocation.lng]).addTo(map);
        map.setView([selectedLocation.lat, selectedLocation.lng], 16);
      }, 
      // Error callback
      err => {
        console.error('Geolocation error:', err);
        let errorMsg = '';
        
        switch(err.code) {
          case err.PERMISSION_DENIED:
            errorMsg = 'Location permission denied. Please enable location access in your browser settings.';
            break;
          case err.POSITION_UNAVAILABLE:
            errorMsg = 'Location information unavailable. Please check your device settings.';
            break;
          case err.TIMEOUT:
            errorMsg = 'Location request timed out. Please try again.';
            break;
          default:
            errorMsg = err.message || 'Unknown error occurred';
        }
        
        addressInfo.textContent = errorMsg;
        toast('GPS error: ' + errorMsg, 4000);
      },
      // Options
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  });

  // submit create spot
  spotForm.addEventListener('submit', handleCreateSpotFromForm);

  // ----------------------------
  // Save + load helpers (use createSpotFromData to add)
  // ----------------------------
  function createSpotFromUIObject(obj){
    // convert UI object to spot data and call createSpotFromData
    createSpotFromData(obj, false);
    saveAll();
    renderAlerts();
  }

  // ----------------------------
  // Render alerts list (1km from map center)
  // ----------------------------
  function renderAlerts(){
    alertsList.innerHTML = '';
    const center = map.getCenter();
    spots.forEach(s=>{
      const d = metersBetween(center.lat, center.lng, s.lat, s.lng);
      if(d <= 1000){
        const item = document.createElement('div');
        // Color code based on risk level
        const borderColor = s.risk === 'Danger - Avoid' ? 'border-red-400 bg-red-50' : 
                          s.risk === 'Take caution' ? 'border-yellow-400 bg-yellow-50' : 
                          s.risk === 'Calm - All clear' ? 'border-blue-400 bg-blue-50' :
                          'border-green-400 bg-green-50';
        const textColor = s.risk === 'Danger - Avoid' ? 'text-red-700' : 
                         s.risk === 'Take caution' ? 'text-yellow-700' : 
                         s.risk === 'Calm - All clear' ? 'text-blue-700' :
                         'text-green-700';
        
        item.className = `border-2 p-2 rounded text-sm cursor-pointer hover:opacity-90 flex justify-between items-center ${borderColor}`;
        item.innerHTML = `
          <div>
            <b>${escapeHtml(s.name)}</b>
            <div class="text-xs text-gray-600">${escapeHtml(s.species)}</div>
            <div class="text-xs font-medium ${textColor}">${escapeHtml(s.risk)}</div>
          </div>
          <div class="text-xs text-gray-500">${(d/1000).toFixed(2)} km</div>
        `;
        item.addEventListener('click', ()=> {
          map.setView([s.lat, s.lng], 16);
          showSpotQuickAlert(s);
        });
        alertsList.appendChild(item);
      }
    });
    
    // Update stats whenever alerts are rendered
    if (typeof renderStats === 'function') {
      renderStats(currentStatsPeriod);
    }
  }
  map.on('moveend', ()=> renderAlerts());

  // ----------------------------
  // Stats calculation and rendering
  // ----------------------------
  let currentStatsPeriod = 'today'; // 'today', 'week', 'season'
  
  async function calculateStats(period = 'today') {
    const now = getCurrentDate();
    const stats = {
      totalReports: 0,
      injuries: 0,
      species: {}
    };
    
    // Define time boundaries
    let startDate;
    if (period === 'today') {
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    } else if (period === 'week') {
      startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    } else if (period === 'season') {
      // Current swooping season (August to November for most birds)
      const currentMonth = now.getMonth() + 1;
      if (currentMonth >= 8) {
        startDate = new Date(now.getFullYear(), 7, 1); // August 1st this year
      } else {
        startDate = new Date(now.getFullYear() - 1, 7, 1); // August 1st last year
      }
    }
    
    // Get ALL reports from ALL spots in database (not just current view)
    try {
      const { data: allReports, error: reportsError } = await supabase
        .from('reports')
        .select(`
          id,
          timestamp,
          bird_behaviour,
          spots!inner (
            species
          )
        `)
        .gte('timestamp', startDate.toISOString());
      
      if (!reportsError && allReports) {
        stats.totalReports = allReports.length;
        
        // Count by species
        allReports.forEach(report => {
          const species = report.spots?.species;
          if (species) {
            if (!stats.species[species]) {
              stats.species[species] = 0;
            }
            stats.species[species]++;
          }
          
          // Count injuries
          if (report.bird_behaviour && 
              report.bird_behaviour.includes('made contact + injured')) {
            stats.injuries++;
          }
        });
      }
    } catch (error) {
      console.error('Error fetching reports:', error);
    }
    
    return stats;
  }
  
  // ----------------------------
  // NOTE: renderStats() function removed - stats now only rendered in Stats Modal
  // ----------------------------

  // ----------------------------
  // NOTE: Activity Stats removed from home page - now only in Stats Modal
  // ----------------------------

  // ----------------------------
  // Open / close details modal
  // ----------------------------
  closeDetails.addEventListener('click', ()=> {
    detailsModal.classList.add('hidden');
    document.body.classList.remove('modal-open');
    activeDetailsSpotId = null;
    // cleanup UI arrays
    selectedReportBird = []; selectedReportHuman = []; selectedReportPrec = [];
    
    // If there are still spots to address in the exit prompt, show it again
    if(spotsToAddress.length > 0) {
      exitPromptModal.classList.remove('hidden');
      document.body.classList.add('modal-open');
    } else if (exitPromptModal && !exitPromptModal.classList.contains('hidden')) {
      // If all spots are addressed and the exit prompt was open, close it with a thank you message
      exitPromptModal.classList.add('hidden');
      document.body.classList.remove('modal-open');
      toast('All spots addressed! Thank you for your feedback.', 2000);
    }
  });

  // report form handlers
  function handleAddReport(e) {
    e.preventDefault();
    if(!activeDetailsSpotId) return;
    
    const s = spots.find(x => x.id === activeDetailsSpotId);
    if(!s) return;
    
    // Validate required fields
    if(selectedReportBird.length === 0 || selectedReportHuman.length === 0 || selectedReportPrec.length === 0) {
      toast('Please complete all required fields');
      return;
    }
    
    // Get repExtra from the modal (not the static DOM reference)
    const repExtraField = detailsModal.querySelector('#repExtra');
    
    // Create new report
    const rep = {
      id: uid(),
      timestamp: getCurrentDate().toISOString(),
      birdBehaviour: selectedReportBird.slice(),
      humanBehaviour: selectedReportHuman.slice(),
      precautions: selectedReportPrec.slice(),
      extra: repExtraField ? repExtraField.value.trim() : '',
      alertLevel: computeAlertFromBirds(selectedReportBird),
      user_id: currentUser?.id || null,
      created_by_name: currentUser ? (userProfile?.display_name || currentUser.email.split('@')[0]) : 'Anonymous'
    };
    
    // Add report to spot
    s.reports.push(rep);
    
    // Recompute overall spot risk
    const newRisk = computeSpotRiskFromReports(s.reports, s.species);
    const oldIsPreseason = s.isPreseason;
    const riskChanged = newRisk !== s.risk;
    
    // Update spot risk
    s.risk = newRisk;
    
    // ALWAYS clear isPreseason flag when a new report is added
    // A new report means we're no longer in pre-season warning mode
    s.isPreseason = false;
    console.log(`ðŸ”§ CLEARED isPreseason flag for ${s.name}: risk=${newRisk}, isPreseason=${s.isPreseason}, oldIsPreseason=${oldIsPreseason}`);
    
    // ALWAYS update the marker when a report is added (don't rely on flag comparison)
    // This ensures the icon reflects the current state
    console.log(`ðŸŽ¨ Updating marker for ${s.name}: risk=${newRisk}, isPreseason=${s.isPreseason}`);
    
    // Update marker icon and circle
    try {
      map.removeLayer(s.marker);
      map.removeLayer(s.circle);
    } catch(e){
      console.error('Error removing old marker:', e);
    }
    
    s.marker = L.marker([s.lat, s.lng], { icon: getBirdIcon(newRisk, s.isPreseason) }).addTo(map);
    s.marker.on('click', ()=> showSpotQuickAlert(s));
    
    const radius = getRadiusByRisk(newRisk);
    s.radius = radius;
    s.circle = L.circle([s.lat, s.lng], { 
      radius: radius,
      color: newRisk === 'Danger - Avoid' ? '#EF4444' : newRisk === 'Take caution' ? '#F59E0B' : newRisk === 'Calm - All clear' ? '#3b82f6' : '#10B981',
      fillColor: newRisk === 'Danger - Avoid' ? '#FEE2E2' : newRisk === 'Take caution' ? '#FEF3C7' : newRisk === 'Calm - All clear' ? '#dbeafe' : '#DCFCE7',
      fillOpacity: 0.35 
    }).addTo(map);
    
    saveAll(); // Save to localStorage
    saveSpotToSupabase(s); // Sync to Supabase
    
    console.log(`ðŸ“ After save: spot ${s.name} isPreseason=${s.isPreseason}, risk=${s.risk}`);
    console.log(`ðŸ“ Spot object:`, { id: s.id, name: s.name, risk: s.risk, isPreseason: s.isPreseason, reports: s.reports.length });
    
    // Remove this spot from visitedSpots to prevent calm feedback prompt after reporting
    if (visitedSpots.has(s.id)) {
      visitedSpots.delete(s.id);
      console.log(`ðŸ—‘ï¸ Removed ${s.name} from visitedSpots - no feedback prompt after updating`);
    }
    
    // Mark this spot as already reported this journey - won't be re-added to visitedSpots
    alreadyReportedThisJourney.add(s.id);
    console.log(`âœ… Added ${s.name} to alreadyReportedThisJourney - won't trigger feedback if still in zone`);
    
    // Increment user's reports counter
    incrementUserReportsCreated();
    
    // Suppress alerts for this spot for 10 seconds (user just reported it)
    recentlyReportedSpots.add(s.id);
    setTimeout(() => {
      recentlyReportedSpots.delete(s.id);
    }, 10000);
    
    // Show success modal with bird behavior context (isNewSpot=false for additional reports)
    showSuccessModal(s.name, s.species, selectedReportBird, false);
    
    // Remove from spots to address if it was in the exit prompt
    spotsToAddress = spotsToAddress.filter(spot => spot.id !== s.id);
    
    // Close the details modal
    detailsModal.classList.add('hidden');
    activeDetailsSpotId = null;
    
    // Clear the report form state
    selectedReportBird = [];
    selectedReportHuman = [];
    selectedReportPrec = [];
  }
  
  reportForm.addEventListener('submit', handleAddReport);
  reportCancel.addEventListener('click', ()=> {
    if(confirm('Cancel new report?')) {
      // Reset form
      selectedReportBird = []; 
      selectedReportHuman = []; 
      selectedReportPrec = [];
      setupTagUI(rbirdBox2, rbirdList2, BIRD_BEHAVIOURS, selectedReportBird, updateRepAlertFromBirds);
      setupTagUI(rhumanBox2, rhumanList2, HUMAN_BEHAVIOURS, selectedReportHuman, ()=>{});
      setupTagUI(rprecBox2, rprecList2, PRECAUTIONS, selectedReportPrec, ()=>{});
      repExtra.value = '';
      repAlertLevel.value = 'Low risk';
      
      // Switch back to main tab
      const mainTab = detailsModal.querySelector('[data-tab="main"]');
      const mainContent = detailsModal.querySelector('#mainTab');
      if(mainTab && mainContent) {
        detailsModal.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-blue-500', 'border-blue-500'));
        detailsModal.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        mainTab.classList.add('active', 'text-blue-500', 'border-blue-500');
        mainContent.classList.remove('hidden');
      }
    }
  });

  // ----------------------------
  // checkLocation - shows userMarker and center alert if within any spot
  // ----------------------------
  let currentAlertSpots = []; // Track currently displayed alert spots (non-dismissed threats)
  let allCurrentSpots = []; // Track ALL spots we're currently in (including dismissed ones)
  let visitedSpots = new Set(); // Track spots visited during current journey
  let hasShownCalmFeedback = false; // Track if we've already shown calm feedback this journey
  let recentlyReportedSpots = new Set(); // Track spots user just reported to prevent immediate alerts
  let alreadyReportedThisJourney = new Set(); // Track spots we've reported on during this journey (won't trigger feedback)
  
  function checkLocation(lat,lng){
    console.log('ðŸŽ¯ checkLocation called:', { lat, lng, timestamp: new Date().toISOString() });
    
    if(userMarker){ 
      try{ 
        userMarker.setLatLng([lat,lng]); 
        // Update icon in case profile changed (e.g., user signed in or changed avatar)
        userMarker.setIcon(getUserIcon());
      } catch(e){} 
    } else { 
      userMarker = L.marker([lat,lng], { icon: getUserIcon() }).addTo(map); 
    }
    
    // Find all spots the user is currently inside
    let insideSpots = [];
    for(const s of spots){
      if(metersBetween(lat,lng,s.lat,s.lng) <= (s.radius || 150)){ 
        insideSpots.push(s);
        // Only track as visited if we haven't already reported on it this journey
        if (!alreadyReportedThisJourney.has(s.id)) {
          visitedSpots.add(s.id); // Track that we've been in this spot
        }
      }
    }
    
    console.log('ðŸ“ Inside spots:', insideSpots.map(s => `${s.name} (${s.risk})`));
    
    // Filter out calm birds from alerts - they're preventative info, not danger warnings
    // Users can still see them on the map and click for info
    // Also filter out spots the user just reported on (suppress alert for 10 seconds)
    const activeThreats = insideSpots.filter(s => 
      s.risk !== 'Calm - All clear' && 
      !recentlyReportedSpots.has(s.id)
    );
    
    console.log('âš ï¸ Active threats (after filtering):', {
      count: activeThreats.length,
      spots: activeThreats.map(s => s.name),
      recentlyReported: Array.from(recentlyReportedSpots)
    });
    
    // Track ALL non-calm spots we're currently in (for exit detection)
    // This includes dismissed ones, unlike activeThreats
    const allNonCalmSpots = insideSpots.filter(s => s.risk !== 'Calm - All clear');
    
    // ALWAYS update allCurrentSpots (even when activeThreats is empty due to dismissal)
    // This is critical for proper exit detection
    allCurrentSpots = allNonCalmSpots;
    
    // Sort by risk level (highest first) for display
    if(activeThreats.length > 0){
      activeThreats.sort((a,b) => {
        const riskOrder = {'Danger - Avoid': 3, 'Take caution': 2, 'Low risk': 1};
        return (riskOrder[b.risk] || 0) - (riskOrder[a.risk] || 0);
      });
    }
    
    if(activeThreats.length > 0){
      // Check if the spots have changed (only show alert if entering NEW zones)
      const currentIds = currentAlertSpots.map(s => s.id).sort().join(',');
      const newIds = activeThreats.map(s => s.id).sort().join(',');
      
      console.log('ðŸ” Zone change check:', {
        currentIds,
        newIds,
        areEqual: currentIds === newIds,
        currentAlertSpots: currentAlertSpots.map(s => s.name),
        activeThreats: activeThreats.map(s => s.name),
        isMinimized: alertBox.classList.contains('minimized')
      });
      
      // Only show alert if we're entering different zones
      if(currentIds !== newIds){
        console.log('ðŸ†• Zone change detected - showing alert');
        
        // New journey starting - reset flags
        hasShownCalmFeedback = false;
        
        // Show the alert for the new zones (restore from minimized if needed)
        showCenteredAlert(activeThreats);
        
        // Update currentAlertSpots to match the new zones
        currentAlertSpots = activeThreats;
      } else if (alertBox.classList.contains('minimized')) {
        console.log('ï¿½ Alert minimized - keeping it minimized');
        // Keep the minimized state, don't update currentAlertSpots
      } else {
        console.log('â¸ï¸ Still in same zones - no alert needed');
        // Update currentAlertSpots to keep tracking
        currentAlertSpots = activeThreats;
      }
    } else {
      // User has exited ALL active threat zones
      // Check allCurrentSpots (which includes all non-calm) to see if we truly exited
      if(allCurrentSpots.length > 0){
        // User is STILL IN ZONES but no active threats (all calm or recently reported)
        // Just keep the tracking active, don't trigger exit
        console.log('ðŸ”• No active threats but user still in zones');
        // Only clear/hide if alert is not minimized
        if (!alertBox.classList.contains('minimized')) {
          currentAlertSpots = [];
          hideCenteredAlert();
        }
      } else {
        // User has TRULY EXITED all zones (allCurrentSpots is empty)
        // Now check if they were visiting active threat spots or calm spots
        const spotsToReport = Array.from(visitedSpots).map(id => spots.find(s => s.id === id)).filter(Boolean);
        
        // Separate active threats from calm spots
        const activeSpotsToReport = spotsToReport.filter(s => s.risk !== 'Calm - All clear');
        
        if(activeSpotsToReport.length > 0) {
          // They visited active threat spots - show exit prompt
          allCurrentSpots = [];
          hideCenteredAlert();
          
          // Play happy tone when exiting all zones
          playHappyTone();
          
          showExitPrompt(activeSpotsToReport);
          
          // Clear ALL journey tracking when exiting
          visitedSpots.clear();
          alreadyReportedThisJourney.clear();
          hasShownCalmFeedback = false;
        } else {
          // They only visited calm spots (or no spots) - check for calm feedback
          allCurrentSpots = [];
          hideCenteredAlert();
        
          // Check if user just exited a calm spot during/near active season - ask for feedback!
          // Only show once per journey!
          if (!hasShownCalmFeedback) {
            const spotsToReport = Array.from(visitedSpots).map(id => spots.find(s => s.id === id)).filter(Boolean);
            console.log('ðŸ” Spots visited during journey:', spotsToReport.length, spotsToReport.map(s => `${s.name} (${s.risk})`));
            
            const calmSpotsNeedingFeedback = spotsToReport.filter(s => {
            if (s.risk !== 'Calm - All clear') {
              console.log(`â­ï¸ Skipping ${s.name} - not calm (${s.risk})`);
              return false;
            }
            
            // Check if we're currently in the swooping season OR within first 30 days of season
            const season = SWOOPING_SEASONS[s.species];
            if (!season) {
              console.log(`â­ï¸ Skipping ${s.name} - no season data for ${s.species}`);
              return false;
            }
            
            const now = getCurrentDate();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();
            
            // Calculate when this season starts
            let seasonStartDate;
            if (currentMonth <= season.end) {
              // Season might be this year
              seasonStartDate = new Date(currentYear, season.start - 1, 1);
            } else {
              // Season is next year
              seasonStartDate = new Date(currentYear + 1, season.start - 1, 1);
            }
            
            // Calculate days until/since season started
            const daysFromSeasonStart = Math.floor((now - seasonStartDate) / (1000 * 60 * 60 * 24));
            
            // Ask for feedback if:
            // 1. We're within 30 days BEFORE season starts (pre-season check), OR
            // 2. We're within first 60 days of the season (early season check)
            const isPreSeason = daysFromSeasonStart >= -30 && daysFromSeasonStart < 0;
            const isEarlySeason = daysFromSeasonStart >= 0 && daysFromSeasonStart <= 60;
            
            console.log(`ðŸ¦ Calm spot feedback check: ${s.name} (${s.species}), days from season start: ${daysFromSeasonStart}, pre-season: ${isPreSeason}, early-season: ${isEarlySeason}`);
            
            return isPreSeason || isEarlySeason;
          });
          
          console.log('ðŸ” Calm spots needing feedback:', calmSpotsNeedingFeedback.length);
          
          if (calmSpotsNeedingFeedback.length > 0) {
            hasShownCalmFeedback = true; // Mark that we've shown it BEFORE calling the function
            console.log('ðŸš« Setting hasShownCalmFeedback = true to prevent duplicates');
            showCalmSpotFeedbackPrompt(calmSpotsNeedingFeedback);
            
            // Clear visitedSpots immediately to prevent duplicate modals on next GPS update
            console.log('âœ… Modal shown - clearing visitedSpots to prevent duplicates');
            visitedSpots.clear();
            return; // Exit early
          } else {
            console.log('âŒ No calm spots need feedback at this time');
          }
          
          // Clear journey tracking when exiting all zones
          visitedSpots.clear();
          alreadyReportedThisJourney.clear();
          hasShownCalmFeedback = false;
        } else {
          console.log('ðŸš« hasShownCalmFeedback is already true - skipping check');
          // Clear visited spots since we're not showing a modal and journey is over
          visitedSpots.clear();
          alreadyReportedThisJourney.clear();
        }
        
        // Journey tracking cleared above
        }
      }
    }
    renderAlerts();
  }

  // Prompt user after exiting all swoop zones
  let spotsToAddress = []; // Track spots that still need to be addressed
  
  function showExitPrompt(spotsVisited) {
    // Sort by risk level (highest first)
    spotsToAddress = spotsVisited.sort((a,b) => {
      const riskOrder = {'Danger - Avoid': 3, 'Take caution': 2, 'Low risk': 1};
      return (riskOrder[b.risk] || 0) - (riskOrder[a.risk] || 0);
    });
    
    renderExitPromptList();
    exitPromptModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
  }
  
  function renderExitPromptList() {
    exitPromptList.innerHTML = '';
    
    if(spotsToAddress.length === 0) {
      exitPromptList.innerHTML = '<div class="text-center text-gray-500 py-8">All spots addressed! Thank you for your feedback, stay safe!</div>';
      return;
    }
    
    spotsToAddress.forEach(spot => {
      const item = document.createElement('div');
      const borderColor = spot.risk === 'Danger - Avoid' ? 'border-red-400 bg-red-50' : 
                         spot.risk === 'Take caution' ? 'border-yellow-400 bg-yellow-50' : 
                         'border-green-400 bg-green-50';
      const textColor = spot.risk === 'Danger - Avoid' ? 'text-red-700' : 
                       spot.risk === 'Take caution' ? 'text-yellow-700' : 
                       'text-green-700';
      
      item.className = `border-2 p-3 rounded ${borderColor}`;
      item.innerHTML = `
        <div class="flex justify-between items-start gap-3">
          <div class="flex-1">
            <div class="font-semibold">${escapeHtml(spot.name)}</div>
            <div class="text-sm text-gray-600">${escapeHtml(spot.species)}</div>
            <div class="text-sm font-medium ${textColor}">${escapeHtml(spot.risk)}</div>
          </div>
          <div class="flex flex-col gap-2">
            <button class="safe-passage-btn text-xs px-3 py-1.5 text-white rounded whitespace-nowrap" style="background-color: #047857;" onmouseover="this.style.backgroundColor='#065f46'" onmouseout="this.style.backgroundColor='#047857'" data-spot-id="${spot.id}">
              Safe Passage
            </button>
            <button class="add-report-exit-btn text-xs px-3 py-1.5 text-white rounded whitespace-nowrap" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'" data-spot-id="${spot.id}">
              Add Report
            </button>
          </div>
        </div>
      `;
      
      exitPromptList.appendChild(item);
    });
    
    // Attach event handlers
    exitPromptList.querySelectorAll('.safe-passage-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const spotId = e.target.dataset.spotId;
        handleSafePassageFromExit(spotId);
      });
    });
    
    exitPromptList.querySelectorAll('.add-report-exit-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const spotId = e.target.dataset.spotId;
        handleAddReportFromExit(spotId);
      });
    });
  }
  
  function handleSafePassageFromExit(spotId) {
    // Check if user is signed in
    if (!currentUser) {
      toast('Please sign in to mark safe passages', 2000);
      authModal.classList.remove('hidden');
      document.body.classList.add('modal-open');
      return;
    }
    
    const spot = spots.find(s => s.id === spotId);
    if(!spot) return;
    
    // Increment safe passage count
    if (!spot.safePassageCount) spot.safePassageCount = 0;
    spot.safePassageCount++;
    spot.lastSafePassage = new Date().toISOString();
    saveAll();
    
    // Save to Supabase if sync is enabled
    if (syncEnabled && currentUser) {
      console.log('ðŸ’¾ Syncing safe passage count to Supabase for spot:', spot.name);
      saveSpotToSupabase(spot);
    }
    
    // Increment user's safe passage count in profile
    incrementUserSafePassages();
    
    // Remove from spots to address
    spotsToAddress = spotsToAddress.filter(s => s.id !== spotId);
    
    // If all spots addressed, close the exit prompt modal
    if (spotsToAddress.length === 0) {
      exitPromptModal.classList.add('hidden');
      document.body.classList.remove('modal-open');
      toast('All spots addressed! Thank you for your feedback.', 2000);
    } else {
      // Re-render the list
      renderExitPromptList();
    }
    
    // Show success modal for safe passage
    showSafePassageModal(spot.name, spot.risk);
  }
  
  function handleAddReportFromExit(spotId) {
    // Remove from spots to address
    spotsToAddress = spotsToAddress.filter(s => s.id !== spotId);
    
    // Close the exit prompt modal
    exitPromptModal.classList.add('hidden');
    
    // Open the details modal for this spot
    openDetailsModal(spotId);
    switchTab('add');
  }
  
  // Close exit prompt modal
  closeExitPrompt.addEventListener('click', () => {
    if(spotsToAddress.length > 0) {
      if(confirm(`You haven't addressed ${spotsToAddress.length} spot${spotsToAddress.length === 1 ? '' : 's'}. Close anyway?`)) {
        exitPromptModal.classList.add('hidden');
        document.body.classList.remove('modal-open');
        spotsToAddress = [];
      }
    } else {
      exitPromptModal.classList.add('hidden');
      document.body.classList.remove('modal-open');
      spotsToAddress = [];
    }
  });

  // Show feedback prompt when user exits a calm spot during active swooping season
  function showCalmSpotFeedbackPrompt(calmSpots) {
    if (!calmSpots || calmSpots.length === 0) return;
    
    console.log('ðŸ¦ showCalmSpotFeedbackPrompt called with', calmSpots.length, 'spots');
    
    // For now, just handle the first calm spot (can be extended for multiple later)
    const spot = calmSpots[0];
    
    // Get the last report year to show in the message
    const lastReportDate = spot.reports && spot.reports.length > 0 
      ? new Date(Math.max(...spot.reports.map(r => new Date(r.timestamp))))
      : null;
    const lastYear = lastReportDate ? lastReportDate.getFullYear() : 'last year';
    
    // Determine if we're pre-season or in-season
    const season = SWOOPING_SEASONS[spot.species];
    const now = getCurrentDate();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    
    let seasonStartDate;
    if (currentMonth <= (season?.end || 12)) {
      seasonStartDate = new Date(currentYear, (season?.start || 8) - 1, 1);
    } else {
      seasonStartDate = new Date(currentYear + 1, (season?.start || 8) - 1, 1);
    }
    
    const daysFromSeasonStart = Math.floor((now - seasonStartDate) / (1000 * 60 * 60 * 24));
    const isPreSeason = daysFromSeasonStart < 0;
    
    // Customize message based on timing
    let seasonMessage;
    if (isPreSeason) {
      const daysUntilSeason = Math.abs(daysFromSeasonStart);
      seasonMessage = `This bird's nesting season begins in ${daysUntilSeason} day${daysUntilSeason === 1 ? '' : 's'} - have you noticed any activity?`;
    } else {
      seasonMessage = `This bird's nesting season has just begun - did you spot this bird today?`;
    }
    
    console.log('ðŸ“… Feedback prompt:', seasonMessage);
    
    // Create a custom modal for this feedback
    const feedbackModal = document.createElement('div');
    feedbackModal.id = 'calmSpotFeedbackModal';
    feedbackModal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
    feedbackModal.style.cssText = 'background-color: rgba(66, 45, 30, 0.5);';
    
    feedbackModal.innerHTML = `
      <div class="rounded-lg shadow-xl max-w-md w-full p-6" style="background-color: #f2eceb;">
        <div class="flex items-start gap-3 mb-4">
          <div class="flex-shrink-0">
            ${getBirdIconSVG('Calm - All clear')}
          </div>
          <div class="flex-1">
            <h3 class="font-bold text-lg mb-1" style="color: #422d1e;">Bird Spotted?</h3>
            <p class="text-sm" style="color: #422d1e;">
              In ${lastYear}, a <span class="font-semibold" style="color: #2563eb;">${escapeHtml(spot.species)}</span> 
              was reported at <span class="font-semibold">${escapeHtml(spot.name)}</span>.
              <br><br>
              ${seasonMessage}
            </p>
          </div>
        </div>
        
        <div class="flex flex-col gap-2">
          <button data-action="yes" class="calm-feedback-btn w-full px-4 py-3 rounded font-medium text-white" style="background-color: #422d1e;">
            Yes, I saw the bird - Add Report
          </button>
          <button data-action="no" class="calm-feedback-btn w-full px-4 py-3 rounded font-medium" style="background-color: #10B981; color: white;">
            No, the bird wasn't there
          </button>
          <button data-action="skip" class="calm-feedback-btn w-full px-4 py-2 rounded text-sm" style="color: #422d1e; opacity: 0.7;">
            Skip
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(feedbackModal);
    document.body.classList.add('modal-open');
    
    console.log('âœ… Feedback modal added to DOM');
    console.log('ðŸ“ Modal element:', feedbackModal);
    console.log('ðŸ“ Modal in body:', document.getElementById('calmSpotFeedbackModal'));
    console.log('ðŸ“ Body has modal-open class:', document.body.classList.contains('modal-open'));
    
    // Direct button click handlers for Safari compatibility
    feedbackModal.querySelectorAll('.calm-feedback-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        
        const action = btn.getAttribute('data-action');
        console.log('ðŸ”˜ Button clicked, action:', action);
        
        // Reset the flag so user can be prompted again on next visit
        hasShownCalmFeedback = false;
        console.log('ðŸ”„ Reset hasShownCalmFeedback flag for next journey');
        
        if (action === 'yes') {
          console.log('âœ… Yes - opening details modal');
          feedbackModal.remove();
          document.body.classList.remove('modal-open');
          openDetailsModal(spot.id);
          setTimeout(() => {
            const addTab = detailsModal.querySelector('[data-tab="add"]');
            if (addTab) addTab.click();
          }, 100);
        } else if (action === 'no') {
          console.log('âœ… No - recording safe passage');
          if (!spot.safePassageCount) spot.safePassageCount = 0;
          spot.safePassageCount++;
          spot.lastSafePassage = new Date().toISOString();
          
          saveAll();
          
          // Save to Supabase if sync is enabled
          if (syncEnabled && currentUser) {
            console.log('ðŸ’¾ Syncing safe passage count to Supabase for spot:', spot.name);
            saveSpotToSupabase(spot);
          }
          
          incrementUserSafePassages();
          
          feedbackModal.remove();
          document.body.classList.remove('modal-open');
          console.log('âœ… Modal removed, modal-open class removed');
          toast(`Thanks! Recorded safe passage at ${spot.name}`, 2000);
        } else if (action === 'skip') {
          console.log('âœ… Skip - closing modal');
          feedbackModal.remove();
          document.body.classList.remove('modal-open');
          console.log('âœ… Modal removed, modal-open class removed');
        }
      });
    });
    
    // Overlay click to close
    feedbackModal.addEventListener('click', (e) => {
      // If clicking directly on the overlay (not bubbled from content), close it
      if (e.target === feedbackModal) {
        console.log('ðŸ”˜ Overlay clicked - closing modal');
        feedbackModal.remove();
        document.body.classList.remove('modal-open');
      }
    });
  }

  // Show pre-season warning alert with preventative tips
  function showPreseasonAlert(s) {
    const seasonStartMonth = getSeasonStartMonth(s.species);
    const preventativeTips = PREVENTATIVE_TIPS[s.species] || PREVENTATIVE_TIPS.general;
    
    // Build preventative tips list
    let tipsHTML = preventativeTips.slice(0, 5).map(tip => 
      `<li class="text-xs text-gray-700">${escapeHtml(tip)}</li>`
    ).join('');
    
    alertBox.innerHTML = `
      <div class="flex flex-col gap-3">
        <div class="flex items-start justify-between gap-2">
          <div class="text-sm font-semibold" style="color: #422d1e;">
            <img src="Assets/Icons/calm.svg" alt="Calm" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 4px;">
            Pre-Season Notice
          </div>
          <button id="closeAlertBtn" class="text-xl" style="color: #422d1e; opacity: 0.7;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
        </div>
        
        <div class="text-sm" style="color: #422d1e;">
          There was a nesting <span class="font-semibold" style="color: #2563eb">${escapeHtml(s.species)}</span> here last year - <span class="font-semibold" style="color: #2563eb">${escapeHtml(s.name)}</span>. 
          <br><br>
          Use caution over the coming weeks as nesting season begins in <span class="font-semibold">${seasonStartMonth}</span>.
        </div>
        
        <div class="border-t pt-2" style="border-color: #d4cac7;">
          <div class="text-xs font-semibold mb-2" style="color: #422d1e;">
            Build rapport with local birds:
          </div>
          <ul class="list-disc pl-5 space-y-1">
            ${tipsHTML}
          </ul>
        </div>
        
        <div class="flex gap-2">
          <button id="morePreventativeTipsBtn" class="text-xs text-white rounded px-4 py-2 flex-1" style="background-color: #059669;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
            <img src="Assets/Icons/tips.svg" alt="Tips" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px; filter: brightness(0) invert(1);">
            More Preventative Tips
          </button>
          <button id="showHistoryBtn" class="text-xs text-white rounded px-4 py-2" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
            View History
          </button>
        </div>
      </div>
    `;
    
    // Use calm color scheme (blue)
    alertBox.classList.remove('risk-danger', 'risk-caution', 'risk-calm', 'risk-low');
    alertBox.classList.add('risk-calm');
    
    alertBox.classList.add('show');
    alertBox.style.display = 'block';
    
    // Attach event handlers
    requestAnimationFrame(() => {
      const closeAlertBtn = document.getElementById('closeAlertBtn');
      const morePreventativeTipsBtn = document.getElementById('morePreventativeTipsBtn');
      const showHistoryBtn = document.getElementById('showHistoryBtn');
      
      if (closeAlertBtn) {
        closeAlertBtn.addEventListener('click', () => {
          alertBox.style.display = 'none';
          alertBox.classList.remove('show');
        });
      }
      
      if (morePreventativeTipsBtn) {
        morePreventativeTipsBtn.addEventListener('click', () => {
          alertBox.style.display = 'none';
          alertBox.classList.remove('show');
          openPreventativeTipsModal(s.species);
        });
      }
      
      if (showHistoryBtn) {
        showHistoryBtn.addEventListener('click', () => {
          alertBox.style.display = 'none';
          alertBox.classList.remove('show');
          openDetailsModal(s.id);
        });
      }
    });
  }

  // Show quick alert for spot from list
  function showSpotQuickAlert(s) {
    console.log(`ðŸ”” showSpotQuickAlert called for ${s.name}: risk=${s.risk}, isPreseason=${s.isPreseason}`);
    
    // Don't show alert for spots the user just reported on
    if (recentlyReportedSpots.has(s.id)) {
      console.log('ðŸ”• Suppressing alert for recently reported spot');
      return;
    }
    
    // Check if this is a pre-season warning spot
    if (s.isPreseason) {
      console.log('ðŸ“… Showing preseason alert');
      showPreseasonAlert(s);
      return;
    }
    
    console.log('âš ï¸ Showing normal alert');
    
    // Get latest report timestamp
    let lastReportedText = '';
    if (s.reports && s.reports.length > 0) {
      const latestReport = s.reports[s.reports.length - 1];
      lastReportedText = `<div class="text-xs text-gray-500 mt-1">Last reported: ${formatTimeAgo(latestReport.timestamp)}</div>`;
    }
    
    // Get last safe passage timestamp
    let lastSafePassageText = '';
    if (s.lastSafePassage) {
      lastSafePassageText = `<div class="text-xs text-gray-500 mt-1">Last safe passage: ${formatTimeAgo(s.lastSafePassage)}</div>`;
    }
    
    // Determine risk class for alert box styling
    let riskClass = 'risk-caution'; // default yellow
    if (s.risk === 'Danger - Avoid') {
      riskClass = 'risk-danger';
    } else if (s.risk === 'Take caution') {
      riskClass = 'risk-caution';
    } else if (s.risk === 'Calm - All clear') {
      riskClass = 'risk-calm';
    } else if (s.risk === 'Low risk') {
      riskClass = 'risk-low';
    }
    
    alertBox.innerHTML = `
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-sm font-semibold mb-1">${escapeHtml(s.name)} - ${escapeHtml(s.species)}</div>
          <div class="text-sm ${s.risk==='Danger - Avoid'?'text-red-600': s.risk==='Take caution' ? 'text-yellow-600' : s.risk==='Calm - All clear' ? 'text-blue-600' : 'text-green-600'} font-medium">
            ${escapeHtml(s.risk)}
          </div>
          <div class="text-xs text-gray-600 mt-1">${s.reports.length} report${s.reports.length === 1 ? '' : 's'}</div>
          ${lastReportedText}
          ${lastSafePassageText}
        </div>
        <div class="flex flex-col gap-2">
          <div class="flex items-center gap-2">
            <button id="showMoreBtn" class="text-xs text-white rounded px-3 py-1.5" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Show More</button>
            <button id="closeAlertBtn" class="text-xs border rounded px-3 py-1.5">Close</button>
          </div>
          <button id="safetyTipsAlertBtn" class="text-xs text-white rounded px-3 py-1.5 w-full flex items-center justify-center gap-1.5" style="background-color: #047857;" onmouseover="this.style.backgroundColor='#065f46'" onmouseout="this.style.backgroundColor='#047857'">
            <img src="Assets/Icons/tips.svg" alt="Tips" style="width: 14px; height: 14px; filter: brightness(0) invert(1);">
            ${s.risk === 'Calm - All clear' ? 'Preventative Tips' : 'Safety Tips'}
          </button>
        </div>
      </div>
    `;
    
    // Remove all risk classes first
    alertBox.classList.remove('risk-danger', 'risk-caution', 'risk-calm', 'risk-low');
    // Add the appropriate risk class
    alertBox.classList.add(riskClass);
    
    alertBox.classList.add('show');
    alertBox.style.display = 'block';
    
    // Attach event handlers after a short delay to ensure DOM is ready
    requestAnimationFrame(() => {
      const showMoreBtn = document.getElementById('showMoreBtn');
      const closeAlertBtn = document.getElementById('closeAlertBtn');
      const safetyTipsAlertBtn = document.getElementById('safetyTipsAlertBtn');
      
      if (showMoreBtn) {
        showMoreBtn.addEventListener('click', () => {
          alertBox.style.display = 'none';
          alertBox.classList.remove('show');
          openDetailsModal(s.id);
        });
      }
      
      if (closeAlertBtn) {
        closeAlertBtn.addEventListener('click', () => {
          alertBox.style.display = 'none';
          alertBox.classList.remove('show');
        });
      }
      
      if (safetyTipsAlertBtn) {
        safetyTipsAlertBtn.addEventListener('click', () => {
          alertBox.style.display = 'none';
          alertBox.classList.remove('show');
          // Show preventative tips for calm spots, safety tips for others
          if (s.risk === 'Calm - All clear') {
            openPreventativeTipsModal(s.species);
          } else {
            openSafetyTipsModal(s.species);
          }
        });
      }
    });
  }


  // Play alert sound and vibrate (for mobile)
  function playAlertNotification() {
    console.log('ðŸ”” Alert notification triggered');
    
    // Play alert sound
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // Create a two-tone alert sound
      oscillator.frequency.value = 800;
      gainNode.gain.value = 0.3;
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.2);
      
      // Second beep
      const oscillator2 = audioContext.createOscillator();
      const gainNode2 = audioContext.createGain();
      oscillator2.connect(gainNode2);
      gainNode2.connect(audioContext.destination);
      oscillator2.frequency.value = 600;
      gainNode2.gain.value = 0.3;
      oscillator2.start(audioContext.currentTime + 0.25);
      oscillator2.stop(audioContext.currentTime + 0.45);
      
      console.log('âœ… Audio alert played');
    } catch(e) {
      console.warn('âŒ Audio alert failed:', e);
    }
    
    // Vibrate (mobile devices)
    if ('vibrate' in navigator) {
      try {
        // More aggressive pattern for better noticeability
        // Pattern: vibrate 300ms, pause 100ms, vibrate 300ms, pause 100ms, vibrate 300ms
        const vibrationPattern = [300, 100, 300, 100, 300];
        const result = navigator.vibrate(vibrationPattern);
        console.log('ðŸ“³ Vibration triggered:', result ? 'Success' : 'Failed or not supported');
      } catch(e) {
        console.warn('âŒ Vibration failed:', e);
      }
    } else {
      console.log('âŒ Vibration API not supported on this device');
      // iOS doesn't support vibration API
      // Show toast notification instead
      if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
        console.log('â„¹ï¸ iOS detected - vibration not available via web');
      }
    }
  }

  // Play happy tone when exiting all zones (safe now!)
  function playHappyTone() {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      
      // Create a pleasant ascending chime (C-E-G major chord arpeggio)
      const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
      const noteDuration = 0.15;
      
      notes.forEach((freq, index) => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = freq;
        oscillator.type = 'sine'; // Smoother, more pleasant sound
        
        // Fade in/out envelope for smoother sound
        const startTime = audioContext.currentTime + (index * noteDuration);
        gainNode.gain.setValueAtTime(0, startTime);
        gainNode.gain.linearRampToValueAtTime(0.2, startTime + 0.02);
        gainNode.gain.linearRampToValueAtTime(0, startTime + noteDuration);
        
        oscillator.start(startTime);
        oscillator.stop(startTime + noteDuration);
      });
    } catch(e) {
      console.warn('Happy tone failed:', e);
    }
    
    // Single short vibration for positive feedback
    if ('vibrate' in navigator) {
      try {
        navigator.vibrate(100);
      } catch(e) {
        console.warn('Vibration failed:', e);
      }
    }
  }

  // Show alert when entering a spot's radius
  function showCenteredAlert(spots) {
    console.log('ðŸš¨ showCenteredAlert called:', { 
      spots: Array.isArray(spots) ? spots.map(s => s.name) : [spots.name],
      timestamp: new Date().toISOString() 
    });
    
    // Remove minimized state if previously minimized
    alertBox.classList.remove('minimized');
    
    // Handle both single spot and array of spots
    const spotArray = Array.isArray(spots) ? spots : [spots];
    
    // Check if any spots are pre-season warnings
    const preseasonSpots = spotArray.filter(s => s.isPreseason);
    if (preseasonSpots.length > 0) {
      // Show pre-season alert for the first one (they're all calm anyway)
      showPreseasonAlert(preseasonSpots[0]);
      return;
    }
    
    // Play sound and vibrate when alert is shown
    playAlertNotification();
    
    if(spotArray.length === 1) {
      // Single spot - styled to match multi-bird view
      const s = spotArray[0];
      const borderColor = s.risk === 'Danger - Avoid' ? 'border-red-400 bg-red-50' : 
                         s.risk === 'Take caution' ? 'border-yellow-400 bg-yellow-50' : 
                         s.risk === 'Calm - All clear' ? 'border-blue-400 bg-blue-50' :
                         'border-green-400 bg-green-50';
      const textColor = s.risk === 'Danger - Avoid' ? 'text-red-700' : 
                       s.risk === 'Take caution' ? 'text-yellow-700' : 
                       s.risk === 'Calm - All clear' ? 'text-blue-700' :
                       'text-green-700';
      
      // Determine risk class for alert box styling
      let riskClass = 'risk-caution';
      if (s.risk === 'Danger - Avoid') {
        riskClass = 'risk-danger';
      } else if (s.risk === 'Take caution') {
        riskClass = 'risk-caution';
      } else if (s.risk === 'Calm - All clear') {
        riskClass = 'risk-calm';
      } else if (s.risk === 'Low risk') {
        riskClass = 'risk-low';
      }
      
      alertBox.innerHTML = `
        <div class="text-sm font-semibold mb-2 flex items-center gap-2">
          <img src="Assets/Icons/alert.svg" alt="Alert" style="width: 20px; height: 20px;">
          Swooping zone detected!
        </div>
        <div class="border-l-4 ${borderColor} p-3 rounded text-xs mb-2">
          <div class="font-semibold">${escapeHtml(s.name)}</div>
          <div class="text-gray-600">${escapeHtml(s.species)}</div>
          <div class="font-medium ${textColor}">${escapeHtml(s.risk)}</div>
          <div class="flex gap-2 mt-2">
            <button class="show-more-btn text-xs text-white rounded px-3 py-1" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'" data-spot-id="${s.id}">Show More</button>
            <button class="safety-tips-btn text-xs text-white rounded px-3 py-1 flex items-center gap-1" style="background-color: #047857;" onmouseover="this.style.backgroundColor='#065f46'" onmouseout="this.style.backgroundColor='#047857'" data-species="${escapeHtml(s.species)}">
              <img src="Assets/Icons/tips.svg" alt="Tips" style="width: 12px; height: 12px; filter: brightness(0) invert(1);">
              Tips
            </button>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="clearAlertBtn" class="flex-1 text-xs border rounded px-3 py-1">Minimise for now</button>
        </div>
      `;

      // Remove all risk classes first, then add the appropriate one
      alertBox.classList.remove('risk-danger', 'risk-caution', 'risk-calm', 'risk-low');
      alertBox.classList.add(riskClass);
      
      alertBox.classList.add('show');
      alertBox.style.display = 'block';

      // Attach event handlers
      const showMoreBtn = alertBox.querySelector('.show-more-btn');
      if(showMoreBtn) {
        showMoreBtn.onclick = () => {
          minimizeCenteredAlert();
          console.log('ðŸ“Œ User minimized alert via Show More');
          openDetailsModal(s.id);
        };
      }
      
      const safetyTipsBtn = alertBox.querySelector('.safety-tips-btn');
      if(safetyTipsBtn) {
        safetyTipsBtn.onclick = () => {
          minimizeCenteredAlert();
          openSafetyTipsModal(s.species);
        };
      }
      
      document.getElementById('clearAlertBtn').onclick = (e) => {
        e.stopPropagation(); // Prevent click from bubbling to alertBox
        minimizeCenteredAlert();
        console.log('ðŸ“Œ User minimized alert');
      };
    } else {
      // Multiple spots - show list with Show More button for each
      const highestRisk = spotArray[0].risk;
      
      // Determine risk class for alert box styling based on highest risk
      let riskClass = 'risk-caution';
      if (highestRisk === 'Danger - Avoid') {
        riskClass = 'risk-danger';
      } else if (highestRisk === 'Take caution') {
        riskClass = 'risk-caution';
      } else if (highestRisk === 'Calm - All clear') {
        riskClass = 'risk-calm';
      } else if (highestRisk === 'Low risk') {
        riskClass = 'risk-low';
      }
      
      alertBox.innerHTML = `
        <div class="text-sm font-semibold mb-2 flex items-center gap-2">
          <img src="Assets/Icons/alert.svg" alt="Alert" style="width: 20px; height: 20px;">
          Multiple swooping zones detected! Highest risk: 
          <span class="ml-1 ${highestRisk==='Danger - Avoid'?'text-red-600': highestRisk==='Take caution' ? 'text-yellow-600' : 'text-green-600'}">${escapeHtml(highestRisk)}</span>
        </div>
        <div class="max-h-48 overflow-y-auto space-y-2 mb-2">
          ${spotArray.map(spot => {
            const borderColor = spot.risk === 'Danger - Avoid' ? 'border-red-400 bg-red-50' : 
                               spot.risk === 'Take caution' ? 'border-yellow-400 bg-yellow-50' : 
                               'border-green-400 bg-green-50';
            const textColor = spot.risk === 'Danger - Avoid' ? 'text-red-700' : 
                             spot.risk === 'Take caution' ? 'text-yellow-700' : 
                             'text-green-700';
            
            return `
              <div class="border-l-4 ${borderColor} p-3 rounded text-xs">
                <div class="font-semibold">${escapeHtml(spot.name)}</div>
                <div class="text-gray-600">${escapeHtml(spot.species)}</div>
                <div class="font-medium ${textColor}">${escapeHtml(spot.risk)}</div>
                <div class="flex gap-2 mt-2">
                  <button class="show-more-btn text-xs text-white rounded px-3 py-1" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'" data-spot-id="${spot.id}">Show More</button>
                  <button class="safety-tips-btn text-xs text-white rounded px-3 py-1 flex items-center gap-1" style="background-color: #047857;" onmouseover="this.style.backgroundColor='#065f46'" onmouseout="this.style.backgroundColor='#047857'" data-species="${escapeHtml(spot.species)}">
                    <img src="Assets/Icons/tips.svg" alt="Tips" style="width: 12px; height: 12px; filter: brightness(0) invert(1);">
                    Tips
                  </button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
        <div class="flex gap-2">
          <button id="clearAlertBtn" class="flex-1 text-xs border rounded px-3 py-1">Minimise for now</button>
        </div>
      `;

      // Remove all risk classes first, then add the appropriate one
      alertBox.classList.remove('risk-danger', 'risk-caution', 'risk-calm', 'risk-low');
      alertBox.classList.add(riskClass);
      
      alertBox.classList.add('show');
      alertBox.style.display = 'block';

      // Attach event handlers for all Show More buttons
      alertBox.querySelectorAll('.show-more-btn').forEach(btn => {
        btn.onclick = () => {
          const spotId = btn.dataset.spotId;
          minimizeCenteredAlert();
          console.log('ðŸ“Œ User minimized alert via Show More');
          openDetailsModal(spotId);
        };
      });
      
      // Attach event handlers for all Safety Tips buttons
      alertBox.querySelectorAll('.safety-tips-btn').forEach(btn => {
        btn.onclick = () => {
          const species = btn.dataset.species;
          minimizeCenteredAlert();
          openSafetyTipsModal(species);
        };
      });
      
      document.getElementById('clearAlertBtn').onclick = (e) => {
        e.stopPropagation(); // Prevent click from bubbling to alertBox
        minimizeCenteredAlert();
        console.log('ðŸ“Œ User minimized alert');
      };
    }
    
    // Add click handler to minimized alert to re-expand it
    alertBox.onclick = (e) => {
      if (alertBox.classList.contains('minimized')) {
        console.log('ðŸ”„ User clicked minimized alert - expanding');
        alertBox.classList.remove('minimized');
        e.stopPropagation();
      }
    };
  }

  // Minimize centered alert (show as small flashing icon)
  function minimizeCenteredAlert() {
    console.log('ðŸ“Œ minimizeCenteredAlert called');
    toast('Minimizing alert...', 1000); // Visual confirmation
    console.log('ðŸ“Œ Before minimizing - classes:', alertBox.className);
    console.log('ðŸ“Œ Before minimizing - display:', alertBox.style.display);
    
    // Ensure alert is visible first
    alertBox.style.display = 'block';
    // Keep the show class for proper state
    alertBox.classList.add('show');
    // Add minimized class - this will override styles with !important
    alertBox.classList.add('minimized');
    
    console.log('ðŸ“Œ After minimizing - classes:', alertBox.className);
    console.log('ðŸ“Œ After minimizing - display:', alertBox.style.display);
    console.log('ðŸ“Œ Alert minimized - showing as pulsing icon');
    
    // Extra check - log the computed styles
    setTimeout(() => {
      const computed = window.getComputedStyle(alertBox);
      console.log('ðŸ“Œ Computed styles:', {
        display: computed.display,
        width: computed.width,
        height: computed.height,
        bottom: computed.bottom,
        right: computed.right,
        opacity: computed.opacity,
        zIndex: computed.zIndex
      });
    }, 100);
  }

  // Hide centered alert (completely remove)
  function hideCenteredAlert() {
    alertBox.style.display = 'none';
    alertBox.classList.remove('show', 'minimized');
    // Remove all risk classes when hiding
    alertBox.classList.remove('risk-danger', 'risk-caution', 'risk-calm', 'risk-low');
  }

  // Show success modal after creating a spot or adding a report
  function showSuccessModal(birdName, birdSpecies, birdBehaviours, isNewSpot = true) {
    console.log('showSuccessModal called with:', { birdName, birdSpecies, birdBehaviours, isNewSpot });
    
    // Ensure birdBehaviours is an array
    if (!Array.isArray(birdBehaviours)) {
      console.warn('birdBehaviours is not an array:', birdBehaviours);
      birdBehaviours = [];
    }
    
    // Determine which icon, message, and color to show based on bird behavior
    let iconPath = 'Assets/Icons/user.svg'; // default
    let message = '';
    let birdNameColor = '#059669'; // default: darker green for low risk (better contrast)
    
    // Determine risk level color based on bird behaviors
    if (birdBehaviours.includes('made contact + injured') || birdBehaviours.includes('made contact + uninjured')) {
      birdNameColor = '#DC2626'; // darker red for danger
    } else if (birdBehaviours.includes('close swoop')) {
      birdNameColor = '#D97706'; // darker orange for caution
    } else if (birdBehaviours.includes('swoop') || birdBehaviours.includes('noisy') || birdBehaviours.includes('none')) {
      birdNameColor = '#059669'; // darker green for low risk
    }
    
    if (isNewSpot) {
      // Messages for creating a new spot
      message = `Thank you for reporting <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}</span> the <span class="font-bold">${escapeHtml(birdSpecies)}</span> and keeping our community safe.`;
      
      if (birdBehaviours.includes('made contact + injured')) {
        iconPath = 'Assets/Icons/user_swoopedinjured.svg';
        message = `Thank you for reporting <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}</span> the <span class="font-bold">${escapeHtml(birdSpecies)}</span>. We're so sorry to hear you were injured! Please seek medical attention if needed.`;
      } else if (birdBehaviours.includes('made contact + uninjured')) {
        iconPath = 'Assets/Icons/user_swoopeduninjured.svg';
        message = `Thank you for reporting <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}</span> the <span class="font-bold">${escapeHtml(birdSpecies)}</span>. Sorry to hear it swooped you, but we're glad you weren't injured!`;
      } else if (birdBehaviours.includes('close swoop') || birdBehaviours.includes('swoop')) {
        iconPath = 'Assets/Icons/user_swooped.svg';
        message = `Thank you for reporting <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}</span> the <span class="font-bold">${escapeHtml(birdSpecies)}</span>. Sorry to hear about the swoop â€” stay safe out there!`;
      } else if (birdBehaviours.includes('noisy')) {
        iconPath = 'Assets/Icons/user_noisy.svg';
        message = `Thank you for reporting <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}</span> the <span class="font-bold">${escapeHtml(birdSpecies)}</span>. Those noisy birds can be quite startling!`;
      }
    } else {
      // Messages for adding a report to an existing spot
      message = `Thank you for adding a report to <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}'s</span> Swoop Spot.`;
      
      if (birdBehaviours.includes('made contact + injured')) {
        iconPath = 'Assets/Icons/user_swoopedinjured.svg';
        message = `Thank you for updating <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}'s</span> Swoop Spot. We're so sorry to hear you were injured! Please seek medical attention if needed.`;
      } else if (birdBehaviours.includes('made contact + uninjured')) {
        iconPath = 'Assets/Icons/user_swoopeduninjured.svg';
        message = `Thank you for updating <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}'s</span> Swoop Spot. Sorry to hear about it swooping you, but we're glad you weren't injured!`;
      } else if (birdBehaviours.includes('close swoop') || birdBehaviours.includes('swoop')) {
        iconPath = 'Assets/Icons/user_swooped.svg';
        message = `Thank you for updating <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}'s</span> Swoop Spot. Sorry to hear about the swoop â€” stay safe out there!`;
      } else if (birdBehaviours.includes('noisy')) {
        iconPath = 'Assets/Icons/user_noisy.svg';
        message = `Thank you for updating <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}'s</span> Swoop Spot. Those noisy birds can be quite startling!`;
      }
    }
    
    console.log('Selected icon:', iconPath);
    console.log('Selected message:', message);
    
    successUserIcon.src = iconPath;
    successMessage.innerHTML = message;
    goodEggMessage.style.display = 'block'; // Show the "good egg" message for general success
    successModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
  }

  // Close success modal
  closeSuccessModal.addEventListener('click', () => {
    successModal.classList.add('hidden');
    document.body.classList.remove('modal-open');
  });

  // Show safe passage modal
  function showSafePassageModal(birdName, spotRisk = 'Low risk') {
    // Map spot risk to appropriate color (using darker colors for better contrast)
    let birdNameColor = '#059669'; // default: darker green for low risk
    
    if (spotRisk === 'Danger - Avoid') {
      birdNameColor = '#DC2626'; // darker red
    } else if (spotRisk === 'Take caution') {
      birdNameColor = '#D97706'; // darker orange
    } else if (spotRisk === 'Calm - All clear') {
      birdNameColor = '#2563eb'; // darker blue
    } else {
      birdNameColor = '#059669'; // darker green for low risk
    }
    
    successUserIcon.src = 'Assets/Icons/user_safepassage.svg';
    successMessage.innerHTML = `I'm so glad you didn't spot <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}</span>. You must be a lucky egg!`;
    goodEggMessage.style.display = 'none'; // Hide the "good egg" message for safe passage
    successModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
  }

  // ----------------------------
  // Safety Tips Functions
  // ----------------------------
  // Safety Tips Functions
  // ----------------------------
  
  function openPreventativeTipsModal(species = 'general') {
    console.log('ðŸŒ± openPreventativeTipsModal called with species:', species);
    
    // Set the species in the dropdown
    tipsSpeciesSelect.value = species;
    
    // Display all tabs' content for the correct species
    displaySafetyTips(species);
    displayPreventativeTips(species);
    displaySources();
    
    // Switch to the Preventative Tips tab
    document.querySelectorAll('.safety-tips-tab-btn').forEach(btn => {
      if (btn.dataset.tab === 'preventative') {
        btn.classList.add('active');
        btn.style.borderColor = '#422d1e';
        btn.style.color = '#422d1e';
        btn.style.opacity = '1';
      } else {
        btn.classList.remove('active');
        btn.style.borderColor = 'transparent';
        btn.style.color = '#422d1e';
        btn.style.opacity = '0.6';
      }
    });
    
    // Show preventative tab content, hide others
    document.querySelectorAll('.safety-tips-tab-content').forEach(content => {
      if (content.id === 'preventativeTab') {
        content.classList.remove('hidden');
        content.classList.add('active');
      } else {
        content.classList.add('hidden');
        content.classList.remove('active');
      }
    });
    
    // Show species selector
    const speciesSelectorContainer = document.getElementById('speciesSelectorContainer');
    if (speciesSelectorContainer) {
      speciesSelectorContainer.classList.remove('hidden');
    }
    
    // Show the modal
    safetyTipsModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
    
    console.log('âœ… Preventative tips modal opened');
  }
  
  function openSafetyTipsModal(species = 'general') {
    console.log('ðŸ¦œ openSafetyTipsModal called with species:', species);
    
    // Set the species in the dropdown
    tipsSpeciesSelect.value = species;
    
    // Display all tabs' content
    displaySafetyTips(species);
    displayPreventativeTips(species);
    displaySources();
    
    // Reset to Safety Tips tab (first tab)
    const allTabs = document.querySelectorAll('.safety-tips-tab-content');
    const allTabBtns = document.querySelectorAll('.safety-tips-tab-btn');
    
    allTabs.forEach(tab => tab.classList.add('hidden'));
    allTabBtns.forEach(btn => {
      btn.classList.remove('active');
      btn.style.borderColor = 'transparent';
      btn.style.opacity = '0.6';
    });
    
    // Activate Safety Tips tab
    const safetyTab = document.getElementById('safetyTab');
    const safetyTabBtn = document.querySelector('[data-tab="safety"]');
    
    if (safetyTab) {
      safetyTab.classList.remove('hidden');
      safetyTab.classList.add('active');
    }
    
    if (safetyTabBtn) {
      safetyTabBtn.classList.add('active');
      safetyTabBtn.style.borderColor = '#422d1e';
      safetyTabBtn.style.opacity = '1';
    }
    
    // Show the modal
    safetyTipsModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
    
    // Scroll to top of the modal content area
    setTimeout(() => {
      const scrollableContent = safetyTipsModal.querySelector('.overflow-y-auto');
      if (scrollableContent) {
        scrollableContent.scrollTop = 0;
        console.log('ðŸ“œ Scrolled safety tips modal to top');
      }
    }, 50);
  }
  
  function displaySafetyTips(species) {
    const tips = SAFETY_TIPS[species] || SAFETY_TIPS.general;
    
    console.log('ðŸ“‹ displaySafetyTips called with species:', species);
    console.log('ðŸ“‹ Found tips:', tips ? tips.title : 'NOT FOUND');
    
    if (!tips || !tips.title || !tips.tips) {
      console.error('âŒ Invalid tips object for species:', species);
      return;
    }
    
    let html = `
      <div class="mb-4">
        <h4 class="text-lg font-bold mb-2" style="color: #422d1e;">${escapeHtml(tips.title)}</h4>
        <p class="text-sm mb-4" style="color: #422d1e; opacity: 0.8;">${escapeHtml(tips.description)}</p>
      </div>
      <div class="space-y-3">
    `;
    
    // Show first 5 tips
    tips.tips.slice(0, 5).forEach((tip, index) => {
      html += `
        <div class="flex items-start gap-3 p-3 rounded" style="background-color: #fff; border-left: 3px solid #10B981;">
          <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white" style="background-color: #10B981;">
            ${index + 1}
          </span>
          <p class="text-sm" style="color: #422d1e;">${escapeHtml(tip)}</p>
        </div>
      `;
    });
    
    html += `</div>`;
    
    // Add remaining tips (hidden initially) if there are more than 5
    if (tips.tips.length > 5) {
      html += `
        <div id="safetyTipsExtra" class="hidden space-y-3 mt-3">
      `;
      
      tips.tips.slice(5).forEach((tip, index) => {
        html += `
          <div class="flex items-start gap-3 p-3 rounded" style="background-color: #fff; border-left: 3px solid #10B981;">
            <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white" style="background-color: #10B981;">
              ${index + 6}
            </span>
            <p class="text-sm" style="color: #422d1e;">${escapeHtml(tip)}</p>
          </div>
        `;
      });
      
      html += `</div>`;
      
      // Add Show More / Show Less button
      html += `
        <div class="mt-4 text-center">
          <button id="safetyTipsShowMoreBtn" class="px-4 py-2 rounded-lg font-medium transition-colors" style="background-color: #e8e2e1; color: #422d1e;" onmouseover="this.style.backgroundColor='#d4cac7'" onmouseout="this.style.backgroundColor='#e8e2e1'">
            Show ${tips.tips.length - 5} More Tips
          </button>
        </div>
      `;
    }
    
    html += `
      <div class="mt-6 p-4 rounded" style="background-color: #FEF3C7; border-left: 3px solid #F59E0B;">
        <p class="text-sm font-medium" style="color: #92400E;">
          Remember: These birds are protected native wildlife. They're defending their nests, not attacking maliciously. 
          Never harm or attempt to remove nesting birds. Contact local wildlife authorities if a bird poses a serious danger.
        </p>
      </div>
    `;
    
    const tipsContentElement = document.getElementById('tipsContent');
    if (tipsContentElement) {
      tipsContentElement.innerHTML = html;
      console.log('âœ… Tips content updated');
      
      // Attach show more/less handler
      const showMoreBtn = document.getElementById('safetyTipsShowMoreBtn');
      if (showMoreBtn) {
        showMoreBtn.addEventListener('click', () => {
          const extraTips = document.getElementById('safetyTipsExtra');
          if (extraTips) {
            const isHidden = extraTips.classList.contains('hidden');
            if (isHidden) {
              extraTips.classList.remove('hidden');
              showMoreBtn.textContent = 'Show Less';
            } else {
              extraTips.classList.add('hidden');
              showMoreBtn.textContent = `Show ${tips.tips.length - 5} More Tips`;
            }
          }
        });
      }
    } else {
      console.error('âŒ tipsContent element not found');
    }
  }
  
  // Safety tips modal event listeners
  if (closeSafetyTips && safetyTipsModal) {
    closeSafetyTips.addEventListener('click', () => {
      safetyTipsModal.classList.add('hidden');
      document.body.classList.remove('modal-open');
      scrollToHome();
    });
  }
  
  const closeSafetyTipsBottom = document.getElementById('closeSafetyTipsBottom');
  if (closeSafetyTipsBottom && safetyTipsModal) {
    closeSafetyTipsBottom.addEventListener('click', () => {
      safetyTipsModal.classList.add('hidden');
      document.body.classList.remove('modal-open');
      scrollToHome();
    });
  }
  
  if (safetyTipsBtn) {
    safetyTipsBtn.addEventListener('click', () => {
      openSafetyTipsModal('general');
    });
  }
  
  // Species selector - update both tabs when changed
  if (tipsSpeciesSelect) {
    tipsSpeciesSelect.addEventListener('change', (e) => {
      const species = e.target.value;
      displaySafetyTips(species);
      displayPreventativeTips(species);
    });
  }
  
  // Tab switching for Safety Tips modal
  document.querySelectorAll('.safety-tips-tab-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const tabId = btn.dataset.tab;
      
      // Update tab buttons
      document.querySelectorAll('.safety-tips-tab-btn').forEach(b => {
        if (b.dataset.tab === tabId) {
          b.classList.add('active');
          b.style.borderColor = '#422d1e';
          b.style.color = '#422d1e';
          b.style.opacity = '1';
        } else {
          b.classList.remove('active');
          b.style.borderColor = 'transparent';
          b.style.color = '#422d1e';
          b.style.opacity = '0.6';
        }
      });
      
      // Show/hide species selector based on tab
      const speciesSelectorContainer = document.getElementById('speciesSelectorContainer');
      if (speciesSelectorContainer) {
        if (tabId === 'sources') {
          speciesSelectorContainer.classList.add('hidden');
        } else {
          speciesSelectorContainer.classList.remove('hidden');
        }
      }
      
      // Update tab content
      document.querySelectorAll('.safety-tips-tab-content').forEach(content => {
        if (content.id === `${tabId}Tab`) {
          content.classList.remove('hidden');
          content.classList.add('active');
        } else {
          content.classList.add('hidden');
          content.classList.remove('active');
        }
      });
    });
  });
  
  // Function to display preventative tips
  function displayPreventativeTips(species) {
    const tips = PREVENTATIVE_TIPS[species] || PREVENTATIVE_TIPS.general;
    
    console.log('ðŸŒ± displayPreventativeTips called with species:', species);
    
    if (!tips || !Array.isArray(tips)) {
      console.error('âŒ Invalid preventative tips for species:', species);
      return;
    }
    
    let html = `
      <div class="mb-4">
        <h4 class="text-lg font-bold mb-2" style="color: #422d1e;">Building Rapport with ${species === 'general' ? 'Local Birds' : species}</h4>
        <p class="text-sm mb-4" style="color: #422d1e; opacity: 0.8;">
          These preventative measures can help reduce swooping behavior before nesting season begins. 
          Building positive relationships with local birds year-round makes everyone safer.
        </p>
      </div>
      <div class="space-y-3">
    `;
    
    // Show first 5 tips
    tips.slice(0, 5).forEach((tip, index) => {
      html += `
        <div class="flex items-start gap-3 p-3 rounded" style="background-color: #fff; border-left: 3px solid #059669;">
          <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white" style="background-color: #059669;">
            ${index + 1}
          </span>
          <p class="text-sm" style="color: #422d1e;">${escapeHtml(tip)}</p>
        </div>
      `;
    });
    
    html += `</div>`;
    
    // Add remaining tips (hidden initially) if there are more than 5
    if (tips.length > 5) {
      html += `
        <div id="preventativeTipsExtra" class="hidden space-y-3 mt-3">
      `;
      
      tips.slice(5).forEach((tip, index) => {
        html += `
          <div class="flex items-start gap-3 p-3 rounded" style="background-color: #fff; border-left: 3px solid #059669;">
            <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white" style="background-color: #059669;">
              ${index + 6}
            </span>
            <p class="text-sm" style="color: #422d1e;">${escapeHtml(tip)}</p>
          </div>
        `;
      });
      
      html += `</div>`;
      
      // Add Show More / Show Less button
      html += `
        <div class="mt-4 text-center">
          <button id="preventativeTipsShowMoreBtn" class="px-4 py-2 rounded-lg font-medium transition-colors" style="background-color: #e8e2e1; color: #422d1e;" onmouseover="this.style.backgroundColor='#d4cac7'" onmouseout="this.style.backgroundColor='#e8e2e1'">
            Show ${tips.length - 5} More Tips
          </button>
        </div>
      `;
    }
    
    html += `
      <div class="mt-6 p-4 rounded" style="background-color: #DCFCE7; border-left: 3px solid #059669;">
        <p class="text-sm font-medium" style="color: #14532D;">
          Remember: Preventative measures work best when practiced consistently throughout the year, 
          not just during nesting season. Birds have excellent memories and can recognize individual humans!
        </p>
      </div>
    `;
    
    const preventativeTipsElement = document.getElementById('preventativeTipsContent');
    if (preventativeTipsElement) {
      preventativeTipsElement.innerHTML = html;
      console.log('âœ… Preventative tips content updated');
      
      // Attach show more/less handler
      const showMoreBtn = document.getElementById('preventativeTipsShowMoreBtn');
      if (showMoreBtn) {
        showMoreBtn.addEventListener('click', () => {
          const extraTips = document.getElementById('preventativeTipsExtra');
          if (extraTips) {
            const isHidden = extraTips.classList.contains('hidden');
            if (isHidden) {
              extraTips.classList.remove('hidden');
              showMoreBtn.textContent = 'Show Less';
            } else {
              extraTips.classList.add('hidden');
              showMoreBtn.textContent = `Show ${tips.length - 5} More Tips`;
            }
          }
        });
      }
    } else {
      console.error('âŒ preventativeTipsContent element not found');
    }
  }
  
  // Function to display sources
  function displaySources() {
    const sources = [
      {
        name: 'Australian Government - Department of Climate Change, Energy, the Environment and Water',
        description: 'Wildlife protection guidelines and native bird behavior information'
      },
      {
        name: 'Australian Museum',
        description: 'Scientific research on Australian bird species behavior and nesting patterns'
      },
      {
        name: 'Birdlife Australia',
        description: 'National bird conservation organization - swooping bird education and safety advice'
      },
      {
        name: 'Local Council Wildlife Services',
        description: 'ACT, NSW, VIC, QLD council guidelines for managing swooping birds in urban areas'
      },
      {
        name: 'NSW Environment and Heritage',
        description: 'State-based wildlife management and public safety guidelines'
      },
      {
        name: 'Queensland Museum',
        description: 'Educational resources on Queensland bird species and behavior'
      }
    ];
    
    let html = `
      <div class="mb-4">
        <h4 class="text-lg font-bold mb-2" style="color: #422d1e;">Information Sources</h4>
        <p class="text-sm mb-4" style="color: #422d1e; opacity: 0.8;">
          All safety tips and preventative measures are compiled from the following trusted sources:
        </p>
      </div>
      <div class="space-y-4">
    `;
    
    sources.forEach((source, index) => {
      html += `
        <div class="p-4 rounded" style="background-color: #fff; border-left: 3px solid #0284C7;">
          <p class="text-sm font-bold mb-1" style="color: #0C4A6E;">${escapeHtml(source.name)}</p>
          <p class="text-xs" style="color: #422d1e; opacity: 0.8;">${escapeHtml(source.description)}</p>
        </div>
      `;
    });
    
    html += `
      </div>
      <div class="mt-6 p-4 rounded" style="background-color: #E0F2FE; border-left: 3px solid #0284C7;">
        <p class="text-xs italic" style="color: #0C4A6E; opacity: 0.8;">
          This information is compiled from publicly available wildlife safety resources and scientific literature. 
          Always follow local authority advice and report dangerous wildlife encounters to your local council or 
          wildlife rescue services.
        </p>
      </div>
    `;
    
    const sourcesElement = document.getElementById('sourcesContent');
    if (sourcesElement) {
      sourcesElement.innerHTML = html;
      console.log('âœ… Sources content updated');
    } else {
      console.error('âŒ sourcesContent element not found');
    }
  }

  // NOTE: Walk simulator event handlers moved to Testing Modal section (lines ~5850+)

  // ----------------------------
  // NOTE: Location Tracking functions moved earlier in code (near map initialization)
  // ----------------------------

  // Track location button click handler - DISABLED (button removed from UI)
  /*
  trackLocationBtn.addEventListener('click', () => {
    if (isTracking) {
      stopLocationTracking();
    } else {
      startLocationTracking();
    }
  });
  */

  // Auto-start tracking on mobile devices (with user interaction)
  function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
           || window.innerWidth <= 768;
  }

  // Optionally auto-start on mobile (you can enable this if desired)
  // Uncomment the following to auto-start tracking on mobile:
  /*
  if (isMobileDevice()) {
    // Give user a moment to see the interface, then offer to start tracking
    setTimeout(() => {
      if (confirm('Start tracking your location automatically?')) {
        startLocationTracking();
      }
    }, 1000);
  }
  */

  // ----------------------------
  // NOTE: GPS button, Test Vibration, and Test Date buttons moved to Testing Modal (see lines ~5700+)
  // ----------------------------

  // ----------------------------
  // Test Date Modal Display Update
  // ----------------------------
  // NOTE: testDate variable and getCurrentDate() function are now declared at top of IIFE (lines ~1118)
  // NOTE: Old test date modal handlers removed - all testing features now in Testing Modal (see below)
  // ----------------------------

  // ----------------------------
  // Testing Modal Event Handlers
  // ----------------------------
  const testingModal = document.getElementById('testingModal');
  const closeTestingModal = document.getElementById('closeTestingModal');
  const closeTestingModalBottom = document.getElementById('closeTestingModalBottom');
  
  // Helper function to close testing modal
  function closeTestingModalFn() {
    if (testingModal) {
      testingModal.classList.add('hidden');
      document.body.classList.remove('modal-open');
      scrollToHome();
    }
  }
  
  // Close Testing Modal
  if (closeTestingModal) {
    closeTestingModal.addEventListener('click', closeTestingModalFn);
  }
  
  if (closeTestingModalBottom) {
    closeTestingModalBottom.addEventListener('click', closeTestingModalFn);
  }
  
  // Close when clicking outside
  if (testingModal) {
    testingModal.addEventListener('click', (e) => {
      if (e.target === testingModal) {
        closeTestingModalFn();
      }
    });
  }
  
  // Find Me / GPS button in modal
  const useGPSBtnModal = document.getElementById('useGPSBtnModal');
  if (useGPSBtnModal) {
    useGPSBtnModal.addEventListener('click', () => {
      if(!navigator.geolocation) {
        toast('Geolocation is not supported by your browser');
        return;
      }
      
      toast('Getting your location...');
      
      navigator.geolocation.getCurrentPosition(
        p => {
          map.setView([p.coords.latitude, p.coords.longitude], 15);
          checkLocation(p.coords.latitude, p.coords.longitude);
          toast('Location found!');
        }, 
        err => {
          console.error('Geolocation error:', err);
          let errorMsg = 'GPS error: ';
          
          switch(err.code) {
            case err.PERMISSION_DENIED:
              errorMsg += 'Location permission denied. Please enable location services.';
              break;
            case err.POSITION_UNAVAILABLE:
              errorMsg += 'Location information unavailable.';
              break;
            case err.TIMEOUT:
              errorMsg += 'Location request timed out.';
              break;
            default:
              errorMsg += 'Unknown error occurred.';
          }
          
          toast(errorMsg, 4000);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
        }
      );
    });
  }
  
  // Test Vibration button in modal
  const testVibrateBtnModal = document.getElementById('testVibrateBtnModal');
  if (testVibrateBtnModal) {
    testVibrateBtnModal.addEventListener('click', () => {
      console.log('ðŸ“³ Testing vibration...');
      
      if ('vibrate' in navigator) {
        toast('Testing vibration...', 1000);
        
        const vibrationPattern = [300, 100, 300, 100, 300];
        const result = navigator.vibrate(vibrationPattern);
        
        console.log('Vibration API called, result:', result);
        
        if (result) {
          setTimeout(() => toast('Vibration test complete', 1000), 1000);
        } else {
          setTimeout(() => toast('Vibration may not be supported on this device', 2000), 1000);
        }
      } else {
        console.log('Vibration API not available');
        
        if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
          toast('iOS does not support web vibration API', 3000);
        } else {
          toast('Vibration not supported on this device', 2000);
        }
      }
    });
  }
  
  // Test Date functionality in modal
  const testDateInputModal = document.getElementById('testDateInputModal');
  const applyTestDateModal = document.getElementById('applyTestDateModal');
  const resetTestDateModal = document.getElementById('resetTestDateModal');
  const currentTestDateModal = document.getElementById('currentTestDateModal');
  
  // Make this function globally accessible
  window.updateTestDateModalDisplay = function() {
    const currentTestDate = window.testDateManager.getTestDate();
    if (currentTestDate) {
      const date = new Date(currentTestDate);
      if (currentTestDateModal) {
        currentTestDateModal.innerHTML = `<strong>Testing with date:</strong> ${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
        currentTestDateModal.style.color = '#D97706';
        currentTestDateModal.style.fontWeight = 'bold';
      }
    } else {
      if (currentTestDateModal) {
        currentTestDateModal.innerHTML = 'Using real date (today)';
        currentTestDateModal.style.color = '#422d1e';
        currentTestDateModal.style.fontWeight = 'normal';
      }
    }
  }
  
  if (applyTestDateModal && testDateInputModal) {
    applyTestDateModal.addEventListener('click', async () => {
      const selectedDate = testDateInputModal.value;
      
      if (selectedDate) {
        const isoDate = new Date(selectedDate).toISOString();
        window.testDateManager.setTestDate(isoDate);
        window.updateTestDateModalDisplay();
        
        // Reload all spots
        spots.forEach(s => {
          try { map.removeLayer(s.marker); } catch(e) {}
          try { map.removeLayer(s.circle); } catch(e) {}
        });
        spots = [];
        
        await loadAllFromSupabase(true);
        renderAlerts();
        
        toast(`Test date set to ${new Date(isoDate).toLocaleDateString()}`, 2000);
      }
    });
  }
  
  if (resetTestDateModal) {
    resetTestDateModal.addEventListener('click', async () => {
      window.testDateManager.setTestDate(null);
      window.updateTestDateModalDisplay();
      
      // Reload all spots
      spots.forEach(s => {
        try { map.removeLayer(s.marker); } catch(e) {}
        try { map.removeLayer(s.circle); } catch(e) {}
      });
      spots = [];
      
      await loadAllFromSupabase(true);
      renderAlerts();
      
      toast('Reset to real date', 2000);
    });
  }
  
  // Walk Simulator in modal
  const simStartModal = document.getElementById('simStartModal');
  const simEndModal = document.getElementById('simEndModal');
  const playSimModal = document.getElementById('playSimModal');
  const stopSimModal = document.getElementById('stopSimModal');
  
  if (playSimModal) {
    playSimModal.addEventListener('click', async () => {
      const s = simStartModal.value.trim();
      const e = simEndModal.value.trim();
      if(!s || !e){ toast('Enter both addresses'); return; }
      try {
        const g1 = await geocodeAddress(s);
        const g2 = await geocodeAddress(e);
        const steps = 80; simPath = [];
        for(let i=0;i<=steps;i++) simPath.push({ lat: g1.lat + (g2.lat - g1.lat)*(i/steps), lng: g1.lng + (g2.lng - g1.lng)*(i/steps) });
        simIndex = 0;
        if(userMarker) try{ map.removeLayer(userMarker); } catch(e){}
        userMarker = L.marker([simPath[0].lat, simPath[0].lng], { icon: getUserIcon() }).addTo(map);
        if(simTimer) clearInterval(simTimer);
        simTimer = setInterval(()=> {
          simIndex++;
          if(simIndex >= simPath.length){ clearInterval(simTimer); simTimer = null; return; }
          const p = simPath[simIndex];
          try{ userMarker.setLatLng([p.lat,p.lng]); } catch(e){}
          checkLocation(p.lat, p.lng);
          map.setView([p.lat,p.lng], map.getZoom());
        }, 400);
        toast('Simulator started', 1500);
      } catch(err){ toast('Simulator error: ' + (err.message || err)); }
    });
  }
  
  if (stopSimModal) {
    stopSimModal.addEventListener('click', () => { 
      if(simTimer) clearInterval(simTimer); 
      simTimer=null;
      toast('Simulator stopped', 1500);
    });
  }

  // ----------------------------
  // ----------------------------
  // Auth UI Event Listeners
  // ----------------------------
  
  // Check if auth UI elements exist
  if (!authModal || !signInButton) {
    console.warn('âš ï¸ Authentication UI elements missing - sign-in disabled');
    // Add a temporary warning for the sign-in button
    if (signInButton) {
      signInButton.addEventListener('click', () => {
        toast('Sign-in temporarily unavailable - viewing in guest mode', 3000);
      });
    }
  }
  
  // Open auth modal
  if (signInButton && authModal) {
    signInButton.addEventListener('click', () => {
      authModal.classList.remove('hidden');
      if (signInForm) signInForm.classList.remove('hidden');
      if (signUpForm) signUpForm.classList.add('hidden');
      if (signInTab) signInTab.classList.add('active');
      if (signUpTab) signUpTab.classList.remove('active');
      if (signInError) signInError.classList.add('hidden');
      if (signUpError) signUpError.classList.add('hidden');
    });
  }
  
  // Close auth modal
  if (closeAuthModal && authModal) {
    closeAuthModal.addEventListener('click', () => {
      authModal.classList.add('hidden');
      if (signInForm) signInForm.reset();
      if (signUpForm) signUpForm.reset();
      if (signInError) signInError.classList.add('hidden');
      if (signUpError) signUpError.classList.add('hidden');
    });
  }
  
  // Tab switching
  if (signInTab) signInTab.addEventListener('click', () => {
    if (signInForm) signInForm.classList.remove('hidden');
    if (signUpForm) signUpForm.classList.add('hidden');
    if (signInTab) {
      signInTab.classList.add('active');
      signInTab.style.borderColor = '#422d1e';
      signInTab.style.opacity = '1';
    }
    if (signUpTab) {
      signUpTab.classList.remove('active');
      signUpTab.style.borderColor = 'transparent';
      signUpTab.style.opacity = '0.6';
    }
    if (signInError) signInError.classList.add('hidden');
    if (signUpError) signUpError.classList.add('hidden');
  });
  
  if (signUpTab) signUpTab.addEventListener('click', () => {
    if (signUpForm) signUpForm.classList.remove('hidden');
    if (signInForm) signInForm.classList.add('hidden');
    if (signUpTab) {
      signUpTab.classList.add('active');
      signUpTab.style.borderColor = '#422d1e';
      signUpTab.style.opacity = '1';
    }
    if (signInTab) {
      signInTab.classList.remove('active');
      signInTab.style.borderColor = 'transparent';
      signInTab.style.opacity = '0.6';
    }
    if (signInError) signInError.classList.add('hidden');
    if (signUpError) signUpError.classList.add('hidden');
  });
  
  // Sign in form submit
  if (signInForm) signInForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    await signIn(signInEmail.value, signInPassword.value);
  });
  
  // Sign up form submit
  if (signUpForm) signUpForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    await signUp(signUpName.value, signUpEmail.value, signUpPassword.value);
  });
  
  // Hamburger menu - toggle menu
  const hamburgerMenuButton = document.getElementById('hamburgerMenuButton');
  const hamburgerMenuDropdown = document.getElementById('hamburgerMenuDropdown');
  
  if (hamburgerMenuButton && hamburgerMenuDropdown) {
    hamburgerMenuButton.addEventListener('click', (e) => {
      e.stopPropagation();
      hamburgerMenuDropdown.classList.toggle('hidden');
    });
  }
  
  // Close menu when clicking outside
  if (hamburgerMenuDropdown) {
    document.addEventListener('click', () => {
      hamburgerMenuDropdown.classList.add('hidden');
    });
    
    hamburgerMenuDropdown.addEventListener('click', (e) => {
      e.stopPropagation();
    });
  }
  
  // Hamburger Menu Items
  const menuHome = document.getElementById('menuHome');
  const menuContributions = document.getElementById('menuContributions');
  const menuEditProfile = document.getElementById('menuEditProfile');
  const menuStats = document.getElementById('menuStats');
  const menuTips = document.getElementById('menuTips');
  const menuTesting = document.getElementById('menuTesting');
  const menuSignIn = document.getElementById('menuSignIn');
  const menuSignOut = document.getElementById('menuSignOut');
  
  // Home
  if (menuHome) {
    menuHome.addEventListener('click', (e) => {
      e.stopPropagation();
      hamburgerMenuDropdown.classList.add('hidden');
      // Close all modals and return to home
      closeAllModals();
      scrollToHome();
    });
  }
  
  // Contributions (Stats)
  if (menuContributions) {
    menuContributions.addEventListener('click', (e) => {
      e.stopPropagation();
      hamburgerMenuDropdown.classList.add('hidden');
      // Close all modals first
      closeAllModals();
      // Then open profile modal
      openProfileModal('stats');
    });
  }
  
  // Edit Profile
  if (menuEditProfile) {
    menuEditProfile.addEventListener('click', (e) => {
      e.stopPropagation();
      hamburgerMenuDropdown.classList.add('hidden');
      // Close all modals first
      closeAllModals();
      // Then open profile modal
      openProfileModal('edit');
    });
  }
  
  // Stats Modal
  if (menuStats) {
    menuStats.addEventListener('click', (e) => {
      e.stopPropagation();
      hamburgerMenuDropdown.classList.add('hidden');
      console.log('ðŸ“Š Stats menu clicked');
      // Close all modals first
      closeAllModals();
      // Open Stats modal (uses 'active' class, not 'hidden')
      const statsModal = document.getElementById('statsModal');
      if (statsModal) {
        console.log('ðŸ“Š Opening stats modal');
        statsModal.classList.add('active');
        // Refresh stats when opening
        if (typeof renderStatsModal === 'function') {
          renderStatsModal('today'); // Default to 'today' period
        }
      }
    });
  }
  
  // Safety Tips
  if (menuTips) {
    menuTips.addEventListener('click', (e) => {
      e.stopPropagation();
      hamburgerMenuDropdown.classList.add('hidden');
      // Close all modals first
      closeAllModals();
      // Then open safety tips
      openSafetyTipsModal('general');
    });
  }
  
  // Testing
  if (menuTesting) {
    menuTesting.addEventListener('click', (e) => {
      e.stopPropagation();
      hamburgerMenuDropdown.classList.add('hidden');
      // Close all modals first
      closeAllModals();
      // Then open testing modal
      const testingModal = document.getElementById('testingModal');
      if (testingModal) {
        testingModal.classList.remove('hidden');
        document.body.classList.add('modal-open');
      }
    });
  }
  
  // Manual Sync
  const menuSync = document.getElementById('menuSync');
  if (menuSync) {
    menuSync.addEventListener('click', async (e) => {
      e.stopPropagation();
      hamburgerMenuDropdown.classList.add('hidden');
      
      if (!currentUser) {
        toast('Please sign in to sync data', 2000);
        return;
      }
      
      if (syncQueue.length === 0) {
        toast('All data is synced!', 2000);
        return;
      }
      
      toast(`Syncing ${syncQueue.length} items...`, 2000);
      await processSyncQueue();
      
      if (syncQueue.length === 0) {
        toast('Sync complete!', 2000);
      } else {
        toast(`${syncQueue.length} items still pending`, 2000);
      }
    });
  }
  
  // Clear Sync Queue
  const menuClearSync = document.getElementById('menuClearSync');
  if (menuClearSync) {
    menuClearSync.addEventListener('click', (e) => {
      e.stopPropagation();
      hamburgerMenuDropdown.classList.add('hidden');
      
      console.log('ðŸ—‘ï¸ Clear Unsynced button clicked');
      
      if (!currentUser) {
        toast('Please sign in first', 2000);
        return;
      }
      
      if (syncQueue.length === 0) {
        toast('Sync queue is already empty', 2000);
        return;
      }
      
      // Show confirmation
      const confirmed = confirm(`Clear ${syncQueue.length} unsynced spot${syncQueue.length > 1 ? 's' : ''} from queue?\n\nThis will remove them from the sync queue but keep them visible locally. They won't be uploaded to the database.`);
      
      if (confirmed) {
        console.log('âœ… User confirmed - clearing sync queue');
        clearSyncQueue();
      } else {
        console.log('âŒ User cancelled clear operation');
      }
    });
  }
  
  // Sign In
  if (menuSignIn) {
    menuSignIn.addEventListener('click', (e) => {
      e.stopPropagation();
      hamburgerMenuDropdown.classList.add('hidden');
      // Close all modals first
      closeAllModals();
      // Then open auth modal
      if (authModal) {
        authModal.classList.remove('hidden');
        document.body.classList.add('modal-open');
      }
    });
  }
  
  // Sign Out
  if (menuSignOut) {
    menuSignOut.addEventListener('click', async (e) => {
      e.stopPropagation();
      await signOutUser();
      hamburgerMenuDropdown.classList.add('hidden');
    });
  }
  
  // Profile Modal Event Listeners
  if (closeProfileModal) closeProfileModal.addEventListener('click', closeProfileModalFn);
  
  // Tab switching
  if (profileStatsTab) profileStatsTab.addEventListener('click', () => {
    if (profileStatsTab) {
      profileStatsTab.classList.add('active');
      profileStatsTab.style.cssText = 'border-color: #422d1e; color: #422d1e; opacity: 1;';
    }
    if (profileEditTab) {
      profileEditTab.classList.remove('active');
      profileEditTab.style.cssText = 'color: #422d1e; opacity: 0.6; border-color: transparent;';
    }
    
    if (profileStatsContent) profileStatsContent.classList.remove('hidden');
    if (profileEditContent) profileEditContent.classList.add('hidden');
  });
  
  if (profileEditTab) profileEditTab.addEventListener('click', () => {
    if (profileEditTab) {
      profileEditTab.classList.add('active');
      profileEditTab.style.cssText = 'border-color: #422d1e; color: #422d1e; opacity: 1;';
    }
    if (profileStatsTab) {
      profileStatsTab.classList.remove('active');
      profileStatsTab.style.cssText = 'color: #422d1e; opacity: 0.6; border-color: transparent;';
    }
    
    if (profileEditContent) profileEditContent.classList.remove('hidden');
    if (profileStatsContent) profileStatsContent.classList.add('hidden');
  });
  
  // Avatar picker - horizontal scroll
  document.querySelectorAll('.avatar-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const avatar = btn.dataset.avatar;
      const selectedAvatarInput = document.getElementById('selectedAvatar');
      if (selectedAvatarInput) selectedAvatarInput.value = avatar;
      
      console.log('ðŸŽ­ Avatar selected:', avatar);
      
      // Update visual selection
      document.querySelectorAll('.avatar-btn').forEach(b => {
        b.style.borderColor = 'transparent';
        b.style.backgroundColor = '';
      });
      btn.style.borderColor = '#422d1e';
      btn.style.backgroundColor = '#e8e2e1';
    });
  });
  
  // Profile edit form
  if (profileEditForm) profileEditForm.addEventListener('submit', updateUserProfile);
  
  if (cancelEditProfile) cancelEditProfile.addEventListener('click', (e) => {
    e.preventDefault();
    if (profileStatsTab) profileStatsTab.click();
  });
  
  // Close modal when clicking outside
  if (profileModal) profileModal.addEventListener('click', (e) => {
    if (e.target === profileModal) {
      e.stopPropagation();
      closeProfileModalFn();
    }
  });
  
  // Prevent clicks inside modal content from closing it
  if (profileModal) {
    const profileModalContent = profileModal.querySelector('.rounded-lg');
    if (profileModalContent) {
      profileModalContent.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }
  }

  // ----------------------------
  // Dark Mode Toggle
  // ----------------------------
  function initDarkMode() {
    const darkModeToggle = document.getElementById('menuDarkMode');
    const moonIcon = darkModeToggle?.querySelector('.moon-icon');
    const sunIcon = darkModeToggle?.querySelector('.sun-icon');
    const darkModeText = darkModeToggle?.querySelector('.dark-mode-text');
    
    // Load saved preference
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const isDarkMode = savedTheme === 'dark' || (!savedTheme && prefersDark);
    
    if (isDarkMode) {
      document.body.classList.add('dark-mode');
      if (moonIcon) moonIcon.classList.add('hidden');
      if (sunIcon) sunIcon.classList.remove('hidden');
      if (darkModeText) darkModeText.textContent = 'Light Mode';
      
      // Toggle menu icons
      document.querySelectorAll('.menu-icon-light').forEach(icon => {
        icon.classList.add('hidden');
      });
      document.querySelectorAll('.menu-icon-dark').forEach(icon => {
        icon.classList.remove('hidden');
      });
    }
    
    // Toggle dark mode
    darkModeToggle?.addEventListener('click', () => {
      const isDark = document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      
      // Switch map tiles
      if (typeof window.switchMapTiles === 'function') {
        window.switchMapTiles(isDark);
      }
      
      // Toggle icons and text
      if (moonIcon && sunIcon) {
        if (isDark) {
          moonIcon.classList.add('hidden');
          sunIcon.classList.remove('hidden');
          if (darkModeText) darkModeText.textContent = 'Light Mode';
        } else {
          moonIcon.classList.remove('hidden');
          sunIcon.classList.add('hidden');
          if (darkModeText) darkModeText.textContent = 'Dark Mode';
        }
      }
      
      // Toggle menu icons
      document.querySelectorAll('.menu-icon-light').forEach(icon => {
        icon.classList.toggle('hidden', isDark);
      });
      document.querySelectorAll('.menu-icon-dark').forEach(icon => {
        icon.classList.toggle('hidden', !isDark);
      });
    });
  }

  // ----------------------------
  // Initial load default spot if none
  // ----------------------------
  // initialize tag UIs once at startup
  initializeAllTagUIs();
  
  // Initialize dark mode
  initDarkMode();
  
  // Initialize authentication
  initAuth();
  
  // Check location permission and start tracking if granted
  (async () => {
    console.log('ðŸŒ Checking location permission state...');
    
    // Check if Permissions API is available
    if (navigator.permissions && navigator.permissions.query) {
      try {
        const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
        console.log('ðŸ“ Geolocation permission state:', permissionStatus.state);
        
        if (permissionStatus.state === 'granted') {
          // Permission already granted - start tracking automatically
          console.log('âœ… Location permission granted - starting tracking');
          startLocationTracking();
        } else if (permissionStatus.state === 'prompt') {
          // Permission not yet requested - show the button
          console.log('â¸ï¸ Location permission not yet requested - showing button');
          const enableLocationBtn = document.getElementById('enableLocationBtn');
          if (enableLocationBtn) {
            enableLocationBtn.classList.remove('hidden');
          }
        } else {
          // Permission denied - show the button
          console.log('âŒ Location permission denied - showing button');
          const enableLocationBtn = document.getElementById('enableLocationBtn');
          if (enableLocationBtn) {
            enableLocationBtn.classList.remove('hidden');
          }
        }
        
        // Listen for permission changes
        permissionStatus.addEventListener('change', () => {
          console.log('ðŸ“ Geolocation permission changed to:', permissionStatus.state);
          
          if (permissionStatus.state === 'granted' && !isTracking) {
            startLocationTracking();
          }
        });
      } catch (err) {
        // Permissions API not supported or query failed
        console.log('âš ï¸ Permissions API not available:', err.message);
        // Fall back to showing the button
        const enableLocationBtn = document.getElementById('enableLocationBtn');
        if (enableLocationBtn) {
          enableLocationBtn.classList.remove('hidden');
        }
      }
    } else {
      // Permissions API not supported - show button so user can request location
      console.log('âš ï¸ Permissions API not supported');
      const enableLocationBtn = document.getElementById('enableLocationBtn');
      if (enableLocationBtn) {
        enableLocationBtn.classList.remove('hidden');
      }
    }
  })();

  // ----------------------------
  // Online/Offline Event Handlers for Sync Queue
  // ----------------------------
  window.addEventListener('online', () => {
    console.log('ðŸŒ Connection restored - processing sync queue');
    toast('Back online - syncing data...', 2000);
    
    // Process sync queue when connection is restored
    if (currentUser && syncQueue.length > 0) {
      setTimeout(() => processSyncQueue(), 1000);
    }
  });
  
  window.addEventListener('offline', () => {
    console.log('ðŸ“¡ Connection lost - will queue changes');
    toast('Offline - changes will sync later', 2000);
  });

  // Sync queue is now loaded in initAuth() after authentication check
  // No need to load it here - initAuth() handles it properly

  // Load spots from Supabase (with fallback to localStorage)
  (async () => {
    console.log('ðŸš€ Starting app initialization...');
    console.log('ðŸ—ºï¸ Map initialized:', !!map);
    console.log('ðŸ“Š Initial spots count:', spots.length);
    
    await loadAllFromSupabase();
    
    console.log('ðŸ“Š After loadAllFromSupabase, spots count:', spots.length);
    
    // Subscribe to real-time updates (moved to after auth completes)
    // subscribeToRealtimeUpdates();
    
    // If no spots loaded, create a default example spot
    if(spots.length === 0){
      console.log('âš ï¸ No spots loaded, creating default example spot...');
      const defaultSpot = {
        id: uid(),
        name: 'South Bank Swoop',
        species: 'Magpie',
        lat: -27.4789,
        lng: 153.0234,
        radius: 150,
        risk: 'Take caution',
        reports: [{
          id: uid(),
          timestamp: getCurrentDate().toISOString(),
          birdBehaviour: ['swoop'],
          humanBehaviour: ['walking'],
          precautions: ['Hat'],
          extraDetails: 'Peak swoop season',
          alertLevel: 'Take caution'
        }]
      };
      createSpotFromData(defaultSpot, false);
      saveAll();
      console.log('âœ… Default spot created');
    }
    
    console.log('ðŸŽ¨ Rendering alerts...');
    renderAlerts();
    console.log('âœ… App initialization complete. Total spots:', spots.length);
  })();

  // re-run initialization each time modals open/close so UI arrays & handlers are fresh
  openAddBtn.addEventListener('click', initializeAllTagUIs);
  addSpotBelowMap.addEventListener('click', initializeAllTagUIs);
  closeSpotModal.addEventListener('click', initializeAllTagUIs);
  closeDetails.addEventListener('click', initializeAllTagUIs);

  // expose some for debugging and cross-scope access
  window.SwoopSpotter = { 
    spots, 
    map, 
    openCreateSpotModal, 
    openDetailsModal, 
    checkLocation,
    supabase, // Expose for debugging
    loadAllFromSupabase, // Expose for manual refresh
    syncEnabled, // Expose to toggle sync
    openProfileModal, // Expose for mobile nav
    openSafetyTipsModal, // Expose for mobile nav
    currentUser, // Expose current user state
    userProfile // Expose user profile
    // testDate and getCurrentDate are now in global window.testDateManager
  };

})(); // IIFE end
</script>

<!-- Mobile Navigation Bar -->
<nav class="mobile-nav" id="mobileNav">
  <div class="mobile-nav-items">
    <button class="mobile-nav-item" id="navLogout" data-view="logout">
      <img src="Assets/Menu Icons/Light Mode/menu-logout.svg" alt="Sign Out">
      <span>Sign Out</span>
    </button>
    <button class="mobile-nav-item" id="navProfile" data-view="profile">
      <img src="Assets/Menu Icons/Light Mode/menu-profile.svg" alt="Profile">
      <span>Profile</span>
    </button>
    <button class="mobile-nav-item active" id="navHome" data-view="home">
      <img src="Assets/Menu Icons/Light Mode/menu-home.svg" alt="Home">
      <span>Home</span>
    </button>
    <button class="mobile-nav-item" id="navTips" data-view="tips">
      <img src="Assets/Menu Icons/Light Mode/menu-tips.svg" alt="Tips">
      <span>Tips</span>
    </button>
    <button class="mobile-nav-item" id="navStats" data-view="stats">
      <img src="Assets/Menu Icons/Light Mode/menu-stats.svg" alt="Stats">
      <span>Stats</span>
    </button>
    <button class="mobile-nav-item" id="navTesting" data-view="testing">
      <img src="Assets/Menu Icons/Light Mode/menu-testing.svg" alt="Testing" width="24" height="24">
      <span>Testing</span>
    </button>
  </div>
</nav>

<!-- Stats Modal for Mobile -->
<div class="stats-modal" id="statsModal">
  <div class="rounded-lg w-full max-w-2xl mx-auto max-h-[90vh] overflow-y-auto relative" style="background-color: #f2eceb;">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold" style="color: #422d1e;">Activity Stats</h2>
        <button id="closeStatsModal" class="text-2xl font-bold" style="color: #422d1e;" aria-label="Close">&times;</button>
      </div>

      <!-- Time Period Tabs -->
      <div class="flex gap-2 mb-4">
        <button class="stats-period-tab-modal active flex-1 text-sm py-2 px-3 rounded" data-period="today" style="background-color: #422d1e; color: white;">
          Today
        </button>
        <button class="stats-period-tab-modal flex-1 text-sm py-2 px-3 rounded" data-period="week" style="background-color: transparent; color: #422d1e; border: 1px solid #d4cac7;">
          This Week
        </button>
        <button class="stats-period-tab-modal flex-1 text-sm py-2 px-3 rounded" data-period="season" style="background-color: transparent; color: #422d1e; border: 1px solid #d4cac7;">
          This Season
        </button>
      </div>

      <!-- Stats Grid -->
      <div class="space-y-3">
        <!-- Total Reports -->
        <div class="flex justify-between items-center p-3 rounded" style="background-color: #e8e2e1;">
          <span style="color: #422d1e; font-weight: 500;">Total Reports</span>
          <span class="font-bold text-lg" style="color: #422d1e;" id="statTotalReportsModal">0</span>
        </div>
        
        <!-- Injuries -->
        <div class="flex justify-between items-center p-3 rounded" style="background-color: #e8e2e1;">
          <span style="color: #DC2626; font-weight: 500;">âš  Injuries</span>
          <span class="font-bold text-lg" style="color: #DC2626;" id="statInjuriesModal">0</span>
        </div>
        
        <!-- Bird Species Breakdown -->
        <div class="p-3 rounded" style="background-color: #e8e2e1;">
          <div class="font-semibold mb-3" style="color: #422d1e;">By Species:</div>
          <div id="statSpeciesBreakdownModal" class="space-y-2">
            <div style="color: #422d1e; opacity: 0.6;">No reports yet</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ----------------------------
// Mobile Navigation - runs after DOM is loaded
// ----------------------------
(function() {
  const navHome = document.getElementById('navHome');
  const navProfile = document.getElementById('navProfile');
  const navStats = document.getElementById('navStats');
  const navTips = document.getElementById('navTips');
  const navTesting = document.getElementById('navTesting');
  const navLogout = document.getElementById('navLogout');
  const statsModal = document.getElementById('statsModal');
  const closeStatsModal = document.getElementById('closeStatsModal');
  
  // Access main app elements
  const authModal = document.getElementById('authModal');
  const safetyTipsModal = document.getElementById('safetyTipsModal');
  
  // Set active nav item
  function setActiveNavItem(activeItem) {
    document.querySelectorAll('.mobile-nav-item').forEach(item => {
      item.classList.remove('active');
    });
    if (activeItem) {
      activeItem.classList.add('active');
    }
  }
  
  // Logout button - signs user out or shows auth modal
  if (navLogout) {
    navLogout.addEventListener('click', async () => {
      // Access currentUser from the main app
      const user = window.SwoopSpotter?.supabase ? 
        (await window.SwoopSpotter.supabase.auth.getUser()).data.user : null;
      
      if (user) {
        // User is logged in - sign them out
        if (confirm('Are you sure you want to sign out?')) {
          // Call signOut through Supabase
          if (window.SwoopSpotter?.supabase) {
            await window.SwoopSpotter.supabase.auth.signOut();
            showToast('Signed out successfully', 2000);
            setActiveNavItem(navHome);
            // Reload to reset state
            window.location.reload();
          }
        }
      } else {
        // User is logged out - show auth modal
        if (authModal) {
          authModal.classList.remove('hidden');
        }
      }
      
      setActiveNavItem(navLogout);
    });
  }
  
  // Profile button - opens profile on Contributions tab
  if (navProfile) {
    navProfile.addEventListener('click', async () => {
      const currentUser = window.SwoopSpotter?.supabase ? (await window.SwoopSpotter.supabase.auth.getUser()).data.user : null;
      
      if (!currentUser) {
        showToast('Please sign in to view your profile', 2000);
        if (authModal) authModal.classList.remove('hidden');
        return;
      }
      
      // Call openProfileModal from main app
      if (window.SwoopSpotter?.openProfileModal) {
        window.SwoopSpotter.openProfileModal('stats', false);
      }
      setActiveNavItem(navProfile);
    });
  }
  
  // Home button - scroll to top (main map view)
  if (navHome) {
    navHome.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
      setActiveNavItem(navHome);
    });
  }
  
  // Tips button - opens Safety Tips modal
  if (navTips) {
    navTips.addEventListener('click', () => {
      // Call openSafetyTipsModal to ensure tips are displayed
      if (window.SwoopSpotter?.openSafetyTipsModal) {
        window.SwoopSpotter.openSafetyTipsModal('general');
      } else if (safetyTipsModal) {
        // Fallback: manually set up the modal
        const tipsSpeciesSelect = document.getElementById('tipsSpeciesSelect');
        if (tipsSpeciesSelect) tipsSpeciesSelect.value = 'general';
        
        // Call displaySafetyTips if available
        const tipsContentElement = document.getElementById('tipsContent');
        if (tipsContentElement && typeof SAFETY_TIPS !== 'undefined') {
          const tips = SAFETY_TIPS.general;
          let html = `
            <div class="mb-4">
              <h4 class="text-lg font-bold mb-2" style="color: #422d1e;">${tips.title}</h4>
              <p class="text-sm mb-4" style="color: #422d1e; opacity: 0.8;">${tips.description}</p>
            </div>
            <div class="space-y-3">
          `;
          tips.tips.forEach((tip, index) => {
            html += `
              <div class="flex items-start gap-3 p-3 rounded" style="background-color: #fff; border-left: 3px solid #10B981;">
                <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white" style="background-color: #10B981;">
                  ${index + 1}
                </span>
                <p class="text-sm" style="color: #422d1e;">${tip}</p>
              </div>
            `;
          });
          html += '</div>';
          tipsContentElement.innerHTML = html;
        }
        
        safetyTipsModal.classList.remove('hidden');
        document.body.classList.add('modal-open');
      }
      setActiveNavItem(navTips);
    });
  }
  
  // Stats button - opens Activity Stats modal
  if (navStats) {
    navStats.addEventListener('click', () => {
      if (statsModal) {
        statsModal.classList.add('active');
        renderStatsModal('today');
      }
      setActiveNavItem(navStats);
    });
  }
  
  // Testing button - opens Testing modal
  if (navTesting) {
    navTesting.addEventListener('click', () => {
      const testingModal = document.getElementById('testingModal');
      if (testingModal) {
        testingModal.classList.remove('hidden');
        document.body.classList.add('modal-open');
        // Update test date display
        if (typeof window.updateTestDateModalDisplay === 'function') {
          window.updateTestDateModalDisplay();
        }
      }
      setActiveNavItem(navTesting);
    });
  }
  
  // Close stats modal
  if (closeStatsModal) {
    closeStatsModal.addEventListener('click', () => {
      statsModal.classList.remove('active');
      statsModal.classList.add('hidden');
      document.body.classList.remove('modal-open');
      scrollToHome();
    });
  }
  
  // Close stats modal when clicking outside
  if (statsModal) {
    statsModal.addEventListener('click', (e) => {
      if (e.target === statsModal) {
        statsModal.classList.remove('active');
        statsModal.classList.add('hidden');
        document.body.classList.remove('modal-open');
        scrollToHome();
      }
    });
  }
  
  // Stats modal period tabs
  document.querySelectorAll('.stats-period-tab-modal').forEach(tab => {
    tab.addEventListener('click', (e) => {
      const period = e.target.dataset.period;
      
      // Update tab styles
      document.querySelectorAll('.stats-period-tab-modal').forEach(t => {
        if (t.dataset.period === period) {
          t.style.cssText = 'background-color: #422d1e; color: white;';
          t.classList.add('active');
        } else {
          t.style.cssText = 'background-color: transparent; color: #422d1e; border: 1px solid #d4cac7;';
          t.classList.remove('active');
        }
      });
      
      // Re-render stats
      renderStatsModal(period);
    });
  });
  
  // Render stats in modal
  async function renderStatsModal(period = 'today') {
    // Call calculateStats from main app if available
    let stats = { totalReports: 0, injuries: 0, species: {} };
    
    if (window.SwoopSpotter?.supabase) {
      const now = new Date();
      let startDate;
      
      if (period === 'today') {
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      } else if (period === 'week') {
        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      } else if (period === 'season') {
        const currentMonth = now.getMonth() + 1;
        if (currentMonth >= 8) {
          startDate = new Date(now.getFullYear(), 7, 1);
        } else {
          startDate = new Date(now.getFullYear() - 1, 7, 1);
        }
      }
      
      try {
        const { data: allReports } = await window.SwoopSpotter.supabase
          .from('reports')
          .select('id, timestamp, bird_behaviour, spots!inner (species)')
          .gte('timestamp', startDate.toISOString());
        
        if (allReports) {
          stats.totalReports = allReports.length;
          
          allReports.forEach(report => {
            const species = report.spots?.species;
            if (species) {
              if (!stats.species[species]) stats.species[species] = 0;
              stats.species[species]++;
            }
            
            if (report.bird_behaviour && report.bird_behaviour.includes('made contact + injured')) {
              stats.injuries++;
            }
          });
        }
      } catch (error) {
        console.error('Error fetching stats:', error);
      }
    }
    
    // Update totals
    const totalReportsEl = document.getElementById('statTotalReportsModal');
    const injuriesEl = document.getElementById('statInjuriesModal');
    
    if (totalReportsEl) totalReportsEl.textContent = stats.totalReports;
    if (injuriesEl) injuriesEl.textContent = stats.injuries;
    
    // Update species breakdown
    const speciesBreakdown = document.getElementById('statSpeciesBreakdownModal');
    if (!speciesBreakdown) return;
    
    speciesBreakdown.innerHTML = '';
    
    if (Object.keys(stats.species).length === 0) {
      speciesBreakdown.innerHTML = '<div style="color: #422d1e; opacity: 0.6;">No reports yet</div>';
    } else {
      const sortedSpecies = Object.entries(stats.species).sort((a, b) => b[1] - a[1]);
      
      sortedSpecies.forEach(([species, count]) => {
        const row = document.createElement('div');
        row.className = 'flex justify-between items-center py-1';
        row.innerHTML = `
          <span style="color: #422d1e;">${escapeHtml(species)}</span>
          <span class="font-bold" style="color: #422d1e;">${count}</span>
        `;
        speciesBreakdown.appendChild(row);
      });
    }
  }
  
  // Desktop Navigation Event Handlers
  // Get desktop nav elements
  const desktopNavHome = document.getElementById('desktopNavHome');
  const desktopNavProfile = document.getElementById('desktopNavProfile');
  const desktopNavTips = document.getElementById('desktopNavTips');
  const desktopNavStats = document.getElementById('desktopNavStats');
  const desktopNavTesting = document.getElementById('desktopNavTesting');
  const desktopNavLogout = document.getElementById('desktopNavLogout');
  
  // Helper function to set active desktop nav item
  function setActiveDesktopNavItem(activeItem) {
    [desktopNavHome, desktopNavProfile, desktopNavTips, desktopNavStats, desktopNavTesting, desktopNavLogout].forEach(item => {
      if (item) {
        if (item === activeItem) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      }
    });
  }
  
  // Sign Out/Sign In button - signs user out if logged in, shows auth modal if logged out
  if (desktopNavLogout) {
    desktopNavLogout.addEventListener('click', async () => {
      console.log('ðŸ–±ï¸ Desktop Logout/Sign In button clicked');
      // Check if user is logged in
      const user = window.SwoopSpotter?.supabase ? (await window.SwoopSpotter.supabase.auth.getUser()).data.user : null;
      console.log('ðŸ‘¤ Current user:', user ? 'Logged in' : 'Not logged in');
      
      if (user) {
        // User is logged in - sign them out
        console.log('ðŸ”“ Signing user out');
        if (window.SwoopSpotter?.supabase) {
          await window.SwoopSpotter.supabase.auth.signOut();
          window.location.reload();
        }
      } else {
        // User is logged out - show auth modal
        console.log('ðŸ” Showing auth modal');
        if (authModal) {
          authModal.classList.remove('hidden');
        }
      }
      
      setActiveDesktopNavItem(desktopNavLogout);
    });
  } else {
    console.warn('âŒ desktopNavLogout button not found');
  }
  
  // Profile button - opens profile on Contributions tab
  if (desktopNavProfile) {
    desktopNavProfile.addEventListener('click', async () => {
      console.log('ðŸ–±ï¸ Desktop Profile button clicked');
      const currentUser = window.SwoopSpotter?.supabase ? (await window.SwoopSpotter.supabase.auth.getUser()).data.user : null;
      console.log('ðŸ‘¤ Current user:', currentUser ? 'Logged in' : 'Not logged in');
      
      if (!currentUser) {
        console.log('âš ï¸ No user - showing auth modal');
        showToast('Please sign in to view your profile', 2000);
        if (authModal) authModal.classList.remove('hidden');
        return;
      }
      
      // Call openProfileModal from main app
      console.log('ðŸ“‚ Attempting to open profile modal');
      if (window.SwoopSpotter?.openProfileModal) {
        console.log('âœ… openProfileModal found, calling it');
        window.SwoopSpotter.openProfileModal('stats', false);
      } else {
        console.error('âŒ openProfileModal not found on window.SwoopSpotter');
      }
      setActiveDesktopNavItem(desktopNavProfile);
    });
  } else {
    console.warn('âŒ desktopNavProfile button not found');
  }
  
  // Home button - scroll to top (main map view)
  if (desktopNavHome) {
    desktopNavHome.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
      setActiveDesktopNavItem(desktopNavHome);
    });
  }
  
  // Tips button - opens Safety Tips modal
  if (desktopNavTips) {
    desktopNavTips.addEventListener('click', () => {
      // Call openSafetyTipsModal
      if (window.SwoopSpotter?.openSafetyTipsModal) {
        window.SwoopSpotter.openSafetyTipsModal('general');
      }
      setActiveDesktopNavItem(desktopNavTips);
    });
  }
  
  // Stats button - opens Activity Stats modal
  if (desktopNavStats) {
    desktopNavStats.addEventListener('click', () => {
      if (statsModal) {
        statsModal.classList.add('active');
        renderStatsModal('today');
      }
      setActiveDesktopNavItem(desktopNavStats);
    });
  }
  
  // Testing button - opens Testing modal
  if (desktopNavTesting) {
    desktopNavTesting.addEventListener('click', () => {
      const testingModal = document.getElementById('testingModal');
      if (testingModal) {
        testingModal.classList.remove('hidden');
        document.body.classList.add('modal-open');
        // Update test date display
        if (typeof window.updateTestDateModalDisplay === 'function') {
          window.updateTestDateModalDisplay();
        }
      }
      setActiveDesktopNavItem(desktopNavTesting);
    });
  }
  
  // Helper function for toast
  function showToast(msg, duration = 1600) {
    const container = document.getElementById('toast-container');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = 'toast-message';
    toast.textContent = msg;
    container.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }
  
  // Helper function for escaping HTML
  function escapeHtml(s) {
    if (s == null) return '';
    return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
  }
})();
</script>

<!-- Force dark mode button styles after Tailwind CDN loads -->
<script>
  // Apply dark mode styles to Show More buttons only
  // Safety Tips buttons now use inline dark green by default
  
  function forceDarkModeStyles() {
    console.log('ðŸŽ¨ Forcing dark mode button styles');
    
    if (!document.body.classList.contains('dark-mode')) {
      console.log('âš ï¸ Not in dark mode, skipping');
      return;
    }
    
    let buttonsModified = 0;
    
    // Show More buttons - Remove Tailwind classes and add inline styles
    document.querySelectorAll('.show-more-btn, #showMoreBtn').forEach(btn => {
      // Remove Tailwind text color class
      btn.classList.remove('text-white');
      
      // Force inline styles (highest specificity)
      btn.style.cssText = (btn.style.cssText || '') + 
        'background-color: #f2eceb !important; ' +
        'color: #422d1e !important;';
      
      buttonsModified++;
      console.log('âœ… Modified Show More button:', btn);
    });
    
    console.log(`âœ… Modified ${buttonsModified} buttons for dark mode`);
  }
  
  // Run immediately on load
  window.addEventListener('load', function() {
    console.log('ðŸŒ™ Window loaded, checking for dark mode');
    
    // Initial application
    setTimeout(forceDarkModeStyles, 100);
    
    // Watch for DOM changes (alerts created dynamically)
    const observer = new MutationObserver(function(mutations) {
      forceDarkModeStyles();
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
    
    console.log('ðŸ‘ï¸ MutationObserver active');
  });
  
  // Run on DOMContentLoaded as backup
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(forceDarkModeStyles, 100);
  });
  
  // Patch the dark mode toggle function to re-apply styles
  setTimeout(function() {
    const menuDarkMode = document.getElementById('menuDarkMode');
    if (menuDarkMode) {
      menuDarkMode.addEventListener('click', function() {
        setTimeout(forceDarkModeStyles, 50);
      });
      console.log('âœ… Patched dark mode toggle');
    }
  }, 1000);
</script>

</body>
</html>
