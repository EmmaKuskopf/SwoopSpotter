<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Swoop Spotter — Reports</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root {
    --color-light: #f2eceb;
    --color-dark: #422d1e;
  }
  body { background: var(--color-light); font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  #map { 
    height: 56vh; 
    width: 100%; 
    border-radius: 0.5rem; 
    position: relative;
    z-index: 1;
    background: #e8e2e1;
  }
  .fab { position:absolute; bottom:1rem; right:1rem; z-index:1400; width:56px; height:56px; border-radius:9999px; display:grid; place-items:center; box-shadow:0 8px 24px rgba(66,45,30,0.18); cursor:pointer; }
  .tag-input { min-height:2.6rem; display:flex; align-items:center; gap:6px; flex-wrap:wrap; padding:6px; border:1px solid #d4cac7; border-radius:8px; background: var(--color-light); cursor:text; }
  .tag { background:#e8e2e1; color: var(--color-dark); padding:6px 8px; border-radius:999px; display:inline-flex; align-items:center; gap:6px; font-size:13px; }
  .tag .x { cursor:pointer; font-weight:700; }
  .tag-list { position:absolute; left:0; right:0; top:100%; margin-top:6px; background: var(--color-light); border:1px solid #d4cac7; border-radius:8px; box-shadow:0 10px 30px rgba(66,45,30,0.12); max-height:220px; overflow:auto; z-index:10050; display:none; }
  .tag-list > div { padding:8px 10px; cursor:pointer; }
  .tag-list > div:hover { background:#e8e2e1; }
  .modal-overlay { 
    z-index:99999 !important; 
    overflow-y: auto;
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
  }
  .tag-box { 
    min-height: 2.6rem; 
    display: flex; 
    align-items: center; 
    gap: 6px; 
    flex-wrap: wrap; 
    padding: 6px; 
    border: 1px solid #d4cac7; 
    border-radius: 8px; 
    background: var(--color-light); 
    cursor: text;
    margin-bottom: 1rem;
  }
  .input-field {
    width: 100%;
    border: 1px solid #d4cac7;
    border-radius: 8px;
    padding: 8px 12px;
    margin-bottom: 1rem;
    background: var(--color-light);
  }
  #alertBox { position: fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index: 1000000; background:#fff7ed; color: var(--color-dark); border:2px solid #f59e0b; border-radius:0.5rem; padding:0.75rem 1rem; max-width:92%; width:460px; box-shadow: 0 10px 30px rgba(66,45,30,.22); opacity:0; pointer-events:none; transition:opacity .26s ease; display:none; }
  #alertBox.show { display:block; opacity:1; pointer-events:auto; }
  .required::after { content: ' *'; color: #ef4444; font-weight:700; margin-left:6px; }
  /* report feed coloring */
  .report-low { border-left: 4px solid #10B981; }
  .report-caution { border-left: 4px solid #F59E0B; }
  .report-danger { border-left: 4px solid #EF4444; }
  @media (max-width:480px){ #alertBox{ width:94%; padding:.6rem; } }

  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .tab-btn {
    transition: all 0.2s;
    position: relative;
  }
  .tab-btn:not(.active) {
    color: var(--color-dark);
    opacity: 0.6;
    border-bottom-color: transparent;
  }
  .tab-btn.active {
    color: var(--color-dark);
    opacity: 1;
    border-bottom-color: var(--color-dark);
  }
  .tab-btn:hover:not(.active) {
    opacity: 0.8;
    border-bottom-color: #d4cac7;
  }
  .latest-report {
    background-color: var(--color-light);
    border-radius: 0.5rem;
    padding: 1rem;
  }
  
  /* Mobile modal scrolling improvements */
  body.modal-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
  }
  
  /* Ensure modal content is scrollable on mobile */
  @media (max-width: 768px) {
    .modal-overlay {
      align-items: flex-start !important;
      padding-top: 1rem;
      padding-bottom: 1rem;
    }
  }
  
  /* Safari-specific form element fixes */
  select, input, textarea {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }
  
  /* Consistent form field styling across all browsers */
  #birdSpecies {
    background-color: white;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 36px !important;
  }
  
  /* Bird Add Button Styling */
  .bird-add-btn {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 8px 24px rgba(0,0,0,0.18);
    overflow: hidden;
    background: transparent;
  }
  .bird-add-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 12px 32px rgba(0,0,0,0.24);
  }
  .bird-add-btn:active {
    transform: scale(0.98);
  }
  .bird-add-btn img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .bird-add-btn .plus-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 32px;
    font-weight: 300;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    pointer-events: none;
    z-index: 2;
  }
  
  /* Location tracking button animation */
  #trackLocationBtn {
    transition: background-color 0.3s ease, transform 0.1s ease;
  }
  #trackLocationBtn:active {
    transform: scale(0.95);
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
</style>
</head>
<body class="min-h-screen">

<header class="shadow sticky top-0 z-50" style="background-color: #f2eceb;">
  <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex-1"></div>
    <img src="Assets/Logo/Logo-Horizontal.svg" alt="Swoop Spotter Logo" class="h-8" />
    <div class="flex-1 flex justify-end">
      <!-- User Button (shown when signed in) -->
      <button id="userButton" class="hidden items-center gap-2 px-3 py-1.5 rounded" style="background-color: #e8e2e1; color: #422d1e;" onmouseover="this.style.backgroundColor='#dcd6d5'" onmouseout="this.style.backgroundColor='#e8e2e1'">
        <span id="userButtonName">User</span>
        <span class="text-xs">▾</span>
      </button>
      <!-- Sign In Button (shown when signed out) -->
      <button id="signInButton" class="items-center gap-2 px-4 py-1.5 rounded text-white" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
        Sign In
      </button>
    </div>
  </div>
</header>

<main class="max-w-4xl mx-auto px-4 pb-12 pt-4">
  <!-- Action buttons below logo, above map -->
  <div class="flex gap-2 mb-4 justify-center flex-wrap">
    <button id="trackLocationBtn" class="text-sm px-4 py-2 rounded text-white" style="background-color: #422d1e;">
      <span id="trackBtnText">Start Tracking</span>
    </button>
    <button id="useGPSBtn" class="text-sm px-4 py-2 rounded text-white" style="background-color: #422d1e;">Find Me</button>
  </div>

  <div id="map" class="shadow rounded relative">
    <button id="openAddBtn" class="fab bird-add-btn" title="Add Swoop Spot">
      <img src="Assets/Icons/bird_background.svg" alt="">
      <span class="plus-icon">+</span>
    </button>
  </div>

  <!-- Add Swoop Spot button below map -->
  <div class="mt-4 flex justify-center gap-2 flex-wrap">
    <button id="addSpotBelowMap" class="px-6 py-2 rounded text-white font-medium" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
      + Add Swoop Spot
    </button>
    <button id="testVibrateBtn" class="px-4 py-2 rounded text-sm border" style="border-color: #d4cac7; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='transparent'">
      Test Vibration 📳
    </button>
  </div>

  <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
    <section class="p-3 rounded shadow" style="background-color: #f2eceb;">
      <h2 class="font-semibold mb-2" style="color: #422d1e;">Nearby Alerts</h2>
      <div id="alertsList" class="space-y-2 max-h-56 overflow-auto"></div>
    </section>

    <section class="p-3 rounded shadow" style="background-color: #f2eceb;">
      <h2 class="font-semibold mb-2" style="color: #422d1e;">Walk Simulator</h2>
      <div class="text-xs mb-2" style="color: #422d1e; opacity: 0.7;">Simulate a straight-line walk (Start → End addresses)</div>
      <div class="grid gap-2">
        <input id="simStart" placeholder="Start walk: Address" class="p-2 rounded w-full" style="border: 1px solid #d4cac7; background-color: #f2eceb;"/>
        <input id="simEnd" placeholder="End walk: Address" class="p-2 rounded w-full" style="border: 1px solid #d4cac7; background-color: #f2eceb;"/>
        <div class="flex gap-2">
          <button id="playSim" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded">Play</button>
          <button id="stopSim" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded">Stop</button>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- centered alert -->
<div id="alertBox" role="status" aria-live="polite"></div>

<!-- Add / New Spot Modal -->
<div id="spotModal" class="hidden fixed inset-0 modal-overlay flex items-start justify-center bg-black/40 pt-4 pb-4 px-4">
  <div class="rounded-lg shadow-lg w-full max-w-2xl my-auto max-h-[95vh] overflow-y-auto" style="background-color: #f2eceb;">
    <div class="p-6">
      <!-- Header -->
      <div class="flex justify-between items-center mb-4">
        <div>
          <h2 class="text-xl font-bold" style="color: #422d1e;">Add Swoop Spot</h2>
          <p class="text-sm mt-1" style="color: #422d1e; opacity: 0.7;">Click the map to select location, or enter an address below</p>
        </div>
        <button id="closeSpotModal" class="text-2xl" style="color: #422d1e; opacity: 0.6;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">&times;</button>
      </div>

    <form id="spotForm" class="space-y-4">
      <!-- Spot Details Section -->
      <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
        <h3 class="font-medium mb-3" style="color: #422d1e;">Spot Details</h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Bird species <span class="text-red-500">*</span></label>
            <select id="birdSpecies" class="w-full rounded-lg p-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #f2eceb; color: #422d1e;">
              <option>Magpie</option>
              <option>Magpie-Lark</option>
              <option>Masked Lapwing (plover)</option>
              <option>Butcherbird</option>
              <option>Crow</option>
              <option>Noisy Miner</option>
              <option>Noisy Friarbird</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Location Section -->
      <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
        <h3 class="font-medium mb-3" style="color: #422d1e;">Location</h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Address (optional)</label>
            <div class="flex gap-2">
              <div class="relative flex-1">
                <input id="addressField" placeholder="Enter an address" class="w-full rounded-lg p-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #f2eceb; color: #422d1e;" />
                <div id="addressField_suggestions"></div>
              </div>
              <button type="button" id="geoBtn" class="px-3 py-2 rounded text-sm whitespace-nowrap" style="border: 1px solid #d4cac7; background-color: #f2eceb; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='#f2eceb'">📍 Find Me</button>
            </div>
            <div id="addressInfo" class="text-xs mt-1" style="color: #422d1e; opacity: 0.7;"></div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Coordinates</label>
            <input id="coordsField" class="w-full rounded-lg p-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #e8e2e1; color: #422d1e;" readonly placeholder="Click map or find address"/>
          </div>
        </div>
      </div>

      <!-- Initial Report Section -->
      <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
        <h3 class="font-medium mb-3" style="color: #422d1e;">Initial Report</h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Bird behaviour <span class="text-red-500">*</span></label>
            <div class="relative">
              <div id="rbirdBox" class="tag-input" tabindex="0"></div>
              <div id="rbirdList" class="tag-list"></div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Human behaviour <span class="text-red-500">*</span></label>
            <div class="relative">
              <div id="rhumanBox" class="tag-input" tabindex="0"></div>
              <div id="rhumanList" class="tag-list"></div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Precautions taken <span class="text-red-500">*</span></label>
            <div class="relative">
              <div id="rprecBox" class="tag-input" tabindex="0"></div>
              <div id="rprecList" class="tag-list"></div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Alert level (auto-set from bird behaviour)</label>
            <input type="text" id="ralertLevel" class="w-full rounded-lg p-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #e8e2e1; color: #422d1e;" readonly>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Extra info (optional)</label>
            <textarea id="reextra" class="w-full rounded-lg p-2 h-20" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #f2eceb; color: #422d1e;" placeholder="Any additional notes..."></textarea>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-2 pt-2">
        <button type="button" id="spotCancel" class="px-4 py-2 rounded" style="border: 1px solid #d4cac7; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='transparent'">Cancel</button>
        <button type="submit" id="spotSave" class="px-4 py-2 text-white rounded" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Create Swoop Spot</button>
      </div>
    </form>
    </div>
  </div>
</div>

<!-- Spot Details / Report Feed Modal -->
<div id="detailsModal" class="hidden fixed inset-0 modal-overlay flex items-start justify-center bg-black/40 pt-4 pb-4 px-4">
  <div class="rounded-lg shadow-lg w-full max-w-2xl p-5 my-auto max-h-[95vh] overflow-y-auto" style="background-color: #f2eceb;">
    <div class="flex justify-between items-start">
      <div>
        <h3 id="detailsTitle" class="text-lg font-semibold" style="color: #422d1e;">Spot details</h3>
        <p id="detailsSubtitle" class="text-xs" style="color: #422d1e; opacity: 0.7;">Feed of reports. Add a new report to append to this spot.</p>
      </div>
      <div>
        <button id="closeDetails" style="color: #422d1e; opacity: 0.7;">✖</button>
      </div>
    </div>

    <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Left: spot summary & reports -->
      <div>
        <div id="spotHeader" class="p-3 rounded mb-3" style="border: 1px solid #d4cac7;">
          <!-- populated dynamically -->
        </div>

        <div class="overflow-auto max-h-96 space-y-2" id="reportsFeed">
          <!-- report items -->
        </div>
      </div>

      <!-- Right: add new report form -->
      <div class="p-3 rounded" style="background-color: #e8e2e1;">
        <h4 class="font-semibold mb-2" style="color: #422d1e;">Add a report</h4>
        <form id="reportForm" class="space-y-3 text-sm">
          <div>
            <label class="required" style="color: #422d1e;">Bird behaviour</label>
            <div class="relative">
              <div id="rbirdBox2" class="tag-input" tabindex="0"></div>
              <div id="rbirdList2" class="tag-list"></div>
            </div>
          </div>

          <div>
            <label class="required" style="color: #422d1e;">Human behaviour</label>
            <div class="relative">
              <div id="rhumanBox2" class="tag-input" tabindex="0"></div>
              <div id="rhumanList2" class="tag-list"></div>
            </div>
          </div>

          <div>
            <label class="required" style="color: #422d1e;">Precautions</label>
            <div class="relative">
              <div id="rprecBox2" class="tag-input" tabindex="0"></div>
              <div id="rprecList2" class="tag-list"></div>
            </div>
          </div>

          <div>
            <label class="required">Alert level (derived)</label>
            <select id="repAlertLevel" class="w-full border p-2 rounded">
              <option>Low risk</option>
              <option>Take caution</option>
              <option>Danger - Avoid</option>
            </select>
          </div>

          <div>
            <label>Extra notes</label>
            <textarea id="repExtra" class="w-full border p-2 rounded"></textarea>
          </div>

          <div class="flex justify-end gap-2">
            <button type="button" id="reportCancel" class="px-3 py-2 border rounded">Cancel</button>
            <button type="submit" id="reportSave" class="px-4 py-2 bg-yellow-500 text-white rounded">Add report</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Confirm discard modal -->
<div id="confirmModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4">
  <div class="rounded-lg shadow-lg p-4 max-w-sm w-full my-auto" style="background-color: #f2eceb;">
    <div class="text-sm mb-3">
      <div class="font-semibold" style="color: #422d1e;">Discard changes?</div>
      <div class="text-xs" style="color: #422d1e; opacity: 0.7;">You have unsaved changes. Are you sure you want to close without saving?</div>
    </div>
    <div class="flex justify-end gap-2">
      <button id="keepEditing" class="px-3 py-1 rounded" style="border: 1px solid #d4cac7; color: #422d1e;">Keep editing</button>
      <button id="discardChanges" class="px-3 py-1 bg-red-600 text-white rounded">Discard</button>
    </div>
  </div>
</div>

<!-- Success modal -->
<div id="successModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4 overflow-y-auto">
  <div class="rounded-lg shadow-lg p-6 max-w-md w-full my-auto" style="background-color: #f2eceb;">
    <div class="text-center">
      <div class="mb-4">
        <img id="successUserIcon" src="" alt="User status" class="w-32 h-32 mx-auto" />
      </div>
      <h3 class="text-xl font-bold mb-2" style="color: #422d1e;">Swoop Spot Created!</h3>
      <p id="successMessage" class="mb-4" style="color: #422d1e;">
        <!-- Message will be dynamically set -->
      </p>
      <p id="goodEggMessage" class="text-lg font-medium text-green-600 mb-4">You're a good egg!</p>
      <button id="closeSuccessModal" class="px-6 py-2 text-white rounded-lg" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
        Got it!
      </button>
    </div>
  </div>
</div>

<!-- Exit Prompt Modal -->
<div id="exitPromptModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4 overflow-y-auto">
  <div class="rounded-lg shadow-lg p-6 max-w-lg w-full my-auto max-h-[90vh] flex flex-col" style="background-color: #f2eceb;">
    <div class="mb-4">
      <h3 class="text-xl font-bold mb-2" style="color: #422d1e;">Did you spot any birds?</h3>
      <p class="text-sm" style="color: #422d1e; opacity: 0.7;">You passed through the following swoop zones. Please update each one:</p>
    </div>
    
    <div id="exitPromptList" class="flex-1 overflow-y-auto space-y-3 mb-4">
      <!-- Spots will be dynamically added here -->
    </div>
    
    <div class="flex justify-end gap-2 pt-3" style="border-top: 1px solid #d4cac7;">
      <button id="closeExitPrompt" class="px-4 py-2 rounded" style="border: 1px solid #d4cac7; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='transparent'">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Auth Modal -->
<div id="authModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4">
  <div class="rounded-lg shadow-lg p-6 max-w-md w-full" style="background-color: #f2eceb;">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold" style="color: #422d1e;" id="authModalTitle">Sign In</h3>
      <button id="closeAuthModal" class="text-2xl" style="color: #422d1e; opacity: 0.7;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
    </div>
    
    <!-- Auth Tabs -->
    <div class="flex gap-2 mb-4" style="border-bottom: 1px solid #d4cac7;">
      <button id="signInTab" class="auth-tab active px-4 py-2 font-medium border-b-2" style="border-color: #422d1e; color: #422d1e;">
        Sign In
      </button>
      <button id="signUpTab" class="auth-tab px-4 py-2 font-medium border-b-2 border-transparent" style="color: #422d1e; opacity: 0.6;">
        Sign Up
      </button>
    </div>
    
    <!-- Sign In Form -->
    <form id="signInForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Email</label>
        <input type="email" id="signInEmail" required class="w-full rounded p-2" style="border: 1px solid #d4cac7; background-color: #fff;" placeholder="your@email.com">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Password</label>
        <input type="password" id="signInPassword" required class="w-full rounded p-2" style="border: 1px solid #d4cac7; background-color: #fff;" placeholder="••••••••">
      </div>
      <div id="signInError" class="hidden text-sm text-red-600"></div>
      <button type="submit" class="w-full px-4 py-2 text-white rounded" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
        Sign In
      </button>
    </form>
    
    <!-- Sign Up Form -->
    <form id="signUpForm" class="space-y-4 hidden">
      <div>
        <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Display Name</label>
        <input type="text" id="signUpName" required class="w-full rounded p-2" style="border: 1px solid #d4cac7; background-color: #fff;" placeholder="Your name">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Email</label>
        <input type="email" id="signUpEmail" required class="w-full rounded p-2" style="border: 1px solid #d4cac7; background-color: #fff;" placeholder="your@email.com">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Password</label>
        <input type="password" id="signUpPassword" required minlength="6" class="w-full rounded p-2" style="border: 1px solid #d4cac7; background-color: #fff;" placeholder="••••••••">
        <p class="text-xs mt-1" style="color: #422d1e; opacity: 0.6;">Minimum 6 characters</p>
      </div>
      <div id="signUpError" class="hidden text-sm text-red-600"></div>
      <button type="submit" class="w-full px-4 py-2 text-white rounded" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
        Sign Up
      </button>
    </form>
  </div>
</div>

<!-- User Menu Dropdown -->
<div id="userMenuDropdown" class="hidden absolute top-16 right-4 rounded-lg shadow-lg p-2 z-50" style="background-color: #f2eceb; border: 1px solid #d4cac7; min-width: 220px;">
  <div class="px-3 py-2 border-b flex items-center gap-3" style="border-color: #d4cac7;">
    <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: #f2eceb; padding: 6px;">
      <img id="userMenuAvatar" src="Assets/Users Icons/user_1.svg" alt="User Avatar" style="width: 100%; height: 100%;">
    </div>
    <div class="flex-1">
      <div class="font-medium" style="color: #422d1e;" id="userMenuName">User Name</div>
      <div class="text-xs" style="color: #422d1e; opacity: 0.6;" id="userMenuEmail">email@example.com</div>
    </div>
  </div>
  <button id="userMenuStats" class="w-full text-left px-3 py-2 text-sm rounded hover:bg-gray-100 flex items-center gap-2" style="color: #422d1e;">
    <img src="Assets/Icons/user_stats.svg" alt="Stats" style="width: 18px; height: 18px;">
    My Stats
  </button>
  <button id="userMenuProfile" class="w-full text-left px-3 py-2 text-sm rounded hover:bg-gray-100 flex items-center gap-2" style="color: #422d1e;">
    <img src="Assets/Icons/user.svg" alt="Profile" style="width: 18px; height: 18px;">
    Profile
  </button>
  <button id="userMenuSignOut" class="w-full text-left px-3 py-2 text-sm rounded hover:bg-gray-100 text-red-600">
    🚪 Sign Out
  </button>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4">
  <div class="rounded-lg shadow-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto" style="background-color: #f2eceb;">
    <div class="p-6">
      <!-- Header -->
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold" style="color: #422d1e;">My Profile</h3>
        <button id="closeProfileModal" class="text-2xl" style="color: #422d1e; opacity: 0.7;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
      </div>
      
      <!-- Profile Tabs -->
      <div class="flex gap-2 mb-6" style="border-bottom: 1px solid #d4cac7;">
        <button id="profileStatsTab" class="profile-tab active px-4 py-2 font-medium border-b-2 flex items-center gap-2" style="border-color: #422d1e; color: #422d1e;">
          <img src="Assets/Icons/user_stats.svg" alt="Stats" style="width: 18px; height: 18px;">
          Stats
        </button>
        <button id="profileEditTab" class="profile-tab px-4 py-2 font-medium border-b-2 border-transparent flex items-center gap-2" style="color: #422d1e; opacity: 0.6;">
          <img src="Assets/Icons/user.svg" alt="Profile" style="width: 18px; height: 18px;">
          Edit Profile
        </button>
      </div>
      
      <!-- Stats Content -->
      <div id="profileStatsContent" class="space-y-4">
        <!-- Profile Header -->
        <div class="flex items-center gap-4 p-4 rounded-lg" style="background-color: #e8e2e1;">
          <div class="w-20 h-20 rounded-full flex items-center justify-center" style="background-color: #f2eceb; padding: 10px;" id="profileAvatarContainer">
            <img id="profileAvatar" src="Assets/Users Icons/user_1.svg" alt="User Avatar" style="width: 100%; height: 100%;">
          </div>
          <div class="flex-1">
            <h4 class="text-xl font-bold" style="color: #422d1e;" id="profileDisplayName">Loading...</h4>
            <p class="text-sm" style="color: #422d1e; opacity: 0.7;" id="profileEmail">email@example.com</p>
            <p class="text-xs mt-1" style="color: #422d1e; opacity: 0.6;" id="profileJoined">Member since: Loading...</p>
            <p class="text-sm mt-2 italic" style="color: #422d1e; opacity: 0.8;" id="profileBio"></p>
          </div>
        </div>
        
        <!-- Statistics Cards -->
        <div class="grid grid-cols-2 gap-4">
          <!-- Spots Created -->
          <div class="p-4 rounded-lg text-center" style="background-color: #e8e2e1;">
            <div class="text-3xl font-bold" style="color: #422d1e;" id="statSpotsCreated">0</div>
            <div class="text-sm mt-1" style="color: #422d1e; opacity: 0.7;">Spots Created</div>
          </div>
          
          <!-- Reports Created -->
          <div class="p-4 rounded-lg text-center" style="background-color: #e8e2e1;">
            <div class="text-3xl font-bold" style="color: #422d1e;" id="statReportsCreated">0</div>
            <div class="text-sm mt-1" style="color: #422d1e; opacity: 0.7;">Reports Created</div>
          </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="p-4 rounded-lg" style="background-color: #e8e2e1;">
          <h5 class="font-medium mb-3" style="color: #422d1e;">Recent Contributions</h5>
          <div id="profileRecentActivity" class="space-y-2">
            <!-- Activity will be loaded dynamically -->
          </div>
        </div>
      </div>
      
      <!-- Edit Profile Content -->
      <div id="profileEditContent" class="hidden space-y-4">
        <form id="profileEditForm" class="space-y-4">
          <!-- Display Name -->
          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Display Name</label>
            <input type="text" id="editDisplayName" required class="w-full rounded p-2" style="border: 1px solid #d4cac7; background-color: #fff;" placeholder="Your name">
          </div>
          
          <!-- Avatar Picker -->
          <div>
            <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Choose Avatar</label>
            <div class="grid grid-cols-5 gap-3" id="avatarPicker">
              <button type="button" class="avatar-btn p-2 rounded hover:bg-gray-200 border-2 border-transparent" data-avatar="user_1.svg">
                <img src="Assets/Users Icons/user_1.svg" alt="Avatar 1" style="width: 100%; height: auto;">
              </button>
              <button type="button" class="avatar-btn p-2 rounded hover:bg-gray-200 border-2 border-transparent" data-avatar="user_2.svg">
                <img src="Assets/Users Icons/user_2.svg" alt="Avatar 2" style="width: 100%; height: auto;">
              </button>
              <button type="button" class="avatar-btn p-2 rounded hover:bg-gray-200 border-2 border-transparent" data-avatar="user_3.svg">
                <img src="Assets/Users Icons/user_3.svg" alt="Avatar 3" style="width: 100%; height: auto;">
              </button>
              <button type="button" class="avatar-btn p-2 rounded hover:bg-gray-200 border-2 border-transparent" data-avatar="user_4.svg">
                <img src="Assets/Users Icons/user_4.svg" alt="Avatar 4" style="width: 100%; height: auto;">
              </button>
              <button type="button" class="avatar-btn p-2 rounded hover:bg-gray-200 border-2 border-transparent" data-avatar="user_5.svg">
                <img src="Assets/Users Icons/user_5.svg" alt="Avatar 5" style="width: 100%; height: auto;">
              </button>
              <button type="button" class="avatar-btn p-2 rounded hover:bg-gray-200 border-2 border-transparent" data-avatar="user_6.svg">
                <img src="Assets/Users Icons/user_6.svg" alt="Avatar 6" style="width: 100%; height: auto;">
              </button>
              <button type="button" class="avatar-btn p-2 rounded hover:bg-gray-200 border-2 border-transparent" data-avatar="user_7.svg">
                <img src="Assets/Users Icons/user_7.svg" alt="Avatar 7" style="width: 100%; height: auto;">
              </button>
              <button type="button" class="avatar-btn p-2 rounded hover:bg-gray-200 border-2 border-transparent" data-avatar="user_8.svg">
                <img src="Assets/Users Icons/user_8.svg" alt="Avatar 8" style="width: 100%; height: auto;">
              </button>
              <button type="button" class="avatar-btn p-2 rounded hover:bg-gray-200 border-2 border-transparent" data-avatar="user_9.svg">
                <img src="Assets/Users Icons/user_9.svg" alt="Avatar 9" style="width: 100%; height: auto;">
              </button>
              <button type="button" class="avatar-btn p-2 rounded hover:bg-gray-200 border-2 border-transparent" data-avatar="user_10.svg">
                <img src="Assets/Users Icons/user_10.svg" alt="Avatar 10" style="width: 100%; height: auto;">
              </button>
            </div>
            <input type="hidden" id="selectedAvatar" value="user_1.svg">
          </div>
          
          <!-- Bio (optional) -->
          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Bio (optional)</label>
            <textarea id="editBio" rows="3" class="w-full rounded p-2" style="border: 1px solid #d4cac7; background-color: #fff;" placeholder="Tell us about yourself..."></textarea>
            <p class="text-xs mt-1" style="color: #422d1e; opacity: 0.6;">Max 200 characters</p>
          </div>
          
          <!-- Save Button -->
          <div class="flex gap-2">
            <button type="submit" class="flex-1 px-4 py-2 text-white rounded" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
              💾 Save Changes
            </button>
            <button type="button" id="cancelEditProfile" class="px-4 py-2 rounded" style="background-color: #d4cac7; color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
              Cancel
            </button>
          </div>
          
          <div id="profileEditError" class="hidden text-sm text-red-600"></div>
          <div id="profileEditSuccess" class="hidden text-sm text-green-600"></div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ----------------------------
  // Supabase Configuration
  // ----------------------------
  const SUPABASE_URL = 'https://ghoipwkezxiyjkgikfyw.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdob2lwd2tlenhpeWprZ2lrZnl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDcyNzQsImV4cCI6MjA3NjEyMzI3NH0.T-Sxyq4hv1U1DI5NHD6k30bHWjO0i5BTMeaUAuFRifg';
  
  // Initialize Supabase client
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  // ----------------------------
  // Authentication State
  // ----------------------------
  let currentUser = null;
  let userProfile = null;
  
  // Sync state
  let isSyncing = false;
  let syncEnabled = true; // Can be toggled for offline mode
  
  // ----------------------------
  // Setup map + icons + DOM refs
  // ----------------------------
  // Initialize map with a slight delay to ensure DOM is ready
  const map = L.map('map', {
    minZoom: 3,
    maxZoom: 18
  }).setView([-27.4698, 153.0251], 14);
  
  // Add CartoDB Voyager tiles (colorful, modern map style - free, no API key needed)
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 20
  }).addTo(map);

  function birdSVG(col){
    let iconName;
    switch(col) {
      case '#10B981': iconName = 'swoop_low.svg'; break;
      case '#F59E0B': iconName = 'swoop_caution.svg'; break;
      case '#EF4444': iconName = 'swoop_danger.svg'; break;
      default: iconName = 'swoop_calm.svg';
    }
    return `<img src="Assets/Icons/${iconName}" width="36" height="36" alt="Bird icon">`;
  }
  function getBirdIcon(level){
    let col = '#10B981'; // low risk (green)
    if(level === 'Take caution') col = '#F59E0B'; // caution (amber)
    if(level === 'Danger - Avoid') col = '#EF4444'; // danger (red)
    return L.divIcon({ className:'bird-marker', html: birdSVG(col), iconSize:[36,36], iconAnchor:[18,18] });
  }
  function getBirdIconSVG(level){
    let iconName;
    if(level === 'Danger - Avoid') iconName = 'swoop_danger.svg';
    else if(level === 'Take caution') iconName = 'swoop_caution.svg';
    else iconName = 'swoop_low.svg';
    return `<img src="Assets/Icons/${iconName}" width="48" height="48" alt="Bird icon" class="rounded-lg">`;
  }
  
  // Function to get user icon based on their profile avatar
  function getUserIcon() {
    // Get avatar filename from profile (e.g., "user_3.svg")
    const avatarFilename = userProfile?.avatar_url || 'user.svg';
    // Construct full path based on whether it's a user avatar or default icon
    const avatarPath = avatarFilename.startsWith('user_') 
      ? `Assets/Users Icons/${avatarFilename}` 
      : `Assets/Icons/${avatarFilename}`;
    
    return L.divIcon({ 
      className:'', // Empty className to avoid default Leaflet divIcon styles
      html: `<img src="${avatarPath}" width="36" height="36" alt="User icon">`, 
      iconSize:[36,36], 
      iconAnchor:[18,18] 
    });
  }

  // DOM refs
  const openAddBtn = document.getElementById('openAddBtn');
  const spotModal = document.getElementById('spotModal');
  const closeSpotModal = document.getElementById('closeSpotModal');
  const spotForm = document.getElementById('spotForm');
  const birdSpecies = document.getElementById('birdSpecies');
  const addressField = document.getElementById('addressField');
  const addressInfo = document.getElementById('addressInfo');
  const coordsField = document.getElementById('coordsField');
  const rbirdBox = document.getElementById('rbirdBox');
  const rbirdList = document.getElementById('rbirdList');
  const rhumanBox = document.getElementById('rhumanBox');
  const rhumanList = document.getElementById('rhumanList');
  const rprecBox = document.getElementById('rprecBox');
  const rprecList = document.getElementById('rprecList');
  const ralertLevel = document.getElementById('ralertLevel');
  const reextra = document.getElementById('reextra');
  const spotCancel = document.getElementById('spotCancel');
  const geoBtn = document.getElementById('geoBtn');

  const detailsModal = document.getElementById('detailsModal');
  const closeDetails = document.getElementById('closeDetails');
  const detailsTitle = document.getElementById('detailsTitle');
  const reportsFeed = document.getElementById('reportsFeed');
  const spotHeader = document.getElementById('spotHeader');
  const reportForm = document.getElementById('reportForm');
  const rbirdBox2 = document.getElementById('rbirdBox2');
  const rbirdList2 = document.getElementById('rbirdList2');
  const rhumanBox2 = document.getElementById('rhumanBox2');
  const rhumanList2 = document.getElementById('rhumanList2');
  const rprecBox2 = document.getElementById('rprecBox2');
  const rprecList2 = document.getElementById('rprecList2');
  const repAlertLevel = document.getElementById('repAlertLevel');
  const repExtra = document.getElementById('repExtra');
  const reportCancel = document.getElementById('reportCancel');

  const alertsList = document.getElementById('alertsList');
  const alertBox = document.getElementById('alertBox');

  const confirmModal = document.getElementById('confirmModal');
  const keepEditing = document.getElementById('keepEditing');
  const discardChanges = document.getElementById('discardChanges');

  const successModal = document.getElementById('successModal');
  const closeSuccessModal = document.getElementById('closeSuccessModal');
  const successUserIcon = document.getElementById('successUserIcon');
  const successMessage = document.getElementById('successMessage');
  const goodEggMessage = document.getElementById('goodEggMessage');

  const exitPromptModal = document.getElementById('exitPromptModal');
  const exitPromptList = document.getElementById('exitPromptList');
  const closeExitPrompt = document.getElementById('closeExitPrompt');

  // Auth UI refs
  const authModal = document.getElementById('authModal');
  const closeAuthModal = document.getElementById('closeAuthModal');
  const signInTab = document.getElementById('signInTab');
  const signUpTab = document.getElementById('signUpTab');
  const signInForm = document.getElementById('signInForm');
  const signUpForm = document.getElementById('signUpForm');
  const signInEmail = document.getElementById('signInEmail');
  const signInPassword = document.getElementById('signInPassword');
  const signInError = document.getElementById('signInError');
  const signUpName = document.getElementById('signUpName');
  const signUpEmail = document.getElementById('signUpEmail');
  const signUpPassword = document.getElementById('signUpPassword');
  const signUpError = document.getElementById('signUpError');
  const signInButton = document.getElementById('signInButton');
  const userButton = document.getElementById('userButton');
  const userButtonName = document.getElementById('userButtonName');
  const userMenuDropdown = document.getElementById('userMenuDropdown');
  const userMenuName = document.getElementById('userMenuName');
  const userMenuEmail = document.getElementById('userMenuEmail');
  const userMenuStats = document.getElementById('userMenuStats');
  const userMenuProfile = document.getElementById('userMenuProfile');
  const userMenuSignOut = document.getElementById('userMenuSignOut');
  
  // Profile Modal Elements
  const profileModal = document.getElementById('profileModal');
  const closeProfileModal = document.getElementById('closeProfileModal');
  const profileStatsTab = document.getElementById('profileStatsTab');
  const profileEditTab = document.getElementById('profileEditTab');
  const profileStatsContent = document.getElementById('profileStatsContent');
  const profileEditContent = document.getElementById('profileEditContent');
  const profileEditForm = document.getElementById('profileEditForm');
  const editDisplayName = document.getElementById('editDisplayName');
  const selectedAvatar = document.getElementById('selectedAvatar');
  const editBio = document.getElementById('editBio');
  const profileEditError = document.getElementById('profileEditError');
  const profileEditSuccess = document.getElementById('profileEditSuccess');
  const cancelEditProfile = document.getElementById('cancelEditProfile');
  
  // Debug: Check if elements exist
  console.log('Profile modal elements:', {
    profileModal: !!profileModal,
    closeProfileModal: !!closeProfileModal,
    profileStatsTab: !!profileStatsTab,
    userMenuStats: !!userMenuStats,
    userMenuProfile: !!userMenuProfile
  });

  const trackLocationBtn = document.getElementById('trackLocationBtn');
  const trackBtnText = document.getElementById('trackBtnText');
  const useGPSBtn = document.getElementById('useGPSBtn');

  const playSim = document.getElementById('playSim');
  const stopSim = document.getElementById('stopSim');

  // constants + data arrays
  const STORAGE_KEY = 'swoop_reports_v1';
  const BIRD_BEHAVIOURS = ["noisy","swoop","close swoop","made contact + uninjured","made contact + injured"];
  const HUMAN_BEHAVIOURS = ["walking","running","cycling","riding e-scooter","alone","with others","with pram","with children","in group","other"];
  const PRECAUTIONS = ["Hat","Sunglasses","Umbrella","Helmet","Helmet with Cable Ties","Made Eye Contact","None"];

  // state
  let spots = []; // spot objects with reports array
  let tempMarker = null;
  let selectedLocation = null; // {lat,lng}
  let initialFormState = null; // for dirty checks
  let selectedRBird = [], selectedRHuman = [], selectedRPrec = [];
  let selectedReportBird = [], selectedReportHuman = [], selectedReportPrec = [];
  let activeDetailsSpotId = null;
  let userMarker = null;
  let simTimer = null, simPath = [], simIndex = 0;
  
  // Location tracking state
  let locationWatchId = null;
  let isTracking = false;

  // cute names - expanded dataset with 50+ creative generic bird names
  const cuteNames = [
    "Fluffy Breeze", "Peckle Pops", "Feather Fiasco", "Wingy Woo", "Sir Chirpsalot",
    "Cloud Nibbler", "Little Zoomer", "Chirpadoodle", "Pip Squeak", "Muffin Flap",
    "Captain Beaky", "Swoopy McSwoopface", "Tweety Tornado", "Baron Von Birb",
    "Princess Plume", "Sky Rascal", "Beaky Blinder", "Lord Featherbottom",
    "Waddle Wellington", "Squawk Box", "Professor Peck", "Ruffles McGee",
    "Wing Commander", "Count Flappula", "Duchess Downy", "Sir Flapsalot",
    "Mister Whistle", "Lady Wingnut", "Captain Caw", "Feathers O'Malley",
    "Birdy Sanders", "Nest Potato", "Flap Jackson", "Beaker Bonanza",
    "Sergeant Swoop", "Admiral Airborne", "Doctor Doodle", "Judge Jitters",
    "Mayor Feathers", "Sheriff Screech", "Detective Talon", "Colonel Crest",
    "General Wings", "Lieutenant Chirp", "Commander Cluck", "Private Peck",
    "Zippy Zephyr", "Gusty Gale", "Breezy Buddy", "Windy Wanderer",
    "Talon Trouble", "Skyward Sam", "Aerial Ace", "Hover Helper",
    "Perch Patrol", "Branch Boss", "Treetop Terror", "Canopy Captain",
    "Swoosh Sultan", "Draft Dodger", "Glide Guide", "Soar Supreme"
  ];
  function randName(){ return cuteNames[Math.floor(Math.random()*cuteNames.length)]; }
  
  // Get a unique name within 5km radius
  function getUniqueName(lat, lng) {
    // Get all spot names within 5km
    const usedNames = spots
      .filter(s => metersBetween(lat, lng, s.lat, s.lng) <= 5000)
      .map(s => s.name);
    
    // Get available names (not used within 5km)
    const availableNames = cuteNames.filter(name => !usedNames.includes(name));
    
    // If all names are used within 5km, just use any random name
    if (availableNames.length === 0) {
      return randName();
    }
    
    // Return a random name from available names
    return availableNames[Math.floor(Math.random() * availableNames.length)];
  }
  
  function uid(){ return 's_' + Math.random().toString(36).slice(2,9); }

  // Format timestamp to show relative time
  function formatTimeAgo(timestamp) {
    const now = Date.now();
    const then = new Date(timestamp).getTime();
    const diff = now - then;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (days > 0) {
      return `${days} day${days > 1 ? 's' : ''} ago`;
    }
    
    if (hours > 0) {
      const remainingMinutes = minutes % 60;
      if (remainingMinutes > 0) {
        return `${hours} hour${hours > 1 ? 's' : ''} ${remainingMinutes} minute${remainingMinutes > 1 ? 's' : ''} ago`;
      }
      return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    }
    
    return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
  }

  // Debounce helper
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // Get radius based on risk level
  function getRadiusByRisk(risk) {
    return risk === 'Danger - Avoid' ? 100 : 
           risk === 'Take caution' ? 80 : 50;
  }

  function metersBetween(aLat,aLng,bLat,bLng){
    const R=6371e3, toRad=v=>v*Math.PI/180;
    const φ1=toRad(aLat), φ2=toRad(bLat), Δφ=toRad(bLat-aLat), Δλ=toRad(bLng-aLng);
    const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
  function toast(msg, t=1600){ const el=document.createElement('div'); el.innerHTML=`<div class="fixed top-24 right-6 z-50 text-white px-3 py-2 rounded" style="background-color: #422d1e;">${String(msg)}</div>`; document.body.appendChild(el); setTimeout(()=>el.remove(), t); }
  function escapeHtml(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // ----------------------------
  // Authentication Functions
  // ----------------------------
  
  // Check auth state on load
  async function initAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      await handleAuthStateChange(session.user);
    }
    
    // Listen for auth changes
    supabase.auth.onAuthStateChange(async (event, session) => {
      if (event === 'SIGNED_IN' && session) {
        await handleAuthStateChange(session.user);
      } else if (event === 'SIGNED_OUT') {
        handleSignOut();
      }
    });
  }
  
  // Load user profile from database
  async function loadUserProfile() {
    if (!currentUser) return null;
    
    const { data: profile, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', currentUser.id)
      .single();
    
    if (profile) {
      userProfile = profile;
      console.log('Profile loaded:', profile);
    } else {
      console.log('No profile found, user metadata:', currentUser.user_metadata);
      // Profile might not exist yet, use metadata as fallback
      userProfile = {
        display_name: currentUser.user_metadata?.display_name || currentUser.email.split('@')[0],
        email: currentUser.email
      };
    }
    
    return userProfile;
  }
  
  // Handle user sign in
  async function handleAuthStateChange(user) {
    currentUser = user;
    
    // Fetch user profile
    await loadUserProfile();
    
    // Update UI
    updateAuthUI();
    
    // Reload spots with user context
    await loadAllFromSupabase();
    
    toast(`Welcome back, ${userProfile?.display_name || user.email.split('@')[0]}!`, 2000);
  }
  
  // Update UI based on auth state
  function updateAuthUI() {
    if (currentUser) {
      // Show user button, hide sign in
      signInButton.classList.add('hidden');
      userButton.classList.remove('hidden');
      userButton.classList.add('flex');
      
      // Get display name from profile or user metadata or email
      const displayName = userProfile?.display_name || 
                         currentUser.user_metadata?.display_name || 
                         currentUser.email.split('@')[0];
      
      userButtonName.textContent = displayName;
      
      // Update menu
      userMenuName.textContent = displayName;
      userMenuEmail.textContent = currentUser.email;
      
      // Update menu avatar
      const avatarUrl = userProfile?.avatar_url || 'user_1.svg';
      const userMenuAvatar = document.getElementById('userMenuAvatar');
      if (userMenuAvatar) {
        userMenuAvatar.src = `Assets/Users Icons/${avatarUrl}`;
      }
      
      console.log('UI updated with display name:', displayName);
    } else {
      // Show sign in, hide user button
      signInButton.classList.remove('hidden');
      userButton.classList.add('hidden');
      userMenuDropdown.classList.add('hidden');
    }
  }
  
  // Handle sign out
  function handleSignOut() {
    currentUser = null;
    userProfile = null;
    updateAuthUI();
    toast('Signed out successfully', 2000);
  }
  
  // Sign in with email/password
  async function signIn(email, password) {
    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
      });
      
      if (error) throw error;
      
      authModal.classList.add('hidden');
      signInError.classList.add('hidden');
      signInForm.reset();
      
      return { success: true };
    } catch (error) {
      console.error('Sign in error:', error);
      signInError.textContent = error.message;
      signInError.classList.remove('hidden');
      return { success: false, error };
    }
  }
  
  // Sign up with email/password
  async function signUp(name, email, password) {
    try {
      const { data, error } = await supabase.auth.signUp({
        email: email,
        password: password,
        options: {
          data: {
            display_name: name
          }
        }
      });
      
      if (error) throw error;
      
      // If user was created, ensure profile has correct display name
      if (data.user) {
        // Wait a bit for trigger to fire, then check/update profile
        setTimeout(async () => {
          try {
            const { data: existingProfile } = await supabase
              .from('profiles')
              .select('*')
              .eq('id', data.user.id)
              .single();
            
            if (existingProfile && !existingProfile.display_name) {
              // Update profile with correct display name
              await supabase
                .from('profiles')
                .update({ display_name: name })
                .eq('id', data.user.id);
              console.log('Profile display name updated to:', name);
            } else if (!existingProfile) {
              // Create profile manually if trigger didn't work
              await supabase
                .from('profiles')
                .insert({
                  id: data.user.id,
                  email: email,
                  display_name: name
                });
              console.log('Profile created manually with display name:', name);
            }
          } catch (profileError) {
            console.warn('Profile update/create failed:', profileError);
          }
        }, 1000);
      }
      
      authModal.classList.add('hidden');
      signUpError.classList.add('hidden');
      signUpForm.reset();
      
      // Check if email confirmation is required
      if (data.user && !data.session) {
        toast('Account created! Please check your email to verify.', 4000);
      } else {
        toast('Account created! You can now start creating spots.', 3000);
      }
      
      return { success: true };
    } catch (error) {
      console.error('Sign up error:', error);
      signUpError.textContent = error.message;
      signUpError.classList.remove('hidden');
      return { success: false, error };
    }
  }
  
  // Sign out
  async function signOutUser() {
    try {
      const { error } = await supabase.auth.signOut();
      if (error) throw error;
    } catch (error) {
      console.error('Sign out error:', error);
      toast('Error signing out', 2000);
    }
  }

  // ----------------------------
  // Profile Modal Functions
  // ----------------------------
  
  async function openProfileModal() {
    console.log('openProfileModal called', { currentUser, userProfile });
    
    if (!currentUser) {
      toast('Please sign in first', 2000);
      return;
    }
    
    // Load fresh profile data
    await loadUserProfile();
    
    // Populate profile header
    document.getElementById('profileDisplayName').textContent = userProfile?.display_name || currentUser.email.split('@')[0];
    document.getElementById('profileEmail').textContent = currentUser.email;
    
    // Set avatar image
    const avatarUrl = userProfile?.avatar_url || 'user_1.svg';
    document.getElementById('profileAvatar').src = `Assets/Users Icons/${avatarUrl}`;
    
    // Format join date
    const joinDate = new Date(currentUser.created_at);
    document.getElementById('profileJoined').textContent = `Member since: ${joinDate.toLocaleDateString()}`;
    
    // Display bio
    const bioElement = document.getElementById('profileBio');
    if (userProfile?.bio && userProfile.bio.trim()) {
      bioElement.textContent = `"${userProfile.bio}"`;
      bioElement.style.display = 'block';
    } else {
      bioElement.style.display = 'none';
    }
    
    // Update stats
    document.getElementById('statSpotsCreated').textContent = userProfile?.total_spots_created || 0;
    document.getElementById('statReportsCreated').textContent = userProfile?.total_reports_created || 0;
    
    // Load recent activity
    await loadRecentActivity();
    
    // Populate edit form
    editDisplayName.value = userProfile?.display_name || currentUser.email.split('@')[0];
    selectedAvatar.value = userProfile?.avatar_url || 'user_1.svg';
    editBio.value = userProfile?.bio || '';
    
    // Update avatar picker selection
    document.querySelectorAll('.avatar-btn').forEach(btn => {
      if (btn.dataset.avatar === selectedAvatar.value) {
        btn.style.borderColor = '#422d1e';
        btn.style.backgroundColor = '#e8e2e1';
      } else {
        btn.style.borderColor = 'transparent';
        btn.style.backgroundColor = '';
      }
    });
    
    // Show modal on stats tab
    profileStatsTab.click();
    profileModal.classList.remove('hidden');
  }
  
  
  function closeProfileModalFn() {
    profileModal.classList.add('hidden');
    profileEditError.classList.add('hidden');
    profileEditSuccess.classList.add('hidden');
  }
  
  async function loadRecentActivity() {
    const activityContainer = document.getElementById('profileRecentActivity');
    activityContainer.innerHTML = '<span style="color: #422d1e; opacity: 0.6;" class="text-sm">Loading...</span>';
    
    try {
      const { data: recentSpots, error: spotsError } = await supabase
        .from('spots')
        .select('id, name, species, created_at')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false })
        .limit(5);
      
      if (spotsError) throw spotsError;
      
      if (!recentSpots || recentSpots.length === 0) {
        activityContainer.innerHTML = '<span style="color: #422d1e; opacity: 0.6;" class="text-sm">No recent activity</span>';
        return;
      }
      
      activityContainer.innerHTML = '';
      recentSpots.forEach(spot => {
        const activityEl = document.createElement('div');
        activityEl.className = 'flex items-start gap-2 text-sm';
        activityEl.style.cssText = 'color: #422d1e;';
        
        const date = new Date(spot.created_at);
        const timeAgo = getTimeAgo(date);
        
        activityEl.innerHTML = `
          <span>📍</span>
          <div class="flex-1">
            <span class="font-medium">${spot.name}</span>
            <span style="opacity: 0.7;"> - ${spot.species}</span>
            <br>
            <span style="opacity: 0.6;" class="text-xs">${timeAgo}</span>
          </div>
        `;
        activityContainer.appendChild(activityEl);
      });
    } catch (error) {
      console.error('Error loading recent activity:', error);
      activityContainer.innerHTML = '<span style="color: #422d1e; opacity: 0.6;" class="text-sm">Error loading activity</span>';
    }
  }
  
  function getTimeAgo(date) {
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
    return date.toLocaleDateString();
  }
  
  async function updateUserProfile(e) {
    e.preventDefault();
    
    profileEditError.classList.add('hidden');
    profileEditSuccess.classList.add('hidden');
    
    const newDisplayName = editDisplayName.value.trim();
    const newAvatar = selectedAvatar.value;
    const newBio = editBio.value.trim().substring(0, 200);
    
    if (!newDisplayName) {
      profileEditError.textContent = 'Display name is required';
      profileEditError.classList.remove('hidden');
      return;
    }
    
    try {
      console.log('Updating profile:', { newDisplayName, newAvatar, newBio, userId: currentUser.id });
      
      const { data, error } = await supabase
        .from('profiles')
        .update({
          display_name: newDisplayName,
          avatar_url: newAvatar,
          bio: newBio
        })
        .eq('id', currentUser.id)
        .select();
      
      if (error) {
        console.error('Supabase error:', error);
        throw error;
      }
      
      console.log('Profile updated successfully:', data);
      
      userProfile = {
        ...userProfile,
        display_name: newDisplayName,
        avatar_url: newAvatar,
        bio: newBio
      };
      
      updateAuthUI();
      
      // Update user marker icon on map
      if (userMarker) {
        try {
          userMarker.setIcon(getUserIcon());
        } catch(e) {
          console.error('Error updating user marker icon:', e);
        }
      }
      
      profileEditSuccess.textContent = 'Profile updated successfully!';
      profileEditSuccess.classList.remove('hidden');
      
      setTimeout(() => {
        profileStatsTab.click();
        document.getElementById('profileDisplayName').textContent = newDisplayName;
        document.getElementById('profileAvatar').src = `Assets/Users Icons/${newAvatar}`;
      }, 1000);
      
    } catch (error) {
      console.error('Error updating profile:', error);
      profileEditError.textContent = `Error: ${error.message || 'Please try again.'}`;
      profileEditError.classList.remove('hidden');
    }
  }

  // ----------------------------
  // Persistence (Supabase + localStorage fallback)
  // ----------------------------
  
  // Save spot to Supabase
  async function saveSpotToSupabase(spot) {
    if (!syncEnabled) return;
    
    try {
      isSyncing = true;
      
      // Prepare spot data (exclude UI elements)
      const spotData = {
        id: spot.id,
        name: spot.name,
        species: spot.species,
        lat: Number(spot.lat),
        lng: Number(spot.lng),
        risk: spot.risk,
        user_id: currentUser?.id || null,
        created_by_name: currentUser ? (userProfile?.display_name || currentUser.email.split('@')[0]) : null
      };
      
      // Upsert spot (insert or update)
      const { data: spotResult, error: spotError } = await supabase
        .from('spots')
        .upsert(spotData)
        .select();
      
      if (spotError) throw spotError;
      
      // Save reports for this spot
      if (spot.reports && spot.reports.length > 0) {
        const reportsData = spot.reports.map(r => ({
          id: r.id,
          spot_id: spot.id,
          alert_level: r.alertLevel,
          bird_behaviour: r.birdBehaviour || [],
          human_behaviour: r.humanBehaviour || [],
          precautions: r.precautions || [],
          extra_details: r.extraDetails || '',
          timestamp: r.timestamp,
          user_id: r.user_id || currentUser?.id || null,
          created_by_name: r.created_by_name || (currentUser ? (userProfile?.display_name || currentUser.email.split('@')[0]) : null)
        }));
        
        const { error: reportsError } = await supabase
          .from('reports')
          .upsert(reportsData);
        
        if (reportsError) throw reportsError;
      }
      
      console.log('✅ Spot synced to Supabase:', spot.name);
      
    } catch (error) {
      console.error('❌ Error saving to Supabase:', error);
      toast('Sync error - saved locally', 2000);
    } finally {
      isSyncing = false;
    }
  }
  
  // Save all spots to localStorage (backup)
  function saveAll(){
    try {
      const serial = spots.map(s => {
        const { marker, circle, ...rest } = s;
        return rest;
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(serial));
    } catch(e){ console.warn(e); }
  }
  
  // Load all spots from Supabase
  async function loadAllFromSupabase() {
    if (!syncEnabled) {
      loadAll(); // Fallback to localStorage
      return;
    }
    
    try {
      toast('Loading spots from cloud...', 1000);
      
      // Fetch all spots with their reports
      const { data: spotsData, error } = await supabase
        .from('spots')
        .select(`
          *,
          reports (*)
        `)
        .order('created_at', { ascending: false });
      
      if (error) throw error;
      
      // Clear existing spots
      spots.forEach(s => {
        try {
          map.removeLayer(s.marker);
          map.removeLayer(s.circle);
        } catch(e) {}
      });
      spots = [];
      
      // Create spots from Supabase data
      if (spotsData && spotsData.length > 0) {
        spotsData.forEach(spotData => {
          // Convert Supabase format to app format
          const spot = {
            id: spotData.id,
            name: spotData.name,
            species: spotData.species,
            lat: Number(spotData.lat),
            lng: Number(spotData.lng),
            risk: spotData.risk,
            reports: (spotData.reports || []).map(r => ({
              id: r.id,
              alertLevel: r.alert_level,
              birdBehaviour: r.bird_behaviour || [],
              humanBehaviour: r.human_behaviour || [],
              precautions: r.precautions || [],
              extraDetails: r.extra_details || '',
              timestamp: r.timestamp
            }))
          };
          
          createSpotFromData(spot, true);
        });
        
        toast(`Loaded ${spotsData.length} spots from cloud`, 2000);
      } else {
        toast('No spots found - add your first!', 2000);
      }
      
      // Save to localStorage as backup
      saveAll();
      
    } catch (error) {
      console.error('❌ Error loading from Supabase:', error);
      toast('Loading from local storage...', 2000);
      loadAll(); // Fallback to localStorage
    }
  }
  
  // Load from localStorage (fallback/offline)
  function loadAll(){
    try {
      const raw = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      raw.forEach(r => createSpotFromData(r, true));
    } catch(e){ console.warn(e); }
  }
  
  // Subscribe to real-time updates
  function subscribeToRealtimeUpdates() {
    if (!syncEnabled) return;
    
    // Subscribe to spots table changes
    const spotsChannel = supabase
      .channel('spots-changes')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'spots'
        },
        (payload) => {
          console.log('🔄 Spot changed:', payload);
          handleSpotRealTimeUpdate(payload);
        }
      )
      .subscribe();
    
    // Subscribe to reports table changes
    const reportsChannel = supabase
      .channel('reports-changes')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'reports'
        },
        (payload) => {
          console.log('🔄 Report changed:', payload);
          handleReportRealTimeUpdate(payload);
        }
      )
      .subscribe();
  }
  
  // Handle real-time spot updates
  function handleSpotRealTimeUpdate(payload) {
    const { eventType, new: newSpot, old: oldSpot } = payload;
    
    if (eventType === 'INSERT') {
      // New spot added by another user
      const existingSpot = spots.find(s => s.id === newSpot.id);
      if (!existingSpot) {
        toast(`New spot: ${newSpot.name}`, 2000);
        loadAllFromSupabase(); // Reload to get the new spot with reports
      }
    } else if (eventType === 'UPDATE') {
      // Spot updated
      loadAllFromSupabase(); // Reload to get updates
    } else if (eventType === 'DELETE') {
      // Spot deleted
      const spot = spots.find(s => s.id === oldSpot.id);
      if (spot) {
        try {
          map.removeLayer(spot.marker);
          map.removeLayer(spot.circle);
        } catch(e) {}
        spots = spots.filter(s => s.id !== oldSpot.id);
        renderAlerts();
        saveAll();
      }
    }
  }
  
  // Handle real-time report updates
  function handleReportRealTimeUpdate(payload) {
    // When a report changes, reload the affected spot
    loadAllFromSupabase();
  }

  // ----------------------------
  // Robust Tag UI: idempotent, safe to re-run
  // Replaces previous setupTagUI implementation
  // ----------------------------
  function setupTagUI(box, list, options, selectedArray, onChange){
    // remove previously attached handlers stored on elements (if any)
    if (box._tagui_cleanup) {
      try { box._tagui_cleanup(); } catch(e){ /* ignore */ }
      delete box._tagui_cleanup;
    }
    if (list._tagui_cleanup) {
      try { list._tagui_cleanup(); } catch(e){ /* ignore */ }
      delete list._tagui_cleanup;
    }

    // render function (idempotent)
    function render(){
      box.innerHTML = '';
      selectedArray.forEach(p=>{
        const span = document.createElement('span');
        span.className='tag';
        span.innerHTML = `${escapeHtml(p)} <span class="x" data-val="${escapeHtml(p)}">&times;</span>`;
        box.appendChild(span);
      });
      if(selectedArray.length === 0){
        const ph = document.createElement('span');
        ph.className='text-xs text-gray-500';
        ph.textContent='Select...';
        box.appendChild(ph);
      }
      const caret = document.createElement('span');
      caret.innerHTML='&#9662;';
      caret.style.marginLeft='auto';
      caret.className='text-gray-400 text-sm';
      box.appendChild(caret);
    }

    // helper to populate list
    function populateList(){
      list.innerHTML = '';
      options.forEach(p => {
        const d = document.createElement('div');
        d.textContent = p;
        d.dataset.val = p;
        list.appendChild(d);
      });
    }

    // state for whether list is shown
    let listVisible = false;

    // click handler for box (toggle list)
    const onBoxClick = (e) => {
      e.stopPropagation();
      // toggle
      listVisible = !listVisible;
      if(listVisible){
        populateList();
        list.style.display = 'block';
      } else {
        list.style.display = 'none';
      }
    };

    // click handler for list items
    const onListClick = (e) => {
      const v = e.target && e.target.dataset && e.target.dataset.val;
      if(!v) return;
      if(!selectedArray.includes(v)) selectedArray.push(v);
      render();
      onChange && onChange();
      list.style.display = 'none';
      listVisible = false;
    };

    // click handler for removing a tag (delegated on the box)
    const onBoxRemoveClick = (e) => {
      const x = e.target.closest('.x');
      if(!x) return;
      const v = x.dataset.val;
      const idx = selectedArray.indexOf(v);
      if(idx>-1) selectedArray.splice(idx,1);
      render();
      onChange && onChange();
    };

    // global click to hide lists when clicking outside
    const onDocumentClick = (e) => {
      if(listVisible){
        list.style.display = 'none';
        listVisible = false;
      }
    };

    // attach listeners
    box.addEventListener('click', onBoxClick);
    list.addEventListener('click', onListClick);
    box.addEventListener('click', onBoxRemoveClick);
    document.addEventListener('click', onDocumentClick);

    // store cleanup function so subsequent initializations remove handlers
    box._tagui_cleanup = () => {
      try { box.removeEventListener('click', onBoxClick); } catch(e){}
      try { box.removeEventListener('click', onBoxRemoveClick); } catch(e){}
      try { document.removeEventListener('click', onDocumentClick); } catch(e){}
      try { list.removeEventListener('click', onListClick); } catch(e){}
      // hide list on cleanup
      try { list.style.display = 'none'; } catch(e){}
    };
    list._tagui_cleanup = box._tagui_cleanup;

    // initial render
    render();
  }

  // initializeAllTagUIs: central handler to reset & attach tag UIs cleanly
  function initializeAllTagUIs(){
    // hide any floating lists left open
    document.querySelectorAll('.tag-list').forEach(el => { el.style.display = 'none'; });

    // reset and attach create-spot modal tags
    selectedRBird = [];
    selectedRHuman = [];
    selectedRPrec = [];
    setupTagUI(rbirdBox, rbirdList, BIRD_BEHAVIOURS, selectedRBird, updateRAlertFromBirds);
    setupTagUI(rhumanBox, rhumanList, HUMAN_BEHAVIOURS, selectedRHuman, ()=>{});
    setupTagUI(rprecBox, rprecList, PRECAUTIONS, selectedRPrec, ()=>{});

    // reset and attach add-report modal tags
    selectedReportBird = [];
    selectedReportHuman = [];
    selectedReportPrec = [];
    setupTagUI(rbirdBox2, rbirdList2, BIRD_BEHAVIOURS, selectedReportBird, updateRepAlertFromBirds);
    setupTagUI(rhumanBox2, rhumanList2, HUMAN_BEHAVIOURS, selectedReportHuman, ()=>{});
    setupTagUI(rprecBox2, rprecList2, PRECAUTIONS, selectedReportPrec, ()=>{});
  }

  // ----------------------------
  // Alert level logic
  // ----------------------------
  function computeAlertFromBirds(birdTags){
    if(!Array.isArray(birdTags)) return 'Low risk';
    if(birdTags.includes('made contact + injured') || birdTags.includes('made contact + uninjured')) return 'Danger - Avoid';
    if(birdTags.includes('close swoop')) return 'Take caution';
    // if has swoop or noisy or none -> Low risk
    return 'Low risk';
  }
  function updateRAlertFromBirds(){ ralertLevel.value = computeAlertFromBirds(selectedRBird); }
  function updateRepAlertFromBirds(){ repAlertLevel.value = computeAlertFromBirds(selectedReportBird); }

  // ----------------------------
  // Geocoding (Nominatim)
  // ----------------------------
  async function geocodeAddress(q){
    const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q);
    const res = await fetch(url);
    const j = await res.json();
    if(!j || j.length===0) throw new Error('Address not found');
    return { lat: parseFloat(j[0].lat), lng: parseFloat(j[0].lon), display: j[0].display_name };
  }

  // Address suggestions UI
  function createAddressList(input) {
    let listId = input.id + '_suggestions';
    let existingList = document.getElementById(listId);
    if (!existingList) {
      const list = document.createElement('div');
      list.id = listId;
      list.className = 'absolute left-0 right-0 rounded-lg shadow-lg mt-1 z-50 max-h-48 overflow-y-auto hidden';
      list.style.backgroundColor = '#f2eceb';
      list.style.border = '1px solid #d4cac7';
      input.parentElement.style.position = 'relative';
      input.parentElement.appendChild(list);
      return list;
    }
    return existingList;
  }

  // Address lookup and suggestion handler
  async function handleAddressLookup(input) {
    if (!input.value.trim()) {
      const list = document.getElementById(input.id + '_suggestions');
      if (list) list.classList.add('hidden');
      return;
    }

    try {
      const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(input.value.trim());
      const res = await fetch(url);
      const results = await res.json();
      
      const list = createAddressList(input);
      list.innerHTML = '';
      
      if (results.length > 0) {
        results.slice(0, 5).forEach(r => {
          const div = document.createElement('div');
          div.className = 'p-2 cursor-pointer text-sm';
          div.style.color = '#422d1e';
          div.textContent = r.display_name;
          div.addEventListener('mouseover', () => div.style.backgroundColor = '#e8e2e1');
          div.addEventListener('mouseout', () => div.style.backgroundColor = 'transparent');
          div.addEventListener('click', () => {
            input.value = r.display_name;
            if (input.id === 'addressField') {
              selectedLocation = { lat: parseFloat(r.lat), lng: parseFloat(r.lon) };
              coordsField.value = `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
              addressInfo.textContent = `Selected: ${r.display_name}`;
              if (tempMarker) try { map.removeLayer(tempMarker); } catch(e){}
              tempMarker = L.marker([selectedLocation.lat, selectedLocation.lng]).addTo(map);
              map.setView([selectedLocation.lat, selectedLocation.lng], 16);
            }
            list.classList.add('hidden');
          });
          list.appendChild(div);
        });
        list.classList.remove('hidden');
      } else {
        list.classList.add('hidden');
      }
    } catch(err) {
      console.warn('Address lookup error:', err);
    }
  }

  // Setup debounced address lookup
  const debouncedAddressLookup = debounce(handleAddressLookup, 300);

  // ----------------------------
  // Map click behavior
  // ----------------------------
  map.on('click', (e) => {
    // if the spot modal is open, treat click as selected location
    if(!spotModal.classList.contains('hidden')){
      selectedLocation = { lat: e.latlng.lat, lng: e.latlng.lng };
      coordsField.value = `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
      addressInfo.textContent = `Selected from map: ${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
      if(tempMarker) try{ map.removeLayer(tempMarker); } catch(e){}
      tempMarker = L.marker(e.latlng).addTo(map);
      return;
    }
    // when details modal open, do nothing special
    if(!detailsModal.classList.contains('hidden')) return;
    // otherwise pan
    map.panTo(e.latlng);
  });

  // ----------------------------
  // Create spot & reports model
  // ----------------------------
  function createSpotFromData(data, skipSave=false){
    if(!data.id) data.id = uid();
    if(!Array.isArray(data.reports)) data.reports = [];
    // compute risk if absent
    if(!data.risk) data.risk = computeSpotRiskFromReports(data.reports);
    
    const lat = Number(data.lat), lng = Number(data.lng);
    const marker = L.marker([lat,lng], { icon: getBirdIcon(data.risk) }).addTo(map);
    const radius = getRadiusByRisk(data.risk);
    
    const circle = L.circle([lat,lng], { 
      radius: radius,
      color: data.risk === 'Danger - Avoid' ? '#EF4444' : data.risk === 'Take caution' ? '#F59E0B' : '#10B981',
      fillColor: data.risk === 'Danger - Avoid' ? '#FEE2E2' : data.risk === 'Take caution' ? '#FEF3C7' : '#DCFCE7',
      fillOpacity: 0.35 
    }).addTo(map);

    const spot = {
      id: data.id,
      name: data.name || 'Swoop Spot',
      species: data.species || data.birdSpecies || '',
      lat, lng,
      address: data.address || '',
      radius: getRadiusByRisk(data.risk),
      risk: data.risk,
      reports: data.reports.slice(),
      safePassageCount: data.safePassageCount || 0,
      marker, circle
    };

    // marker click shows quick alert (custom yellow box)
    marker.on('click', ()=> showSpotQuickAlert(spot));

    spots.push(spot);
    if(!skipSave) {
      saveAll(); // Save to localStorage
      saveSpotToSupabase(spot); // Sync to Supabase
    }
    renderAlerts();
    return spot;
  }

  function buildSpotPopup(s){
    return `<div class="text-sm"><b>${escapeHtml(s.name)}</b><br/>Species: ${escapeHtml(s.species)}<br/>Risk: ${escapeHtml(s.risk)}<br/>Reports: ${s.reports.length}</div>`;
  }

  // ----------------------------
  // Add new spot (create from createSpotFromData)
  // ----------------------------
  function handleCreateSpotFromForm(e){
    e.preventDefault();
    // validations - removed spot name from required fields since it's auto-generated
    const missing = [];
    if(!birdSpecies.value.trim()) missing.push('Bird species');
    if(selectedRBird.length===0) missing.push('Bird behaviour (initial report)');
    if(selectedRHuman.length===0) missing.push('Human behaviour (initial report)');
    if(selectedRPrec.length===0) missing.push('Precautions');
    if(!selectedLocation && !addressField.value.trim()) missing.push('Location (click map or enter address)');
    if(missing.length>0){ toast('Please complete: ' + missing.join(', ')); return; }

    (async ()=>{
      let latlng = null;
      // prefer address if provided
      if(addressField.value.trim()){
        try {
          addressInfo.textContent = 'Finding address...';
          const g = await geocodeAddress(addressField.value.trim());
          latlng = { lat: g.lat, lng: g.lng, display: g.display };
          addressInfo.textContent = `Found: ${g.display}`;
        } catch(err){
          addressInfo.textContent = 'Address not found — use map click instead';
          if(selectedLocation) latlng = selectedLocation;
          else { toast('Address not found and no map selection'); return; }
        }
      } else if(selectedLocation){
        latlng = selectedLocation;
      } else {
        toast('Please select a location');
        return;
      }

      // create initial report
      const report = {
        id: uid(),
        timestamp: new Date().toISOString(),
        birdBehaviour: selectedRBird.slice(),
        humanBehaviour: selectedRHuman.slice(),
        precautions: selectedRPrec.slice(),
        extra: reextra.value.trim(),
        alertLevel: computeAlertFromBirds(selectedRBird),
        user_id: currentUser?.id || null,
        created_by_name: currentUser ? (userProfile?.display_name || currentUser.email.split('@')[0]) : 'Anonymous'
      };

      // determine spot risk based on initial report (same immediate raise)
      const spotRisk = computeSpotRiskFromReports([report]);

      // Generate unique random name within 5km radius
      const birdName = getUniqueName(latlng.lat, latlng.lng);
      
      const spotData = {
        id: uid(),
        name: birdName,
        species: birdSpecies.value,
        lat: latlng.lat,
        lng: latlng.lng,
        address: latlng.display || addressField.value.trim() || '',
        radius: spotRisk === 'Danger - Avoid' ? 100 : spotRisk === 'Take caution' ? 80 : 50,
        risk: spotRisk,
        reports: [report]
      };

      createSpotFromData(spotData, false);
      saveAll();
      
      // Show success modal BEFORE resetting the form (so selectedRBird is still populated)
      showSuccessModal(birdName, birdSpecies.value, selectedRBird);
      
      closeSpotModalImmediate();
    })();
  }

  // compute new overall spot risk from array of reports
  function computeSpotRiskFromReports(reportsArray){
    // Highest priority: any contact (injured/uninjured) => Danger
    for(const r of reportsArray){
      if(Array.isArray(r.birdBehaviour) && (r.birdBehaviour.includes('made contact + injured') || r.birdBehaviour.includes('made contact + uninjured'))) return 'Danger - Avoid';
    }
    // Next: any close swoop
    for(const r of reportsArray){ if(Array.isArray(r.birdBehaviour) && r.birdBehaviour.includes('close swoop')) return 'Take caution'; }
    // else Low
    return 'Low risk';
  }

  // ----------------------------
  // Details modal (feed) + add report
  // ----------------------------
  function openDetailsModal(spotId) {
    const s = spots.find(x => x.id === spotId);
    if(!s) return;
    activeDetailsSpotId = spotId;

    // Initialize new arrays for tag UI
    selectedReportBird = [];
    selectedReportHuman = [];
    selectedReportPrec = [];

    detailsModal.innerHTML = `
      <div class="rounded-lg w-full max-w-2xl mx-auto my-auto max-h-[95vh] overflow-y-auto relative" style="background-color: #f2eceb;">
        <div class="p-6">
          <!-- Header -->
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold" style="color: #422d1e;">${escapeHtml(s.name)}</h2>
            <button id="closeDetails" style="color: #422d1e; opacity: 0.7;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
          </div>

          <!-- Risk Level Banner -->
          <div class="mb-4 py-2 px-3 rounded ${
            s.risk === 'Danger - Avoid' ? 'bg-red-100 text-red-700' :
            s.risk === 'Take caution' ? 'bg-yellow-100 text-yellow-700' :
            'bg-green-100 text-green-700'
          }">
            <div class="font-medium">${escapeHtml(s.risk)}</div>
            <div class="text-sm">${escapeHtml(s.species)} • ${s.reports.length} report${s.reports.length === 1 ? '' : 's'} • ${s.safePassageCount || 0} safe passage${(s.safePassageCount || 0) === 1 ? '' : 's'}</div>
          </div>

          <!-- Tabs -->
          <div style="border-bottom: 1px solid #d4cac7;">
            <nav class="flex -mb-px" role="tablist">
              <button data-tab="main" role="tab" class="tab-btn active mr-4 py-2 px-1 border-b-2 font-medium" style="border-color: #422d1e; color: #422d1e;">
                Main Info
              </button>
              <button data-tab="feed" role="tab" class="tab-btn mr-4 py-2 px-1 border-b-2 border-transparent" style="color: #422d1e; opacity: 0.6;" onmouseover="this.style.opacity='0.8'" onmouseout="this.classList.contains('active') || (this.style.opacity='0.6')">
                Reports Feed
              </button>
              <button data-tab="add" role="tab" class="tab-btn py-2 px-1 border-b-2 border-transparent" style="color: #422d1e; opacity: 0.6;" onmouseover="this.style.opacity='0.8'" onmouseout="this.classList.contains('active') || (this.style.opacity='0.6')">
                Add Report
              </button>
            </nav>
          </div>

          <!-- Tab Content -->
          <div class="mt-4">
            <!-- Main Info Tab -->
            <div id="mainTab" class="tab-content active" role="tabpanel">
              <div class="space-y-4">
                <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
                  <div class="flex items-start gap-4 mb-3">
                    <div class="flex-shrink-0">
                      ${getBirdIconSVG(s.risk)}
                    </div>
                    <div class="flex-1">
                      <h3 class="font-medium mb-1" style="color: #422d1e;">Location Details</h3>
                      <div class="text-sm space-y-2" style="color: #422d1e;">
                        <div><span style="opacity: 0.7;">Address:</span> ${s.address ? escapeHtml(s.address) : `${s.lat.toFixed(6)}, ${s.lng.toFixed(6)}`}</div>
                        <div><span style="opacity: 0.7;">Bird Species:</span> ${escapeHtml(s.species)}</div>
                        <div><span style="opacity: 0.7;">Total Reports:</span> ${s.reports.length}</div>
                        ${s.created_by_name ? `<div><span style="opacity: 0.7;">Created by:</span> ${escapeHtml(s.created_by_name)}</div>` : ''}
                      </div>
                    </div>
                  </div>
                </div>

                <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
                  <h3 class="font-medium mb-3" style="color: #422d1e;">Latest Report</h3>
                  <div id="latestReport" class="rounded p-3" style="background-color: #f2eceb; border: 1px solid #d4cac7;">
                    ${s.reports.length > 0 ? renderLatestReport(s.reports[s.reports.length - 1]) : '<p style="color: #422d1e; opacity: 0.7;">No reports yet</p>'}
                  </div>
                </div>

                <div class="mt-4 text-center">
                  <button class="text-white px-4 py-2 rounded add-report-btn" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                    Add New Report
                  </button>
                </div>
              </div>
            </div>

            <!-- Reports Feed Tab -->
            <div id="feedTab" class="tab-content hidden" role="tabpanel">
              <div class="space-y-3 max-h-[calc(100vh-300px)] overflow-y-auto">
                ${renderReportsFeedContent(s)}
              </div>
            </div>

            <!-- Add Report Tab -->
            <div id="addTab" class="tab-content hidden" role="tabpanel">
              <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
                <div class="mb-4 flex gap-3">
                  <button type="button" id="noBirdBtn" class="flex-1 px-4 py-2 rounded" style="background-color: #e8e2e1; color: #422d1e; border: 1px solid #d4cac7;" onmouseover="this.style.backgroundColor='#dcd6d5'" onmouseout="this.style.backgroundColor='#e8e2e1'">
                    No Birds Spotted
                  </button>
                  <button type="button" id="addReportBtn" class="flex-1 px-4 py-2 text-white rounded" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                    Report Bird Activity
                  </button>
                </div>

                <form id="reportForm" class="hidden space-y-4">
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Bird Behaviour <span class="text-red-500">*</span></label>
                    <div class="relative">
                      <div id="rbirdBox2" class="tag-box"></div>
                      <div id="rbirdList2" class="tag-list"></div>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Human Behaviour <span class="text-red-500">*</span></label>
                    <div class="relative">
                      <div id="rhumanBox2" class="tag-box"></div>
                      <div id="rhumanList2" class="tag-list"></div>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Precautions <span class="text-red-500">*</span></label>
                    <div class="relative">
                      <div id="rprecBox2" class="tag-box"></div>
                      <div id="rprecList2" class="tag-list"></div>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Alert Level (auto-set)</label>
                    <input type="text" id="repAlertLevel" class="w-full rounded p-2" style="border: 1px solid #d4cac7; background-color: #e8e2e1; color: #422d1e;" readonly>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Extra Notes</label>
                    <textarea id="repExtra" class="w-full rounded p-2 h-20" style="border: 1px solid #d4cac7; background-color: #f2eceb; color: #422d1e;"></textarea>
                  </div>
                  <div class="flex justify-end gap-2">
                    <button type="button" id="reportCancel" class="px-4 py-2 rounded" style="border: 1px solid #d4cac7; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='transparent'">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-white rounded" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Submit Report</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    // Set up event handlers after the modal content is created
    detailsModal.querySelector('#closeDetails').addEventListener('click', () => {
      detailsModal.classList.add('hidden');
      activeDetailsSpotId = null;
    });

    // Tab switching
    detailsModal.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        switchTab(btn.dataset.tab);
      });
    });

    // Add report buttons
    detailsModal.querySelectorAll('.add-report-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        switchTab('add');
      });
    });

    // No bird button
    detailsModal.querySelector('#noBirdBtn').addEventListener('click', () => {
      // Just increment the safe passage counter
      if (!s.safePassageCount) s.safePassageCount = 0;
      s.safePassageCount++;
      s.lastSafePassage = new Date().toISOString();
      
      saveAll();
      
      // Close the details modal
      detailsModal.classList.add('hidden');
      
      // Show success modal for safe passage
      showSafePassageModal(s.name);
    });

    // Report form handling
    const addReportBtn = detailsModal.querySelector('#addReportBtn');
    const reportForm = detailsModal.querySelector('#reportForm');
    
    addReportBtn.addEventListener('click', () => {
      reportForm.classList.remove('hidden');
      addReportBtn.classList.add('hidden');
      detailsModal.querySelector('#noBirdBtn').classList.add('hidden');
      
      // Get the tag UI elements
      const rbirdBox2 = detailsModal.querySelector('#rbirdBox2');
      const rbirdList2 = detailsModal.querySelector('#rbirdList2');
      const rhumanBox2 = detailsModal.querySelector('#rhumanBox2');
      const rhumanList2 = detailsModal.querySelector('#rhumanList2');
      const rprecBox2 = detailsModal.querySelector('#rprecBox2');
      const rprecList2 = detailsModal.querySelector('#rprecList2');
      const repAlertLevel = detailsModal.querySelector('#repAlertLevel');
      
      // Reset and set up tag UIs
      selectedReportBird = [];
      selectedReportHuman = [];
      selectedReportPrec = [];
      
      setupTagUI(rbirdBox2, rbirdList2, BIRD_BEHAVIOURS, selectedReportBird, () => {
        repAlertLevel.value = computeAlertFromBirds(selectedReportBird);
      });
      setupTagUI(rhumanBox2, rhumanList2, HUMAN_BEHAVIOURS, selectedReportHuman, ()=>{});
      setupTagUI(rprecBox2, rprecList2, PRECAUTIONS, selectedReportPrec, ()=>{});
      
      repAlertLevel.value = 'Low risk';
    });

    const reportCancel = detailsModal.querySelector('#reportCancel');
    reportCancel.addEventListener('click', () => {
      reportForm.classList.add('hidden');
      addReportBtn.classList.remove('hidden');
      detailsModal.querySelector('#noBirdBtn').classList.remove('hidden');
      
      // Reset form and tag arrays
      selectedReportBird = [];
      selectedReportHuman = [];
      selectedReportPrec = [];
      
      const repExtra = detailsModal.querySelector('#repExtra');
      const repAlertLevel = detailsModal.querySelector('#repAlertLevel');
      
      if (repExtra) repExtra.value = '';
      if (repAlertLevel) repAlertLevel.value = 'Low risk';
    });

    // Set up tag UIs - Note: these are set up when the "Report Bird Activity" button is clicked
    // to ensure they use the correct DOM elements from the modal

    // Show modal
    detailsModal.classList.remove('hidden');
    document.body.classList.add('modal-open');

    // Set up form submission
    reportForm.addEventListener('submit', handleAddReport);
  }

  function renderLatestReport(report) {
    if (!report) return '<p class="text-gray-500">No reports yet</p>';
    
    const level = report.alertLevel || computeAlertFromBirds(report.birdBehaviour || []);
    const levelClass = level === 'Danger - Avoid' ? 'text-red-600' : 
                      level === 'Take caution' ? 'text-yellow-600' : 
                      'text-green-600';
    
    return `
      <div class="space-y-2">
        <div class="font-medium ${levelClass}">${escapeHtml(level)}</div>
        <div class="text-sm text-gray-600">
          ${new Date(report.timestamp).toLocaleString()}
          ${report.created_by_name ? ` • Reported by ${escapeHtml(report.created_by_name)}` : ''}
        </div>
        <div class="text-sm"><b>Bird behavior:</b> ${escapeHtml((report.birdBehaviour||[]).join(', '))}</div>
        <div class="text-sm"><b>Human activity:</b> ${escapeHtml((report.humanBehaviour||[]).join(', '))}</div>
        <div class="text-sm"><b>Precautions:</b> ${escapeHtml((report.precautions||[]).join(', '))}</div>
        ${report.extra ? `<div class="text-sm mt-1"><b>Notes:</b> ${escapeHtml(report.extra)}</div>` : ''}
      </div>
    `;
  }

  function renderReportsFeedContent(spot) {
    if (!spot.reports || spot.reports.length === 0) {
      return `
        <div class="text-center py-8 text-gray-500">
          No reports yet. Be the first to report bird activity at this location!
        </div>
        <div class="mt-4 text-center">
          <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 add-report-btn">
            Add Report
          </button>
        </div>
      `;
    }

    return `
      <div class="space-y-4">
        ${spot.reports.slice().reverse().map(report => {
          const level = report.alertLevel || computeAlertFromBirds(report.birdBehaviour || []);
          const cls = level === 'Danger - Avoid' ? 'border-red-500' : 
                     level === 'Take caution' ? 'border-yellow-500' : 
                     'border-green-500';
          const textColor = level === 'Danger - Avoid' ? 'text-red-600' : 
                           level === 'Take caution' ? 'text-yellow-600' : 
                           'text-green-600';

          return `
            <div class="p-3 rounded bg-white border-l-4 shadow-sm ${cls}">
              <div class="flex justify-between items-start mb-2">
                <div class="font-medium ${textColor}">${escapeHtml(level)}</div>
                <div class="text-xs text-gray-500">
                  ${new Date(report.timestamp).toLocaleString()}
                  ${report.created_by_name ? `<br>by ${escapeHtml(report.created_by_name)}` : ''}
                </div>
              </div>
              <div class="space-y-2">
                <div class="text-sm">
                  <span class="font-medium">Bird Activity:</span> 
                  ${escapeHtml((report.birdBehaviour||[]).join(', ')||'N/A')}
                </div>
                <div class="text-sm">
                  <span class="font-medium">Human Activity:</span> 
                  ${escapeHtml((report.humanBehaviour||[]).join(', ')||'N/A')}
                </div>
                <div class="text-sm">
                  <span class="font-medium">Precautions:</span> 
                  ${escapeHtml((report.precautions||[]).join(', ')||'None')}
                </div>
                ${report.extra ? `
                  <div class="text-sm pt-1 border-t">
                    <span class="font-medium">Notes:</span><br>
                    ${escapeHtml(report.extra)}
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }).join('')}
      </div>
      <div class="mt-4 text-center">
        <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 add-report-btn">
          Add New Report
        </button>
      </div>
    `;
  }

  function switchTab(tabId) {
    const tabButtons = detailsModal.querySelectorAll('.tab-btn');
    const tabContents = detailsModal.querySelectorAll('.tab-content');

    // Update all tab buttons with inline styles
    tabButtons.forEach(btn => {
      if (btn.dataset.tab === tabId) {
        btn.classList.add('active');
        btn.style.borderColor = '#422d1e';
        btn.style.color = '#422d1e';
        btn.style.opacity = '1';
      } else {
        btn.classList.remove('active');
        btn.style.borderColor = 'transparent';
        btn.style.color = '#422d1e';
        btn.style.opacity = '0.6';
      }
    });

    // Update all tab contents
    tabContents.forEach(content => {
      if (content.id === `${tabId}Tab`) {
        content.classList.add('active');
        content.classList.remove('hidden');
      } else {
        content.classList.remove('active');
        content.classList.add('hidden');
      }
    });
  }

  // ----------------------------
  // Create spot modal flow controls
  // ----------------------------
  openAddBtn.addEventListener('click', (e)=>{
    e.stopPropagation(); // Prevent click from propagating to map
    openCreateSpotModal();
  });

  // Add event listener for the button below the map
  const addSpotBelowMap = document.getElementById('addSpotBelowMap');
  addSpotBelowMap.addEventListener('click', ()=>{
    openCreateSpotModal();
  });

  function openCreateSpotModal(){
    // reset all form fields and state
    selectedLocation = null;
    if(tempMarker) try{ map.removeLayer(tempMarker); } catch(e){}
    tempMarker = null;
    
    // Show modal
    spotModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
    
    // Set default location to map center
    const center = map.getCenter();
    selectedLocation = { lat: center.lat, lng: center.lng };
    coordsField.value = `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
    addressInfo.textContent = 'Using map center. Click the map to change location or enter an address.';
    tempMarker = L.marker([selectedLocation.lat, selectedLocation.lng]).addTo(map);
    
    // Reset all form fields
    birdSpecies.value = 'Magpie';
    addressField.value = '';
    selectedRBird = []; 
    selectedRHuman = []; 
    selectedRPrec = [];
    reextra.value = '';
    ralertLevel.value = 'Low risk';
    
    // Clear any suggestion lists
    const addressSuggestions = document.getElementById('addressField_suggestions');
    if(addressSuggestions) addressSuggestions.innerHTML = '';
    
    // Reset tag UIs
    setupTagUI(rbirdBox, rbirdList, BIRD_BEHAVIOURS, selectedRBird, updateRAlertFromBirds);
    setupTagUI(rhumanBox, rhumanList, HUMAN_BEHAVIOURS, selectedRHuman, ()=>{});
    setupTagUI(rprecBox, rprecList, PRECAUTIONS, selectedRPrec, ()=>{});
    
    // Capture clean state for dirty checking
    initialFormState = captureSpotFormState();
  }

  // Close button in the modal header
  closeSpotModal.addEventListener('click', ()=> {
    spotModal.classList.add('hidden');
    closeSpotModalImmediate();
  });

  // Cancel button in the form
  spotCancel.addEventListener('click', ()=> {
    spotModal.classList.add('hidden');
    closeSpotModalImmediate();
  });

  function closeSpotModalImmediate(){
    // Hide the modal
    spotModal.classList.add('hidden');
    document.body.classList.remove('modal-open');
    
    // Clean up map
    if(tempMarker) {
      try { 
        map.removeLayer(tempMarker); 
      } catch(e){}
      tempMarker = null;
    }
    
    // Reset state
    selectedLocation = null;
    selectedRBird = [];
    selectedRHuman = [];
    selectedRPrec = [];
    
    // Clear any suggestion lists
    const addressSuggestions = document.getElementById('addressField_suggestions');
    if(addressSuggestions) addressSuggestions.innerHTML = '';
    
    // Reset form fields
    birdSpecies.value = 'Magpie';
    addressField.value = '';
    coordsField.value = '';
    addressInfo.textContent = '';
    reextra.value = '';
    ralertLevel.value = 'Low risk';
    
    // Reset tag UIs
    setupTagUI(rbirdBox, rbirdList, BIRD_BEHAVIOURS, selectedRBird, updateRAlertFromBirds);
    setupTagUI(rhumanBox, rhumanList, HUMAN_BEHAVIOURS, selectedRHuman, ()=>{});
    setupTagUI(rprecBox, rprecList, PRECAUTIONS, selectedRPrec, ()=>{});
  }

  function captureSpotFormState(){
    return {
      species: birdSpecies.value||'',
      addr: addressField.value||'',
      coords: coordsField.value||'',
      rbird: selectedRBird.slice(),
      rhuman: selectedRHuman.slice(),
      rprec: selectedRPrec.slice(),
      ralert: ralertLevel.value||'',
      extra: reextra.value||''
    };
  }
  function spotFormIsDirty(){ return JSON.stringify(captureSpotFormState()) !== JSON.stringify(initialFormState); }

  // Set up address auto-complete
  addressField.addEventListener('input', () => {
    debouncedAddressLookup(addressField);
  });

  // geo locate - Find Me button
  geoBtn.addEventListener('click', ()=>{
    if(!navigator.geolocation) {
      toast('Geolocation is not supported by your browser');
      addressInfo.textContent = 'Geolocation not supported';
      return;
    }
    
    // Show loading state
    addressInfo.textContent = 'Getting your location...';
    
    navigator.geolocation.getCurrentPosition(
      // Success callback
      p => {
        selectedLocation = { lat: p.coords.latitude, lng: p.coords.longitude };
        coordsField.value = `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
        addressInfo.textContent = 'Located device coordinates successfully';
        if(tempMarker) try{ map.removeLayer(tempMarker); } catch(e){}
        tempMarker = L.marker([selectedLocation.lat, selectedLocation.lng]).addTo(map);
        map.setView([selectedLocation.lat, selectedLocation.lng], 16);
      }, 
      // Error callback
      err => {
        console.error('Geolocation error:', err);
        let errorMsg = '';
        
        switch(err.code) {
          case err.PERMISSION_DENIED:
            errorMsg = 'Location permission denied. Please enable location access in your browser settings.';
            break;
          case err.POSITION_UNAVAILABLE:
            errorMsg = 'Location information unavailable. Please check your device settings.';
            break;
          case err.TIMEOUT:
            errorMsg = 'Location request timed out. Please try again.';
            break;
          default:
            errorMsg = err.message || 'Unknown error occurred';
        }
        
        addressInfo.textContent = errorMsg;
        toast('GPS error: ' + errorMsg, 4000);
      },
      // Options
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  });

  // submit create spot
  spotForm.addEventListener('submit', handleCreateSpotFromForm);

  // ----------------------------
  // Save + load helpers (use createSpotFromData to add)
  // ----------------------------
  function createSpotFromUIObject(obj){
    // convert UI object to spot data and call createSpotFromData
    createSpotFromData(obj, false);
    saveAll();
    renderAlerts();
  }

  // ----------------------------
  // Render alerts list (1km from map center)
  // ----------------------------
  function renderAlerts(){
    alertsList.innerHTML = '';
    const center = map.getCenter();
    spots.forEach(s=>{
      const d = metersBetween(center.lat, center.lng, s.lat, s.lng);
      if(d <= 1000){
        const item = document.createElement('div');
        // Color code based on risk level
        const borderColor = s.risk === 'Danger - Avoid' ? 'border-red-400 bg-red-50' : 
                          s.risk === 'Take caution' ? 'border-yellow-400 bg-yellow-50' : 
                          'border-green-400 bg-green-50';
        const textColor = s.risk === 'Danger - Avoid' ? 'text-red-700' : 
                         s.risk === 'Take caution' ? 'text-yellow-700' : 
                         'text-green-700';
        
        item.className = `border-2 p-2 rounded text-sm cursor-pointer hover:opacity-90 flex justify-between items-center ${borderColor}`;
        item.innerHTML = `
          <div>
            <b>${escapeHtml(s.name)}</b>
            <div class="text-xs text-gray-600">${escapeHtml(s.species)}</div>
            <div class="text-xs font-medium ${textColor}">${escapeHtml(s.risk)}</div>
          </div>
          <div class="text-xs text-gray-500">${(d/1000).toFixed(2)} km</div>
        `;
        item.addEventListener('click', ()=> {
          map.setView([s.lat, s.lng], 16);
          showSpotQuickAlert(s);
        });
        alertsList.appendChild(item);
      }
    });
  }
  map.on('moveend', ()=> renderAlerts());

  // ----------------------------
  // Open / close details modal
  // ----------------------------
  closeDetails.addEventListener('click', ()=> {
    detailsModal.classList.add('hidden');
    document.body.classList.remove('modal-open');
    activeDetailsSpotId = null;
    // cleanup UI arrays
    selectedReportBird = []; selectedReportHuman = []; selectedReportPrec = [];
    
    // If there are still spots to address in the exit prompt, show it again
    if(spotsToAddress.length > 0) {
      exitPromptModal.classList.remove('hidden');
      document.body.classList.add('modal-open');
    }
  });

  // report form handlers
  function handleAddReport(e) {
    e.preventDefault();
    if(!activeDetailsSpotId) return;
    
    const s = spots.find(x => x.id === activeDetailsSpotId);
    if(!s) return;
    
    // Validate required fields
    if(selectedReportBird.length === 0 || selectedReportHuman.length === 0 || selectedReportPrec.length === 0) {
      toast('Please complete all required fields');
      return;
    }
    
    // Get repExtra from the modal (not the static DOM reference)
    const repExtraField = detailsModal.querySelector('#repExtra');
    
    // Create new report
    const rep = {
      id: uid(),
      timestamp: new Date().toISOString(),
      birdBehaviour: selectedReportBird.slice(),
      humanBehaviour: selectedReportHuman.slice(),
      precautions: selectedReportPrec.slice(),
      extra: repExtraField ? repExtraField.value.trim() : '',
      alertLevel: computeAlertFromBirds(selectedReportBird),
      user_id: currentUser?.id || null,
      created_by_name: currentUser ? (userProfile?.display_name || currentUser.email.split('@')[0]) : 'Anonymous'
    };
    
    // Add report to spot
    s.reports.push(rep);
    
    // Recompute overall spot risk
    const newRisk = computeSpotRiskFromReports(s.reports);
    if(newRisk !== s.risk) {
      s.risk = newRisk;
      // Update marker icon and circle
      try {
        map.removeLayer(s.marker);
        map.removeLayer(s.circle);
      } catch(e){}
      
      s.marker = L.marker([s.lat, s.lng], { icon: getBirdIcon(newRisk) }).addTo(map);
      s.marker.on('click', ()=> showSpotQuickAlert(s));
      
      const radius = getRadiusByRisk(newRisk);
      s.radius = radius;
      s.circle = L.circle([s.lat, s.lng], { 
        radius: radius,
        color: newRisk === 'Danger - Avoid' ? '#EF4444' : newRisk === 'Take caution' ? '#F59E0B' : '#10B981',
        fillColor: newRisk === 'Danger - Avoid' ? '#FEE2E2' : newRisk === 'Take caution' ? '#FEF3C7' : '#DCFCE7',
        fillOpacity: 0.35 
      }).addTo(map);
    }
    
    saveAll(); // Save to localStorage
    saveSpotToSupabase(s); // Sync to Supabase
    
    // Show success modal with bird behavior context (isNewSpot=false for additional reports)
    showSuccessModal(s.name, s.species, selectedReportBird, false);
    
    // Remove from spots to address if it was in the exit prompt
    spotsToAddress = spotsToAddress.filter(spot => spot.id !== s.id);
    
    // Close the details modal
    detailsModal.classList.add('hidden');
    activeDetailsSpotId = null;
    
    // Clear the report form state
    selectedReportBird = [];
    selectedReportHuman = [];
    selectedReportPrec = [];
  }
  
  reportForm.addEventListener('submit', handleAddReport);
  reportCancel.addEventListener('click', ()=> {
    if(confirm('Cancel new report?')) {
      // Reset form
      selectedReportBird = []; 
      selectedReportHuman = []; 
      selectedReportPrec = [];
      setupTagUI(rbirdBox2, rbirdList2, BIRD_BEHAVIOURS, selectedReportBird, updateRepAlertFromBirds);
      setupTagUI(rhumanBox2, rhumanList2, HUMAN_BEHAVIOURS, selectedReportHuman, ()=>{});
      setupTagUI(rprecBox2, rprecList2, PRECAUTIONS, selectedReportPrec, ()=>{});
      repExtra.value = '';
      repAlertLevel.value = 'Low risk';
      
      // Switch back to main tab
      const mainTab = detailsModal.querySelector('[data-tab="main"]');
      const mainContent = detailsModal.querySelector('#mainTab');
      if(mainTab && mainContent) {
        detailsModal.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-blue-500', 'border-blue-500'));
        detailsModal.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        mainTab.classList.add('active', 'text-blue-500', 'border-blue-500');
        mainContent.classList.remove('hidden');
      }
    }
  });

  // ----------------------------
  // checkLocation - shows userMarker and center alert if within any spot
  // ----------------------------
  let currentAlertSpots = []; // Track currently displayed spots
  let visitedSpots = new Set(); // Track spots visited during current journey
  
  function checkLocation(lat,lng){
    if(userMarker){ try{ userMarker.setLatLng([lat,lng]); } catch(e){} } else { userMarker = L.marker([lat,lng], { icon: getUserIcon() }).addTo(map); }
    
    // Find all spots the user is currently inside
    let insideSpots = [];
    for(const s of spots){
      if(metersBetween(lat,lng,s.lat,s.lng) <= (s.radius || 150)){ 
        insideSpots.push(s);
        visitedSpots.add(s.id); // Track that we've been in this spot
      }
    }
    
    // Sort by risk level (highest first) for display
    if(insideSpots.length > 0){
      insideSpots.sort((a,b) => {
        const riskOrder = {'Danger - Avoid': 3, 'Take caution': 2, 'Low risk': 1};
        return (riskOrder[b.risk] || 0) - (riskOrder[a.risk] || 0);
      });
    }
    
    if(insideSpots.length > 0){
      // Check if the spots have changed
      const currentIds = currentAlertSpots.map(s => s.id).sort().join(',');
      const newIds = insideSpots.map(s => s.id).sort().join(',');
      
      if(currentIds !== newIds){
        currentAlertSpots = insideSpots;
        showCenteredAlert(insideSpots);
      }
    } else {
      // User has exited ALL zones
      if(currentAlertSpots.length > 0){
        const spotsToReport = Array.from(visitedSpots).map(id => spots.find(s => s.id === id)).filter(Boolean);
        currentAlertSpots = [];
        hideCenteredAlert();
        
        // Play happy tone when exiting all zones
        playHappyTone();
        
        // Only show prompt if they visited spots
        if(spotsToReport.length > 0){
          showExitPrompt(spotsToReport);
        }
        
        // Clear visited spots for next journey
        visitedSpots.clear();
      } else {
        currentAlertSpots = [];
        hideCenteredAlert();
      }
    }
    renderAlerts();
  }

  // Prompt user after exiting all swoop zones
  let spotsToAddress = []; // Track spots that still need to be addressed
  
  function showExitPrompt(spotsVisited) {
    // Sort by risk level (highest first)
    spotsToAddress = spotsVisited.sort((a,b) => {
      const riskOrder = {'Danger - Avoid': 3, 'Take caution': 2, 'Low risk': 1};
      return (riskOrder[b.risk] || 0) - (riskOrder[a.risk] || 0);
    });
    
    renderExitPromptList();
    exitPromptModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
  }
  
  function renderExitPromptList() {
    exitPromptList.innerHTML = '';
    
    if(spotsToAddress.length === 0) {
      exitPromptList.innerHTML = '<div class="text-center text-gray-500 py-8">All spots addressed! Thank you for your feedback, stay safe!</div>';
      return;
    }
    
    spotsToAddress.forEach(spot => {
      const item = document.createElement('div');
      const borderColor = spot.risk === 'Danger - Avoid' ? 'border-red-400 bg-red-50' : 
                         spot.risk === 'Take caution' ? 'border-yellow-400 bg-yellow-50' : 
                         'border-green-400 bg-green-50';
      const textColor = spot.risk === 'Danger - Avoid' ? 'text-red-700' : 
                       spot.risk === 'Take caution' ? 'text-yellow-700' : 
                       'text-green-700';
      
      item.className = `border-2 p-3 rounded ${borderColor}`;
      item.innerHTML = `
        <div class="flex justify-between items-start gap-3">
          <div class="flex-1">
            <div class="font-semibold">${escapeHtml(spot.name)}</div>
            <div class="text-sm text-gray-600">${escapeHtml(spot.species)}</div>
            <div class="text-sm font-medium ${textColor}">${escapeHtml(spot.risk)}</div>
          </div>
          <div class="flex flex-col gap-2">
            <button class="safe-passage-btn text-xs px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded whitespace-nowrap" data-spot-id="${spot.id}">
              Safe Passage
            </button>
            <button class="add-report-exit-btn text-xs px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded whitespace-nowrap" data-spot-id="${spot.id}">
              Add Report
            </button>
          </div>
        </div>
      `;
      
      exitPromptList.appendChild(item);
    });
    
    // Attach event handlers
    exitPromptList.querySelectorAll('.safe-passage-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const spotId = e.target.dataset.spotId;
        handleSafePassageFromExit(spotId);
      });
    });
    
    exitPromptList.querySelectorAll('.add-report-exit-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const spotId = e.target.dataset.spotId;
        handleAddReportFromExit(spotId);
      });
    });
  }
  
  function handleSafePassageFromExit(spotId) {
    const spot = spots.find(s => s.id === spotId);
    if(!spot) return;
    
    // Increment safe passage count
    if (!spot.safePassageCount) spot.safePassageCount = 0;
    spot.safePassageCount++;
    spot.lastSafePassage = new Date().toISOString();
    saveAll();
    
    // Remove from spots to address
    spotsToAddress = spotsToAddress.filter(s => s.id !== spotId);
    
    // Re-render the list
    renderExitPromptList();
    
    // Show success modal for safe passage
    showSafePassageModal(spot.name);
  }
  
  function handleAddReportFromExit(spotId) {
    // Remove from spots to address
    spotsToAddress = spotsToAddress.filter(s => s.id !== spotId);
    
    // Close the exit prompt modal
    exitPromptModal.classList.add('hidden');
    
    // Open the details modal for this spot
    openDetailsModal(spotId);
    switchTab('add');
  }
  
  // Close exit prompt modal
  closeExitPrompt.addEventListener('click', () => {
    if(spotsToAddress.length > 0) {
      if(confirm(`You haven't addressed ${spotsToAddress.length} spot${spotsToAddress.length === 1 ? '' : 's'}. Close anyway?`)) {
        exitPromptModal.classList.add('hidden');
        document.body.classList.remove('modal-open');
        spotsToAddress = [];
      }
    } else {
      exitPromptModal.classList.add('hidden');
      document.body.classList.remove('modal-open');
      spotsToAddress = [];
    }
  });

  // Show quick alert for spot from list
  function showSpotQuickAlert(s) {
    // Get latest report timestamp
    let lastReportedText = '';
    if (s.reports && s.reports.length > 0) {
      const latestReport = s.reports[s.reports.length - 1];
      lastReportedText = `<div class="text-xs text-gray-500 mt-1">Last reported: ${formatTimeAgo(latestReport.timestamp)}</div>`;
    }
    
    // Get last safe passage timestamp
    let lastSafePassageText = '';
    if (s.lastSafePassage) {
      lastSafePassageText = `<div class="text-xs text-gray-500 mt-1">Last safe passage: ${formatTimeAgo(s.lastSafePassage)}</div>`;
    }
    
    alertBox.innerHTML = `
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-sm font-semibold mb-1">${escapeHtml(s.name)} - ${escapeHtml(s.species)}</div>
          <div class="text-sm ${s.risk==='Danger - Avoid'?'text-red-600': s.risk==='Take caution' ? 'text-yellow-600' : 'text-green-600'} font-medium">
            ${escapeHtml(s.risk)}
          </div>
          <div class="text-xs text-gray-600 mt-1">${s.reports.length} report${s.reports.length === 1 ? '' : 's'}</div>
          ${lastReportedText}
          ${lastSafePassageText}
        </div>
        <div class="flex items-center gap-2">
          <button id="showMoreBtn" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-white rounded px-3 py-1.5">Show More</button>
          <button id="closeAlertBtn" class="text-xs border rounded px-3 py-1.5">Close</button>
        </div>
      </div>
    `;
    
    alertBox.classList.add('show');
    alertBox.style.display = 'block';
    
    // Attach event handlers after a short delay to ensure DOM is ready
    requestAnimationFrame(() => {
      const showMoreBtn = document.getElementById('showMoreBtn');
      const closeAlertBtn = document.getElementById('closeAlertBtn');
      
      if (showMoreBtn) {
        showMoreBtn.addEventListener('click', () => {
          alertBox.style.display = 'none';
          alertBox.classList.remove('show');
          openDetailsModal(s.id);
        });
      }
      
      if (closeAlertBtn) {
        closeAlertBtn.addEventListener('click', () => {
          alertBox.style.display = 'none';
          alertBox.classList.remove('show');
        });
      }
    });
  }


  // Play alert sound and vibrate (for mobile)
  function playAlertNotification() {
    console.log('🔔 Alert notification triggered');
    
    // Play alert sound
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // Create a two-tone alert sound
      oscillator.frequency.value = 800;
      gainNode.gain.value = 0.3;
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.2);
      
      // Second beep
      const oscillator2 = audioContext.createOscillator();
      const gainNode2 = audioContext.createGain();
      oscillator2.connect(gainNode2);
      gainNode2.connect(audioContext.destination);
      oscillator2.frequency.value = 600;
      gainNode2.gain.value = 0.3;
      oscillator2.start(audioContext.currentTime + 0.25);
      oscillator2.stop(audioContext.currentTime + 0.45);
      
      console.log('✅ Audio alert played');
    } catch(e) {
      console.warn('❌ Audio alert failed:', e);
    }
    
    // Vibrate (mobile devices)
    if ('vibrate' in navigator) {
      try {
        // More aggressive pattern for better noticeability
        // Pattern: vibrate 300ms, pause 100ms, vibrate 300ms, pause 100ms, vibrate 300ms
        const vibrationPattern = [300, 100, 300, 100, 300];
        const result = navigator.vibrate(vibrationPattern);
        console.log('📳 Vibration triggered:', result ? 'Success' : 'Failed or not supported');
      } catch(e) {
        console.warn('❌ Vibration failed:', e);
      }
    } else {
      console.log('❌ Vibration API not supported on this device');
      // iOS doesn't support vibration API
      // Show toast notification instead
      if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
        console.log('ℹ️ iOS detected - vibration not available via web');
      }
    }
  }

  // Play happy tone when exiting all zones (safe now!)
  function playHappyTone() {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      
      // Create a pleasant ascending chime (C-E-G major chord arpeggio)
      const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
      const noteDuration = 0.15;
      
      notes.forEach((freq, index) => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = freq;
        oscillator.type = 'sine'; // Smoother, more pleasant sound
        
        // Fade in/out envelope for smoother sound
        const startTime = audioContext.currentTime + (index * noteDuration);
        gainNode.gain.setValueAtTime(0, startTime);
        gainNode.gain.linearRampToValueAtTime(0.2, startTime + 0.02);
        gainNode.gain.linearRampToValueAtTime(0, startTime + noteDuration);
        
        oscillator.start(startTime);
        oscillator.stop(startTime + noteDuration);
      });
    } catch(e) {
      console.warn('Happy tone failed:', e);
    }
    
    // Single short vibration for positive feedback
    if ('vibrate' in navigator) {
      try {
        navigator.vibrate(100);
      } catch(e) {
        console.warn('Vibration failed:', e);
      }
    }
  }

  // Show alert when entering a spot's radius
  function showCenteredAlert(spots) {
    // Handle both single spot and array of spots
    const spotArray = Array.isArray(spots) ? spots : [spots];
    
    // Play sound and vibrate when alert is shown
    playAlertNotification();
    
    if(spotArray.length === 1) {
      // Single spot - styled to match multi-bird view
      const s = spotArray[0];
      const borderColor = s.risk === 'Danger - Avoid' ? 'border-red-400 bg-red-50' : 
                         s.risk === 'Take caution' ? 'border-yellow-400 bg-yellow-50' : 
                         'border-green-400 bg-green-50';
      const textColor = s.risk === 'Danger - Avoid' ? 'text-red-700' : 
                       s.risk === 'Take caution' ? 'text-yellow-700' : 
                       'text-green-700';
      
      alertBox.innerHTML = `
        <div class="text-sm font-semibold mb-2">
          ⚠️ Swooping zone detected!
        </div>
        <div class="border-l-4 ${borderColor} p-3 rounded text-xs mb-2">
          <div class="font-semibold">${escapeHtml(s.name)}</div>
          <div class="text-gray-600">${escapeHtml(s.species)}</div>
          <div class="font-medium ${textColor}">${escapeHtml(s.risk)}</div>
          <button class="show-more-btn mt-2 text-xs bg-yellow-500 hover:bg-yellow-600 text-white rounded px-3 py-1" data-spot-id="${s.id}">Show More</button>
        </div>
        <div class="flex gap-2">
          <button id="clearAlertBtn" class="flex-1 text-xs border rounded px-3 py-1">Clear Alert</button>
        </div>
      `;

      alertBox.classList.add('show');
      alertBox.style.display = 'block';

      // Attach event handlers
      const showMoreBtn = alertBox.querySelector('.show-more-btn');
      if(showMoreBtn) {
        showMoreBtn.onclick = () => {
          hideCenteredAlert();
          openDetailsModal(s.id);
        };
      }
      
      document.getElementById('clearAlertBtn').onclick = () => {
        currentAlertSpots = [];
        hideCenteredAlert();
        if (userMarker) try { map.removeLayer(userMarker); } catch(e){}
      };
    } else {
      // Multiple spots - show list with Show More button for each
      const highestRisk = spotArray[0].risk;
      alertBox.innerHTML = `
        <div class="text-sm font-semibold mb-2">
          ⚠️ Multiple swooping zones detected! Highest risk: 
          <span class="ml-1 ${highestRisk==='Danger - Avoid'?'text-red-600': highestRisk==='Take caution' ? 'text-yellow-600' : 'text-green-600'}">${escapeHtml(highestRisk)}</span>
        </div>
        <div class="max-h-48 overflow-y-auto space-y-2 mb-2">
          ${spotArray.map(spot => {
            const borderColor = spot.risk === 'Danger - Avoid' ? 'border-red-400 bg-red-50' : 
                               spot.risk === 'Take caution' ? 'border-yellow-400 bg-yellow-50' : 
                               'border-green-400 bg-green-50';
            const textColor = spot.risk === 'Danger - Avoid' ? 'text-red-700' : 
                             spot.risk === 'Take caution' ? 'text-yellow-700' : 
                             'text-green-700';
            
            return `
              <div class="border-l-4 ${borderColor} p-3 rounded text-xs">
                <div class="font-semibold">${escapeHtml(spot.name)}</div>
                <div class="text-gray-600">${escapeHtml(spot.species)}</div>
                <div class="font-medium ${textColor}">${escapeHtml(spot.risk)}</div>
                <button class="show-more-btn mt-2 text-xs bg-yellow-500 hover:bg-yellow-600 text-white rounded px-3 py-1" data-spot-id="${spot.id}">Show More</button>
              </div>
            `;
          }).join('')}
        </div>
        <div class="flex gap-2">
          <button id="clearAlertBtn" class="flex-1 text-xs border rounded px-3 py-1">Clear Alert</button>
        </div>
      `;

      alertBox.classList.add('show');
      alertBox.style.display = 'block';

      // Attach event handlers for all Show More buttons
      alertBox.querySelectorAll('.show-more-btn').forEach(btn => {
        btn.onclick = () => {
          const spotId = btn.dataset.spotId;
          hideCenteredAlert();
          openDetailsModal(spotId);
        };
      });
      
      document.getElementById('clearAlertBtn').onclick = () => {
        currentAlertSpots = [];
        hideCenteredAlert();
        if (userMarker) try { map.removeLayer(userMarker); } catch(e){}
      };
    }
  }

  // Hide centered alert
  function hideCenteredAlert() {
    alertBox.style.display = 'none';
    alertBox.classList.remove('show');
  }

  // Show success modal after creating a spot or adding a report
  function showSuccessModal(birdName, birdSpecies, birdBehaviours, isNewSpot = true) {
    console.log('showSuccessModal called with:', { birdName, birdSpecies, birdBehaviours, isNewSpot });
    
    // Ensure birdBehaviours is an array
    if (!Array.isArray(birdBehaviours)) {
      console.warn('birdBehaviours is not an array:', birdBehaviours);
      birdBehaviours = [];
    }
    
    // Determine which icon and message to show based on bird behavior
    let iconPath = 'Assets/Icons/user.svg'; // default
    let message = '';
    
    if (isNewSpot) {
      // Messages for creating a new spot
      message = `Thank you for keeping our community safe from <span class="font-bold text-blue-600">${escapeHtml(birdName)}</span> the <span class="font-bold">${escapeHtml(birdSpecies)}</span>.`;
      
      if (birdBehaviours.includes('made contact + injured')) {
        iconPath = 'Assets/Icons/user_swoopedinjured.svg';
        message = `Thank you for reporting <span class="font-bold text-blue-600">${escapeHtml(birdName)}</span> the <span class="font-bold">${escapeHtml(birdSpecies)}</span>. We're so sorry to hear you were injured! Please seek medical attention if needed.`;
      } else if (birdBehaviours.includes('made contact + uninjured')) {
        iconPath = 'Assets/Icons/user_swoopeduninjured.svg';
        message = `Thank you for reporting <span class="font-bold text-blue-600">${escapeHtml(birdName)}</span> the <span class="font-bold">${escapeHtml(birdSpecies)}</span>. Sorry to hear about it swooping you, but we're glad you weren't injured!`;
      } else if (birdBehaviours.includes('close swoop') || birdBehaviours.includes('swoop')) {
        iconPath = 'Assets/Icons/user_swooped.svg';
        message = `Thank you for reporting <span class="font-bold text-blue-600">${escapeHtml(birdName)}</span> the <span class="font-bold">${escapeHtml(birdSpecies)}</span>. Sorry to hear about the swoop — stay safe out there!`;
      } else if (birdBehaviours.includes('noisy')) {
        iconPath = 'Assets/Icons/user_noisy.svg';
        message = `Thank you for reporting <span class="font-bold text-blue-600">${escapeHtml(birdName)}</span> the <span class="font-bold">${escapeHtml(birdSpecies)}</span>. Those noisy birds can be quite startling!`;
      }
    } else {
      // Messages for adding a report to an existing spot
      message = `Thank you for adding a report to <span class="font-bold text-blue-600">${escapeHtml(birdName)}'s</span> Swoop Spot.`;
      
      if (birdBehaviours.includes('made contact + injured')) {
        iconPath = 'Assets/Icons/user_swoopedinjured.svg';
        message = `Thank you for updating <span class="font-bold text-blue-600">${escapeHtml(birdName)}'s</span> Swoop Spot. We're so sorry to hear you were injured! Please seek medical attention if needed.`;
      } else if (birdBehaviours.includes('made contact + uninjured')) {
        iconPath = 'Assets/Icons/user_swoopeduninjured.svg';
        message = `Thank you for updating <span class="font-bold text-blue-600">${escapeHtml(birdName)}'s</span> Swoop Spot. Sorry to hear about it swooping you, but we're glad you weren't injured!`;
      } else if (birdBehaviours.includes('close swoop') || birdBehaviours.includes('swoop')) {
        iconPath = 'Assets/Icons/user_swooped.svg';
        message = `Thank you for updating <span class="font-bold text-blue-600">${escapeHtml(birdName)}'s</span> Swoop Spot. Sorry to hear about the swoop — stay safe out there!`;
      } else if (birdBehaviours.includes('noisy')) {
        iconPath = 'Assets/Icons/user_noisy.svg';
        message = `Thank you for updating <span class="font-bold text-blue-600">${escapeHtml(birdName)}'s</span> Swoop Spot. Those noisy birds can be quite startling!`;
      }
    }
    
    console.log('Selected icon:', iconPath);
    console.log('Selected message:', message);
    
    successUserIcon.src = iconPath;
    successMessage.innerHTML = message;
    goodEggMessage.style.display = 'block'; // Show the "good egg" message for general success
    successModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
  }

  // Close success modal
  closeSuccessModal.addEventListener('click', () => {
    successModal.classList.add('hidden');
    document.body.classList.remove('modal-open');
  });

  // Show safe passage modal
  function showSafePassageModal(birdName) {
    successUserIcon.src = 'Assets/Icons/user_safepassage.svg';
    successMessage.innerHTML = `I'm so glad you didn't spot <span class="font-bold text-blue-600">${escapeHtml(birdName)}</span>. You must be a lucky egg!`;
    goodEggMessage.style.display = 'none'; // Hide the "good egg" message for safe passage
    successModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
  }

  // ----------------------------
  // Walk simulator (straight line)
  // ----------------------------
  document.getElementById('playSim').addEventListener('click', async ()=>{
    const s = document.getElementById('simStart').value.trim();
    const e = document.getElementById('simEnd').value.trim();
    if(!s || !e){ toast('Enter both addresses'); return; }
    try {
      const g1 = await geocodeAddress(s);
      const g2 = await geocodeAddress(e);
      const steps = 80; simPath = [];
      for(let i=0;i<=steps;i++) simPath.push({ lat: g1.lat + (g2.lat - g1.lat)*(i/steps), lng: g1.lng + (g2.lng - g1.lng)*(i/steps) });
      simIndex = 0;
      if(userMarker) try{ map.removeLayer(userMarker); } catch(e){}
      userMarker = L.marker([simPath[0].lat, simPath[0].lng], { icon: getUserIcon() }).addTo(map);
      if(simTimer) clearInterval(simTimer);
      simTimer = setInterval(()=> {
        simIndex++;
        if(simIndex >= simPath.length){ clearInterval(simTimer); simTimer = null; return; }
        const p = simPath[simIndex];
        try{ userMarker.setLatLng([p.lat,p.lng]); } catch(e){}
        checkLocation(p.lat, p.lng);
        map.setView([p.lat,p.lng], map.getZoom());
      }, 400);
    } catch(err){ toast('Simulator error: ' + (err.message || err)); }
  });
  document.getElementById('stopSim').addEventListener('click', ()=> { if(simTimer) clearInterval(simTimer); simTimer=null; });

  // ----------------------------
  // Location Tracking (Continuous)
  // ----------------------------
  function startLocationTracking() {
    if (!navigator.geolocation) {
      toast('Geolocation is not supported by your browser');
      return;
    }

    if (isTracking) {
      // Already tracking, stop it
      stopLocationTracking();
      return;
    }

    toast('Starting location tracking...');

    // Use watchPosition for continuous tracking
    locationWatchId = navigator.geolocation.watchPosition(
      // Success callback
      (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        
        // Update user location on map and check for alerts
        checkLocation(lat, lng);
        
        // Optionally center map on user (only on first location)
        if (!isTracking) {
          map.setView([lat, lng], Math.max(map.getZoom(), 14));
        }
        
        if (!isTracking) {
          isTracking = true;
          trackBtnText.textContent = 'Stop Tracking';
          trackLocationBtn.style.backgroundColor = '#ef4444'; // Red when tracking
          toast('Location tracking active', 2000);
        }
      },
      // Error callback
      (err) => {
        console.error('Location tracking error:', err);
        let errorMsg = 'Tracking error: ';
        
        switch(err.code) {
          case err.PERMISSION_DENIED:
            errorMsg += 'Location permission denied. Please enable location access.';
            break;
          case err.POSITION_UNAVAILABLE:
            errorMsg += 'Location unavailable. Check your device settings.';
            break;
          case err.TIMEOUT:
            errorMsg += 'Location request timed out. Retrying...';
            break;
          default:
            errorMsg += err.message || 'Unknown error';
        }
        
        toast(errorMsg, 3000);
        
        // If permission denied, stop tracking
        if (err.code === err.PERMISSION_DENIED) {
          stopLocationTracking();
        }
      },
      // Options - optimized for mobile walking/cycling
      {
        enableHighAccuracy: true,  // Use GPS for better accuracy
        timeout: 10000,            // 10 second timeout
        maximumAge: 3000           // Accept positions up to 3 seconds old (checks ~every 3 seconds)
      }
    );
  }

  function stopLocationTracking() {
    if (locationWatchId !== null) {
      navigator.geolocation.clearWatch(locationWatchId);
      locationWatchId = null;
    }
    
    isTracking = false;
    trackBtnText.textContent = 'Start Tracking';
    trackLocationBtn.style.backgroundColor = '#422d1e'; // Back to dark color
    toast('Location tracking stopped');
  }

  // Track location button click handler
  trackLocationBtn.addEventListener('click', () => {
    if (isTracking) {
      stopLocationTracking();
    } else {
      startLocationTracking();
    }
  });

  // Auto-start tracking on mobile devices (with user interaction)
  function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
           || window.innerWidth <= 768;
  }

  // Optionally auto-start on mobile (you can enable this if desired)
  // Uncomment the following to auto-start tracking on mobile:
  /*
  if (isMobileDevice()) {
    // Give user a moment to see the interface, then offer to start tracking
    setTimeout(() => {
      if (confirm('Start tracking your location automatically?')) {
        startLocationTracking();
      }
    }, 1000);
  }
  */

  // ----------------------------
  // Use GPS & clear spots
  // ----------------------------
  useGPSBtn.addEventListener('click', ()=> {
    if(!navigator.geolocation) {
      toast('Geolocation is not supported by your browser');
      return;
    }
    
    // Show loading state
    toast('Getting your location...');
    
    navigator.geolocation.getCurrentPosition(
      // Success callback
      p => {
        map.setView([p.coords.latitude, p.coords.longitude], 15);
        checkLocation(p.coords.latitude, p.coords.longitude);
        toast('Location found!');
      }, 
      // Error callback
      err => {
        console.error('Geolocation error:', err);
        let errorMsg = 'GPS error: ';
        
        switch(err.code) {
          case err.PERMISSION_DENIED:
            errorMsg += 'Location permission denied. Please enable location access in your browser settings.';
            break;
          case err.POSITION_UNAVAILABLE:
            errorMsg += 'Location information unavailable. Please check your device settings.';
            break;
          case err.TIMEOUT:
            errorMsg += 'Location request timed out. Please try again.';
            break;
          default:
            errorMsg += err.message || 'Unknown error occurred';
        }
        
        toast(errorMsg, 4000); // Show error for 4 seconds
      },
      // Options
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  });

  // Test vibration button
  const testVibrateBtn = document.getElementById('testVibrateBtn');
  testVibrateBtn.addEventListener('click', ()=> {
    console.log('📳 Testing vibration...');
    
    if ('vibrate' in navigator) {
      toast('Testing vibration...', 1000);
      
      // Test vibration
      const vibrationPattern = [300, 100, 300, 100, 300];
      const result = navigator.vibrate(vibrationPattern);
      
      console.log('Vibration API called, result:', result);
      
      if (result) {
        setTimeout(() => {
          toast('Vibration triggered! Did you feel it?', 3000);
        }, 1000);
      } else {
        toast('Vibration API returned false - may not be supported', 3000);
      }
    } else {
      console.log('Vibration API not available');
      
      // Check if iOS
      if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
        toast('⚠️ iOS does not support web vibration API', 3000);
      } else {
        toast('⚠️ Vibration not supported on this browser', 3000);
      }
    }
  });

  // ----------------------------
  // ----------------------------
  // Auth UI Event Listeners
  // ----------------------------
  
  // Open auth modal
  signInButton.addEventListener('click', () => {
    authModal.classList.remove('hidden');
    signInForm.classList.remove('hidden');
    signUpForm.classList.add('hidden');
    signInTab.classList.add('active');
    signUpTab.classList.remove('active');
    signInError.classList.add('hidden');
    signUpError.classList.add('hidden');
  });
  
  // Close auth modal
  closeAuthModal.addEventListener('click', () => {
    authModal.classList.add('hidden');
    signInForm.reset();
    signUpForm.reset();
    signInError.classList.add('hidden');
    signUpError.classList.add('hidden');
  });
  
  // Tab switching
  signInTab.addEventListener('click', () => {
    signInForm.classList.remove('hidden');
    signUpForm.classList.add('hidden');
    signInTab.classList.add('active');
    signInTab.style.borderColor = '#422d1e';
    signInTab.style.opacity = '1';
    signUpTab.classList.remove('active');
    signUpTab.style.borderColor = 'transparent';
    signUpTab.style.opacity = '0.6';
    signInError.classList.add('hidden');
    signUpError.classList.add('hidden');
  });
  
  signUpTab.addEventListener('click', () => {
    signUpForm.classList.remove('hidden');
    signInForm.classList.add('hidden');
    signUpTab.classList.add('active');
    signUpTab.style.borderColor = '#422d1e';
    signUpTab.style.opacity = '1';
    signInTab.classList.remove('active');
    signInTab.style.borderColor = 'transparent';
    signInTab.style.opacity = '0.6';
    signInError.classList.add('hidden');
    signUpError.classList.add('hidden');
  });
  
  // Sign in form submit
  signInForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    await signIn(signInEmail.value, signInPassword.value);
  });
  
  // Sign up form submit
  signUpForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    await signUp(signUpName.value, signUpEmail.value, signUpPassword.value);
  });
  
  // User button - toggle menu
  userButton.addEventListener('click', (e) => {
    e.stopPropagation();
    userMenuDropdown.classList.toggle('hidden');
  });
  
  // Close menu when clicking outside
  document.addEventListener('click', () => {
    userMenuDropdown.classList.add('hidden');
  });
  
  userMenuDropdown.addEventListener('click', (e) => {
    e.stopPropagation();
  });
  
  // Menu actions
  userMenuSignOut.addEventListener('click', async () => {
    await signOutUser();
    userMenuDropdown.classList.add('hidden');
  });
  
  // Menu actions - Stats and Profile
  userMenuStats.addEventListener('click', () => {
    openProfileModal();
    userMenuDropdown.classList.add('hidden');
  });
  
  userMenuProfile.addEventListener('click', () => {
    openProfileModal();
    userMenuDropdown.classList.add('hidden');
  });
  
  // Profile Modal Event Listeners
  closeProfileModal.addEventListener('click', closeProfileModalFn);
  
  // Tab switching
  profileStatsTab.addEventListener('click', () => {
    profileStatsTab.classList.add('active');
    profileStatsTab.style.cssText = 'border-color: #422d1e; color: #422d1e; opacity: 1;';
    profileEditTab.classList.remove('active');
    profileEditTab.style.cssText = 'color: #422d1e; opacity: 0.6; border-color: transparent;';
    
    profileStatsContent.classList.remove('hidden');
    profileEditContent.classList.add('hidden');
  });
  
  profileEditTab.addEventListener('click', () => {
    profileEditTab.classList.add('active');
    profileEditTab.style.cssText = 'border-color: #422d1e; color: #422d1e; opacity: 1;';
    profileStatsTab.classList.remove('active');
    profileStatsTab.style.cssText = 'color: #422d1e; opacity: 0.6; border-color: transparent;';
    
    profileEditContent.classList.remove('hidden');
    profileStatsContent.classList.add('hidden');
  });
  
  // Avatar picker
  document.querySelectorAll('.avatar-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const avatar = btn.dataset.avatar;
      selectedAvatar.value = avatar;
      
      // Update visual selection
      document.querySelectorAll('.avatar-btn').forEach(b => {
        b.style.borderColor = 'transparent';
        b.style.backgroundColor = '';
      });
      btn.style.borderColor = '#422d1e';
      btn.style.backgroundColor = '#e8e2e1';
    });
  });
  
  // Profile edit form
  profileEditForm.addEventListener('submit', updateUserProfile);
  
  cancelEditProfile.addEventListener('click', () => {
    profileStatsTab.click();
  });
  
  // Close modal when clicking outside
  profileModal.addEventListener('click', (e) => {
    if (e.target === profileModal) {
      closeProfileModalFn();
    }
  });

  // ----------------------------
  // Initial load default spot if none
  // ----------------------------
  // initialize tag UIs once at startup
  initializeAllTagUIs();
  
  // Initialize authentication
  initAuth();

  // Load spots from Supabase (with fallback to localStorage)
  (async () => {
    await loadAllFromSupabase();
    
    // Subscribe to real-time updates
    subscribeToRealtimeUpdates();
    
    // If no spots loaded, create a default example spot
    if(spots.length === 0){
      const defaultSpot = {
        id: uid(),
        name: 'South Bank Swoop',
        species: 'Magpie',
        lat: -27.4789,
        lng: 153.0234,
        radius: 150,
        risk: 'Take caution',
        reports: [{
          id: uid(),
          timestamp: new Date().toISOString(),
          birdBehaviour: ['swoop'],
          humanBehaviour: ['walking'],
          precautions: ['Hat'],
          extraDetails: 'Peak swoop season',
          alertLevel: 'Take caution'
        }]
      };
      createSpotFromData(defaultSpot, false);
      saveAll();
    }
    renderAlerts();
  })();

  // re-run initialization each time modals open/close so UI arrays & handlers are fresh
  openAddBtn.addEventListener('click', initializeAllTagUIs);
  addSpotBelowMap.addEventListener('click', initializeAllTagUIs);
  closeSpotModal.addEventListener('click', initializeAllTagUIs);
  closeDetails.addEventListener('click', initializeAllTagUIs);

  // expose some for debugging
  window.SwoopSpotter = { 
    spots, 
    map, 
    openCreateSpotModal, 
    openDetailsModal, 
    checkLocation,
    supabase, // Expose for debugging
    loadAllFromSupabase, // Expose for manual refresh
    syncEnabled // Expose to toggle sync
  };

})(); // IIFE end
</script>
</body>
</html>
