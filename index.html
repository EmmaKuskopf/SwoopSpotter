<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Swoop Spotter ‚Äî Reports</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root {
    --color-light: #f2eceb;
    --color-dark: #422d1e;
  }
  body { background: var(--color-light); font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  #map { 
    height: 56vh; 
    width: 100%; 
    border-radius: 0.5rem; 
    position: relative;
    z-index: 1;
    background: #e8e2e1;
  }
  .fab { position:absolute; bottom:1rem; right:1rem; z-index:1400; width:56px; height:56px; border-radius:9999px; display:grid; place-items:center; box-shadow:0 8px 24px rgba(66,45,30,0.18); cursor:pointer; }
  .tag-input { min-height:2.6rem; display:flex; align-items:center; gap:6px; flex-wrap:wrap; padding:6px; border:1px solid #d4cac7; border-radius:8px; background: var(--color-light); cursor:text; }
  .tag { background:#e8e2e1; color: var(--color-dark); padding:6px 8px; border-radius:999px; display:inline-flex; align-items:center; gap:6px; font-size:13px; }
  .tag .x { cursor:pointer; font-weight:700; }
  .tag-list { position:absolute; left:0; right:0; top:100%; margin-top:6px; background: var(--color-light); border:1px solid #d4cac7; border-radius:8px; box-shadow:0 10px 30px rgba(66,45,30,0.12); max-height:220px; overflow:auto; z-index:10050; display:none; }
  .tag-list > div { padding:8px 10px; cursor:pointer; }
  .tag-list > div:hover { background:#e8e2e1; }
  .modal-overlay { 
    z-index:99999 !important; 
    overflow-y: auto;
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
  }
  .tag-box { 
    min-height: 2.6rem; 
    display: flex; 
    align-items: center; 
    gap: 6px; 
    flex-wrap: wrap; 
    padding: 6px; 
    border: 1px solid #d4cac7; 
    border-radius: 8px; 
    background: var(--color-light); 
    cursor: text;
    margin-bottom: 1rem;
  }
  .input-field {
    width: 100%;
    border: 1px solid #d4cac7;
    border-radius: 8px;
    padding: 8px 12px;
    margin-bottom: 1rem;
    background: var(--color-light);
  }
  #alertBox { position: fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index: 1000000; background:#fff7ed; color: var(--color-dark); border:2px solid #f59e0b; border-radius:0.5rem; padding:0.75rem 1rem; max-width:92%; width:460px; box-shadow: 0 10px 30px rgba(66,45,30,.22); opacity:0; pointer-events:none; transition:opacity .26s ease; display:none; }
  #alertBox.show { display:block; opacity:1; pointer-events:auto; }
  /* Risk level colors for alert box */
  #alertBox.risk-danger { background: #fee2e2; border-color: #ef4444; }
  #alertBox.risk-caution { background: #fff7ed; border-color: #f59e0b; }
  #alertBox.risk-low { background: #dcfce7; border-color: #22c55e; }
  #alertBox.risk-calm { background: #dbeafe; border-color: #3b82f6; }
  .required::after { content: ' *'; color: #ef4444; font-weight:700; margin-left:6px; }
  /* report feed coloring */
  .report-low { border-left: 4px solid #10B981; }
  .report-caution { border-left: 4px solid #F59E0B; }
  .report-danger { border-left: 4px solid #EF4444; }
  @media (max-width:480px){ #alertBox{ width:94%; padding:.6rem; } }

  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .tab-btn {
    transition: all 0.2s;
    position: relative;
  }
  .tab-btn:not(.active) {
    color: var(--color-dark);
    opacity: 0.6;
    border-bottom-color: transparent;
  }
  .tab-btn.active {
    color: var(--color-dark);
    opacity: 1;
    border-bottom-color: var(--color-dark);
  }
  .tab-btn:hover:not(.active) {
    opacity: 0.8;
    border-bottom-color: #d4cac7;
  }
  .latest-report {
    background-color: var(--color-light);
    border-radius: 0.5rem;
    padding: 1rem;
  }
  
  /* Mobile modal scrolling improvements */
  body.modal-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
  }
  
  /* Ensure modal content is scrollable on mobile */
  @media (max-width: 768px) {
    .modal-overlay {
      align-items: flex-start !important;
      padding-top: 1rem;
      padding-bottom: 1rem;
    }
  }
  
  /* Safari-specific form element fixes */
  select, input, textarea {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }
  
  /* Consistent form field styling across all browsers */
  #birdSpecies {
    background-color: white;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 36px !important;
  }
  
  /* Bird Add Button Styling */
  .bird-add-btn {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 8px 24px rgba(0,0,0,0.18);
    overflow: hidden;
    background: transparent;
  }
  .bird-add-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 12px 32px rgba(0,0,0,0.24);
  }
  .bird-add-btn:active {
    transform: scale(0.98);
  }
  .bird-add-btn img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .bird-add-btn .plus-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 32px;
    font-weight: 300;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    pointer-events: none;
    z-index: 2;
  }
  
  /* Location tracking button animation */
  #trackLocationBtn {
    transition: background-color 0.3s ease, transform 0.1s ease;
  }
  #trackLocationBtn:active {
    transform: scale(0.95);
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
</style>
</head>
<body class="min-h-screen">

<header class="shadow sticky top-0 z-50" style="background-color: #f2eceb;">
  <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex-1"></div>
    <img src="Assets/Logo/Logo-Horizontal.svg" alt="Swoop Spotter Logo" class="h-8" />
    <div class="flex-1 flex justify-end relative">
      <!-- User Button (shown when signed in) -->
      <button id="userButton" class="hidden items-center gap-2 px-3 py-1.5 rounded" style="background-color: #e8e2e1; color: #422d1e;" onmouseover="this.style.backgroundColor='#dcd6d5'" onmouseout="this.style.backgroundColor='#e8e2e1'">
        <span id="userButtonName">User</span>
        <span class="text-xs">‚ñæ</span>
      </button>
      
      <!-- User Menu Dropdown -->
      <div id="userMenuDropdown" class="hidden absolute right-0 top-full mt-2 rounded-lg shadow-xl p-4 z-50" style="background-color: #f2eceb; border: 2px solid #d4cac7; min-width: 200px;">
        <div class="flex items-center gap-3 mb-3 pb-3" style="border-bottom: 1px solid #d4cac7;">
          <img id="userMenuAvatar" src="Assets/Users Icons/user_1.svg" alt="Avatar" class="w-10 h-10 rounded-full">
          <div>
            <div id="userMenuName" class="font-medium" style="color: #422d1e;">User Name</div>
            <div id="userMenuEmail" class="text-xs" style="color: #422d1e; opacity: 0.7;">user@email.com</div>
          </div>
        </div>
        <button id="userMenuStats" class="w-full text-left px-3 py-2 rounded mb-1 hover:bg-gray-100" style="color: #422d1e;">
          View Contributions
        </button>
        <button id="userMenuProfile" class="w-full text-left px-3 py-2 rounded mb-1 hover:bg-gray-100" style="color: #422d1e;">
          Edit Profile
        </button>
        <button id="userMenuSignOut" class="w-full text-left px-3 py-2 rounded hover:bg-gray-100" style="color: #422d1e;">
          Sign Out
        </button>
      </div>
      
      <!-- Sign In Button (shown when signed out) -->
      <button id="signInButton" class="items-center gap-2 px-4 py-1.5 rounded text-white" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
        Sign In
      </button>
    </div>
  </div>
</header>

<main class="max-w-4xl mx-auto px-4 pb-12 pt-4">
  <!-- Action buttons below logo, above map -->
  <div class="flex gap-2 mb-4 justify-center flex-wrap">
    <button id="trackLocationBtn" class="text-sm px-4 py-2 rounded text-white" style="background-color: #422d1e;">
      <span id="trackBtnText">Start Tracking</span>
    </button>
    <button id="useGPSBtn" class="text-sm px-4 py-2 rounded text-white" style="background-color: #422d1e;">Find Me</button>
  </div>

  <div id="map" class="shadow rounded relative">
    <button id="openAddBtn" class="fab bird-add-btn" title="Add Swoop Spot">
      <img src="Assets/Icons/bird_background.svg" alt="">
      <span class="plus-icon">+</span>
    </button>
  </div>

  <!-- Add Swoop Spot button below map -->
  <div class="mt-4 flex justify-center gap-2 flex-wrap">
    <button id="addSpotBelowMap" class="px-6 py-2 rounded text-white font-medium" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
      + Add Swoop Spot
    </button>
    <button id="safetyTipsBtn" class="px-6 py-2 rounded text-white font-medium flex items-center gap-2" style="background-color: #10B981;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
      <img src="Assets/Icons/tips.svg" alt="Tips" style="width: 20px; height: 20px; filter: brightness(0) invert(1);">
      Safety Tips
    </button>
    <button id="testVibrateBtn" class="px-4 py-2 rounded text-sm border" style="border-color: #d4cac7; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='transparent'">
      Test Vibration
    </button>
    <button id="testDateBtn" class="px-4 py-2 rounded text-sm border" style="border-color: #d4cac7; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='transparent'">
      Test Date
    </button>
  </div>

  <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
    <section class="p-3 rounded shadow" style="background-color: #f2eceb;">
      <h2 class="font-semibold mb-2" style="color: #422d1e;">Nearby Alerts</h2>
      <div id="alertsList" class="space-y-2 max-h-56 overflow-auto"></div>
      
      <!-- Stats Section -->
      <div class="mt-4 pt-3 border-t" style="border-color: #d4cac7;">
        <h3 class="font-semibold text-sm mb-3 flex items-center gap-2" style="color: #422d1e;">
          <img src="Assets/Menu Icons/Light Mode/menu-stats.svg" width="18" height="18" alt="Stats icon">
          Activity Stats
        </h3>
        
        <!-- Time Period Tabs -->
        <div class="flex gap-2 mb-3">
          <button class="stats-period-tab active flex-1 text-xs py-1 px-2 rounded" data-period="today" style="background-color: #422d1e; color: white;">
            Today
          </button>
          <button class="stats-period-tab flex-1 text-xs py-1 px-2 rounded" data-period="week" style="background-color: transparent; color: #422d1e; border: 1px solid #d4cac7;">
            This Week
          </button>
          <button class="stats-period-tab flex-1 text-xs py-1 px-2 rounded" data-period="season" style="background-color: transparent; color: #422d1e; border: 1px solid #d4cac7;">
            This Season
          </button>
        </div>
        
        <!-- Stats Grid -->
        <div class="space-y-2 text-xs">
          <!-- Total Reports -->
          <div class="flex justify-between items-center p-2 rounded" style="background-color: #e8e2e1;">
            <span style="color: #422d1e;">Total Reports</span>
            <span class="font-bold" style="color: #422d1e;" id="statTotalReports">0</span>
          </div>
          
          <!-- Safe Passages -->
          <div class="flex justify-between items-center p-2 rounded" style="background-color: #e8e2e1;">
            <span style="color: #059669;">‚úì Safe Passages</span>
            <span class="font-bold" style="color: #059669;" id="statSafePassages">0</span>
          </div>
          
          <!-- Injuries -->
          <div class="flex justify-between items-center p-2 rounded" style="background-color: #e8e2e1;">
            <span style="color: #DC2626;">‚ö† Injuries</span>
            <span class="font-bold" style="color: #DC2626;" id="statInjuries">0</span>
          </div>
          
          <!-- Bird Species Breakdown -->
          <div class="p-2 rounded" style="background-color: #e8e2e1;">
            <div class="font-semibold mb-2" style="color: #422d1e;">By Species:</div>
            <div id="statSpeciesBreakdown" class="space-y-1 text-xs">
              <div style="color: #422d1e; opacity: 0.6;">No reports yet</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="p-3 rounded shadow" style="background-color: #f2eceb;">
      <h2 class="font-semibold mb-2" style="color: #422d1e;">Walk Simulator</h2>
      <div class="text-xs mb-2" style="color: #422d1e; opacity: 0.7;">Simulate a straight-line walk (Start ‚Üí End addresses)</div>
      <div class="grid gap-2">
        <input id="simStart" placeholder="Start walk: Address" class="p-2 rounded w-full" style="border: 1px solid #d4cac7; background-color: #f2eceb;"/>
        <input id="simEnd" placeholder="End walk: Address" class="p-2 rounded w-full" style="border: 1px solid #d4cac7; background-color: #f2eceb;"/>
        <div class="flex gap-2">
          <button id="playSim" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded">Play</button>
          <button id="stopSim" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded">Stop</button>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- centered alert -->
<div id="alertBox" role="status" aria-live="polite"></div>

<!-- Add / New Spot Modal -->
<div id="spotModal" class="hidden fixed inset-0 modal-overlay flex items-start justify-center bg-black/40 pt-4 pb-4 px-4">
  <div class="rounded-lg shadow-lg w-full max-w-2xl my-auto max-h-[95vh] overflow-y-auto" style="background-color: #f2eceb;">
    <div class="p-6">
      <!-- Header -->
      <div class="flex justify-between items-center mb-4">
        <div>
          <h2 class="text-xl font-bold" style="color: #422d1e;">Add Swoop Spot</h2>
          <p class="text-sm mt-1" style="color: #422d1e; opacity: 0.7;">Click the map to select location, or enter an address below</p>
        </div>
        <button id="closeSpotModal" class="text-2xl" style="color: #422d1e; opacity: 0.6;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">&times;</button>
      </div>

    <form id="spotForm" class="space-y-4">
      <!-- Spot Details Section -->
      <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
        <h3 class="font-medium mb-3" style="color: #422d1e;">Spot Details</h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Bird species <span class="text-red-500">*</span></label>
            <select id="birdSpecies" class="w-full rounded-lg p-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #f2eceb; color: #422d1e;">
              <option>Magpie</option>
              <option>Magpie-Lark</option>
              <option>Masked Lapwing (plover)</option>
              <option>Butcherbird</option>
              <option>Crow</option>
              <option>Noisy Miner</option>
              <option>Noisy Friarbird</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Location Section -->
      <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
        <h3 class="font-medium mb-3" style="color: #422d1e;">Location</h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Address (optional)</label>
            <div class="flex gap-2">
              <div class="relative flex-1">
                <input id="addressField" placeholder="Enter an address" class="w-full rounded-lg p-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #f2eceb; color: #422d1e;" />
                <div id="addressField_suggestions"></div>
              </div>
              <button type="button" id="geoBtn" class="px-3 py-2 rounded text-sm whitespace-nowrap" style="border: 1px solid #d4cac7; background-color: #f2eceb; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='#f2eceb'">üìç Find Me</button>
            </div>
            <div id="addressInfo" class="text-xs mt-1" style="color: #422d1e; opacity: 0.7;"></div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Coordinates</label>
            <input id="coordsField" class="w-full rounded-lg p-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #e8e2e1; color: #422d1e;" readonly placeholder="Click map or find address"/>
          </div>
        </div>
      </div>

      <!-- Initial Report Section -->
      <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
        <h3 class="font-medium mb-3" style="color: #422d1e;">Initial Report</h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Bird behaviour <span class="text-red-500">*</span></label>
            <div class="relative">
              <div id="rbirdBox" class="tag-input" tabindex="0"></div>
              <div id="rbirdList" class="tag-list"></div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Human behaviour <span class="text-red-500">*</span></label>
            <div class="relative">
              <div id="rhumanBox" class="tag-input" tabindex="0"></div>
              <div id="rhumanList" class="tag-list"></div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Precautions taken <span class="text-red-500">*</span></label>
            <div class="relative">
              <div id="rprecBox" class="tag-input" tabindex="0"></div>
              <div id="rprecList" class="tag-list"></div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Alert level (auto-set from bird behaviour)</label>
            <input type="text" id="ralertLevel" class="w-full rounded-lg p-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #e8e2e1; color: #422d1e;" readonly>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Extra info (optional)</label>
            <textarea id="reextra" class="w-full rounded-lg p-2 h-20" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #f2eceb; color: #422d1e;" placeholder="Any additional notes..."></textarea>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-2 pt-2">
        <button type="button" id="spotCancel" class="px-4 py-2 rounded" style="border: 1px solid #d4cac7; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='transparent'">Cancel</button>
        <button type="submit" id="spotSave" class="px-4 py-2 text-white rounded" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Create Swoop Spot</button>
      </div>
    </form>
    </div>
  </div>
</div>

<!-- Spot Details / Report Feed Modal -->
<div id="detailsModal" class="hidden fixed inset-0 modal-overlay flex items-start justify-center bg-black/40 pt-4 pb-4 px-4">
  <div class="rounded-lg shadow-lg w-full max-w-2xl p-5 my-auto max-h-[95vh] overflow-y-auto" style="background-color: #f2eceb;">
    <div class="flex justify-between items-start">
      <div>
        <h3 id="detailsTitle" class="text-lg font-semibold" style="color: #422d1e;">Spot details</h3>
        <p id="detailsSubtitle" class="text-xs" style="color: #422d1e; opacity: 0.7;">Feed of reports. Add a new report to append to this spot.</p>
      </div>
      <div>
        <button id="closeDetails" style="color: #422d1e; opacity: 0.7;">‚úñ</button>
      </div>
    </div>

    <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Left: spot summary & reports -->
      <div>
        <div id="spotHeader" class="p-3 rounded mb-3" style="border: 1px solid #d4cac7;">
          <!-- populated dynamically -->
        </div>

        <div class="overflow-auto max-h-96 space-y-2" id="reportsFeed">
          <!-- report items -->
        </div>
      </div>

      <!-- Right: add new report form -->
      <div class="p-3 rounded" style="background-color: #e8e2e1;">
        <h4 class="font-semibold mb-2" style="color: #422d1e;">Add a report</h4>
        <form id="reportForm" class="space-y-3 text-sm">
          <div>
            <label class="required" style="color: #422d1e;">Bird behaviour</label>
            <div class="relative">
              <div id="rbirdBox2" class="tag-input" tabindex="0"></div>
              <div id="rbirdList2" class="tag-list"></div>
            </div>
          </div>

          <div>
            <label class="required" style="color: #422d1e;">Human behaviour</label>
            <div class="relative">
              <div id="rhumanBox2" class="tag-input" tabindex="0"></div>
              <div id="rhumanList2" class="tag-list"></div>
            </div>
          </div>

          <div>
            <label class="required" style="color: #422d1e;">Precautions</label>
            <div class="relative">
              <div id="rprecBox2" class="tag-input" tabindex="0"></div>
              <div id="rprecList2" class="tag-list"></div>
            </div>
          </div>

          <div>
            <label class="required">Alert level (derived)</label>
            <select id="repAlertLevel" class="w-full border p-2 rounded">
              <option>Low risk</option>
              <option>Take caution</option>
              <option>Danger - Avoid</option>
            </select>
          </div>

          <div>
            <label>Extra notes</label>
            <textarea id="repExtra" class="w-full border p-2 rounded"></textarea>
          </div>

          <div class="flex justify-end gap-2">
            <button type="button" id="reportCancel" class="px-3 py-2 border rounded">Cancel</button>
            <button type="submit" id="reportSave" class="px-4 py-2 bg-yellow-500 text-white rounded">Add report</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Confirm discard modal -->
<div id="confirmModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4">
  <div class="rounded-lg shadow-lg p-4 max-w-sm w-full my-auto" style="background-color: #f2eceb;">
    <div class="text-sm mb-3">
      <div class="font-semibold" style="color: #422d1e;">Discard changes?</div>
      <div class="text-xs" style="color: #422d1e; opacity: 0.7;">You have unsaved changes. Are you sure you want to close without saving?</div>
    </div>
    <div class="flex justify-end gap-2">
      <button id="keepEditing" class="px-3 py-1 rounded" style="border: 1px solid #d4cac7; color: #422d1e;">Keep editing</button>
      <button id="discardChanges" class="px-3 py-1 bg-red-600 text-white rounded">Discard</button>
    </div>
  </div>
</div>

<!-- Success modal -->
<div id="successModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4 overflow-y-auto">
  <div class="rounded-lg shadow-lg p-6 max-w-md w-full my-auto" style="background-color: #f2eceb;">
    <div class="text-center">
      <div class="mb-4">
        <img id="successUserIcon" src="" alt="User status" class="w-32 h-32 mx-auto" />
      </div>
      <h3 class="text-xl font-bold mb-2" style="color: #422d1e;">Swoop Spot Created!</h3>
      <p id="successMessage" class="mb-4" style="color: #422d1e;">
        <!-- Message will be dynamically set -->
      </p>
      <p id="goodEggMessage" class="text-lg font-medium text-green-600 mb-4">You're a good egg!</p>
      <button id="closeSuccessModal" class="px-6 py-2 text-white rounded-lg" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
        Got it!
      </button>
    </div>
  </div>
</div>

<!-- Exit Prompt Modal -->
<div id="exitPromptModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4 overflow-y-auto">
  <div class="rounded-lg shadow-lg p-6 max-w-lg w-full my-auto max-h-[90vh] flex flex-col" style="background-color: #f2eceb;">
    <div class="mb-4">
      <h3 class="text-xl font-bold mb-2" style="color: #422d1e;">Did you spot any birds?</h3>
      <p class="text-sm" style="color: #422d1e; opacity: 0.7;">You passed through the following swoop zones. Please update each one:</p>
    </div>
    
    <div id="exitPromptList" class="flex-1 overflow-y-auto space-y-3 mb-4">
      <!-- Spots will be dynamically added here -->
    </div>
    
    <div class="flex justify-end gap-2 pt-3" style="border-top: 1px solid #d4cac7;">
      <button id="closeExitPrompt" class="px-4 py-2 rounded" style="border: 1px solid #d4cac7; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='transparent'">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Test Date Modal -->
<div id="testDateModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4">
  <div class="rounded-lg shadow-lg w-full max-w-md mx-auto" style="background-color: #f2eceb;">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold" style="color: #422d1e;">Test Date Simulation</h3>
        <button id="closeTestDate" class="text-2xl" style="color: #422d1e; opacity: 0.7;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
      </div>
      
      <div class="mb-4">
        <p class="text-sm mb-4" style="color: #422d1e; opacity: 0.8;">
          Set a test date to see how the app behaves at different times of year. This is useful for testing pre-season warnings and seasonal features.
        </p>
        
        <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Select Test Date:</label>
        <input type="date" id="testDateInput" class="w-full rounded-lg p-2 mb-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #fff; color: #422d1e;">
        
        <div class="text-xs mb-4" style="color: #422d1e; opacity: 0.6;">
          <strong>Tips:</strong>
          <ul class="list-disc pl-5 mt-1">
            <li>Set to July to see pre-season warnings (30 days before August nesting season)</li>
            <li>Set to December to see spots marked as "Calm" (after nesting season)</li>
            <li>Set to September to see active swooping season alerts</li>
          </ul>
        </div>
      </div>
      
      <div class="flex gap-2">
        <button id="applyTestDate" class="flex-1 px-4 py-2 text-white rounded font-medium" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
          Apply Test Date
        </button>
        <button id="resetTestDate" class="flex-1 px-4 py-2 rounded font-medium" style="background-color: #d4cac7; color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
          Reset to Today
        </button>
      </div>
      
      <div id="currentTestDate" class="mt-4 text-sm text-center" style="color: #422d1e;">
        <!-- Will show current test date or "Using real date" -->
      </div>
    </div>
  </div>
</div>
<!-- Auth Modal -->
<div id="authModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="z-index: 9999;">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" style="background-color: #f2eceb; border: 2px solid #d4cac7;">
    <div class="flex items-center justify-between p-6 border-b" style="border-color: #d4cac7;">
      <h2 class="text-2xl font-bold" style="color: #422d1e;">Welcome to SwoopSpotter</h2>
      <button id="closeAuthModal" class="text-gray-500 hover:text-gray-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <!-- Tabs -->
    <div class="flex border-b" style="border-color: #d4cac7;">
      <button id="signInTab" class="flex-1 py-3 px-4 text-center font-medium active" style="border-bottom: 2px solid #422d1e; color: #422d1e;">
        Sign In
      </button>
      <button id="signUpTab" class="flex-1 py-3 px-4 text-center font-medium" style="color: #422d1e; opacity: 0.6;">
        Sign Up
      </button>
    </div>
    
    <!-- Sign In Form -->
    <form id="signInForm" class="p-6">
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Email</label>
        <input type="email" id="signInEmail" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color: #d4cac7; background-color: white;">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Password</label>
        <input type="password" id="signInPassword" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color: #d4cac7; background-color: white;">
      </div>
      <div id="signInError" class="hidden mb-4 p-3 rounded" style="background-color: #FEE2E2; color: #991B1B;"></div>
      <button type="submit" class="w-full text-white py-2 px-4 rounded-lg font-medium" style="background-color: #422d1e;">
        Sign In
      </button>
    </form>
    
    <!-- Sign Up Form -->
    <form id="signUpForm" class="hidden p-6">
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Display Name</label>
        <input type="text" id="signUpName" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color: #d4cac7; background-color: white;">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Email</label>
        <input type="email" id="signUpEmail" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color: #d4cac7; background-color: white;">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Password</label>
        <input type="password" id="signUpPassword" required minlength="6" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color: #d4cac7; background-color: white;">
      </div>
      <div id="signUpError" class="hidden mb-4 p-3 rounded" style="background-color: #FEE2E2; color: #991B1B;"></div>
      <button type="submit" class="w-full text-white py-2 px-4 rounded-lg font-medium" style="background-color: #422d1e;">
        Sign Up
      </button>
    </form>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="z-index: 9999;">
  <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" style="background-color: #f2eceb; border: 2px solid #d4cac7;">
    <div class="flex items-center justify-between p-6 border-b" style="border-color: #d4cac7;">
      <h2 class="text-2xl font-bold" style="color: #422d1e;">My Profile</h2>
      <button id="closeProfileModal" class="text-gray-500 hover:text-gray-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <!-- Profile Header -->
    <div class="p-6 border-b" style="border-color: #d4cac7;">
      <div class="flex items-center gap-4">
        <img id="profileAvatar" src="Assets/Users Icons/user_1.svg" alt="Avatar" class="w-20 h-20 rounded-full">
        <div>
          <h3 id="profileDisplayName" class="text-xl font-bold" style="color: #422d1e;"></h3>
          <p id="profileEmail" class="text-sm" style="color: #422d1e; opacity: 0.7;"></p>
          <p id="profileJoined" class="text-xs mt-1" style="color: #422d1e; opacity: 0.6;"></p>
        </div>
      </div>
      <p id="profileBio" class="mt-4 text-sm italic" style="color: #422d1e; opacity: 0.8;"></p>
    </div>
    
    <!-- New User Welcome Message -->
    <div id="newUserWelcome" class="hidden p-4 mx-6 mt-6 rounded" style="background-color: #DCFCE7; border-left: 3px solid #059669;">
      <p class="text-sm font-medium" style="color: #14532D;">
        üéâ Welcome to SwoopSpotter! Complete your profile below to personalize your experience.
      </p>
    </div>
    
    <!-- Tabs -->
    <div class="flex border-b" style="border-color: #d4cac7;">
      <button id="profileStatsTab" class="flex-1 py-3 px-4 text-center font-medium active" style="border-bottom: 2px solid #422d1e; color: #422d1e; opacity: 1;">
        Contributions
      </button>
      <button id="profileEditTab" class="flex-1 py-3 px-4 text-center font-medium" style="color: #422d1e; opacity: 0.6; border-color: transparent;">
        Edit Profile
      </button>
    </div>
    
    <!-- Stats Content -->
    <div id="profileStatsContent" class="p-6">
      <h3 class="text-lg font-bold mb-4" style="color: #422d1e;">Your Contributions</h3>
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="text-center p-4 rounded" style="background-color: white; border: 2px solid #d4cac7;">
          <div class="text-3xl font-bold" style="color: #422d1e;" id="statSpotsCreated">0</div>
          <div class="text-sm" style="color: #422d1e; opacity: 0.7;">Spots Created</div>
        </div>
        <div class="text-center p-4 rounded" style="background-color: white; border: 2px solid #d4cac7;">
          <div class="text-3xl font-bold" style="color: #422d1e;" id="statReportsCreated">0</div>
          <div class="text-sm" style="color: #422d1e; opacity: 0.7;">Reports Added</div>
        </div>
        <div class="text-center p-4 rounded" style="background-color: white; border: 2px solid #d4cac7;">
          <div class="text-3xl font-bold" style="color: #422d1e;" id="statSafePassages">0</div>
          <div class="text-sm" style="color: #422d1e; opacity: 0.7;">Safe Passages</div>
        </div>
      </div>
      
      <h3 class="text-lg font-bold mb-4" style="color: #422d1e;">Recent Activity</h3>
      <div id="profileRecentActivity" class="space-y-2">
        <span style="color: #422d1e; opacity: 0.6;" class="text-sm">Loading...</span>
      </div>
    </div>
    
    <!-- Edit Profile Content -->
    <div id="profileEditContent" class="hidden p-6">
      <form id="profileEditForm">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Display Name</label>
          <input type="text" id="editDisplayName" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color: #d4cac7; background-color: white;">
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Avatar</label>
          <input type="hidden" id="selectedAvatar" value="user_1.svg">
          <div class="grid grid-cols-4 gap-3">
            <button type="button" class="avatar-btn p-2 rounded border-2 hover:bg-gray-100" data-avatar="user_1.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_1.svg" alt="Avatar 1" class="w-full h-auto">
            </button>
            <button type="button" class="avatar-btn p-2 rounded border-2 hover:bg-gray-100" data-avatar="user_2.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_2.svg" alt="Avatar 2" class="w-full h-auto">
            </button>
            <button type="button" class="avatar-btn p-2 rounded border-2 hover:bg-gray-100" data-avatar="user_3.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_3.svg" alt="Avatar 3" class="w-full h-auto">
            </button>
            <button type="button" class="avatar-btn p-2 rounded border-2 hover:bg-gray-100" data-avatar="user_4.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_4.svg" alt="Avatar 4" class="w-full h-auto">
            </button>
            <button type="button" class="avatar-btn p-2 rounded border-2 hover:bg-gray-100" data-avatar="user_5.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_5.svg" alt="Avatar 5" class="w-full h-auto">
            </button>
            <button type="button" class="avatar-btn p-2 rounded border-2 hover:bg-gray-100" data-avatar="user_6.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_6.svg" alt="Avatar 6" class="w-full h-auto">
            </button>
            <button type="button" class="avatar-btn p-2 rounded border-2 hover:bg-gray-100" data-avatar="user_7.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_7.svg" alt="Avatar 7" class="w-full h-auto">
            </button>
            <button type="button" class="avatar-btn p-2 rounded border-2 hover:bg-gray-100" data-avatar="user_8.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_8.svg" alt="Avatar 8" class="w-full h-auto">
            </button>
            <button type="button" class="avatar-btn p-2 rounded border-2 hover:bg-gray-100" data-avatar="user_9.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_9.svg" alt="Avatar 9" class="w-full h-auto">
            </button>
            <button type="button" class="avatar-btn p-2 rounded border-2 hover:bg-gray-100" data-avatar="user_10.svg" style="border-color: transparent;">
              <img src="Assets/Users Icons/user_10.svg" alt="Avatar 10" class="w-full h-auto">
            </button>
          </div>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Bio (optional)</label>
          <textarea id="editBio" rows="3" maxlength="200" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2" style="border-color: #d4cac7; background-color: white;" placeholder="Tell us a bit about yourself..."></textarea>
          <p class="text-xs mt-1" style="color: #422d1e; opacity: 0.6;">Max 200 characters</p>
        </div>
        
        <div id="profileEditError" class="hidden mb-4 p-3 rounded" style="background-color: #FEE2E2; color: #991B1B;"></div>
        <div id="profileEditSuccess" class="hidden mb-4 p-3 rounded" style="background-color: #DCFCE7; color: #14532D;"></div>
        
        <div class="flex gap-3">
          <button type="submit" class="flex-1 text-white py-2 px-4 rounded-lg font-medium" style="background-color: #422d1e;">
            Save Changes
          </button>
          <button type="button" id="cancelEditProfile" class="flex-1 py-2 px-4 rounded-lg font-medium" style="background-color: white; border: 2px solid #d4cac7; color: #422d1e;">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Safety Tips Modal -->
<div id="safetyTipsModal" class="hidden fixed inset-0 flex items-center justify-center bg-black/40 z-50 p-4 overflow-y-auto">
  <div class="rounded-lg shadow-lg w-full max-w-2xl mx-auto my-auto" style="background-color: #f2eceb;">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold" style="color: #422d1e;">Safety Tips</h3>
        <button id="closeSafetyTips" class="text-2xl" style="color: #422d1e; opacity: 0.7;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
      </div>
      
      <!-- Species selector -->
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2" style="color: #422d1e;">Select bird species for specific tips:</label>
        <select id="tipsSpeciesSelect" class="w-full rounded-lg p-2" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d4cac7; background-color: #fff; color: #422d1e;">
          <option value="general">General Tips (All Birds)</option>
          <option value="Magpie">Magpie</option>
          <option value="Magpie-Lark">Magpie-Lark</option>
          <option value="Masked Lapwing (plover)">Masked Lapwing (Plover)</option>
          <option value="Butcherbird">Butcherbird</option>
          <option value="Crow">Crow</option>
          <option value="Noisy Miner">Noisy Miner</option>
          <option value="Noisy Friarbird">Noisy Friarbird</option>
        </select>
      </div>
      
      <!-- Tips content -->
      <div id="tipsContent" class="space-y-4" style="color: #422d1e;">
        <!-- Will be populated by JavaScript -->
      </div>
      
      <!-- Close button at bottom -->
      <div class="mt-6 text-center">
        <button id="closeSafetyTipsBottom" class="px-6 py-2 text-white rounded font-medium" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ----------------------------
  // Supabase Configuration
  // ----------------------------
  const SUPABASE_URL = 'https://ghoipwkezxiyjkgikfyw.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdob2lwd2tlenhpeWprZ2lrZnl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDcyNzQsImV4cCI6MjA3NjEyMzI3NH0.T-Sxyq4hv1U1DI5NHD6k30bHWjO0i5BTMeaUAuFRifg';
  
  // Initialize Supabase client
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  // ----------------------------
  // Authentication State
  // ----------------------------
  let currentUser = null;
  let userProfile = null;
  
  // Sync state
  let isSyncing = false;
  let syncEnabled = true; // Can be toggled for offline mode
  
  // ----------------------------
  // Setup map + icons + DOM refs
  // ----------------------------
  // Initialize map with a slight delay to ensure DOM is ready
  const map = L.map('map', {
    minZoom: 3,
    maxZoom: 18
  }).setView([-27.4698, 153.0251], 14);
  
  // Add CartoDB Voyager tiles (colorful, modern map style - free, no API key needed)
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 20
  }).addTo(map);

  function birdSVG(col){
    let iconName;
    switch(col) {
      case '#10B981': iconName = 'swoop_low.svg'; break;
      case '#F59E0B': iconName = 'swoop_caution.svg'; break;
      case '#EF4444': iconName = 'swoop_danger.svg'; break;
      case '#3b82f6': iconName = 'calm.svg'; break; // Blue for calm
      default: iconName = 'swoop_calm.svg';
    }
    return `<img src="Assets/Icons/${iconName}" width="36" height="36" alt="Bird icon">`;
  }
  function getBirdIcon(level, isPreseason = false){
    console.log(`üé® getBirdIcon called: level=${level}, isPreseason=${isPreseason}`);
    
    // If isPreseason flag is set, always use blue (calm) color for preventative messaging
    if (isPreseason) {
      console.log('  ‚Üí Returning blue (calm) icon due to isPreseason flag');
      return L.divIcon({ className:'bird-marker', html: birdSVG('#3b82f6'), iconSize:[36,36], iconAnchor:[18,18] });
    }
    
    let col = '#10B981'; // low risk (green)
    if(level === 'Take caution') col = '#F59E0B'; // caution (amber)
    if(level === 'Danger - Avoid') col = '#EF4444'; // danger (red)
    if(level === 'Calm - All clear') col = '#3b82f6'; // calm (blue)
    
    console.log(`  ‚Üí Returning ${col} icon for risk level: ${level}`);
    return L.divIcon({ className:'bird-marker', html: birdSVG(col), iconSize:[36,36], iconAnchor:[18,18] });
  }
  function getBirdIconSVG(level){
    let iconName;
    if(level === 'Danger - Avoid') iconName = 'swoop_danger.svg';
    else if(level === 'Take caution') iconName = 'swoop_caution.svg';
    else if(level === 'Calm - All clear') iconName = 'calm.svg';
    else iconName = 'swoop_low.svg';
    return `<img src="Assets/Icons/${iconName}" width="48" height="48" alt="Bird icon" class="rounded-lg">`;
  }
  
  // Function to get user icon based on their profile avatar
  function getUserIcon() {
    // Get avatar filename from profile (e.g., "user_3.svg")
    const avatarFilename = userProfile?.avatar_url || 'user.svg';
    // Construct full path based on whether it's a user avatar or default icon
    const avatarPath = avatarFilename.startsWith('user_') 
      ? `Assets/Users Icons/${avatarFilename}` 
      : `Assets/Icons/${avatarFilename}`;
    
    return L.divIcon({ 
      className:'', // Empty className to avoid default Leaflet divIcon styles
      html: `<img src="${avatarPath}" width="36" height="36" alt="User icon">`, 
      iconSize:[36,36], 
      iconAnchor:[18,18] 
    });
  }

  // DOM refs
  const openAddBtn = document.getElementById('openAddBtn');
  const spotModal = document.getElementById('spotModal');
  const closeSpotModal = document.getElementById('closeSpotModal');
  const spotForm = document.getElementById('spotForm');
  const birdSpecies = document.getElementById('birdSpecies');
  const addressField = document.getElementById('addressField');
  const addressInfo = document.getElementById('addressInfo');
  const coordsField = document.getElementById('coordsField');
  const rbirdBox = document.getElementById('rbirdBox');
  const rbirdList = document.getElementById('rbirdList');
  const rhumanBox = document.getElementById('rhumanBox');
  const rhumanList = document.getElementById('rhumanList');
  const rprecBox = document.getElementById('rprecBox');
  const rprecList = document.getElementById('rprecList');
  const ralertLevel = document.getElementById('ralertLevel');
  const reextra = document.getElementById('reextra');
  const spotCancel = document.getElementById('spotCancel');
  const geoBtn = document.getElementById('geoBtn');

  const detailsModal = document.getElementById('detailsModal');
  const closeDetails = document.getElementById('closeDetails');
  const detailsTitle = document.getElementById('detailsTitle');
  const reportsFeed = document.getElementById('reportsFeed');
  const spotHeader = document.getElementById('spotHeader');
  const reportForm = document.getElementById('reportForm');
  const rbirdBox2 = document.getElementById('rbirdBox2');
  const rbirdList2 = document.getElementById('rbirdList2');
  const rhumanBox2 = document.getElementById('rhumanBox2');
  const rhumanList2 = document.getElementById('rhumanList2');
  const rprecBox2 = document.getElementById('rprecBox2');
  const rprecList2 = document.getElementById('rprecList2');
  const repAlertLevel = document.getElementById('repAlertLevel');
  const repExtra = document.getElementById('repExtra');
  const reportCancel = document.getElementById('reportCancel');

  const alertsList = document.getElementById('alertsList');
  const alertBox = document.getElementById('alertBox');

  const confirmModal = document.getElementById('confirmModal');
  const keepEditing = document.getElementById('keepEditing');
  const discardChanges = document.getElementById('discardChanges');

  const successModal = document.getElementById('successModal');
  const closeSuccessModal = document.getElementById('closeSuccessModal');
  const successUserIcon = document.getElementById('successUserIcon');
  const successMessage = document.getElementById('successMessage');
  const goodEggMessage = document.getElementById('goodEggMessage');

  const exitPromptModal = document.getElementById('exitPromptModal');
  const exitPromptList = document.getElementById('exitPromptList');
  const closeExitPrompt = document.getElementById('closeExitPrompt');

  // Test Date refs
  const testDateBtn = document.getElementById('testDateBtn');
  const testDateModal = document.getElementById('testDateModal');
  const closeTestDate = document.getElementById('closeTestDate');
  const testDateInput = document.getElementById('testDateInput');
  const applyTestDate = document.getElementById('applyTestDate');
  const resetTestDate = document.getElementById('resetTestDate');
  const currentTestDate = document.getElementById('currentTestDate');

  // Safety Tips refs
  const safetyTipsModal = document.getElementById('safetyTipsModal');
  const closeSafetyTips = document.getElementById('closeSafetyTips');
  const safetyTipsBtn = document.getElementById('safetyTipsBtn');
  const tipsSpeciesSelect = document.getElementById('tipsSpeciesSelect');
  const tipsContent = document.getElementById('tipsContent');

  // Auth UI refs
  const authModal = document.getElementById('authModal');
  const closeAuthModal = document.getElementById('closeAuthModal');
  const signInTab = document.getElementById('signInTab');
  const signUpTab = document.getElementById('signUpTab');
  const signInForm = document.getElementById('signInForm');
  const signUpForm = document.getElementById('signUpForm');
  const signInEmail = document.getElementById('signInEmail');
  const signInPassword = document.getElementById('signInPassword');
  const signInError = document.getElementById('signInError');
  const signUpName = document.getElementById('signUpName');
  const signUpEmail = document.getElementById('signUpEmail');
  const signUpPassword = document.getElementById('signUpPassword');
  const signUpError = document.getElementById('signUpError');
  const signInButton = document.getElementById('signInButton');
  const userButton = document.getElementById('userButton');
  const userButtonName = document.getElementById('userButtonName');
  const userMenuDropdown = document.getElementById('userMenuDropdown');
  const userMenuName = document.getElementById('userMenuName');
  const userMenuEmail = document.getElementById('userMenuEmail');
  const userMenuStats = document.getElementById('userMenuStats');
  const userMenuProfile = document.getElementById('userMenuProfile');
  const userMenuSignOut = document.getElementById('userMenuSignOut');
  
  // Profile Modal Elements
  const profileModal = document.getElementById('profileModal');
  const closeProfileModal = document.getElementById('closeProfileModal');
  const profileStatsTab = document.getElementById('profileStatsTab');
  const profileEditTab = document.getElementById('profileEditTab');
  const profileStatsContent = document.getElementById('profileStatsContent');
  const profileEditContent = document.getElementById('profileEditContent');
  const profileEditForm = document.getElementById('profileEditForm');
  const editDisplayName = document.getElementById('editDisplayName');
  const selectedAvatar = document.getElementById('selectedAvatar');
  const editBio = document.getElementById('editBio');
  const profileEditError = document.getElementById('profileEditError');
  const profileEditSuccess = document.getElementById('profileEditSuccess');
  const cancelEditProfile = document.getElementById('cancelEditProfile');
  
  // Debug: Check if elements exist
  console.log('Profile modal elements:', {
    profileModal: !!profileModal,
    closeProfileModal: !!closeProfileModal,
    profileStatsTab: !!profileStatsTab,
    userMenuStats: !!userMenuStats,
    userMenuProfile: !!userMenuProfile
  });

  const trackLocationBtn = document.getElementById('trackLocationBtn');
  const trackBtnText = document.getElementById('trackBtnText');
  const useGPSBtn = document.getElementById('useGPSBtn');

  const playSim = document.getElementById('playSim');
  const stopSim = document.getElementById('stopSim');

  // constants + data arrays
  const STORAGE_KEY = 'swoop_reports_v1';
  const BIRD_BEHAVIOURS = ["noisy","swoop","close swoop","made contact + uninjured","made contact + injured"];
  const HUMAN_BEHAVIOURS = ["walking","running","cycling","riding e-scooter","alone","with others","with pram","with children","in group","other"];
  const PRECAUTIONS = ["Hat","Sunglasses","Umbrella","Helmet","Helmet with Cable Ties","Made Eye Contact","None"];

  // Swooping season data (month ranges: 1 = January, 12 = December)
  const SWOOPING_SEASONS = {
    "Magpie": { start: 8, end: 11 },  // August to November
    "Magpie-lark": { start: 8, end: 11 },  // August to November
    "Masked Lapwing": { start: 6, end: 12 },  // June to December (longer season)
    "Butcherbird": { start: 8, end: 11 },  // August to November
    "Crow": { start: 8, end: 10 },  // August to October
    "Noisy Miner": { start: 7, end: 11 },  // July to November
    "Noisy Friarbird": { start: 9, end: 12 }  // September to December
  };

  // Days to wait after last report before auto-calming
  const AUTO_CALM_DAYS = 10;
  
  // Days before season start to show pre-season warning with preventative tips (30 days = 1 month)
  const PRESEASON_WARNING_DAYS = 30;
  
  // Preventative tips for building rapport with birds (shown for pre-season warnings)
  // All tips sourced from documented organizations - see SAFETY_TIPS_SOURCES.md
  const PREVENTATIVE_TIPS = {
    general: [
      "Walk the same routes regularly so birds become familiar with you",
      "Plant native trees and shrubs to provide nesting habitat",
      "Provide fresh water sources year-round",
      "Keep pets supervised or indoors during nesting seasons",
      "Avoid disturbing nests or approaching nesting birds",
      "Learn to recognize bird alarm calls and give space when heard"
    ],
    Magpie: [
      "Feed magpies outside nesting season to build positive associations",
      "Magpies remember individual human faces for years",
      "Walk past regularly before nesting season - familiarity reduces aggression",
      "Avoid feeding during breeding season (August-November)",
      "Only ~10% of male magpies swoop - consistent presence helps birds recognize you",
      "Give respectful distance to known nesting trees year-round"
    ],
    "Magpie-lark": [
      "Provide water sources - magpie-larks love bathing",
      "Plant native shrubs that attract insects",
      "Avoid loud noises or sudden movements near their territory",
      "Become a familiar presence before breeding season begins"
    ],
    "Masked Lapwing": [
      "Keep lawns slightly longer to protect ground nests",
      "Mark known nesting areas to avoid accidental disturbance",
      "Keep dogs leashed in areas where plovers nest",
      "Learn their distinctive alarm calls and respect warning signals",
      "Plovers protect ground nests - wide berth year-round builds trust"
    ],
    Butcherbird: [
      "Respect their territory - butcherbirds are highly territorial",
      "Provide high perches and hunting opportunities",
      "Maintain respectful distance from known nesting areas",
      "Consistent non-threatening presence reduces defensive behavior"
    ],
    Crow: [
      "Crows have exceptional memory and recognize individual humans",
      "Never threaten or harm crows - they remember and communicate threats",
      "Consistent friendly behavior builds long-term recognition",
      "Crows teach offspring about threats - positive associations last generations"
    ],
    "Noisy Miner": [
      "Plant native flowering plants that attract insects and nectar",
      "Miners are highly communal - respect the entire colony's space",
      "Provide water sources year-round",
      "Consistent presence during non-breeding times reduces aggression"
    ],
    "Noisy Friarbird": [
      "Plant native flowering trees - friarbirds feed on nectar",
      "Provide water sources for drinking and bathing",
      "Maintain respectful distance from flowering trees during breeding",
      "Friarbirds are less aggressive than other species - calm presence helps"
    ]
  };

  // Safety tips data
  const SAFETY_TIPS = {
    general: {
      title: "General Bird Swooping Safety",
      description: "These tips apply to most swooping birds during nesting season (typically August to November in Australia).",
      tips: [
        "Avoid the area if possible during nesting season",
        "Travel in groups - birds usually target individuals",
        "Wear a broad-brimmed hat or helmet",
        "Carry an open umbrella above your head",
        "Wear sunglasses or safety glasses to protect your eyes",
        "Don't run - move calmly and quickly through the area",
        "Face the bird and maintain eye contact while moving away",
        "Dismount from bikes and scooters and walk through swooping zones",
        "Attach cable ties or pipe cleaners to your helmet to deter birds",
        "Take an alternate route if available",
        "Don't attempt to harm or provoke the bird - they're protecting their nest",
        "Report aggressive birds to local authorities"
      ]
    },
    Magpie: {
      title: "Australian Magpie Safety Tips",
      description: "Magpies are highly territorial during breeding season and account for most swooping incidents. They have excellent memory and may target specific individuals.",
      tips: [
        "Magpies remember faces - if swooped, avoid that area for several weeks",
        "Walk, don't run - running triggers their chase instinct",
        "Wear a broad-brimmed hat and sunglasses",
        "Attach cable ties or zip ties to your helmet (very effective for magpies)",
        "Draw eyes on the back of your hat or helmet",
        "Dismount your bike and walk it through the area",
        "Travel in groups - magpies rarely swoop groups",
        "Make eye contact and face the bird as you move away",
        "Don't wave your arms or swing objects - this may provoke more attacks",
        "Feed magpies in your yard outside nesting season to build positive associations",
        "Most magpies only swoop for 4-6 weeks during nesting",
        "Only 10% of male magpies actually swoop humans"
      ]
    },
    "Magpie-Lark": {
      title: "Magpie-Lark (Peewee) Safety Tips",
      description: "Magpie-larks are smaller but can be very aggressive defenders of their territory. Despite the name, they're not related to magpies.",
      tips: [
        "Wear a hat or helmet for head protection",
        "These birds are persistent but less dangerous than magpies",
        "Move quickly but calmly through the area",
        "Don't stop or linger near their nesting tree",
        "They typically swoop within 50 meters of their nest",
        "Face the bird and maintain eye contact",
        "Carry an umbrella or stick held above your head",
        "They're very protective but rarely make contact",
        "Nesting season is shorter than magpies (usually 3-4 weeks of swooping)"
      ]
    },
    "Masked Lapwing (plover)": {
      title: "Masked Lapwing (Plover) Safety Tips",
      description: "Plovers nest on the ground and are extremely protective of their eggs and chicks. They have distinctive yellow facial wattles and wing spurs.",
      tips: [
        "Watch for their distinctive alarm call - a loud, urgent cry",
        "Look for ground nests (small depressions) and give them wide berth",
        "Don't approach chicks - parents will attack"
      ]
    }
  };

  // state
  let spots = []; // spot objects with reports array
  let tempMarker = null;
  let selectedLocation = null; // {lat,lng}
  let initialFormState = null; // for dirty checks
  let selectedRBird = [], selectedRHuman = [], selectedRPrec = [];
  let selectedReportBird = [], selectedReportHuman = [], selectedReportPrec = [];
  let activeDetailsSpotId = null;
  let userMarker = null;
  let simTimer = null, simPath = [], simIndex = 0;
  
  // Location tracking state
  let locationWatchId = null;
  let isTracking = false;

  // cute names - expanded dataset with 50+ creative generic bird names
  const cuteNames = [
    "Fluffy Breeze", "Peckle Pops", "Feather Fiasco", "Wingy Woo", "Sir Chirpsalot",
    "Cloud Nibbler", "Little Zoomer", "Chirpadoodle", "Pip Squeak", "Muffin Flap",
    "Captain Beaky", "Swoopy McSwoopface", "Tweety Tornado", "Baron Von Birb",
    "Princess Plume", "Sky Rascal", "Beaky Blinder", "Lord Featherbottom",
    "Waddle Wellington", "Squawk Box", "Professor Peck", "Ruffles McGee",
    "Wing Commander", "Count Flappula", "Duchess Downy", "Sir Flapsalot",
    "Mister Whistle", "Lady Wingnut", "Captain Caw", "Feathers O'Malley",
    "Birdy Sanders", "Nest Potato", "Flap Jackson", "Beaker Bonanza",
    "Sergeant Swoop", "Admiral Airborne", "Doctor Doodle", "Judge Jitters",
    "Mayor Feathers", "Sheriff Screech", "Detective Talon", "Colonel Crest",
    "General Wings", "Lieutenant Chirp", "Commander Cluck", "Private Peck",
    "Zippy Zephyr", "Gusty Gale", "Breezy Buddy", "Windy Wanderer",
    "Talon Trouble", "Skyward Sam", "Aerial Ace", "Hover Helper",
    "Perch Patrol", "Branch Boss", "Treetop Terror", "Canopy Captain",
    "Swoosh Sultan", "Draft Dodger", "Glide Guide", "Soar Supreme"
  ];
  function randName(){ return cuteNames[Math.floor(Math.random()*cuteNames.length)]; }
  
  // Get a unique name within 5km radius
  function getUniqueName(lat, lng) {
    // Get all spot names within 5km
    const usedNames = spots
      .filter(s => metersBetween(lat, lng, s.lat, s.lng) <= 5000)
      .map(s => s.name);
    
    // Get available names (not used within 5km)
    const availableNames = cuteNames.filter(name => !usedNames.includes(name));
    
    // If all names are used within 5km, just use any random name
    if (availableNames.length === 0) {
      return randName();
    }
    
    // Return a random name from available names
    return availableNames[Math.floor(Math.random() * availableNames.length)];
  }
  
  function uid(){ return 's_' + Math.random().toString(36).slice(2,9); }

  // Format timestamp to show relative time
  function formatTimeAgo(timestamp) {
    const now = getCurrentDate().getTime();
    const then = new Date(timestamp).getTime();
    const diff = now - then;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (days > 0) {
      return `${days} day${days > 1 ? 's' : ''} ago`;
    }
    
    if (hours > 0) {
      const remainingMinutes = minutes % 60;
      if (remainingMinutes > 0) {
        return `${hours} hour${hours > 1 ? 's' : ''} ${remainingMinutes} minute${remainingMinutes > 1 ? 's' : ''} ago`;
      }
      return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    }
    
    return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
  }

  // Debounce helper
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // Get radius based on risk level
  function getRadiusByRisk(risk) {
    return risk === 'Danger - Avoid' ? 100 : 
           risk === 'Take caution' ? 80 : 50;
  }

  function metersBetween(aLat,aLng,bLat,bLng){
    const R=6371e3, toRad=v=>v*Math.PI/180;
    const œÜ1=toRad(aLat), œÜ2=toRad(bLat), ŒîœÜ=toRad(bLat-aLat), ŒîŒª=toRad(bLng-aLng);
    const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
  
  // Toast notification function with stacking support
  function toast(msg, t=1600){ 
    // Create or get toast container
    let container = document.getElementById('toast-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toast-container';
      container.style.cssText = 'position: fixed; top: 6rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; max-width: 320px;';
      document.body.appendChild(container);
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.style.cssText = 'background-color: #422d1e; color: white; padding: 0.75rem; border-radius: 0.375rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out;';
    toast.textContent = String(msg);
    
    // Add slide-in animation
    const style = document.createElement('style');
    if (!document.getElementById('toast-animation-style')) {
      style.id = 'toast-animation-style';
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    }
    
    container.appendChild(toast);
    
    // Remove toast after duration
    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease-in';
      setTimeout(() => {
        toast.remove();
        // Remove container if empty
        if (container.children.length === 0) {
          container.remove();
        }
      }, 300);
    }, t);
  }
  
  function escapeHtml(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // ----------------------------
  // Authentication Functions
  // ----------------------------
  
  // Check auth state on load
  async function initAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      await handleAuthStateChange(session.user);
    }
    
    // Listen for auth changes
    supabase.auth.onAuthStateChange(async (event, session) => {
      if (event === 'SIGNED_IN' && session) {
        await handleAuthStateChange(session.user);
      } else if (event === 'SIGNED_OUT') {
        handleSignOut();
      }
    });
  }
  
  // Load user profile from database
  async function loadUserProfile() {
    if (!currentUser) return null;
    
    const { data: profile, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', currentUser.id)
      .single();
    
    if (profile) {
      userProfile = profile;
      console.log('Profile loaded:', profile);
    } else {
      console.log('No profile found, user metadata:', currentUser.user_metadata);
      // Profile might not exist yet, use metadata as fallback
      userProfile = {
        display_name: currentUser.user_metadata?.display_name || currentUser.email.split('@')[0],
        email: currentUser.email
      };
    }
    
    return userProfile;
  }
  
  // Handle user sign in
  async function handleAuthStateChange(user) {
    currentUser = user;
    
    // Fetch user profile
    await loadUserProfile();
    
    // Update UI
    updateAuthUI();
    
    // Reload spots with user context (silently since we show welcome message)
    await loadAllFromSupabase(true);
    
    // Check if this is a new user signup
    const isNewUser = sessionStorage.getItem('newUserSignup') === 'true';
    
    if (isNewUser) {
      // Clear the flag
      sessionStorage.removeItem('newUserSignup');
      
      // Open profile modal on edit tab for new users
      setTimeout(() => {
        openProfileModal('edit', true);
      }, 500);
    } else {
      toast(`Welcome back, ${userProfile?.display_name || user.email.split('@')[0]}!`, 2000);
    }
  }
  
  // Update UI based on auth state
  function updateAuthUI() {
    if (currentUser) {
      // Show user button, hide sign in
      if (signInButton) signInButton.classList.add('hidden');
      if (userButton) {
        userButton.classList.remove('hidden');
        userButton.classList.add('flex');
      }
      
      // Get display name from profile or user metadata or email
      const displayName = userProfile?.display_name || 
                         currentUser.user_metadata?.display_name || 
                         currentUser.email.split('@')[0];
      
      if (userButtonName) userButtonName.textContent = displayName;
      
      // Update menu
      if (userMenuName) userMenuName.textContent = displayName;
      if (userMenuEmail) userMenuEmail.textContent = currentUser.email;
      
      // Update menu avatar
      const avatarUrl = userProfile?.avatar_url || 'user_1.svg';
      const userMenuAvatar = document.getElementById('userMenuAvatar');
      if (userMenuAvatar) {
        userMenuAvatar.src = `Assets/Users Icons/${avatarUrl}`;
      }
      
      console.log('UI updated with display name:', displayName);
    } else {
      // Show sign in, hide user button
      if (signInButton) signInButton.classList.remove('hidden');
      if (userButton) userButton.classList.add('hidden');
      if (userMenuDropdown) userMenuDropdown.classList.add('hidden');
    }
  }
  
  // Handle sign out
  function handleSignOut() {
    currentUser = null;
    userProfile = null;
    updateAuthUI();
    toast('Signed out successfully', 2000);
  }
  
  // Sign in with email/password
  async function signIn(email, password) {
    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
      });
      
      if (error) throw error;
      
      if (authModal) authModal.classList.add('hidden');
      if (signInError) signInError.classList.add('hidden');
      if (signInForm) signInForm.reset();
      
      return { success: true };
    } catch (error) {
      console.error('Sign in error:', error);
      if (signInError) {
        signInError.textContent = error.message;
        signInError.classList.remove('hidden');
      } else {
        toast('Sign in error: ' + error.message, 3000);
      }
      return { success: false, error };
    }
  }
  
  // Sign up with email/password
  async function signUp(name, email, password) {
    try {
      const { data, error } = await supabase.auth.signUp({
        email: email,
        password: password,
        options: {
          data: {
            display_name: name
          }
        }
      });
      
      if (error) throw error;
      
      // If user was created, ensure profile has correct display name
      if (data.user) {
        // Wait a bit for trigger to fire, then check/update profile
        setTimeout(async () => {
          try {
            const { data: existingProfile } = await supabase
              .from('profiles')
              .select('*')
              .eq('id', data.user.id)
              .single();
            
            if (existingProfile && !existingProfile.display_name) {
              // Update profile with correct display name
              await supabase
                .from('profiles')
                .update({ display_name: name })
                .eq('id', data.user.id);
              console.log('Profile display name updated to:', name);
            } else if (!existingProfile) {
              // Create profile manually if trigger didn't work
              await supabase
                .from('profiles')
                .insert({
                  id: data.user.id,
                  email: email,
                  display_name: name
                });
              console.log('Profile created manually with display name:', name);
            }
          } catch (profileError) {
            console.warn('Profile update/create failed:', profileError);
          }
        }, 1000);
      }
      
      if (authModal) authModal.classList.add('hidden');
      if (signUpError) signUpError.classList.add('hidden');
      if (signUpForm) signUpForm.reset();
      
      // Check if email confirmation is required
      if (data.user && !data.session) {
        toast('Account created! Please check your email to verify.', 4000);
      } else {
        // Mark this as a new signup to trigger profile setup flow
        sessionStorage.setItem('newUserSignup', 'true');
        toast('Welcome! Let\'s set up your profile.', 3000);
      }
      
      return { success: true };
    } catch (error) {
      console.error('Sign up error:', error);
      if (signUpError) {
        signUpError.textContent = error.message;
        signUpError.classList.remove('hidden');
      } else {
        toast('Sign up error: ' + error.message, 3000);
      }
      return { success: false, error };
    }
  }
  
  // Sign out
  async function signOutUser() {
    try {
      const { error } = await supabase.auth.signOut();
      if (error) throw error;
    } catch (error) {
      console.error('Sign out error:', error);
      toast('Error signing out', 2000);
    }
  }

  // ----------------------------
  // Profile Modal Functions
  // ----------------------------
  
  async function openProfileModal(defaultTab = 'stats', isNewUser = false) {
    console.log('openProfileModal called', { currentUser, userProfile, defaultTab, isNewUser });
    
    if (!currentUser) {
      toast('Please sign in first', 2000);
      return;
    }
    
    // Load fresh profile data
    await loadUserProfile();
    
    // Populate profile header
    document.getElementById('profileDisplayName').textContent = userProfile?.display_name || currentUser.email.split('@')[0];
    document.getElementById('profileEmail').textContent = currentUser.email;
    
    // Set avatar image
    const avatarUrl = userProfile?.avatar_url || 'user_1.svg';
    document.getElementById('profileAvatar').src = `Assets/Users Icons/${avatarUrl}`;
    
    // Format join date
    const joinDate = new Date(currentUser.created_at);
    document.getElementById('profileJoined').textContent = `Member since: ${joinDate.toLocaleDateString()}`;
    
    // Display bio
    const bioElement = document.getElementById('profileBio');
    if (userProfile?.bio && userProfile.bio.trim()) {
      bioElement.textContent = `"${userProfile.bio}"`;
      bioElement.style.display = 'block';
    } else {
      bioElement.style.display = 'none';
    }
    
    // Update stats
    document.getElementById('statSpotsCreated').textContent = userProfile?.total_spots_created || 0;
    document.getElementById('statReportsCreated').textContent = userProfile?.total_reports_created || 0;
    document.getElementById('statSafePassages').textContent = userProfile?.total_safe_passages || 0;
    
    // Load recent activity
    await loadRecentActivity();
    
    // Populate edit form
    editDisplayName.value = userProfile?.display_name || currentUser.email.split('@')[0];
    selectedAvatar.value = userProfile?.avatar_url || 'user_1.svg';
    editBio.value = userProfile?.bio || '';
    
    // Update avatar picker selection
    document.querySelectorAll('.avatar-btn').forEach(btn => {
      if (btn.dataset.avatar === selectedAvatar.value) {
        btn.style.borderColor = '#422d1e';
        btn.style.backgroundColor = '#e8e2e1';
      } else {
        btn.style.borderColor = 'transparent';
        btn.style.backgroundColor = '';
      }
    });
    
    // Show/hide new user welcome message
    const newUserWelcome = document.getElementById('newUserWelcome');
    if (newUserWelcome) {
      if (isNewUser) {
        newUserWelcome.classList.remove('hidden');
      } else {
        newUserWelcome.classList.add('hidden');
      }
    }
    
    // Show modal on specified tab
    if (defaultTab === 'edit') {
      profileEditTab.click();
    } else {
      profileStatsTab.click();
    }
    profileModal.classList.remove('hidden');
  }
  
  
  function closeProfileModalFn() {
    profileModal.classList.add('hidden');
    profileEditError.classList.add('hidden');
    profileEditSuccess.classList.add('hidden');
  }
  
  async function loadRecentActivity() {
    const activityContainer = document.getElementById('profileRecentActivity');
    activityContainer.innerHTML = '<span style="color: #422d1e; opacity: 0.6;" class="text-sm">Loading...</span>';
    
    try {
      const { data: recentSpots, error: spotsError } = await supabase
        .from('spots')
        .select('id, name, species, created_at')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false })
        .limit(5);
      
      if (spotsError) throw spotsError;
      
      if (!recentSpots || recentSpots.length === 0) {
        activityContainer.innerHTML = '<span style="color: #422d1e; opacity: 0.6;" class="text-sm">No recent activity</span>';
        return;
      }
      
      activityContainer.innerHTML = '';
      recentSpots.forEach(spot => {
        const activityEl = document.createElement('div');
        activityEl.className = 'flex items-start gap-2 text-sm';
        activityEl.style.cssText = 'color: #422d1e;';
        
        const date = new Date(spot.created_at);
        const timeAgo = getTimeAgo(date);
        
        activityEl.innerHTML = `
          <span>üìç</span>
          <div class="flex-1">
            <span class="font-medium">${spot.name}</span>
            <span style="opacity: 0.7;"> - ${spot.species}</span>
            <br>
            <span style="opacity: 0.6;" class="text-xs">${timeAgo}</span>
          </div>
        `;
        activityContainer.appendChild(activityEl);
      });
    } catch (error) {
      console.error('Error loading recent activity:', error);
      activityContainer.innerHTML = '<span style="color: #422d1e; opacity: 0.6;" class="text-sm">Error loading activity</span>';
    }
  }
  
  function getTimeAgo(date) {
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
    return date.toLocaleDateString();
  }
  
  async function updateUserProfile(e) {
    e.preventDefault();
    
    profileEditError.classList.add('hidden');
    profileEditSuccess.classList.add('hidden');
    
    const newDisplayName = editDisplayName.value.trim();
    const newAvatar = selectedAvatar.value;
    const newBio = editBio.value.trim().substring(0, 200);
    
    if (!newDisplayName) {
      profileEditError.textContent = 'Display name is required';
      profileEditError.classList.remove('hidden');
      return;
    }
    
    try {
      console.log('Updating profile:', { newDisplayName, newAvatar, newBio, userId: currentUser.id });
      
      const { data, error } = await supabase
        .from('profiles')
        .update({
          display_name: newDisplayName,
          avatar_url: newAvatar,
          bio: newBio
        })
        .eq('id', currentUser.id)
        .select();
      
      if (error) {
        console.error('Supabase error:', error);
        throw error;
      }
      
      console.log('Profile updated successfully:', data);
      
      userProfile = {
        ...userProfile,
        display_name: newDisplayName,
        avatar_url: newAvatar,
        bio: newBio
      };
      
      updateAuthUI();
      
      // Update user marker icon on map
      if (userMarker) {
        try {
          userMarker.setIcon(getUserIcon());
        } catch(e) {
          console.error('Error updating user marker icon:', e);
        }
      }
      
      profileEditSuccess.textContent = 'Profile updated successfully!';
      profileEditSuccess.classList.remove('hidden');
      
      setTimeout(() => {
        profileStatsTab.click();
        document.getElementById('profileDisplayName').textContent = newDisplayName;
        document.getElementById('profileAvatar').src = `Assets/Users Icons/${newAvatar}`;
      }, 1000);
      
    } catch (error) {
      console.error('Error updating profile:', error);
      profileEditError.textContent = `Error: ${error.message || 'Please try again.'}`;
      profileEditError.classList.remove('hidden');
    }
  }
  
  // Increment user's safe passage count
  async function incrementUserSafePassages() {
    if (!currentUser) return;
    
    try {
      // Increment the safe passage counter in the database
      const { error } = await supabase.rpc('increment_safe_passages', {
        user_id: currentUser.id
      });
      
      if (error) throw error;
      
      // Update local userProfile
      if (userProfile) {
        userProfile.total_safe_passages = (userProfile.total_safe_passages || 0) + 1;
        
        // Update the displayed stat if profile modal is open
        const statElement = document.getElementById('statSafePassages');
        if (statElement) {
          statElement.textContent = userProfile.total_safe_passages;
        }
      }
      
      console.log('‚úÖ Safe passage count incremented');
    } catch (error) {
      console.error('‚ùå Error incrementing safe passages:', error);
      // Don't show error to user, just log it
    }
  }
  
  // Increment user's spots created count
  async function incrementUserSpotsCreated() {
    if (!currentUser) return;
    
    try {
      // Increment the spots counter in the database
      const { error } = await supabase.rpc('increment_spots_created', {
        user_id: currentUser.id
      });
      
      if (error) throw error;
      
      // Update local userProfile
      if (userProfile) {
        userProfile.total_spots_created = (userProfile.total_spots_created || 0) + 1;
        
        // Update the displayed stat if profile modal is open
        const statElement = document.getElementById('statSpotsCreated');
        if (statElement) {
          statElement.textContent = userProfile.total_spots_created;
        }
      }
      
      console.log('‚úÖ Spots created count incremented');
    } catch (error) {
      console.error('‚ùå Error incrementing spots created:', error);
      // Don't show error to user, just log it
    }
  }
  
  // Increment user's reports created count
  async function incrementUserReportsCreated() {
    if (!currentUser) return;
    
    try {
      // Increment the reports counter in the database
      const { error } = await supabase.rpc('increment_reports_created', {
        user_id: currentUser.id
      });
      
      if (error) throw error;
      
      // Update local userProfile
      if (userProfile) {
        userProfile.total_reports_created = (userProfile.total_reports_created || 0) + 1;
        
        // Update the displayed stat if profile modal is open
        const statElement = document.getElementById('statReportsCreated');
        if (statElement) {
          statElement.textContent = userProfile.total_reports_created;
        }
      }
      
      console.log('‚úÖ Reports created count incremented');
    } catch (error) {
      console.error('‚ùå Error incrementing reports created:', error);
      // Don't show error to user, just log it
    }
  }

  // ----------------------------
  // Persistence (Supabase + localStorage fallback)
  // ----------------------------
  
  // Save spot to Supabase
  async function saveSpotToSupabase(spot) {
    if (!syncEnabled) return;
    
    try {
      isSyncing = true;
      
      // Prepare spot data (exclude UI elements)
      const spotData = {
        id: spot.id,
        name: spot.name,
        species: spot.species,
        lat: Number(spot.lat),
        lng: Number(spot.lng),
        risk: spot.risk,
        is_preseason: spot.isPreseason || false, // Include isPreseason flag
        user_id: currentUser?.id || null,
        created_by_name: currentUser ? (userProfile?.display_name || currentUser.email.split('@')[0]) : null
      };
      
      // Upsert spot (insert or update)
      const { data: spotResult, error: spotError } = await supabase
        .from('spots')
        .upsert(spotData)
        .select();
      
      if (spotError) throw spotError;
      
      // Save reports for this spot
      if (spot.reports && spot.reports.length > 0) {
        const reportsData = spot.reports.map(r => ({
          id: r.id,
          spot_id: spot.id,
          alert_level: r.alertLevel,
          bird_behaviour: r.birdBehaviour || [],
          human_behaviour: r.humanBehaviour || [],
          precautions: r.precautions || [],
          extra_details: r.extra || '',
          timestamp: r.timestamp,
          user_id: r.user_id || currentUser?.id || null,
          created_by_name: r.created_by_name || (currentUser ? (userProfile?.display_name || currentUser.email.split('@')[0]) : null)
        }));
        
        const { error: reportsError } = await supabase
          .from('reports')
          .upsert(reportsData);
        
        if (reportsError) throw reportsError;
      }
      
      console.log('‚úÖ Spot synced to Supabase:', spot.name);
      
    } catch (error) {
      console.error('‚ùå Error saving to Supabase:', error);
      toast('Sync error - saved locally', 2000);
    } finally {
      isSyncing = false;
    }
  }
  
  // Save all spots to localStorage (backup)
  function saveAll(){
    try {
      const serial = spots.map(s => {
        const { marker, circle, ...rest } = s;
        return rest;
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(serial));
    } catch(e){ console.warn(e); }
  }
  
  // Load all spots from Supabase
  async function loadAllFromSupabase(silent = false) {
    console.log('üîÑ loadAllFromSupabase called, syncEnabled:', syncEnabled);
    
    if (!syncEnabled) {
      console.log('‚ö†Ô∏è Sync disabled, falling back to localStorage');
      loadAll(); // Fallback to localStorage
      return;
    }
    
    try {
      if (!silent) {
        toast('Loading spots from cloud...', 1000);
      }
      
      console.log('üì° Fetching spots from Supabase...');
      
      // Fetch all spots with their reports
      const { data: spotsData, error } = await supabase
        .from('spots')
        .select(`
          *,
          reports (*)
        `)
        .order('created_at', { ascending: false });
      
      console.log('üìä Supabase response:', { spotsData, error });
      
      if (error) throw error;
      
      // Clear existing spots
      console.log('üóëÔ∏è Clearing existing spots:', spots.length);
      spots.forEach(s => {
        try {
          map.removeLayer(s.marker);
          map.removeLayer(s.circle);
        } catch(e) {}
      });
      spots = [];
      
      // Create spots from Supabase data
      if (spotsData && spotsData.length > 0) {
        console.log(`‚úÖ Creating ${spotsData.length} spots from Supabase data`);
        spotsData.forEach(spotData => {
          console.log('Creating spot:', spotData.name);
          // Convert Supabase format to app format
          const spot = {
            id: spotData.id,
            name: spotData.name,
            species: spotData.species,
            lat: Number(spotData.lat),
            lng: Number(spotData.lng),
            // DO NOT set risk here - let createSpotFromData calculate it based on current date
            // risk: spotData.risk,  // REMOVED - forces recalculation
            address: spotData.address || '',
            createdAt: spotData.created_at,
            safePassageCount: spotData.safe_passage_count || 0,
            isPreseason: spotData.is_preseason || false, // Load isPreseason flag from database
            reports: (spotData.reports || []).map(r => ({
              id: r.id,
              alertLevel: r.alert_level,
              birdBehaviour: r.bird_behaviour || [],
              humanBehaviour: r.human_behaviour || [],
              precautions: r.precautions || [],
              extraDetails: r.extra_details || '',
              timestamp: r.timestamp,
              user_id: r.user_id,
              created_by_name: r.created_by_name
            }))
          };
          
          createSpotFromData(spot, true);
        });
        
        console.log(`‚úÖ Successfully created ${spots.length} spots`);
        
        // Only show toast if not silent
        if (!silent) {
          toast(`Loaded ${spotsData.length} spots from cloud`, 2000);
        }
      } else if (!silent) {
        console.log('‚ö†Ô∏è No spots found in Supabase');
        toast('No spots found - add your first!', 2000);
      }
      
      // Save to localStorage as backup
      saveAll();
      
    } catch (error) {
      console.error('‚ùå Error loading from Supabase:', error);
      if (!silent) {
        toast('Loading from local storage...', 2000);
      }
      loadAll(); // Fallback to localStorage
    }
  }
  
  // Load from localStorage (fallback/offline)
  function loadAll(){
    console.log('üìÇ Loading spots from localStorage...');
    try {
      const raw = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      console.log(`üìÇ Found ${raw.length} spots in localStorage`);
      raw.forEach(r => createSpotFromData(r, true));
      console.log(`‚úÖ Successfully loaded ${spots.length} spots from localStorage`);
    } catch(e){ console.warn('‚ùå localStorage load error:', e); }
  }
  
  // Subscribe to real-time updates
  function subscribeToRealtimeUpdates() {
    if (!syncEnabled) return;
    
    // Subscribe to spots table changes
    const spotsChannel = supabase
      .channel('spots-changes')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'spots'
        },
        (payload) => {
          console.log('üîÑ Spot changed:', payload);
          handleSpotRealTimeUpdate(payload);
        }
      )
      .subscribe();
    
    // Subscribe to reports table changes
    const reportsChannel = supabase
      .channel('reports-changes')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'reports'
        },
        (payload) => {
          console.log('üîÑ Report changed:', payload);
          handleReportRealTimeUpdate(payload);
        }
      )
      .subscribe();
  }
  
  // Handle real-time spot updates
  function handleSpotRealTimeUpdate(payload) {
    const { eventType, new: newSpot, old: oldSpot } = payload;
    
    if (eventType === 'INSERT') {
      // New spot added by another user
      const existingSpot = spots.find(s => s.id === newSpot.id);
      if (!existingSpot) {
        toast(`New spot: ${newSpot.name}`, 2000);
        loadAllFromSupabase(true); // Reload silently
      }
    } else if (eventType === 'UPDATE') {
      // Spot updated
      loadAllFromSupabase(true); // Reload silently
    } else if (eventType === 'DELETE') {
      // Spot deleted
      const spot = spots.find(s => s.id === oldSpot.id);
      if (spot) {
        try {
          map.removeLayer(spot.marker);
          map.removeLayer(spot.circle);
        } catch(e) {}
        spots = spots.filter(s => s.id !== oldSpot.id);
        renderAlerts();
        saveAll();
      }
    }
  }
  
  // Handle real-time report updates
  function handleReportRealTimeUpdate(payload) {
    // When a report changes, reload the affected spot
    loadAllFromSupabase(true); // Reload silently
  }

  // ----------------------------
  // Robust Tag UI: idempotent, safe to re-run
  // Replaces previous setupTagUI implementation
  // ----------------------------
  function setupTagUI(box, list, options, selectedArray, onChange){
    // remove previously attached handlers stored on elements (if any)
    if (box._tagui_cleanup) {
      try { box._tagui_cleanup(); } catch(e){ /* ignore */ }
      delete box._tagui_cleanup;
    }
    if (list._tagui_cleanup) {
      try { list._tagui_cleanup(); } catch(e){ /* ignore */ }
      delete list._tagui_cleanup;
    }

    // render function (idempotent)
    function render(){
      box.innerHTML = '';
      selectedArray.forEach(p=>{
        const span = document.createElement('span');
        span.className='tag';
        span.innerHTML = `${escapeHtml(p)} <span class="x" data-val="${escapeHtml(p)}">&times;</span>`;
        box.appendChild(span);
      });
      if(selectedArray.length === 0){
        const ph = document.createElement('span');
        ph.className='text-xs text-gray-500';
        ph.textContent='Select...';
        box.appendChild(ph);
      }
      const caret = document.createElement('span');
      caret.innerHTML='&#9662;';
      caret.style.marginLeft='auto';
      caret.className='text-gray-400 text-sm';
      box.appendChild(caret);
    }

    // helper to populate list
    function populateList(){
      list.innerHTML = '';
      options.forEach(p => {
        const d = document.createElement('div');
        d.textContent = p;
        d.dataset.val = p;
        list.appendChild(d);
      });
    }

    // state for whether list is shown
    let listVisible = false;

    // click handler for box (toggle list)
    const onBoxClick = (e) => {
      e.stopPropagation();
      // toggle
      listVisible = !listVisible;
      if(listVisible){
        populateList();
        list.style.display = 'block';
      } else {
        list.style.display = 'none';
      }
    };

    // click handler for list items
    const onListClick = (e) => {
      const v = e.target && e.target.dataset && e.target.dataset.val;
      if(!v) return;
      if(!selectedArray.includes(v)) selectedArray.push(v);
      render();
      onChange && onChange();
      list.style.display = 'none';
      listVisible = false;
    };

    // click handler for removing a tag (delegated on the box)
    const onBoxRemoveClick = (e) => {
      const x = e.target.closest('.x');
      if(!x) return;
      const v = x.dataset.val;
      const idx = selectedArray.indexOf(v);
      if(idx>-1) selectedArray.splice(idx,1);
      render();
      onChange && onChange();
    };

    // global click to hide lists when clicking outside
    const onDocumentClick = (e) => {
      if(listVisible){
        list.style.display = 'none';
        listVisible = false;
      }
    };

    // attach listeners
    box.addEventListener('click', onBoxClick);
    list.addEventListener('click', onListClick);
    box.addEventListener('click', onBoxRemoveClick);
    document.addEventListener('click', onDocumentClick);

    // store cleanup function so subsequent initializations remove handlers
    box._tagui_cleanup = () => {
      try { box.removeEventListener('click', onBoxClick); } catch(e){}
      try { box.removeEventListener('click', onBoxRemoveClick); } catch(e){}
      try { document.removeEventListener('click', onDocumentClick); } catch(e){}
      try { list.removeEventListener('click', onListClick); } catch(e){}
      // hide list on cleanup
      try { list.style.display = 'none'; } catch(e){}
    };
    list._tagui_cleanup = box._tagui_cleanup;

    // initial render
    render();
  }

  // initializeAllTagUIs: central handler to reset & attach tag UIs cleanly
  function initializeAllTagUIs(){
    // hide any floating lists left open
    document.querySelectorAll('.tag-list').forEach(el => { el.style.display = 'none'; });

    // reset and attach create-spot modal tags
    selectedRBird = [];
    selectedRHuman = [];
    selectedRPrec = [];
    setupTagUI(rbirdBox, rbirdList, BIRD_BEHAVIOURS, selectedRBird, updateRAlertFromBirds);
    setupTagUI(rhumanBox, rhumanList, HUMAN_BEHAVIOURS, selectedRHuman, ()=>{});
    setupTagUI(rprecBox, rprecList, PRECAUTIONS, selectedRPrec, ()=>{});

    // reset and attach add-report modal tags
    selectedReportBird = [];
    selectedReportHuman = [];
    selectedReportPrec = [];
    setupTagUI(rbirdBox2, rbirdList2, BIRD_BEHAVIOURS, selectedReportBird, updateRepAlertFromBirds);
    setupTagUI(rhumanBox2, rhumanList2, HUMAN_BEHAVIOURS, selectedReportHuman, ()=>{});
    setupTagUI(rprecBox2, rprecList2, PRECAUTIONS, selectedReportPrec, ()=>{});
  }

  // ----------------------------
  // Alert level logic
  // ----------------------------
  function computeAlertFromBirds(birdTags){
    if(!Array.isArray(birdTags)) return 'Low risk';
    if(birdTags.includes('made contact + injured') || birdTags.includes('made contact + uninjured')) return 'Danger - Avoid';
    if(birdTags.includes('close swoop')) return 'Take caution';
    // if has swoop or noisy or none -> Low risk
    return 'Low risk';
  }
  function updateRAlertFromBirds(){ ralertLevel.value = computeAlertFromBirds(selectedRBird); }
  function updateRepAlertFromBirds(){ repAlertLevel.value = computeAlertFromBirds(selectedReportBird); }

  // ----------------------------
  // Geocoding (Nominatim)
  // ----------------------------
  async function geocodeAddress(q){
    const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q);
    const res = await fetch(url);
    const j = await res.json();
    if(!j || j.length===0) throw new Error('Address not found');
    return { lat: parseFloat(j[0].lat), lng: parseFloat(j[0].lon), display: j[0].display_name };
  }

  // Address suggestions UI
  function createAddressList(input) {
    let listId = input.id + '_suggestions';
    let existingList = document.getElementById(listId);
    if (!existingList) {
      const list = document.createElement('div');
      list.id = listId;
      list.className = 'absolute left-0 right-0 rounded-lg shadow-lg mt-1 z-50 max-h-48 overflow-y-auto hidden';
      list.style.backgroundColor = '#f2eceb';
      list.style.border = '1px solid #d4cac7';
      input.parentElement.style.position = 'relative';
      input.parentElement.appendChild(list);
      return list;
    }
    return existingList;
  }

  // Address lookup and suggestion handler
  async function handleAddressLookup(input) {
    if (!input.value.trim()) {
      const list = document.getElementById(input.id + '_suggestions');
      if (list) list.classList.add('hidden');
      return;
    }

    try {
      const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(input.value.trim());
      const res = await fetch(url);
      const results = await res.json();
      
      const list = createAddressList(input);
      list.innerHTML = '';
      
      if (results.length > 0) {
        results.slice(0, 5).forEach(r => {
          const div = document.createElement('div');
          div.className = 'p-2 cursor-pointer text-sm';
          div.style.color = '#422d1e';
          div.textContent = r.display_name;
          div.addEventListener('mouseover', () => div.style.backgroundColor = '#e8e2e1');
          div.addEventListener('mouseout', () => div.style.backgroundColor = 'transparent');
          div.addEventListener('click', () => {
            input.value = r.display_name;
            if (input.id === 'addressField') {
              selectedLocation = { lat: parseFloat(r.lat), lng: parseFloat(r.lon) };
              coordsField.value = `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
              addressInfo.textContent = `Selected: ${r.display_name}`;
              if (tempMarker) try { map.removeLayer(tempMarker); } catch(e){}
              tempMarker = L.marker([selectedLocation.lat, selectedLocation.lng]).addTo(map);
              map.setView([selectedLocation.lat, selectedLocation.lng], 16);
            }
            list.classList.add('hidden');
          });
          list.appendChild(div);
        });
        list.classList.remove('hidden');
      } else {
        list.classList.add('hidden');
      }
    } catch(err) {
      console.warn('Address lookup error:', err);
    }
  }

  // Setup debounced address lookup
  const debouncedAddressLookup = debounce(handleAddressLookup, 300);

  // ----------------------------
  // Map click behavior
  // ----------------------------
  map.on('click', (e) => {
    // if the spot modal is open, treat click as selected location
    if(!spotModal.classList.contains('hidden')){
      selectedLocation = { lat: e.latlng.lat, lng: e.latlng.lng };
      coordsField.value = `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
      addressInfo.textContent = `Selected from map: ${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
      if(tempMarker) try{ map.removeLayer(tempMarker); } catch(e){}
      tempMarker = L.marker(e.latlng).addTo(map);
      return;
    }
    // when details modal open, do nothing special
    if(!detailsModal.classList.contains('hidden')) return;
    // otherwise pan
    map.panTo(e.latlng);
  });

  // ----------------------------
  // Create spot & reports model
  // ----------------------------
  function createSpotFromData(data, skipSave=false){
    if(!data.id) data.id = uid();
    if(!Array.isArray(data.reports)) data.reports = [];
    if(!data.createdAt) data.createdAt = new Date().toISOString(); // Add creation date if missing
    
    console.log(`üî® Creating spot: ${data.name}, species: ${data.species || data.birdSpecies}, reports: ${data.reports?.length || 0}`);
    
    // Check if spot should show pre-season warning
    const showPreseasonMsg = shouldShowPreseasonWarning(data.reports, data.species || data.birdSpecies, data.createdAt);
    
    // compute risk if absent
    if(!data.risk) data.risk = computeSpotRiskFromReports(data.reports, data.species || data.birdSpecies);
    
    console.log(`üéØ Spot ${data.name} risk calculated as: ${data.risk}, isPreseason: ${showPreseasonMsg}`);
    
    // If showing pre-season warning, override to Calm and mark it
    // Otherwise, clear the isPreseason flag (in case it was set previously)
    if (showPreseasonMsg) {
      data.risk = 'Calm - All clear';
      data.isPreseason = true;
    } else {
      data.isPreseason = false;
    }
    
    const lat = Number(data.lat), lng = Number(data.lng);
    const marker = L.marker([lat,lng], { icon: getBirdIcon(data.risk, data.isPreseason) }).addTo(map);
    const radius = getRadiusByRisk(data.risk);
    
    const circle = L.circle([lat,lng], { 
      radius: radius,
      color: data.risk === 'Danger - Avoid' ? '#EF4444' : data.risk === 'Take caution' ? '#F59E0B' : data.risk === 'Calm - All clear' ? '#3b82f6' : '#10B981',
      fillColor: data.risk === 'Danger - Avoid' ? '#FEE2E2' : data.risk === 'Take caution' ? '#FEF3C7' : data.risk === 'Calm - All clear' ? '#dbeafe' : '#DCFCE7',
      fillOpacity: 0.35 
    }).addTo(map);

    const spot = {
      id: data.id,
      name: data.name || 'Swoop Spot',
      species: data.species || data.birdSpecies || '',
      lat, lng,
      address: data.address || '',
      radius: getRadiusByRisk(data.risk),
      risk: data.risk,
      reports: data.reports.slice(),
      safePassageCount: data.safePassageCount || 0,
      createdAt: data.createdAt,
      isPreseason: showPreseasonMsg || false,
      marker, circle
    };

    // marker click shows quick alert (custom yellow box)
    marker.on('click', ()=> showSpotQuickAlert(spot));

    spots.push(spot);
    if(!skipSave) {
      saveAll(); // Save to localStorage
      saveSpotToSupabase(spot); // Sync to Supabase
    }
    renderAlerts();
    return spot;
  }

  function buildSpotPopup(s){
    return `<div class="text-sm"><b>${escapeHtml(s.name)}</b><br/>Species: ${escapeHtml(s.species)}<br/>Risk: ${escapeHtml(s.risk)}<br/>Reports: ${s.reports.length}</div>`;
  }

  // ----------------------------
  // Add new spot (create from createSpotFromData)
  // ----------------------------
  function handleCreateSpotFromForm(e){
    e.preventDefault();
    // validations - removed spot name from required fields since it's auto-generated
    const missing = [];
    if(!birdSpecies.value.trim()) missing.push('Bird species');
    if(selectedRBird.length===0) missing.push('Bird behaviour (initial report)');
    if(selectedRHuman.length===0) missing.push('Human behaviour (initial report)');
    if(selectedRPrec.length===0) missing.push('Precautions');
    if(!selectedLocation && !addressField.value.trim()) missing.push('Location (click map or enter address)');
    if(missing.length>0){ toast('Please complete: ' + missing.join(', ')); return; }

    (async ()=>{
      let latlng = null;
      // prefer address if provided
      if(addressField.value.trim()){
        try {
          addressInfo.textContent = 'Finding address...';
          const g = await geocodeAddress(addressField.value.trim());
          latlng = { lat: g.lat, lng: g.lng, display: g.display };
          addressInfo.textContent = `Found: ${g.display}`;
        } catch(err){
          addressInfo.textContent = 'Address not found ‚Äî use map click instead';
          if(selectedLocation) latlng = selectedLocation;
          else { toast('Address not found and no map selection'); return; }
        }
      } else if(selectedLocation){
        latlng = selectedLocation;
      } else {
        toast('Please select a location');
        return;
      }

      // create initial report
      const report = {
        id: uid(),
        timestamp: new Date().toISOString(),
        birdBehaviour: selectedRBird.slice(),
        humanBehaviour: selectedRHuman.slice(),
        precautions: selectedRPrec.slice(),
        extra: reextra.value.trim(),
        alertLevel: computeAlertFromBirds(selectedRBird),
        user_id: currentUser?.id || null,
        created_by_name: currentUser ? (userProfile?.display_name || currentUser.email.split('@')[0]) : 'Anonymous'
      };

      // determine spot risk based on initial report (same immediate raise)
      const spotRisk = computeSpotRiskFromReports([report], birdSpecies.value);

      // Generate unique random name within 5km radius
      const birdName = getUniqueName(latlng.lat, latlng.lng);
      
      const spotData = {
        id: uid(),
        name: birdName,
        species: birdSpecies.value,
        lat: latlng.lat,
        lng: latlng.lng,
        address: latlng.display || addressField.value.trim() || '',
        radius: spotRisk === 'Danger - Avoid' ? 100 : spotRisk === 'Take caution' ? 80 : 50,
        risk: spotRisk,
        reports: [report],
        createdAt: new Date().toISOString() // Track creation date for lifecycle management
      };

      createSpotFromData(spotData, false);
      saveAll();
      
      // Increment user's spots and reports counters
      incrementUserSpotsCreated(); // +1 spot
      incrementUserReportsCreated(); // +1 report (the initial report)
      
      // Show success modal BEFORE resetting the form (so selectedRBird is still populated)
      showSuccessModal(birdName, birdSpecies.value, selectedRBird);
      
      closeSpotModalImmediate();
    })();
  }

  // compute new overall spot risk from array of reports
  function computeSpotRiskFromReports(reportsArray, species = ''){
    // Check if the spot should be auto-calmed (season ended + 10 days since last report)
    // Spots stay calm even when new season starts - only new reports change the risk
    if (shouldAutoCalm(reportsArray, species)) {
      return 'Calm - All clear';
    }
    
    // If we get here, there must be recent reports (within current season)
    // Calculate risk based on most severe behavior reported
    
    // Highest priority: any contact (injured/uninjured) => Danger
    for(const r of reportsArray){
      if(Array.isArray(r.birdBehaviour) && (r.birdBehaviour.includes('made contact + injured') || r.birdBehaviour.includes('made contact + uninjured'))) return 'Danger - Avoid';
    }
    // Next: any close swoop
    for(const r of reportsArray){ if(Array.isArray(r.birdBehaviour) && r.birdBehaviour.includes('close swoop')) return 'Take caution'; }
    // else Low
    return 'Low risk';
  }

  // Check if a spot should be automatically marked as calm
  // Returns true if:
  // 1. Season has ended + 10 days since last report, OR
  // 2. New season started but no new reports yet (stays calm until proven active)
  function shouldAutoCalm(reportsArray, species) {
    if (!species) {
      console.log('‚ùå shouldAutoCalm: No species');
      return false;
    }
    
    // Get the swooping season for this species
    const season = SWOOPING_SEASONS[species];
    if (!season) {
      console.log('‚ùå shouldAutoCalm: No season data for', species);
      return false;
    }
    
    // Must have at least one report (from previous season) to be marked calm
    if (!reportsArray || reportsArray.length === 0) {
      console.log('‚ùå shouldAutoCalm: No reports, cannot be calm');
      return false;
    }
    
    // Get current date and most recent report date
    const now = getCurrentDate();
    const currentMonth = now.getMonth() + 1;
    const currentYear = now.getFullYear();
    
    // Find the most recent report
    const sortedReports = [...reportsArray].sort((a, b) => 
      new Date(b.timestamp) - new Date(a.timestamp)
    );
    const lastReport = sortedReports[0];
    const lastReportDate = new Date(lastReport.timestamp);
    const daysSinceLastReport = Math.floor((now - lastReportDate) / (1000 * 60 * 60 * 24));
    
    console.log(`üîç shouldAutoCalm: ${species}, current: ${currentMonth}/${currentYear}, season: ${season.start}-${season.end}, last report: ${daysSinceLastReport} days ago`);
    
    // Check if we're currently in the swooping season
    const isInSeason = currentMonth >= season.start && currentMonth <= season.end;
    
    if (isInSeason) {
      // We're in the active season - check if there are any reports from THIS season
      const currentSeasonStart = new Date(currentYear, season.start - 1, 1);
      const hasCurrentSeasonReports = reportsArray.some(r => new Date(r.timestamp) >= currentSeasonStart);
      
      if (hasCurrentSeasonReports) {
        // There are reports from this season - calculate risk normally
        console.log(`‚ùå shouldAutoCalm: In season with current reports - calculate risk normally`);
        return false;
      } else {
        // In season but no reports yet this year - stay calm
        console.log(`‚úÖ shouldAutoCalm: In season but no new reports - staying calm`);
        return true;
      }
    }
    
    // We're outside the season - check if enough time has passed since last report
    if (daysSinceLastReport >= AUTO_CALM_DAYS) {
      console.log(`‚úÖ shouldAutoCalm: Outside season + ${daysSinceLastReport} days since last report - marking calm`);
      return true;
    }
    
    console.log(`‚ùå shouldAutoCalm: Outside season but only ${daysSinceLastReport} days since last report (need ${AUTO_CALM_DAYS})`);
    return false;
  }
  
  
  // Check if a spot should be reactivated with pre-season warning
  // This controls the ENTRY ALERT (blue preventative tips when entering the zone)
  // Note: This is different from the EXIT FEEDBACK prompt for calm spots during season
  function shouldShowPreseasonWarning(reportsArray, species, createdAt) {
    if (!species) return false;
    
    const season = SWOOPING_SEASONS[species];
    if (!season) return false;
    
    const now = getCurrentDate();
    const currentMonth = now.getMonth() + 1;
    const currentYear = now.getFullYear();
    
    // Check if currently outside nesting season
    const isOutsideSeason = currentMonth > season.end || currentMonth < season.start;
    if (!isOutsideSeason) return false; // Currently in season, no pre-season warning needed
    
    // Calculate days until next season starts
    let daysUntilSeason;
    
    if (currentMonth < season.start) {
      // Season starts later this year
      const seasonStartDate = new Date(currentYear, season.start - 1, 1);
      daysUntilSeason = Math.floor((seasonStartDate - now) / (1000 * 60 * 60 * 24));
    } else {
      // Season starts next year (we're past the end of this year's season)
      const nextSeasonStartDate = new Date(currentYear + 1, season.start - 1, 1);
      daysUntilSeason = Math.floor((nextSeasonStartDate - now) / (1000 * 60 * 60 * 24));
    }
    
    // Show pre-season warning ENTRY ALERT if we're within 30 days of next season
    // BUT we're NOT too close (not within 4 days) - those get the exit feedback instead
    const isInPreseasonWindow = daysUntilSeason >= 4 && daysUntilSeason <= PRESEASON_WARNING_DAYS;
    
    console.log(`üìÖ shouldShowPreseasonWarning: ${species}, days until season: ${daysUntilSeason}, showing entry alert: ${isInPreseasonWindow}`);
    
    return isInPreseasonWindow;
  }
  
  // Get the month name when nesting season begins
  function getSeasonStartMonth(species) {
    const season = SWOOPING_SEASONS[species];
    if (!season) return 'Unknown';
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                        'July', 'August', 'September', 'October', 'November', 'December'];
    return monthNames[season.start - 1];
  }

  // ----------------------------
  // Details modal (feed) + add report
  // ----------------------------
  function openDetailsModal(spotId) {
    const s = spots.find(x => x.id === spotId);
    if(!s) return;
    activeDetailsSpotId = spotId;

    // Initialize new arrays for tag UI
    selectedReportBird = [];
    selectedReportHuman = [];
    selectedReportPrec = [];

    detailsModal.innerHTML = `
      <div class="rounded-lg w-full max-w-2xl mx-auto my-auto max-h-[95vh] overflow-y-auto relative" style="background-color: #f2eceb;">
        <div class="p-6">
          <!-- Header -->
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold" style="color: #422d1e;">${escapeHtml(s.name)}</h2>
            <button id="closeDetails" style="color: #422d1e; opacity: 0.7;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
          </div>

          <!-- Risk Level Banner -->
          <div class="mb-4 py-2 px-3 rounded ${
            s.risk === 'Danger - Avoid' ? 'bg-red-100 text-red-700' :
            s.risk === 'Take caution' ? 'bg-yellow-100 text-yellow-700' :
            s.risk === 'Calm - All clear' ? 'bg-blue-100 text-blue-700' :
            'bg-green-100 text-green-700'
          }">
            <div class="font-medium">${escapeHtml(s.risk)}</div>
            <div class="text-sm">${escapeHtml(s.species)} ‚Ä¢ ${s.reports.length} report${s.reports.length === 1 ? '' : 's'} ‚Ä¢ ${s.safePassageCount || 0} safe passage${(s.safePassageCount || 0) === 1 ? '' : 's'}</div>
          </div>

          <!-- Tabs -->
          <div style="border-bottom: 1px solid #d4cac7;">
            <nav class="flex -mb-px" role="tablist">
              <button data-tab="main" role="tab" class="tab-btn active mr-4 py-2 px-1 border-b-2 font-medium" style="border-color: #422d1e; color: #422d1e;">
                Main Info
              </button>
              <button data-tab="feed" role="tab" class="tab-btn mr-4 py-2 px-1 border-b-2 border-transparent" style="color: #422d1e; opacity: 0.6;" onmouseover="this.style.opacity='0.8'" onmouseout="this.classList.contains('active') || (this.style.opacity='0.6')">
                Reports Feed
              </button>
              <button data-tab="add" role="tab" class="tab-btn py-2 px-1 border-b-2 border-transparent" style="color: #422d1e; opacity: 0.6;" onmouseover="this.style.opacity='0.8'" onmouseout="this.classList.contains('active') || (this.style.opacity='0.6')">
                Add Report
              </button>
            </nav>
          </div>

          <!-- Tab Content -->
          <div class="mt-4">
            <!-- Main Info Tab -->
            <div id="mainTab" class="tab-content active" role="tabpanel">
              <div class="space-y-4">
                <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
                  <div class="flex items-start gap-4 mb-3">
                    <div class="flex-shrink-0">
                      ${getBirdIconSVG(s.risk)}
                    </div>
                    <div class="flex-1">
                      <h3 class="font-medium mb-1" style="color: #422d1e;">Location Details</h3>
                      <div class="text-sm space-y-2" style="color: #422d1e;">
                        <div><span style="opacity: 0.7;">Address:</span> ${s.address ? escapeHtml(s.address) : `${s.lat.toFixed(6)}, ${s.lng.toFixed(6)}`}</div>
                        <div><span style="opacity: 0.7;">Bird Species:</span> ${escapeHtml(s.species)}</div>
                        <div><span style="opacity: 0.7;">Total Reports:</span> ${s.reports.length}</div>
                        ${s.created_by_name ? `<div><span style="opacity: 0.7;">Created by:</span> ${escapeHtml(s.created_by_name)}</div>` : ''}
                      </div>
                    </div>
                  </div>
                </div>

                <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
                  <h3 class="font-medium mb-3" style="color: #422d1e;">Latest Report</h3>
                  <div id="latestReport" class="rounded p-3" style="background-color: #f2eceb; border: 1px solid #d4cac7;">
                    ${s.reports.length > 0 ? renderLatestReport(s.reports[s.reports.length - 1]) : '<p style="color: #422d1e; opacity: 0.7;">No reports yet</p>'}
                  </div>
                </div>

                <div class="mt-4 text-center">
                  <button class="text-white px-4 py-2 rounded add-report-btn" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                    Add New Report
                  </button>
                </div>
              </div>
            </div>

            <!-- Reports Feed Tab -->
            <div id="feedTab" class="tab-content hidden" role="tabpanel">
              <div class="space-y-3 max-h-[calc(100vh-300px)] overflow-y-auto">
                ${renderReportsFeedContent(s)}
              </div>
            </div>

            <!-- Add Report Tab -->
            <div id="addTab" class="tab-content hidden" role="tabpanel">
              <div class="rounded-lg p-4" style="background-color: #e8e2e1;">
                <div class="mb-4 flex gap-3">
                  <button type="button" id="noBirdBtn" class="flex-1 px-4 py-2 rounded" style="background-color: #e8e2e1; color: #422d1e; border: 1px solid #d4cac7;" onmouseover="this.style.backgroundColor='#dcd6d5'" onmouseout="this.style.backgroundColor='#e8e2e1'">
                    No Birds Spotted
                  </button>
                  <button type="button" id="addReportBtn" class="flex-1 px-4 py-2 text-white rounded" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                    Report Bird Activity
                  </button>
                </div>

                <form id="reportForm" class="hidden space-y-4">
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Bird Behaviour <span class="text-red-500">*</span></label>
                    <div class="relative">
                      <div id="rbirdBox2" class="tag-box"></div>
                      <div id="rbirdList2" class="tag-list"></div>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Human Behaviour <span class="text-red-500">*</span></label>
                    <div class="relative">
                      <div id="rhumanBox2" class="tag-box"></div>
                      <div id="rhumanList2" class="tag-list"></div>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Precautions <span class="text-red-500">*</span></label>
                    <div class="relative">
                      <div id="rprecBox2" class="tag-box"></div>
                      <div id="rprecList2" class="tag-list"></div>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Alert Level (auto-set)</label>
                    <input type="text" id="repAlertLevel" class="w-full rounded p-2" style="border: 1px solid #d4cac7; background-color: #e8e2e1; color: #422d1e;" readonly>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: #422d1e;">Extra Notes</label>
                    <textarea id="repExtra" class="w-full rounded p-2 h-20" style="border: 1px solid #d4cac7; background-color: #f2eceb; color: #422d1e;"></textarea>
                  </div>
                  <div class="flex justify-end gap-2">
                    <button type="button" id="reportCancel" class="px-4 py-2 rounded" style="border: 1px solid #d4cac7; color: #422d1e;" onmouseover="this.style.backgroundColor='#e8e2e1'" onmouseout="this.style.backgroundColor='transparent'">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-white rounded" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Submit Report</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    // Set up event handlers after the modal content is created
    detailsModal.querySelector('#closeDetails').addEventListener('click', () => {
      detailsModal.classList.add('hidden');
      activeDetailsSpotId = null;
    });

    // Tab switching
    detailsModal.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        switchTab(btn.dataset.tab);
      });
    });

    // Add report buttons
    detailsModal.querySelectorAll('.add-report-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        switchTab('add');
      });
    });

    // No bird button
    detailsModal.querySelector('#noBirdBtn').addEventListener('click', () => {
      // Just increment the safe passage counter
      if (!s.safePassageCount) s.safePassageCount = 0;
      s.safePassageCount++;
      s.lastSafePassage = new Date().toISOString();
      
      saveAll();
      
      // Increment user's safe passage count in profile
      incrementUserSafePassages();
      
      // Close the details modal
      detailsModal.classList.add('hidden');
      
      // Show success modal for safe passage
      showSafePassageModal(s.name, s.risk);
    });

    // Report form handling
    const addReportBtn = detailsModal.querySelector('#addReportBtn');
    const reportForm = detailsModal.querySelector('#reportForm');
    
    addReportBtn.addEventListener('click', () => {
      reportForm.classList.remove('hidden');
      addReportBtn.classList.add('hidden');
      detailsModal.querySelector('#noBirdBtn').classList.add('hidden');
      
      // Get the tag UI elements
      const rbirdBox2 = detailsModal.querySelector('#rbirdBox2');
      const rbirdList2 = detailsModal.querySelector('#rbirdList2');
      const rhumanBox2 = detailsModal.querySelector('#rhumanBox2');
      const rhumanList2 = detailsModal.querySelector('#rhumanList2');
      const rprecBox2 = detailsModal.querySelector('#rprecBox2');
      const rprecList2 = detailsModal.querySelector('#rprecList2');
      const repAlertLevel = detailsModal.querySelector('#repAlertLevel');
      
      // Reset and set up tag UIs
      selectedReportBird = [];
      selectedReportHuman = [];
      selectedReportPrec = [];
      
      setupTagUI(rbirdBox2, rbirdList2, BIRD_BEHAVIOURS, selectedReportBird, () => {
        repAlertLevel.value = computeAlertFromBirds(selectedReportBird);
      });
      setupTagUI(rhumanBox2, rhumanList2, HUMAN_BEHAVIOURS, selectedReportHuman, ()=>{});
      setupTagUI(rprecBox2, rprecList2, PRECAUTIONS, selectedReportPrec, ()=>{});
      
      repAlertLevel.value = 'Low risk';
    });

    const reportCancel = detailsModal.querySelector('#reportCancel');
    reportCancel.addEventListener('click', () => {
      reportForm.classList.add('hidden');
      addReportBtn.classList.remove('hidden');
      detailsModal.querySelector('#noBirdBtn').classList.remove('hidden');
      
      // Reset form and tag arrays
      selectedReportBird = [];
      selectedReportHuman = [];
      selectedReportPrec = [];
      
      const repExtra = detailsModal.querySelector('#repExtra');
      const repAlertLevel = detailsModal.querySelector('#repAlertLevel');
      
      if (repExtra) repExtra.value = '';
      if (repAlertLevel) repAlertLevel.value = 'Low risk';
    });

    // Set up tag UIs - Note: these are set up when the "Report Bird Activity" button is clicked
    // to ensure they use the correct DOM elements from the modal

    // Show modal
    detailsModal.classList.remove('hidden');
    document.body.classList.add('modal-open');

    // Set up form submission
    reportForm.addEventListener('submit', handleAddReport);
  }

  function renderLatestReport(report) {
    if (!report) return '<p class="text-gray-500">No reports yet</p>';
    
    const level = report.alertLevel || computeAlertFromBirds(report.birdBehaviour || []);
    const levelClass = level === 'Danger - Avoid' ? 'text-red-600' : 
                      level === 'Take caution' ? 'text-yellow-600' : 
                      'text-green-600';
    
    return `
      <div class="space-y-2">
        <div class="font-medium ${levelClass}">${escapeHtml(level)}</div>
        <div class="text-sm text-gray-600">
          ${new Date(report.timestamp).toLocaleString()}
          ${report.created_by_name ? ` ‚Ä¢ Reported by ${escapeHtml(report.created_by_name)}` : ''}
        </div>
        <div class="text-sm"><b>Bird behavior:</b> ${escapeHtml((report.birdBehaviour||[]).join(', '))}</div>
        <div class="text-sm"><b>Human activity:</b> ${escapeHtml((report.humanBehaviour||[]).join(', '))}</div>
        <div class="text-sm"><b>Precautions:</b> ${escapeHtml((report.precautions||[]).join(', '))}</div>
        ${report.extra ? `<div class="text-sm mt-1"><b>Notes:</b> ${escapeHtml(report.extra)}</div>` : ''}
      </div>
    `;
  }

  function renderReportsFeedContent(spot) {
    if (!spot.reports || spot.reports.length === 0) {
      return `
        <div class="text-center py-8 text-gray-500">
          No reports yet. Be the first to report bird activity at this location!
        </div>
        <div class="mt-4 text-center">
          <button class="text-white px-4 py-2 rounded add-report-btn" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
            Add Report
          </button>
        </div>
      `;
    }

    return `
      <div class="space-y-4">
        ${spot.reports.slice().reverse().map(report => {
          const level = report.alertLevel || computeAlertFromBirds(report.birdBehaviour || []);
          const cls = level === 'Danger - Avoid' ? 'border-red-500' : 
                     level === 'Take caution' ? 'border-yellow-500' : 
                     'border-green-500';
          const textColor = level === 'Danger - Avoid' ? 'text-red-600' : 
                           level === 'Take caution' ? 'text-yellow-600' : 
                           'text-green-600';

          return `
            <div class="p-3 rounded bg-white border-l-4 shadow-sm ${cls}">
              <div class="flex justify-between items-start mb-2">
                <div class="font-medium ${textColor}">${escapeHtml(level)}</div>
                <div class="text-xs text-gray-500">
                  ${new Date(report.timestamp).toLocaleString()}
                  ${report.created_by_name ? `<br>by ${escapeHtml(report.created_by_name)}` : ''}
                </div>
              </div>
              <div class="space-y-2">
                <div class="text-sm">
                  <span class="font-medium">Bird Activity:</span> 
                  ${escapeHtml((report.birdBehaviour||[]).join(', ')||'N/A')}
                </div>
                <div class="text-sm">
                  <span class="font-medium">Human Activity:</span> 
                  ${escapeHtml((report.humanBehaviour||[]).join(', ')||'N/A')}
                </div>
                <div class="text-sm">
                  <span class="font-medium">Precautions:</span> 
                  ${escapeHtml((report.precautions||[]).join(', ')||'None')}
                </div>
                ${report.extra ? `
                  <div class="text-sm pt-1 border-t">
                    <span class="font-medium">Notes:</span><br>
                    ${escapeHtml(report.extra)}
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }).join('')}
      </div>
      <div class="mt-4 text-center">
        <button class="text-white px-4 py-2 rounded add-report-btn" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
          Add New Report
        </button>
      </div>
    `;
  }

  function switchTab(tabId) {
    const tabButtons = detailsModal.querySelectorAll('.tab-btn');
    const tabContents = detailsModal.querySelectorAll('.tab-content');

    // Update all tab buttons with inline styles
    tabButtons.forEach(btn => {
      if (btn.dataset.tab === tabId) {
        btn.classList.add('active');
        btn.style.borderColor = '#422d1e';
        btn.style.color = '#422d1e';
        btn.style.opacity = '1';
      } else {
        btn.classList.remove('active');
        btn.style.borderColor = 'transparent';
        btn.style.color = '#422d1e';
        btn.style.opacity = '0.6';
      }
    });

    // Update all tab contents
    tabContents.forEach(content => {
      if (content.id === `${tabId}Tab`) {
        content.classList.add('active');
        content.classList.remove('hidden');
      } else {
        content.classList.remove('active');
        content.classList.add('hidden');
      }
    });
  }

  // ----------------------------
  // Create spot modal flow controls
  // ----------------------------
  openAddBtn.addEventListener('click', (e)=>{
    e.stopPropagation(); // Prevent click from propagating to map
    openCreateSpotModal();
  });

  // Add event listener for the button below the map
  const addSpotBelowMap = document.getElementById('addSpotBelowMap');
  addSpotBelowMap.addEventListener('click', ()=>{
    openCreateSpotModal();
  });

  function openCreateSpotModal(){
    // Check if user is logged in
    if (!currentUser) {
      toast('Please sign in to create spots', 2000);
      authModal.classList.remove('hidden');
      return;
    }
    
    // reset all form fields and state
    selectedLocation = null;
    if(tempMarker) try{ map.removeLayer(tempMarker); } catch(e){}
    tempMarker = null;
    
    // Show modal
    spotModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
    
    // Set default location to map center
    const center = map.getCenter();
    selectedLocation = { lat: center.lat, lng: center.lng };
    coordsField.value = `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
    addressInfo.textContent = 'Using map center. Click the map to change location or enter an address.';
    tempMarker = L.marker([selectedLocation.lat, selectedLocation.lng]).addTo(map);
    
    // Reset all form fields
    birdSpecies.value = 'Magpie';
    addressField.value = '';
    selectedRBird = []; 
    selectedRHuman = []; 
    selectedRPrec = [];
    reextra.value = '';
    ralertLevel.value = 'Low risk';
    
    // Clear any suggestion lists
    const addressSuggestions = document.getElementById('addressField_suggestions');
    if(addressSuggestions) addressSuggestions.innerHTML = '';
    
    // Reset tag UIs
    setupTagUI(rbirdBox, rbirdList, BIRD_BEHAVIOURS, selectedRBird, updateRAlertFromBirds);
    setupTagUI(rhumanBox, rhumanList, HUMAN_BEHAVIOURS, selectedRHuman, ()=>{});
    setupTagUI(rprecBox, rprecList, PRECAUTIONS, selectedRPrec, ()=>{});
    
    // Capture clean state for dirty checking
    initialFormState = captureSpotFormState();
  }

  // Close button in the modal header
  closeSpotModal.addEventListener('click', ()=> {
    spotModal.classList.add('hidden');
    closeSpotModalImmediate();
  });

  // Cancel button in the form
  spotCancel.addEventListener('click', ()=> {
    spotModal.classList.add('hidden');
    closeSpotModalImmediate();
  });

  function closeSpotModalImmediate(){
    // Hide the modal
    spotModal.classList.add('hidden');
    document.body.classList.remove('modal-open');
    
    // Clean up map
    if(tempMarker) {
      try { 
        map.removeLayer(tempMarker); 
      } catch(e){}
      tempMarker = null;
    }
    
    // Reset state
    selectedLocation = null;
    selectedRBird = [];
    selectedRHuman = [];
    selectedRPrec = [];
    
    // Clear any suggestion lists
    const addressSuggestions = document.getElementById('addressField_suggestions');
    if(addressSuggestions) addressSuggestions.innerHTML = '';
    
    // Reset form fields
    birdSpecies.value = 'Magpie';
    addressField.value = '';
    coordsField.value = '';
    addressInfo.textContent = '';
    reextra.value = '';
    ralertLevel.value = 'Low risk';
    
    // Reset tag UIs
    setupTagUI(rbirdBox, rbirdList, BIRD_BEHAVIOURS, selectedRBird, updateRAlertFromBirds);
    setupTagUI(rhumanBox, rhumanList, HUMAN_BEHAVIOURS, selectedRHuman, ()=>{});
    setupTagUI(rprecBox, rprecList, PRECAUTIONS, selectedRPrec, ()=>{});
  }

  function captureSpotFormState(){
    return {
      species: birdSpecies.value||'',
      addr: addressField.value||'',
      coords: coordsField.value||'',
      rbird: selectedRBird.slice(),
      rhuman: selectedRHuman.slice(),
      rprec: selectedRPrec.slice(),
      ralert: ralertLevel.value||'',
      extra: reextra.value||''
    };
  }
  function spotFormIsDirty(){ return JSON.stringify(captureSpotFormState()) !== JSON.stringify(initialFormState); }

  // Set up address auto-complete
  addressField.addEventListener('input', () => {
    debouncedAddressLookup(addressField);
  });

  // geo locate - Find Me button
  geoBtn.addEventListener('click', ()=>{
    if(!navigator.geolocation) {
      toast('Geolocation is not supported by your browser');
      addressInfo.textContent = 'Geolocation not supported';
      return;
    }
    
    // Show loading state
    addressInfo.textContent = 'Getting your location...';
    
    navigator.geolocation.getCurrentPosition(
      // Success callback
      p => {
        selectedLocation = { lat: p.coords.latitude, lng: p.coords.longitude };
        coordsField.value = `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
        addressInfo.textContent = 'Located device coordinates successfully';
        if(tempMarker) try{ map.removeLayer(tempMarker); } catch(e){}
        tempMarker = L.marker([selectedLocation.lat, selectedLocation.lng]).addTo(map);
        map.setView([selectedLocation.lat, selectedLocation.lng], 16);
      }, 
      // Error callback
      err => {
        console.error('Geolocation error:', err);
        let errorMsg = '';
        
        switch(err.code) {
          case err.PERMISSION_DENIED:
            errorMsg = 'Location permission denied. Please enable location access in your browser settings.';
            break;
          case err.POSITION_UNAVAILABLE:
            errorMsg = 'Location information unavailable. Please check your device settings.';
            break;
          case err.TIMEOUT:
            errorMsg = 'Location request timed out. Please try again.';
            break;
          default:
            errorMsg = err.message || 'Unknown error occurred';
        }
        
        addressInfo.textContent = errorMsg;
        toast('GPS error: ' + errorMsg, 4000);
      },
      // Options
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  });

  // submit create spot
  spotForm.addEventListener('submit', handleCreateSpotFromForm);

  // ----------------------------
  // Save + load helpers (use createSpotFromData to add)
  // ----------------------------
  function createSpotFromUIObject(obj){
    // convert UI object to spot data and call createSpotFromData
    createSpotFromData(obj, false);
    saveAll();
    renderAlerts();
  }

  // ----------------------------
  // Render alerts list (1km from map center)
  // ----------------------------
  function renderAlerts(){
    alertsList.innerHTML = '';
    const center = map.getCenter();
    spots.forEach(s=>{
      const d = metersBetween(center.lat, center.lng, s.lat, s.lng);
      if(d <= 1000){
        const item = document.createElement('div');
        // Color code based on risk level
        const borderColor = s.risk === 'Danger - Avoid' ? 'border-red-400 bg-red-50' : 
                          s.risk === 'Take caution' ? 'border-yellow-400 bg-yellow-50' : 
                          s.risk === 'Calm - All clear' ? 'border-blue-400 bg-blue-50' :
                          'border-green-400 bg-green-50';
        const textColor = s.risk === 'Danger - Avoid' ? 'text-red-700' : 
                         s.risk === 'Take caution' ? 'text-yellow-700' : 
                         s.risk === 'Calm - All clear' ? 'text-blue-700' :
                         'text-green-700';
        
        item.className = `border-2 p-2 rounded text-sm cursor-pointer hover:opacity-90 flex justify-between items-center ${borderColor}`;
        item.innerHTML = `
          <div>
            <b>${escapeHtml(s.name)}</b>
            <div class="text-xs text-gray-600">${escapeHtml(s.species)}</div>
            <div class="text-xs font-medium ${textColor}">${escapeHtml(s.risk)}</div>
          </div>
          <div class="text-xs text-gray-500">${(d/1000).toFixed(2)} km</div>
        `;
        item.addEventListener('click', ()=> {
          map.setView([s.lat, s.lng], 16);
          showSpotQuickAlert(s);
        });
        alertsList.appendChild(item);
      }
    });
    
    // Update stats whenever alerts are rendered
    if (typeof renderStats === 'function') {
      renderStats(currentStatsPeriod);
    }
  }
  map.on('moveend', ()=> renderAlerts());

  // ----------------------------
  // Stats calculation and rendering
  // ----------------------------
  let currentStatsPeriod = 'today'; // 'today', 'week', 'season'
  
  function calculateStats(period = 'today') {
    const now = getCurrentDate();
    const stats = {
      totalReports: 0,
      safePassages: 0,
      injuries: 0,
      species: {}
    };
    
    // Define time boundaries
    let startDate;
    if (period === 'today') {
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    } else if (period === 'week') {
      startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    } else if (period === 'season') {
      // Current swooping season (August to November for most birds)
      const currentMonth = now.getMonth() + 1;
      if (currentMonth >= 8) {
        startDate = new Date(now.getFullYear(), 7, 1); // August 1st this year
      } else {
        startDate = new Date(now.getFullYear() - 1, 7, 1); // August 1st last year
      }
    }
    
    // Count reports and analyze each spot
    spots.forEach(spot => {
      if (!spot.reports) return;
      
      // Count safe passages for this spot
      if (spot.lastSafePassage) {
        const safePassageDate = new Date(spot.lastSafePassage);
        if (safePassageDate >= startDate) {
          stats.safePassages += (spot.safePassageCount || 0);
        }
      }
      
      // Analyze reports
      spot.reports.forEach(report => {
        const reportDate = new Date(report.timestamp);
        if (reportDate >= startDate) {
          // Count total reports
          stats.totalReports++;
          
          // Count by species
          if (spot.species) {
            if (!stats.species[spot.species]) {
              stats.species[spot.species] = 0;
            }
            stats.species[spot.species]++;
          }
          
          // Count injuries
          if (report.birdBehaviour && 
              report.birdBehaviour.includes('made contact + injured')) {
            stats.injuries++;
          }
        }
      });
    });
    
    return stats;
  }
  
  function renderStats(period = 'today') {
    const stats = calculateStats(period);
    
    // Update totals
    document.getElementById('statTotalReports').textContent = stats.totalReports;
    document.getElementById('statSafePassages').textContent = stats.safePassages;
    document.getElementById('statInjuries').textContent = stats.injuries;
    
    // Update species breakdown
    const speciesBreakdown = document.getElementById('statSpeciesBreakdown');
    speciesBreakdown.innerHTML = '';
    
    if (Object.keys(stats.species).length === 0) {
      speciesBreakdown.innerHTML = '<div style="color: #422d1e; opacity: 0.6;">No reports yet</div>';
    } else {
      // Sort species by count (descending)
      const sortedSpecies = Object.entries(stats.species)
        .sort((a, b) => b[1] - a[1]);
      
      sortedSpecies.forEach(([species, count]) => {
        const row = document.createElement('div');
        row.className = 'flex justify-between items-center';
        row.innerHTML = `
          <span style="color: #422d1e;">${escapeHtml(species)}</span>
          <span class="font-bold" style="color: #422d1e;">${count}</span>
        `;
        speciesBreakdown.appendChild(row);
      });
    }
  }
  
  // Setup stats period tabs
  document.addEventListener('DOMContentLoaded', () => {
    const periodTabs = document.querySelectorAll('.stats-period-tab');
    periodTabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        const period = e.target.dataset.period;
        currentStatsPeriod = period;
        
        // Update tab styles
        periodTabs.forEach(t => {
          if (t.dataset.period === period) {
            t.style.backgroundColor = '#422d1e';
            t.style.color = 'white';
            t.style.border = 'none';
            t.classList.add('active');
          } else {
            t.style.backgroundColor = 'transparent';
            t.style.color = '#422d1e';
            t.style.border = '1px solid #d4cac7';
            t.classList.remove('active');
          }
        });
        
        // Re-render stats
        renderStats(period);
      });
    });
    
    // Initial render
    renderStats('today');
  });

  // ----------------------------
  // Open / close details modal
  // ----------------------------
  closeDetails.addEventListener('click', ()=> {
    detailsModal.classList.add('hidden');
    document.body.classList.remove('modal-open');
    activeDetailsSpotId = null;
    // cleanup UI arrays
    selectedReportBird = []; selectedReportHuman = []; selectedReportPrec = [];
    
    // If there are still spots to address in the exit prompt, show it again
    if(spotsToAddress.length > 0) {
      exitPromptModal.classList.remove('hidden');
      document.body.classList.add('modal-open');
    } else if (exitPromptModal && !exitPromptModal.classList.contains('hidden')) {
      // If all spots are addressed and the exit prompt was open, close it with a thank you message
      exitPromptModal.classList.add('hidden');
      document.body.classList.remove('modal-open');
      toast('All spots addressed! Thank you for your feedback.', 2000);
    }
  });

  // report form handlers
  function handleAddReport(e) {
    e.preventDefault();
    if(!activeDetailsSpotId) return;
    
    const s = spots.find(x => x.id === activeDetailsSpotId);
    if(!s) return;
    
    // Validate required fields
    if(selectedReportBird.length === 0 || selectedReportHuman.length === 0 || selectedReportPrec.length === 0) {
      toast('Please complete all required fields');
      return;
    }
    
    // Get repExtra from the modal (not the static DOM reference)
    const repExtraField = detailsModal.querySelector('#repExtra');
    
    // Create new report
    const rep = {
      id: uid(),
      timestamp: new Date().toISOString(),
      birdBehaviour: selectedReportBird.slice(),
      humanBehaviour: selectedReportHuman.slice(),
      precautions: selectedReportPrec.slice(),
      extra: repExtraField ? repExtraField.value.trim() : '',
      alertLevel: computeAlertFromBirds(selectedReportBird),
      user_id: currentUser?.id || null,
      created_by_name: currentUser ? (userProfile?.display_name || currentUser.email.split('@')[0]) : 'Anonymous'
    };
    
    // Add report to spot
    s.reports.push(rep);
    
    // Recompute overall spot risk
    const newRisk = computeSpotRiskFromReports(s.reports, s.species);
    const oldIsPreseason = s.isPreseason;
    const riskChanged = newRisk !== s.risk;
    
    // Update spot risk
    s.risk = newRisk;
    
    // Clear isPreseason flag if spot is no longer calm (new activity reported)
    if (newRisk !== 'Calm - All clear') {
      console.log(`üîß Clearing isPreseason flag for ${s.name} (risk changed to ${newRisk})`);
      s.isPreseason = false;
    }
    
    // Update marker if risk changed OR if isPreseason flag changed
    const preseasonChanged = oldIsPreseason !== s.isPreseason;
    if (riskChanged || preseasonChanged) {
      console.log(`üé® Updating marker for ${s.name}: risk=${newRisk}, isPreseason=${s.isPreseason}, riskChanged=${riskChanged}, preseasonChanged=${preseasonChanged}`);
      
      // Update marker icon and circle
      try {
        map.removeLayer(s.marker);
        map.removeLayer(s.circle);
      } catch(e){}
      
      s.marker = L.marker([s.lat, s.lng], { icon: getBirdIcon(newRisk, s.isPreseason) }).addTo(map);
      s.marker.on('click', ()=> showSpotQuickAlert(s));
      
      const radius = getRadiusByRisk(newRisk);
      s.radius = radius;
      s.circle = L.circle([s.lat, s.lng], { 
        radius: radius,
        color: newRisk === 'Danger - Avoid' ? '#EF4444' : newRisk === 'Take caution' ? '#F59E0B' : newRisk === 'Calm - All clear' ? '#3b82f6' : '#10B981',
        fillColor: newRisk === 'Danger - Avoid' ? '#FEE2E2' : newRisk === 'Take caution' ? '#FEF3C7' : newRisk === 'Calm - All clear' ? '#dbeafe' : '#DCFCE7',
        fillOpacity: 0.35 
      }).addTo(map);
    }
    
    saveAll(); // Save to localStorage
    saveSpotToSupabase(s); // Sync to Supabase
    
    // Increment user's reports counter
    incrementUserReportsCreated();
    
    // Show success modal with bird behavior context (isNewSpot=false for additional reports)
    showSuccessModal(s.name, s.species, selectedReportBird, false);
    
    // Remove from spots to address if it was in the exit prompt
    spotsToAddress = spotsToAddress.filter(spot => spot.id !== s.id);
    
    // Close the details modal
    detailsModal.classList.add('hidden');
    activeDetailsSpotId = null;
    
    // Clear the report form state
    selectedReportBird = [];
    selectedReportHuman = [];
    selectedReportPrec = [];
  }
  
  reportForm.addEventListener('submit', handleAddReport);
  reportCancel.addEventListener('click', ()=> {
    if(confirm('Cancel new report?')) {
      // Reset form
      selectedReportBird = []; 
      selectedReportHuman = []; 
      selectedReportPrec = [];
      setupTagUI(rbirdBox2, rbirdList2, BIRD_BEHAVIOURS, selectedReportBird, updateRepAlertFromBirds);
      setupTagUI(rhumanBox2, rhumanList2, HUMAN_BEHAVIOURS, selectedReportHuman, ()=>{});
      setupTagUI(rprecBox2, rprecList2, PRECAUTIONS, selectedReportPrec, ()=>{});
      repExtra.value = '';
      repAlertLevel.value = 'Low risk';
      
      // Switch back to main tab
      const mainTab = detailsModal.querySelector('[data-tab="main"]');
      const mainContent = detailsModal.querySelector('#mainTab');
      if(mainTab && mainContent) {
        detailsModal.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'text-blue-500', 'border-blue-500'));
        detailsModal.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        mainTab.classList.add('active', 'text-blue-500', 'border-blue-500');
        mainContent.classList.remove('hidden');
      }
    }
  });

  // ----------------------------
  // checkLocation - shows userMarker and center alert if within any spot
  // ----------------------------
  let currentAlertSpots = []; // Track currently displayed spots
  let visitedSpots = new Set(); // Track spots visited during current journey
  let hasShownCalmFeedback = false; // Track if we've already shown calm feedback this journey
  
  function checkLocation(lat,lng){
    if(userMarker){ try{ userMarker.setLatLng([lat,lng]); } catch(e){} } else { userMarker = L.marker([lat,lng], { icon: getUserIcon() }).addTo(map); }
    
    // Find all spots the user is currently inside
    let insideSpots = [];
    for(const s of spots){
      if(metersBetween(lat,lng,s.lat,s.lng) <= (s.radius || 150)){ 
        insideSpots.push(s);
        visitedSpots.add(s.id); // Track that we've been in this spot
      }
    }
    
    // Filter out calm birds from alerts - they're preventative info, not danger warnings
    // Users can still see them on the map and click for info
    const activeThreats = insideSpots.filter(s => s.risk !== 'Calm - All clear');
    
    // Sort by risk level (highest first) for display
    if(activeThreats.length > 0){
      activeThreats.sort((a,b) => {
        const riskOrder = {'Danger - Avoid': 3, 'Take caution': 2, 'Low risk': 1};
        return (riskOrder[b.risk] || 0) - (riskOrder[a.risk] || 0);
      });
    }
    
    if(activeThreats.length > 0){
      // Check if the spots have changed
      const currentIds = currentAlertSpots.map(s => s.id).sort().join(',');
      const newIds = activeThreats.map(s => s.id).sort().join(',');
      
      if(currentIds !== newIds){
        // New journey starting - reset the calm feedback flag
        hasShownCalmFeedback = false;
        currentAlertSpots = activeThreats;
        showCenteredAlert(activeThreats);
      }
    } else {
      // User has exited ALL active threat zones (calm birds don't count)
      if(currentAlertSpots.length > 0){
        const spotsToReport = Array.from(visitedSpots).map(id => spots.find(s => s.id === id)).filter(Boolean);
        // Filter out calm birds from exit prompt too
        const activeSpotsToReport = spotsToReport.filter(s => s.risk !== 'Calm - All clear');
        currentAlertSpots = [];
        hideCenteredAlert();
        
        // Play happy tone when exiting all zones
        playHappyTone();
        
        // Only show prompt if they visited active threat spots
        if(activeSpotsToReport.length > 0){
          showExitPrompt(activeSpotsToReport);
        }
        
        // Clear visited spots for next journey
        visitedSpots.clear();
        hasShownCalmFeedback = false; // Reset calm feedback flag for next journey
      } else {
        currentAlertSpots = [];
        hideCenteredAlert();
        
        // Check if user just exited a calm spot during/near active season - ask for feedback!
        // Only show once per journey!
        if (!hasShownCalmFeedback) {
          const spotsToReport = Array.from(visitedSpots).map(id => spots.find(s => s.id === id)).filter(Boolean);
          console.log('üîç Spots visited during journey:', spotsToReport.length, spotsToReport.map(s => `${s.name} (${s.risk})`));
          
          const calmSpotsNeedingFeedback = spotsToReport.filter(s => {
            if (s.risk !== 'Calm - All clear') {
              console.log(`‚è≠Ô∏è Skipping ${s.name} - not calm (${s.risk})`);
              return false;
            }
            
            // Check if we're currently in the swooping season OR within first 30 days of season
            const season = SWOOPING_SEASONS[s.species];
            if (!season) {
              console.log(`‚è≠Ô∏è Skipping ${s.name} - no season data for ${s.species}`);
              return false;
            }
            
            const now = getCurrentDate();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();
            
            // Calculate when this season starts
            let seasonStartDate;
            if (currentMonth <= season.end) {
              // Season might be this year
              seasonStartDate = new Date(currentYear, season.start - 1, 1);
            } else {
              // Season is next year
              seasonStartDate = new Date(currentYear + 1, season.start - 1, 1);
            }
            
            // Calculate days until/since season started
            const daysFromSeasonStart = Math.floor((now - seasonStartDate) / (1000 * 60 * 60 * 24));
            
            // Ask for feedback if:
            // 1. We're within 30 days BEFORE season starts (pre-season check), OR
            // 2. We're within first 60 days of the season (early season check)
            const isPreSeason = daysFromSeasonStart >= -30 && daysFromSeasonStart < 0;
            const isEarlySeason = daysFromSeasonStart >= 0 && daysFromSeasonStart <= 60;
            
            console.log(`üê¶ Calm spot feedback check: ${s.name} (${s.species}), days from season start: ${daysFromSeasonStart}, pre-season: ${isPreSeason}, early-season: ${isEarlySeason}`);
            
            return isPreSeason || isEarlySeason;
          });
          
          console.log('üîç Calm spots needing feedback:', calmSpotsNeedingFeedback.length);
          
          if (calmSpotsNeedingFeedback.length > 0) {
            hasShownCalmFeedback = true; // Mark that we've shown it BEFORE calling the function
            console.log('üö´ Setting hasShownCalmFeedback = true to prevent duplicates');
            showCalmSpotFeedbackPrompt(calmSpotsNeedingFeedback);
            
            // Clear visitedSpots immediately to prevent duplicate modals on next GPS update
            console.log('‚úÖ Modal shown - clearing visitedSpots to prevent duplicates');
            visitedSpots.clear();
            return; // Exit early
          } else {
            console.log('‚ùå No calm spots need feedback at this time');
          }
        } else {
          console.log('üö´ hasShownCalmFeedback is already true - skipping check');
          // Clear visited spots since we're not showing a modal and journey is over
          visitedSpots.clear();
        }
        
        // Note: hasShownCalmFeedback flag is NOT reset here!
        // It will be reset only when entering a new zone (starting a new journey)
        // This prevents duplicate modals during the same journey
      }
    }
    renderAlerts();
  }

  // Prompt user after exiting all swoop zones
  let spotsToAddress = []; // Track spots that still need to be addressed
  
  function showExitPrompt(spotsVisited) {
    // Sort by risk level (highest first)
    spotsToAddress = spotsVisited.sort((a,b) => {
      const riskOrder = {'Danger - Avoid': 3, 'Take caution': 2, 'Low risk': 1};
      return (riskOrder[b.risk] || 0) - (riskOrder[a.risk] || 0);
    });
    
    renderExitPromptList();
    exitPromptModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
  }
  
  function renderExitPromptList() {
    exitPromptList.innerHTML = '';
    
    if(spotsToAddress.length === 0) {
      exitPromptList.innerHTML = '<div class="text-center text-gray-500 py-8">All spots addressed! Thank you for your feedback, stay safe!</div>';
      return;
    }
    
    spotsToAddress.forEach(spot => {
      const item = document.createElement('div');
      const borderColor = spot.risk === 'Danger - Avoid' ? 'border-red-400 bg-red-50' : 
                         spot.risk === 'Take caution' ? 'border-yellow-400 bg-yellow-50' : 
                         'border-green-400 bg-green-50';
      const textColor = spot.risk === 'Danger - Avoid' ? 'text-red-700' : 
                       spot.risk === 'Take caution' ? 'text-yellow-700' : 
                       'text-green-700';
      
      item.className = `border-2 p-3 rounded ${borderColor}`;
      item.innerHTML = `
        <div class="flex justify-between items-start gap-3">
          <div class="flex-1">
            <div class="font-semibold">${escapeHtml(spot.name)}</div>
            <div class="text-sm text-gray-600">${escapeHtml(spot.species)}</div>
            <div class="text-sm font-medium ${textColor}">${escapeHtml(spot.risk)}</div>
          </div>
          <div class="flex flex-col gap-2">
            <button class="safe-passage-btn text-xs px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded whitespace-nowrap" data-spot-id="${spot.id}">
              Safe Passage
            </button>
            <button class="add-report-exit-btn text-xs px-3 py-1.5 text-white rounded whitespace-nowrap" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'" data-spot-id="${spot.id}">
              Add Report
            </button>
          </div>
        </div>
      `;
      
      exitPromptList.appendChild(item);
    });
    
    // Attach event handlers
    exitPromptList.querySelectorAll('.safe-passage-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const spotId = e.target.dataset.spotId;
        handleSafePassageFromExit(spotId);
      });
    });
    
    exitPromptList.querySelectorAll('.add-report-exit-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const spotId = e.target.dataset.spotId;
        handleAddReportFromExit(spotId);
      });
    });
  }
  
  function handleSafePassageFromExit(spotId) {
    const spot = spots.find(s => s.id === spotId);
    if(!spot) return;
    
    // Increment safe passage count
    if (!spot.safePassageCount) spot.safePassageCount = 0;
    spot.safePassageCount++;
    spot.lastSafePassage = new Date().toISOString();
    saveAll();
    
    // Increment user's safe passage count in profile
    incrementUserSafePassages();
    
    // Remove from spots to address
    spotsToAddress = spotsToAddress.filter(s => s.id !== spotId);
    
    // If all spots addressed, close the exit prompt modal
    if (spotsToAddress.length === 0) {
      exitPromptModal.classList.add('hidden');
      document.body.classList.remove('modal-open');
      toast('All spots addressed! Thank you for your feedback.', 2000);
    } else {
      // Re-render the list
      renderExitPromptList();
    }
    
    // Show success modal for safe passage
    showSafePassageModal(spot.name, spot.risk);
  }
  
  function handleAddReportFromExit(spotId) {
    // Remove from spots to address
    spotsToAddress = spotsToAddress.filter(s => s.id !== spotId);
    
    // Close the exit prompt modal
    exitPromptModal.classList.add('hidden');
    
    // Open the details modal for this spot
    openDetailsModal(spotId);
    switchTab('add');
  }
  
  // Close exit prompt modal
  closeExitPrompt.addEventListener('click', () => {
    if(spotsToAddress.length > 0) {
      if(confirm(`You haven't addressed ${spotsToAddress.length} spot${spotsToAddress.length === 1 ? '' : 's'}. Close anyway?`)) {
        exitPromptModal.classList.add('hidden');
        document.body.classList.remove('modal-open');
        spotsToAddress = [];
      }
    } else {
      exitPromptModal.classList.add('hidden');
      document.body.classList.remove('modal-open');
      spotsToAddress = [];
    }
  });

  // Show feedback prompt when user exits a calm spot during active swooping season
  function showCalmSpotFeedbackPrompt(calmSpots) {
    if (!calmSpots || calmSpots.length === 0) return;
    
    console.log('üê¶ showCalmSpotFeedbackPrompt called with', calmSpots.length, 'spots');
    
    // For now, just handle the first calm spot (can be extended for multiple later)
    const spot = calmSpots[0];
    
    // Get the last report year to show in the message
    const lastReportDate = spot.reports && spot.reports.length > 0 
      ? new Date(Math.max(...spot.reports.map(r => new Date(r.timestamp))))
      : null;
    const lastYear = lastReportDate ? lastReportDate.getFullYear() : 'last year';
    
    // Determine if we're pre-season or in-season
    const season = SWOOPING_SEASONS[spot.species];
    const now = getCurrentDate();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;
    
    let seasonStartDate;
    if (currentMonth <= (season?.end || 12)) {
      seasonStartDate = new Date(currentYear, (season?.start || 8) - 1, 1);
    } else {
      seasonStartDate = new Date(currentYear + 1, (season?.start || 8) - 1, 1);
    }
    
    const daysFromSeasonStart = Math.floor((now - seasonStartDate) / (1000 * 60 * 60 * 24));
    const isPreSeason = daysFromSeasonStart < 0;
    
    // Customize message based on timing
    let seasonMessage;
    if (isPreSeason) {
      const daysUntilSeason = Math.abs(daysFromSeasonStart);
      seasonMessage = `This bird's nesting season begins in ${daysUntilSeason} day${daysUntilSeason === 1 ? '' : 's'} - have you noticed any activity?`;
    } else {
      seasonMessage = `This bird's nesting season has just begun - did you spot this bird today?`;
    }
    
    console.log('üìÖ Feedback prompt:', seasonMessage);
    
    // Create a custom modal for this feedback
    const feedbackModal = document.createElement('div');
    feedbackModal.id = 'calmSpotFeedbackModal';
    feedbackModal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
    feedbackModal.style.cssText = 'background-color: rgba(66, 45, 30, 0.5);';
    
    feedbackModal.innerHTML = `
      <div class="rounded-lg shadow-xl max-w-md w-full p-6" style="background-color: #f2eceb;">
        <div class="flex items-start gap-3 mb-4">
          <div class="flex-shrink-0">
            ${getBirdIconSVG('Calm - All clear')}
          </div>
          <div class="flex-1">
            <h3 class="font-bold text-lg mb-1" style="color: #422d1e;">Bird Spotted?</h3>
            <p class="text-sm" style="color: #422d1e;">
              In ${lastYear}, a <span class="font-semibold" style="color: #2563eb;">${escapeHtml(spot.species)}</span> 
              was reported at <span class="font-semibold">${escapeHtml(spot.name)}</span>.
              <br><br>
              ${seasonMessage}
            </p>
          </div>
        </div>
        
        <div class="flex flex-col gap-2">
          <button data-action="yes" class="calm-feedback-btn w-full px-4 py-3 rounded font-medium text-white" style="background-color: #422d1e;">
            Yes, I saw the bird - Add Report
          </button>
          <button data-action="no" class="calm-feedback-btn w-full px-4 py-3 rounded font-medium" style="background-color: #10B981; color: white;">
            No, the bird wasn't there
          </button>
          <button data-action="skip" class="calm-feedback-btn w-full px-4 py-2 rounded text-sm" style="color: #422d1e; opacity: 0.7;">
            Skip
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(feedbackModal);
    document.body.classList.add('modal-open');
    
    console.log('‚úÖ Feedback modal added to DOM');
    console.log('üìç Modal element:', feedbackModal);
    console.log('üìç Modal in body:', document.getElementById('calmSpotFeedbackModal'));
    console.log('üìç Body has modal-open class:', document.body.classList.contains('modal-open'));
    
    // Direct button click handlers for Safari compatibility
    feedbackModal.querySelectorAll('.calm-feedback-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        
        const action = btn.getAttribute('data-action');
        console.log('üîò Button clicked, action:', action);
        
        // Reset the flag so user can be prompted again on next visit
        hasShownCalmFeedback = false;
        console.log('üîÑ Reset hasShownCalmFeedback flag for next journey');
        
        if (action === 'yes') {
          console.log('‚úÖ Yes - opening details modal');
          feedbackModal.remove();
          document.body.classList.remove('modal-open');
          openDetailsModal(spot.id);
          setTimeout(() => {
            const addTab = detailsModal.querySelector('[data-tab="add"]');
            if (addTab) addTab.click();
          }, 100);
        } else if (action === 'no') {
          console.log('‚úÖ No - recording safe passage');
          if (!spot.safePassageCount) spot.safePassageCount = 0;
          spot.safePassageCount++;
          spot.lastSafePassage = new Date().toISOString();
          
          saveAll();
          incrementUserSafePassages();
          
          feedbackModal.remove();
          document.body.classList.remove('modal-open');
          console.log('‚úÖ Modal removed, modal-open class removed');
          toast(`Thanks! Recorded safe passage at ${spot.name}`, 2000);
        } else if (action === 'skip') {
          console.log('‚úÖ Skip - closing modal');
          feedbackModal.remove();
          document.body.classList.remove('modal-open');
          console.log('‚úÖ Modal removed, modal-open class removed');
        }
      });
    });
    
    // Overlay click to close
    feedbackModal.addEventListener('click', (e) => {
      // If clicking directly on the overlay (not bubbled from content), close it
      if (e.target === feedbackModal) {
        console.log('üîò Overlay clicked - closing modal');
        feedbackModal.remove();
        document.body.classList.remove('modal-open');
      }
    });
  }

  // Show pre-season warning alert with preventative tips
  function showPreseasonAlert(s) {
    const seasonStartMonth = getSeasonStartMonth(s.species);
    const preventativeTips = PREVENTATIVE_TIPS[s.species] || PREVENTATIVE_TIPS.general;
    
    // Build preventative tips list
    let tipsHTML = preventativeTips.slice(0, 5).map(tip => 
      `<li class="text-xs text-gray-700">${escapeHtml(tip)}</li>`
    ).join('');
    
    alertBox.innerHTML = `
      <div class="flex flex-col gap-3">
        <div class="flex items-start justify-between gap-2">
          <div class="text-sm font-semibold" style="color: #422d1e;">
            <img src="Assets/Icons/calm.svg" alt="Calm" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: 4px;">
            Pre-Season Notice
          </div>
          <button id="closeAlertBtn" class="text-xl" style="color: #422d1e; opacity: 0.7;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
        </div>
        
        <div class="text-sm" style="color: #422d1e;">
          There was a nesting <span class="font-semibold" style="color: #2563eb">${escapeHtml(s.species)}</span> here last year - <span class="font-semibold" style="color: #2563eb">${escapeHtml(s.name)}</span>. 
          <br><br>
          Use caution over the coming weeks as nesting season begins in <span class="font-semibold">${seasonStartMonth}</span>.
        </div>
        
        <div class="border-t pt-2" style="border-color: #d4cac7;">
          <div class="text-xs font-semibold mb-2" style="color: #422d1e;">
            Build rapport with local birds:
          </div>
          <ul class="list-disc pl-5 space-y-1">
            ${tipsHTML}
          </ul>
        </div>
        
        <div class="flex gap-2">
          <button id="morePreventativeTipsBtn" class="text-xs text-white rounded px-4 py-2 flex-1" style="background-color: #059669;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
            <img src="Assets/Icons/tips.svg" alt="Tips" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px; filter: brightness(0) invert(1);">
            More Preventative Tips
          </button>
          <button id="showHistoryBtn" class="text-xs text-white rounded px-4 py-2" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
            View History
          </button>
        </div>
      </div>
    `;
    
    // Use calm color scheme (blue)
    alertBox.classList.remove('risk-danger', 'risk-caution', 'risk-calm', 'risk-low');
    alertBox.classList.add('risk-calm');
    
    alertBox.classList.add('show');
    alertBox.style.display = 'block';
    
    // Attach event handlers
    requestAnimationFrame(() => {
      const closeAlertBtn = document.getElementById('closeAlertBtn');
      const morePreventativeTipsBtn = document.getElementById('morePreventativeTipsBtn');
      const showHistoryBtn = document.getElementById('showHistoryBtn');
      
      if (closeAlertBtn) {
        closeAlertBtn.addEventListener('click', () => {
          alertBox.style.display = 'none';
          alertBox.classList.remove('show');
        });
      }
      
      if (morePreventativeTipsBtn) {
        morePreventativeTipsBtn.addEventListener('click', () => {
          alertBox.style.display = 'none';
          alertBox.classList.remove('show');
          openPreventativeTipsModal(s.species);
        });
      }
      
      if (showHistoryBtn) {
        showHistoryBtn.addEventListener('click', () => {
          alertBox.style.display = 'none';
          alertBox.classList.remove('show');
          openDetailsModal(s.id);
        });
      }
    });
  }

  // Show quick alert for spot from list
  function showSpotQuickAlert(s) {
    // Check if this is a pre-season warning spot
    if (s.isPreseason) {
      showPreseasonAlert(s);
      return;
    }
    
    // Get latest report timestamp
    let lastReportedText = '';
    if (s.reports && s.reports.length > 0) {
      const latestReport = s.reports[s.reports.length - 1];
      lastReportedText = `<div class="text-xs text-gray-500 mt-1">Last reported: ${formatTimeAgo(latestReport.timestamp)}</div>`;
    }
    
    // Get last safe passage timestamp
    let lastSafePassageText = '';
    if (s.lastSafePassage) {
      lastSafePassageText = `<div class="text-xs text-gray-500 mt-1">Last safe passage: ${formatTimeAgo(s.lastSafePassage)}</div>`;
    }
    
    // Determine risk class for alert box styling
    let riskClass = 'risk-caution'; // default yellow
    if (s.risk === 'Danger - Avoid') {
      riskClass = 'risk-danger';
    } else if (s.risk === 'Take caution') {
      riskClass = 'risk-caution';
    } else if (s.risk === 'Calm - All clear') {
      riskClass = 'risk-calm';
    } else if (s.risk === 'Low risk') {
      riskClass = 'risk-low';
    }
    
    alertBox.innerHTML = `
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-sm font-semibold mb-1">${escapeHtml(s.name)} - ${escapeHtml(s.species)}</div>
          <div class="text-sm ${s.risk==='Danger - Avoid'?'text-red-600': s.risk==='Take caution' ? 'text-yellow-600' : s.risk==='Calm - All clear' ? 'text-blue-600' : 'text-green-600'} font-medium">
            ${escapeHtml(s.risk)}
          </div>
          <div class="text-xs text-gray-600 mt-1">${s.reports.length} report${s.reports.length === 1 ? '' : 's'}</div>
          ${lastReportedText}
          ${lastSafePassageText}
        </div>
        <div class="flex flex-col gap-2">
          <div class="flex items-center gap-2">
            <button id="showMoreBtn" class="text-xs text-white rounded px-3 py-1.5" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Show More</button>
            <button id="closeAlertBtn" class="text-xs border rounded px-3 py-1.5">Close</button>
          </div>
          <button id="safetyTipsAlertBtn" class="text-xs bg-green-600 hover:bg-green-700 text-white rounded px-3 py-1.5 w-full flex items-center justify-center gap-1.5">
            <img src="Assets/Icons/tips.svg" alt="Tips" style="width: 14px; height: 14px; filter: brightness(0) invert(1);">
            ${s.risk === 'Calm - All clear' ? 'Preventative Tips' : 'Safety Tips'}
          </button>
        </div>
      </div>
    `;
    
    // Remove all risk classes first
    alertBox.classList.remove('risk-danger', 'risk-caution', 'risk-calm', 'risk-low');
    // Add the appropriate risk class
    alertBox.classList.add(riskClass);
    
    alertBox.classList.add('show');
    alertBox.style.display = 'block';
    
    // Attach event handlers after a short delay to ensure DOM is ready
    requestAnimationFrame(() => {
      const showMoreBtn = document.getElementById('showMoreBtn');
      const closeAlertBtn = document.getElementById('closeAlertBtn');
      const safetyTipsAlertBtn = document.getElementById('safetyTipsAlertBtn');
      
      if (showMoreBtn) {
        showMoreBtn.addEventListener('click', () => {
          alertBox.style.display = 'none';
          alertBox.classList.remove('show');
          openDetailsModal(s.id);
        });
      }
      
      if (closeAlertBtn) {
        closeAlertBtn.addEventListener('click', () => {
          alertBox.style.display = 'none';
          alertBox.classList.remove('show');
        });
      }
      
      if (safetyTipsAlertBtn) {
        safetyTipsAlertBtn.addEventListener('click', () => {
          alertBox.style.display = 'none';
          alertBox.classList.remove('show');
          // Show preventative tips for calm spots, safety tips for others
          if (s.risk === 'Calm - All clear') {
            openPreventativeTipsModal(s.species);
          } else {
            openSafetyTipsModal(s.species);
          }
        });
      }
    });
  }


  // Play alert sound and vibrate (for mobile)
  function playAlertNotification() {
    console.log('üîî Alert notification triggered');
    
    // Play alert sound
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // Create a two-tone alert sound
      oscillator.frequency.value = 800;
      gainNode.gain.value = 0.3;
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.2);
      
      // Second beep
      const oscillator2 = audioContext.createOscillator();
      const gainNode2 = audioContext.createGain();
      oscillator2.connect(gainNode2);
      gainNode2.connect(audioContext.destination);
      oscillator2.frequency.value = 600;
      gainNode2.gain.value = 0.3;
      oscillator2.start(audioContext.currentTime + 0.25);
      oscillator2.stop(audioContext.currentTime + 0.45);
      
      console.log('‚úÖ Audio alert played');
    } catch(e) {
      console.warn('‚ùå Audio alert failed:', e);
    }
    
    // Vibrate (mobile devices)
    if ('vibrate' in navigator) {
      try {
        // More aggressive pattern for better noticeability
        // Pattern: vibrate 300ms, pause 100ms, vibrate 300ms, pause 100ms, vibrate 300ms
        const vibrationPattern = [300, 100, 300, 100, 300];
        const result = navigator.vibrate(vibrationPattern);
        console.log('üì≥ Vibration triggered:', result ? 'Success' : 'Failed or not supported');
      } catch(e) {
        console.warn('‚ùå Vibration failed:', e);
      }
    } else {
      console.log('‚ùå Vibration API not supported on this device');
      // iOS doesn't support vibration API
      // Show toast notification instead
      if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
        console.log('‚ÑπÔ∏è iOS detected - vibration not available via web');
      }
    }
  }

  // Play happy tone when exiting all zones (safe now!)
  function playHappyTone() {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      
      // Create a pleasant ascending chime (C-E-G major chord arpeggio)
      const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
      const noteDuration = 0.15;
      
      notes.forEach((freq, index) => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = freq;
        oscillator.type = 'sine'; // Smoother, more pleasant sound
        
        // Fade in/out envelope for smoother sound
        const startTime = audioContext.currentTime + (index * noteDuration);
        gainNode.gain.setValueAtTime(0, startTime);
        gainNode.gain.linearRampToValueAtTime(0.2, startTime + 0.02);
        gainNode.gain.linearRampToValueAtTime(0, startTime + noteDuration);
        
        oscillator.start(startTime);
        oscillator.stop(startTime + noteDuration);
      });
    } catch(e) {
      console.warn('Happy tone failed:', e);
    }
    
    // Single short vibration for positive feedback
    if ('vibrate' in navigator) {
      try {
        navigator.vibrate(100);
      } catch(e) {
        console.warn('Vibration failed:', e);
      }
    }
  }

  // Show alert when entering a spot's radius
  function showCenteredAlert(spots) {
    // Handle both single spot and array of spots
    const spotArray = Array.isArray(spots) ? spots : [spots];
    
    // Check if any spots are pre-season warnings
    const preseasonSpots = spotArray.filter(s => s.isPreseason);
    if (preseasonSpots.length > 0) {
      // Show pre-season alert for the first one (they're all calm anyway)
      showPreseasonAlert(preseasonSpots[0]);
      return;
    }
    
    // Play sound and vibrate when alert is shown
    playAlertNotification();
    
    if(spotArray.length === 1) {
      // Single spot - styled to match multi-bird view
      const s = spotArray[0];
      const borderColor = s.risk === 'Danger - Avoid' ? 'border-red-400 bg-red-50' : 
                         s.risk === 'Take caution' ? 'border-yellow-400 bg-yellow-50' : 
                         s.risk === 'Calm - All clear' ? 'border-blue-400 bg-blue-50' :
                         'border-green-400 bg-green-50';
      const textColor = s.risk === 'Danger - Avoid' ? 'text-red-700' : 
                       s.risk === 'Take caution' ? 'text-yellow-700' : 
                       s.risk === 'Calm - All clear' ? 'text-blue-700' :
                       'text-green-700';
      
      // Determine risk class for alert box styling
      let riskClass = 'risk-caution';
      if (s.risk === 'Danger - Avoid') {
        riskClass = 'risk-danger';
      } else if (s.risk === 'Take caution') {
        riskClass = 'risk-caution';
      } else if (s.risk === 'Calm - All clear') {
        riskClass = 'risk-calm';
      } else if (s.risk === 'Low risk') {
        riskClass = 'risk-low';
      }
      
      alertBox.innerHTML = `
        <div class="text-sm font-semibold mb-2 flex items-center gap-2">
          <img src="Assets/Icons/alert.svg" alt="Alert" style="width: 20px; height: 20px;">
          Swooping zone detected!
        </div>
        <div class="border-l-4 ${borderColor} p-3 rounded text-xs mb-2">
          <div class="font-semibold">${escapeHtml(s.name)}</div>
          <div class="text-gray-600">${escapeHtml(s.species)}</div>
          <div class="font-medium ${textColor}">${escapeHtml(s.risk)}</div>
          <div class="flex gap-2 mt-2">
            <button class="show-more-btn text-xs text-white rounded px-3 py-1" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'" data-spot-id="${s.id}">Show More</button>
            <button class="safety-tips-btn text-xs bg-green-600 hover:bg-green-700 text-white rounded px-3 py-1 flex items-center gap-1" data-species="${escapeHtml(s.species)}">
              <img src="Assets/Icons/tips.svg" alt="Tips" style="width: 12px; height: 12px; filter: brightness(0) invert(1);">
              Tips
            </button>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="clearAlertBtn" class="flex-1 text-xs border rounded px-3 py-1">Clear Alert</button>
        </div>
      `;

      // Remove all risk classes first, then add the appropriate one
      alertBox.classList.remove('risk-danger', 'risk-caution', 'risk-calm', 'risk-low');
      alertBox.classList.add(riskClass);
      
      alertBox.classList.add('show');
      alertBox.style.display = 'block';

      // Attach event handlers
      const showMoreBtn = alertBox.querySelector('.show-more-btn');
      if(showMoreBtn) {
        showMoreBtn.onclick = () => {
          hideCenteredAlert();
          openDetailsModal(s.id);
        };
      }
      
      const safetyTipsBtn = alertBox.querySelector('.safety-tips-btn');
      if(safetyTipsBtn) {
        safetyTipsBtn.onclick = () => {
          hideCenteredAlert();
          openSafetyTipsModal(s.species);
        };
      }
      
      document.getElementById('clearAlertBtn').onclick = () => {
        currentAlertSpots = [];
        hideCenteredAlert();
        if (userMarker) try { map.removeLayer(userMarker); } catch(e){}
      };
    } else {
      // Multiple spots - show list with Show More button for each
      const highestRisk = spotArray[0].risk;
      
      // Determine risk class for alert box styling based on highest risk
      let riskClass = 'risk-caution';
      if (highestRisk === 'Danger - Avoid') {
        riskClass = 'risk-danger';
      } else if (highestRisk === 'Take caution') {
        riskClass = 'risk-caution';
      } else if (highestRisk === 'Calm - All clear') {
        riskClass = 'risk-calm';
      } else if (highestRisk === 'Low risk') {
        riskClass = 'risk-low';
      }
      
      alertBox.innerHTML = `
        <div class="text-sm font-semibold mb-2 flex items-center gap-2">
          <img src="Assets/Icons/alert.svg" alt="Alert" style="width: 20px; height: 20px;">
          Multiple swooping zones detected! Highest risk: 
          <span class="ml-1 ${highestRisk==='Danger - Avoid'?'text-red-600': highestRisk==='Take caution' ? 'text-yellow-600' : 'text-green-600'}">${escapeHtml(highestRisk)}</span>
        </div>
        <div class="max-h-48 overflow-y-auto space-y-2 mb-2">
          ${spotArray.map(spot => {
            const borderColor = spot.risk === 'Danger - Avoid' ? 'border-red-400 bg-red-50' : 
                               spot.risk === 'Take caution' ? 'border-yellow-400 bg-yellow-50' : 
                               'border-green-400 bg-green-50';
            const textColor = spot.risk === 'Danger - Avoid' ? 'text-red-700' : 
                             spot.risk === 'Take caution' ? 'text-yellow-700' : 
                             'text-green-700';
            
            return `
              <div class="border-l-4 ${borderColor} p-3 rounded text-xs">
                <div class="font-semibold">${escapeHtml(spot.name)}</div>
                <div class="text-gray-600">${escapeHtml(spot.species)}</div>
                <div class="font-medium ${textColor}">${escapeHtml(spot.risk)}</div>
                <div class="flex gap-2 mt-2">
                  <button class="show-more-btn text-xs text-white rounded px-3 py-1" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'" data-spot-id="${spot.id}">Show More</button>
                  <button class="safety-tips-btn text-xs bg-green-600 hover:bg-green-700 text-white rounded px-3 py-1 flex items-center gap-1" data-species="${escapeHtml(spot.species)}">
                    <img src="Assets/Icons/tips.svg" alt="Tips" style="width: 12px; height: 12px; filter: brightness(0) invert(1);">
                    Tips
                  </button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
        <div class="flex gap-2">
          <button id="clearAlertBtn" class="flex-1 text-xs border rounded px-3 py-1">Clear Alert</button>
        </div>
      `;

      // Remove all risk classes first, then add the appropriate one
      alertBox.classList.remove('risk-danger', 'risk-caution', 'risk-calm', 'risk-low');
      alertBox.classList.add(riskClass);
      
      alertBox.classList.add('show');
      alertBox.style.display = 'block';

      // Attach event handlers for all Show More buttons
      alertBox.querySelectorAll('.show-more-btn').forEach(btn => {
        btn.onclick = () => {
          const spotId = btn.dataset.spotId;
          hideCenteredAlert();
          openDetailsModal(spotId);
        };
      });
      
      // Attach event handlers for all Safety Tips buttons
      alertBox.querySelectorAll('.safety-tips-btn').forEach(btn => {
        btn.onclick = () => {
          const species = btn.dataset.species;
          hideCenteredAlert();
          openSafetyTipsModal(species);
        };
      });
      
      document.getElementById('clearAlertBtn').onclick = () => {
        currentAlertSpots = [];
        hideCenteredAlert();
        if (userMarker) try { map.removeLayer(userMarker); } catch(e){}
      };
    }
  }

  // Hide centered alert
  function hideCenteredAlert() {
    alertBox.style.display = 'none';
    alertBox.classList.remove('show');
    // Remove all risk classes when hiding
    alertBox.classList.remove('risk-danger', 'risk-caution', 'risk-calm', 'risk-low');
  }

  // Show success modal after creating a spot or adding a report
  function showSuccessModal(birdName, birdSpecies, birdBehaviours, isNewSpot = true) {
    console.log('showSuccessModal called with:', { birdName, birdSpecies, birdBehaviours, isNewSpot });
    
    // Ensure birdBehaviours is an array
    if (!Array.isArray(birdBehaviours)) {
      console.warn('birdBehaviours is not an array:', birdBehaviours);
      birdBehaviours = [];
    }
    
    // Determine which icon, message, and color to show based on bird behavior
    let iconPath = 'Assets/Icons/user.svg'; // default
    let message = '';
    let birdNameColor = '#059669'; // default: darker green for low risk (better contrast)
    
    // Determine risk level color based on bird behaviors
    if (birdBehaviours.includes('made contact + injured') || birdBehaviours.includes('made contact + uninjured')) {
      birdNameColor = '#DC2626'; // darker red for danger
    } else if (birdBehaviours.includes('close swoop')) {
      birdNameColor = '#D97706'; // darker orange for caution
    } else if (birdBehaviours.includes('swoop') || birdBehaviours.includes('noisy') || birdBehaviours.includes('none')) {
      birdNameColor = '#059669'; // darker green for low risk
    }
    
    if (isNewSpot) {
      // Messages for creating a new spot
      message = `Thank you for keeping our community safe from <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}</span> the <span class="font-bold">${escapeHtml(birdSpecies)}</span>.`;
      
      if (birdBehaviours.includes('made contact + injured')) {
        iconPath = 'Assets/Icons/user_swoopedinjured.svg';
        message = `Thank you for reporting <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}</span> the <span class="font-bold">${escapeHtml(birdSpecies)}</span>. We're so sorry to hear you were injured! Please seek medical attention if needed.`;
      } else if (birdBehaviours.includes('made contact + uninjured')) {
        iconPath = 'Assets/Icons/user_swoopeduninjured.svg';
        message = `Thank you for reporting <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}</span> the <span class="font-bold">${escapeHtml(birdSpecies)}</span>. Sorry to hear about it swooping you, but we're glad you weren't injured!`;
      } else if (birdBehaviours.includes('close swoop') || birdBehaviours.includes('swoop')) {
        iconPath = 'Assets/Icons/user_swooped.svg';
        message = `Thank you for reporting <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}</span> the <span class="font-bold">${escapeHtml(birdSpecies)}</span>. Sorry to hear about the swoop ‚Äî stay safe out there!`;
      } else if (birdBehaviours.includes('noisy')) {
        iconPath = 'Assets/Icons/user_noisy.svg';
        message = `Thank you for reporting <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}</span> the <span class="font-bold">${escapeHtml(birdSpecies)}</span>. Those noisy birds can be quite startling!`;
      }
    } else {
      // Messages for adding a report to an existing spot
      message = `Thank you for adding a report to <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}'s</span> Swoop Spot.`;
      
      if (birdBehaviours.includes('made contact + injured')) {
        iconPath = 'Assets/Icons/user_swoopedinjured.svg';
        message = `Thank you for updating <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}'s</span> Swoop Spot. We're so sorry to hear you were injured! Please seek medical attention if needed.`;
      } else if (birdBehaviours.includes('made contact + uninjured')) {
        iconPath = 'Assets/Icons/user_swoopeduninjured.svg';
        message = `Thank you for updating <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}'s</span> Swoop Spot. Sorry to hear about it swooping you, but we're glad you weren't injured!`;
      } else if (birdBehaviours.includes('close swoop') || birdBehaviours.includes('swoop')) {
        iconPath = 'Assets/Icons/user_swooped.svg';
        message = `Thank you for updating <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}'s</span> Swoop Spot. Sorry to hear about the swoop ‚Äî stay safe out there!`;
      } else if (birdBehaviours.includes('noisy')) {
        iconPath = 'Assets/Icons/user_noisy.svg';
        message = `Thank you for updating <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}'s</span> Swoop Spot. Those noisy birds can be quite startling!`;
      }
    }
    
    console.log('Selected icon:', iconPath);
    console.log('Selected message:', message);
    
    successUserIcon.src = iconPath;
    successMessage.innerHTML = message;
    goodEggMessage.style.display = 'block'; // Show the "good egg" message for general success
    successModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
  }

  // Close success modal
  closeSuccessModal.addEventListener('click', () => {
    successModal.classList.add('hidden');
    document.body.classList.remove('modal-open');
  });

  // Show safe passage modal
  function showSafePassageModal(birdName, spotRisk = 'Low risk') {
    // Map spot risk to appropriate color (using darker colors for better contrast)
    let birdNameColor = '#059669'; // default: darker green for low risk
    
    if (spotRisk === 'Danger - Avoid') {
      birdNameColor = '#DC2626'; // darker red
    } else if (spotRisk === 'Take caution') {
      birdNameColor = '#D97706'; // darker orange
    } else if (spotRisk === 'Calm - All clear') {
      birdNameColor = '#2563eb'; // darker blue
    } else {
      birdNameColor = '#059669'; // darker green for low risk
    }
    
    successUserIcon.src = 'Assets/Icons/user_safepassage.svg';
    successMessage.innerHTML = `I'm so glad you didn't spot <span class="font-bold" style="color: ${birdNameColor}">${escapeHtml(birdName)}</span>. You must be a lucky egg!`;
    goodEggMessage.style.display = 'none'; // Hide the "good egg" message for safe passage
    successModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
  }

  // ----------------------------
  // Safety Tips Functions
  // ----------------------------
  // Safety Tips Functions
  // ----------------------------
  
  function openPreventativeTipsModal(species = 'general') {
    const tips = PREVENTATIVE_TIPS[species] || PREVENTATIVE_TIPS.general;
    
    let html = `
      <div class="mb-4">
        <h4 class="text-lg font-bold mb-2" style="color: #422d1e;">Building Rapport with ${species === 'general' ? 'Local Birds' : escapeHtml(species) + 's'}</h4>
        <p class="text-sm mb-4" style="color: #422d1e; opacity: 0.8;">
          These preventative tips can help you build positive relationships with birds in your area before nesting season begins. 
          Birds have excellent memories and are more likely to tolerate familiar, friendly humans.
        </p>
      </div>
      <div class="space-y-3">
    `;
    
    tips.forEach((tip, index) => {
      html += `
        <div class="flex items-start gap-3 p-3 rounded" style="background-color: #fff; border-left: 3px solid #059669;">
          <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white" style="background-color: #059669;">
            ${index + 1}
          </span>
          <p class="text-sm" style="color: #422d1e;">${escapeHtml(tip)}</p>
        </div>
      `;
    });
    
    html += `
      </div>
      <div class="mt-6 p-4 rounded" style="background-color: #DCFCE7; border-left: 3px solid #059669;">
        <p class="text-sm font-medium" style="color: #14532D;">
          Building positive relationships with birds takes time and consistency. Start these practices well before nesting season 
          for the best results. Remember, you're sharing their habitat - respect and patience go a long way!
        </p>
      </div>
      
      <div class="mt-4 text-center">
        <button id="viewSafetyTipsBtn" class="text-white px-6 py-2 rounded font-medium" style="background-color: #422d1e;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
          View Safety Tips (During Nesting Season)
        </button>
      </div>
    `;
    
    tipsContent.innerHTML = html;
    
    // Show the modal
    safetyTipsModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
    
    // Set up the button to switch to safety tips
    requestAnimationFrame(() => {
      const viewSafetyTipsBtn = document.getElementById('viewSafetyTipsBtn');
      if (viewSafetyTipsBtn) {
        viewSafetyTipsBtn.addEventListener('click', () => {
          displaySafetyTips(species);
        });
      }
    });
  }
  
  function openSafetyTipsModal(species = 'general') {
    // Set the species in the dropdown
    tipsSpeciesSelect.value = species;
    
    // Display the tips
    displaySafetyTips(species);
    
    // Show the modal
    safetyTipsModal.classList.remove('hidden');
    document.body.classList.add('modal-open');
  }
  
  function displaySafetyTips(species) {
    const tips = SAFETY_TIPS[species] || SAFETY_TIPS.general;
    
    let html = `
      <div class="mb-4">
        <h4 class="text-lg font-bold mb-2" style="color: #422d1e;">${escapeHtml(tips.title)}</h4>
        <p class="text-sm mb-4" style="color: #422d1e; opacity: 0.8;">${escapeHtml(tips.description)}</p>
      </div>
      <div class="space-y-3">
    `;
    
    tips.tips.forEach((tip, index) => {
      html += `
        <div class="flex items-start gap-3 p-3 rounded" style="background-color: #fff; border-left: 3px solid #10B981;">
          <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white" style="background-color: #10B981;">
            ${index + 1}
          </span>
          <p class="text-sm" style="color: #422d1e;">${escapeHtml(tip)}</p>
        </div>
      `;
    });
    
    html += `
      </div>
      <div class="mt-6 p-4 rounded" style="background-color: #FEF3C7; border-left: 3px solid #F59E0B;">
        <p class="text-sm font-medium" style="color: #92400E;">
          Remember: These birds are protected native wildlife. They're defending their nests, not attacking maliciously. 
          Never harm or attempt to remove nesting birds. Contact local wildlife authorities if a bird poses a serious danger.
        </p>
      </div>
      
      <div class="mt-6 p-4 rounded" style="background-color: #E0F2FE; border-left: 3px solid #0284C7;">
        <h5 class="text-sm font-bold mb-2" style="color: #0C4A6E;">Information Sources</h5>
        <div class="text-xs space-y-1" style="color: #0C4A6E;">
          <p><strong>Australian Government - Department of Climate Change, Energy, the Environment and Water</strong></p>
          <p class="ml-3">Wildlife protection guidelines and native bird behavior information</p>
          
          <p class="mt-2"><strong>Birdlife Australia</strong></p>
          <p class="ml-3">National bird conservation organization - swooping bird education and safety advice</p>
          
          <p class="mt-2"><strong>Australian Museum</strong></p>
          <p class="ml-3">Scientific research on Australian bird species behavior and nesting patterns</p>
          
          <p class="mt-2"><strong>NSW Environment and Heritage</strong></p>
          <p class="ml-3">State-based wildlife management and public safety guidelines</p>
          
          <p class="mt-2"><strong>Queensland Museum</strong></p>
          <p class="ml-3">Educational resources on Queensland bird species and behavior</p>
          
          <p class="mt-2"><strong>Local Council Wildlife Services</strong></p>
          <p class="ml-3">ACT, NSW, VIC, QLD council guidelines for managing swooping birds in urban areas</p>
          
          <p class="mt-3 italic" style="opacity: 0.8;">This information is compiled from publicly available wildlife safety resources and scientific literature. Always follow local authority advice and report dangerous wildlife encounters to your local council or wildlife rescue services.</p>
        </div>
      </div>
    `;
    
    tipsContent.innerHTML = html;
  }
  
  // Safety tips modal event listeners
  if (closeSafetyTips && safetyTipsModal) {
    closeSafetyTips.addEventListener('click', () => {
      safetyTipsModal.classList.add('hidden');
      document.body.classList.remove('modal-open');
    });
  }
  
  const closeSafetyTipsBottom = document.getElementById('closeSafetyTipsBottom');
  if (closeSafetyTipsBottom && safetyTipsModal) {
    closeSafetyTipsBottom.addEventListener('click', () => {
      safetyTipsModal.classList.add('hidden');
      document.body.classList.remove('modal-open');
    });
  }
  
  if (safetyTipsBtn) {
    safetyTipsBtn.addEventListener('click', () => {
      openSafetyTipsModal('general');
    });
  }
  
  if (tipsSpeciesSelect) {
    tipsSpeciesSelect.addEventListener('change', (e) => {
      displaySafetyTips(e.target.value);
    });
  }

  // ----------------------------
  // Walk simulator (straight line)
  // ----------------------------
  document.getElementById('playSim').addEventListener('click', async ()=>{
    const s = document.getElementById('simStart').value.trim();
    const e = document.getElementById('simEnd').value.trim();
    if(!s || !e){ toast('Enter both addresses'); return; }
    try {
      const g1 = await geocodeAddress(s);
      const g2 = await geocodeAddress(e);
      const steps = 80; simPath = [];
      for(let i=0;i<=steps;i++) simPath.push({ lat: g1.lat + (g2.lat - g1.lat)*(i/steps), lng: g1.lng + (g2.lng - g1.lng)*(i/steps) });
      simIndex = 0;
      if(userMarker) try{ map.removeLayer(userMarker); } catch(e){}
      userMarker = L.marker([simPath[0].lat, simPath[0].lng], { icon: getUserIcon() }).addTo(map);
      if(simTimer) clearInterval(simTimer);
      simTimer = setInterval(()=> {
        simIndex++;
        if(simIndex >= simPath.length){ clearInterval(simTimer); simTimer = null; return; }
        const p = simPath[simIndex];
        try{ userMarker.setLatLng([p.lat,p.lng]); } catch(e){}
        checkLocation(p.lat, p.lng);
        map.setView([p.lat,p.lng], map.getZoom());
      }, 400);
    } catch(err){ toast('Simulator error: ' + (err.message || err)); }
  });
  document.getElementById('stopSim').addEventListener('click', ()=> { if(simTimer) clearInterval(simTimer); simTimer=null; });

  // ----------------------------
  // Location Tracking (Continuous)
  // ----------------------------
  function startLocationTracking() {
    if (!navigator.geolocation) {
      toast('Geolocation is not supported by your browser');
      return;
    }

    if (isTracking) {
      // Already tracking, stop it
      stopLocationTracking();
      return;
    }

    toast('Starting location tracking...');

    // Use watchPosition for continuous tracking
    locationWatchId = navigator.geolocation.watchPosition(
      // Success callback
      (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        
        // Update user location on map and check for alerts
        checkLocation(lat, lng);
        
        // Optionally center map on user (only on first location)
        if (!isTracking) {
          map.setView([lat, lng], Math.max(map.getZoom(), 14));
        }
        
        if (!isTracking) {
          isTracking = true;
          trackBtnText.textContent = 'Stop Tracking';
          trackLocationBtn.style.backgroundColor = '#ef4444'; // Red when tracking
          toast('Location tracking active', 2000);
        }
      },
      // Error callback
      (err) => {
        console.error('Location tracking error:', err);
        let errorMsg = 'Tracking error: ';
        
        switch(err.code) {
          case err.PERMISSION_DENIED:
            errorMsg += 'Location permission denied. Please enable location access.';
            break;
          case err.POSITION_UNAVAILABLE:
            errorMsg += 'Location unavailable. Check your device settings.';
            break;
          case err.TIMEOUT:
            errorMsg += 'Location request timed out. Retrying...';
            break;
          default:
            errorMsg += err.message || 'Unknown error';
        }
        
        toast(errorMsg, 3000);
        
        // If permission denied, stop tracking
        if (err.code === err.PERMISSION_DENIED) {
          stopLocationTracking();
        }
      },
      // Options - optimized for mobile walking/cycling
      {
        enableHighAccuracy: true,  // Use GPS for better accuracy
        timeout: 10000,            // 10 second timeout
        maximumAge: 3000           // Accept positions up to 3 seconds old (checks ~every 3 seconds)
      }
    );
  }

  function stopLocationTracking() {
    if (locationWatchId !== null) {
      navigator.geolocation.clearWatch(locationWatchId);
      locationWatchId = null;
    }
    
    isTracking = false;
    trackBtnText.textContent = 'Start Tracking';
    trackLocationBtn.style.backgroundColor = '#422d1e'; // Back to dark color
    toast('Location tracking stopped');
  }

  // Track location button click handler
  trackLocationBtn.addEventListener('click', () => {
    if (isTracking) {
      stopLocationTracking();
    } else {
      startLocationTracking();
    }
  });

  // Auto-start tracking on mobile devices (with user interaction)
  function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
           || window.innerWidth <= 768;
  }

  // Optionally auto-start on mobile (you can enable this if desired)
  // Uncomment the following to auto-start tracking on mobile:
  /*
  if (isMobileDevice()) {
    // Give user a moment to see the interface, then offer to start tracking
    setTimeout(() => {
      if (confirm('Start tracking your location automatically?')) {
        startLocationTracking();
      }
    }, 1000);
  }
  */

  // ----------------------------
  // Use GPS & clear spots
  // ----------------------------
  useGPSBtn.addEventListener('click', ()=> {
    if(!navigator.geolocation) {
      toast('Geolocation is not supported by your browser');
      return;
    }
    
    // Show loading state
    toast('Getting your location...');
    
    navigator.geolocation.getCurrentPosition(
      // Success callback
      p => {
        map.setView([p.coords.latitude, p.coords.longitude], 15);
        checkLocation(p.coords.latitude, p.coords.longitude);
        toast('Location found!');
      }, 
      // Error callback
      err => {
        console.error('Geolocation error:', err);
        let errorMsg = 'GPS error: ';
        
        switch(err.code) {
          case err.PERMISSION_DENIED:
            errorMsg += 'Location permission denied. Please enable location access in your browser settings.';
            break;
          case err.POSITION_UNAVAILABLE:
            errorMsg += 'Location information unavailable. Please check your device settings.';
            break;
          case err.TIMEOUT:
            errorMsg += 'Location request timed out. Please try again.';
            break;
          default:
            errorMsg += err.message || 'Unknown error occurred';
        }
        
        toast(errorMsg, 4000); // Show error for 4 seconds
      },
      // Options
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  });

  // Test vibration button
  const testVibrateBtn = document.getElementById('testVibrateBtn');
  testVibrateBtn.addEventListener('click', ()=> {
    console.log('üì≥ Testing vibration...');
    
    if ('vibrate' in navigator) {
      toast('Testing vibration...', 1000);
      
      // Test vibration
      const vibrationPattern = [300, 100, 300, 100, 300];
      const result = navigator.vibrate(vibrationPattern);
      
      console.log('Vibration API called, result:', result);
      
      if (result) {
        setTimeout(() => {
          toast('Vibration triggered! Did you feel it?', 3000);
        }, 1000);
      } else {
        toast('Vibration API returned false - may not be supported', 3000);
      }
    } else {
      console.log('Vibration API not available');
      
      // Check if iOS
      if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
        toast('iOS does not support web vibration API', 3000);
      } else {
        toast('Vibration not supported on this browser', 3000);
      }
    }
  });

  // ----------------------------
  // Test Date Functionality
  // ----------------------------
  let testDate = null; // null = use real date, otherwise use this date
  
  // Helper function to get current date (real or test)
  function getCurrentDate() {
    return testDate ? new Date(testDate) : new Date();
  }
  
  // Debug: Check if test date elements exist
  console.log('üîç Test Date Elements Check:', {
    testDateBtn: !!testDateBtn,
    testDateModal: !!testDateModal,
    closeTestDate: !!closeTestDate,
    testDateInput: !!testDateInput,
    applyTestDate: !!applyTestDate,
    resetTestDate: !!resetTestDate,
    currentTestDate: !!currentTestDate
  });
  
  // Open test date modal
  testDateBtn.addEventListener('click', () => {
    console.log('üìÖ Test Date Modal opened');
    // Set input to current test date or today
    const dateToShow = testDate ? new Date(testDate) : new Date();
    testDateInput.value = dateToShow.toISOString().split('T')[0];
    updateTestDateDisplay();
    testDateModal.classList.remove('hidden');
  });
  
  // Close test date modal
  closeTestDate.addEventListener('click', () => {
    console.log('‚ùå Test Date Modal closed');
    testDateModal.classList.add('hidden');
  });
  
  // Apply test date
  console.log('üîß Setting up applyTestDate event listener...');
  applyTestDate.addEventListener('click', async () => {
    console.log('üéØ Apply Test Date clicked!');
    const selectedDate = testDateInput.value;
    console.log('üìÖ Selected date:', selectedDate);
    
    if (selectedDate) {
      testDate = new Date(selectedDate).toISOString();
      console.log('‚úÖ Test date set to:', testDate);
      console.log('üìä Current spots before reload:', spots.length);
      
      updateTestDateDisplay();
      
      // Reload all spots to recalculate with new date
      spots.forEach(s => {
        try {
          map.removeLayer(s.marker);
          map.removeLayer(s.circle);
        } catch(e) {}
      });
      spots = [];
      console.log('üóëÔ∏è Spots cleared, reloading from Supabase...');
      
      // Reload from Supabase to recalculate risk levels with new test date
      await loadAllFromSupabase(true);
      console.log('üìä Spots after reload:', spots.length);
      
      renderAlerts();
      
      toast(`Test date set to ${new Date(testDate).toLocaleDateString()}`, 2000);
      testDateModal.classList.add('hidden');
    } else {
      console.log('‚ùå No date selected');
    }
  });
  
  // Reset to real date
  resetTestDate.addEventListener('click', async () => {
    testDate = null;
    updateTestDateDisplay();
    
    // Reload all spots to recalculate with real date
    spots.forEach(s => {
      try {
        map.removeLayer(s.marker);
        map.removeLayer(s.circle);
      } catch(e) {}
    });
    spots = [];
    
    // Reload from Supabase to recalculate risk levels with real date
    await loadAllFromSupabase(true);
    renderAlerts();
    
    toast('Reset to real date', 2000);
    testDateModal.classList.add('hidden');
  });
  
  function updateTestDateDisplay() {
    if (testDate) {
      const date = new Date(testDate);
      currentTestDate.innerHTML = `<strong>Testing with date:</strong> ${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
      currentTestDate.style.color = '#D97706';
      currentTestDate.style.fontWeight = 'bold';
      testDateBtn.style.backgroundColor = '#FEF3C7';
      testDateBtn.style.borderColor = '#F59E0B';
    } else {
      currentTestDate.innerHTML = 'Using real date (today)';
      currentTestDate.style.color = '#422d1e';
      currentTestDate.style.fontWeight = 'normal';
      testDateBtn.style.backgroundColor = 'transparent';
      testDateBtn.style.borderColor = '#d4cac7';
    }
  }
  
  // Initial display update
  updateTestDateDisplay();

  // ----------------------------
  // ----------------------------
  // Auth UI Event Listeners
  // ----------------------------
  
  // Check if auth UI elements exist
  if (!authModal || !signInButton) {
    console.warn('‚ö†Ô∏è Authentication UI elements missing - sign-in disabled');
    // Add a temporary warning for the sign-in button
    if (signInButton) {
      signInButton.addEventListener('click', () => {
        toast('Sign-in temporarily unavailable - viewing in guest mode', 3000);
      });
    }
  }
  
  // Open auth modal
  if (signInButton && authModal) {
    signInButton.addEventListener('click', () => {
      authModal.classList.remove('hidden');
      if (signInForm) signInForm.classList.remove('hidden');
      if (signUpForm) signUpForm.classList.add('hidden');
      if (signInTab) signInTab.classList.add('active');
      if (signUpTab) signUpTab.classList.remove('active');
      if (signInError) signInError.classList.add('hidden');
      if (signUpError) signUpError.classList.add('hidden');
    });
  }
  
  // Close auth modal
  if (closeAuthModal && authModal) {
    closeAuthModal.addEventListener('click', () => {
      authModal.classList.add('hidden');
      if (signInForm) signInForm.reset();
      if (signUpForm) signUpForm.reset();
      if (signInError) signInError.classList.add('hidden');
      if (signUpError) signUpError.classList.add('hidden');
    });
  }
  
  // Tab switching
  if (signInTab) signInTab.addEventListener('click', () => {
    if (signInForm) signInForm.classList.remove('hidden');
    if (signUpForm) signUpForm.classList.add('hidden');
    if (signInTab) {
      signInTab.classList.add('active');
      signInTab.style.borderColor = '#422d1e';
      signInTab.style.opacity = '1';
    }
    if (signUpTab) {
      signUpTab.classList.remove('active');
      signUpTab.style.borderColor = 'transparent';
      signUpTab.style.opacity = '0.6';
    }
    if (signInError) signInError.classList.add('hidden');
    if (signUpError) signUpError.classList.add('hidden');
  });
  
  if (signUpTab) signUpTab.addEventListener('click', () => {
    if (signUpForm) signUpForm.classList.remove('hidden');
    if (signInForm) signInForm.classList.add('hidden');
    if (signUpTab) {
      signUpTab.classList.add('active');
      signUpTab.style.borderColor = '#422d1e';
      signUpTab.style.opacity = '1';
    }
    if (signInTab) {
      signInTab.classList.remove('active');
      signInTab.style.borderColor = 'transparent';
      signInTab.style.opacity = '0.6';
    }
    if (signInError) signInError.classList.add('hidden');
    if (signUpError) signUpError.classList.add('hidden');
  });
  
  // Sign in form submit
  if (signInForm) signInForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    await signIn(signInEmail.value, signInPassword.value);
  });
  
  // Sign up form submit
  if (signUpForm) signUpForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    await signUp(signUpName.value, signUpEmail.value, signUpPassword.value);
  });
  
  // User button - toggle menu
  if (userButton && userMenuDropdown) {
    userButton.addEventListener('click', (e) => {
      e.stopPropagation();
      userMenuDropdown.classList.toggle('hidden');
    });
  }
  
  // Close menu when clicking outside
  if (userMenuDropdown) {
    document.addEventListener('click', () => {
      userMenuDropdown.classList.add('hidden');
    });
    
    userMenuDropdown.addEventListener('click', (e) => {
      e.stopPropagation();
    });
  }
  
  // Menu actions
  if (userMenuSignOut && userMenuDropdown) {
    userMenuSignOut.addEventListener('click', async (e) => {
      e.stopPropagation();
      await signOutUser();
      userMenuDropdown.classList.add('hidden');
    });
  }
  
  // Menu actions - Stats and Profile
  if (userMenuStats && userMenuDropdown) {
    userMenuStats.addEventListener('click', (e) => {
      e.stopPropagation();
      openProfileModal('stats');
      userMenuDropdown.classList.add('hidden');
    });
  }
  
  if (userMenuProfile && userMenuDropdown) {
    userMenuProfile.addEventListener('click', (e) => {
      e.stopPropagation();
      openProfileModal('edit');
      userMenuDropdown.classList.add('hidden');
    });
  }
  
  // Profile Modal Event Listeners
  if (closeProfileModal) closeProfileModal.addEventListener('click', closeProfileModalFn);
  
  // Tab switching
  if (profileStatsTab) profileStatsTab.addEventListener('click', () => {
    if (profileStatsTab) {
      profileStatsTab.classList.add('active');
      profileStatsTab.style.cssText = 'border-color: #422d1e; color: #422d1e; opacity: 1;';
    }
    if (profileEditTab) {
      profileEditTab.classList.remove('active');
      profileEditTab.style.cssText = 'color: #422d1e; opacity: 0.6; border-color: transparent;';
    }
    
    if (profileStatsContent) profileStatsContent.classList.remove('hidden');
    if (profileEditContent) profileEditContent.classList.add('hidden');
  });
  
  if (profileEditTab) profileEditTab.addEventListener('click', () => {
    if (profileEditTab) {
      profileEditTab.classList.add('active');
      profileEditTab.style.cssText = 'border-color: #422d1e; color: #422d1e; opacity: 1;';
    }
    if (profileStatsTab) {
      profileStatsTab.classList.remove('active');
      profileStatsTab.style.cssText = 'color: #422d1e; opacity: 0.6; border-color: transparent;';
    }
    
    if (profileEditContent) profileEditContent.classList.remove('hidden');
    if (profileStatsContent) profileStatsContent.classList.add('hidden');
  });
  
  // Avatar picker
  document.querySelectorAll('.avatar-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const avatar = btn.dataset.avatar;
      if (selectedAvatar) selectedAvatar.value = avatar;
      
      // Update visual selection
      document.querySelectorAll('.avatar-btn').forEach(b => {
        b.style.borderColor = 'transparent';
        b.style.backgroundColor = '';
      });
      btn.style.borderColor = '#422d1e';
      btn.style.backgroundColor = '#e8e2e1';
    });
  });
  
  // Profile edit form
  if (profileEditForm) profileEditForm.addEventListener('submit', updateUserProfile);
  
  if (cancelEditProfile) cancelEditProfile.addEventListener('click', (e) => {
    e.preventDefault();
    if (profileStatsTab) profileStatsTab.click();
  });
  
  // Close modal when clicking outside
  if (profileModal) profileModal.addEventListener('click', (e) => {
    if (e.target === profileModal) {
      e.stopPropagation();
      closeProfileModalFn();
    }
  });
  
  // Prevent clicks inside modal content from closing it
  if (profileModal) {
    const profileModalContent = profileModal.querySelector('.rounded-lg');
    if (profileModalContent) {
      profileModalContent.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }
  }

  // ----------------------------
  // Initial load default spot if none
  // ----------------------------
  // initialize tag UIs once at startup
  initializeAllTagUIs();
  
  // Initialize authentication
  initAuth();

  // Load spots from Supabase (with fallback to localStorage)
  (async () => {
    console.log('üöÄ Starting app initialization...');
    console.log('üó∫Ô∏è Map initialized:', !!map);
    console.log('üìä Initial spots count:', spots.length);
    
    await loadAllFromSupabase();
    
    console.log('üìä After loadAllFromSupabase, spots count:', spots.length);
    
    // Subscribe to real-time updates
    subscribeToRealtimeUpdates();
    
    // If no spots loaded, create a default example spot
    if(spots.length === 0){
      console.log('‚ö†Ô∏è No spots loaded, creating default example spot...');
      const defaultSpot = {
        id: uid(),
        name: 'South Bank Swoop',
        species: 'Magpie',
        lat: -27.4789,
        lng: 153.0234,
        radius: 150,
        risk: 'Take caution',
        reports: [{
          id: uid(),
          timestamp: new Date().toISOString(),
          birdBehaviour: ['swoop'],
          humanBehaviour: ['walking'],
          precautions: ['Hat'],
          extraDetails: 'Peak swoop season',
          alertLevel: 'Take caution'
        }]
      };
      createSpotFromData(defaultSpot, false);
      saveAll();
      console.log('‚úÖ Default spot created');
    }
    
    console.log('üé® Rendering alerts...');
    renderAlerts();
    console.log('‚úÖ App initialization complete. Total spots:', spots.length);
  })();

  // re-run initialization each time modals open/close so UI arrays & handlers are fresh
  openAddBtn.addEventListener('click', initializeAllTagUIs);
  addSpotBelowMap.addEventListener('click', initializeAllTagUIs);
  closeSpotModal.addEventListener('click', initializeAllTagUIs);
  closeDetails.addEventListener('click', initializeAllTagUIs);

  // expose some for debugging
  window.SwoopSpotter = { 
    spots, 
    map, 
    openCreateSpotModal, 
    openDetailsModal, 
    checkLocation,
    supabase, // Expose for debugging
    loadAllFromSupabase, // Expose for manual refresh
    syncEnabled // Expose to toggle sync
  };

})(); // IIFE end
</script>
</body>
</html>
